<!DOCTYPE html><html lang="en-us" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>[Book] Reverse Engineering Core (리버스 엔지니어링 핵심 원리) | ISSAC/iss4cf0ng's blog</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":true,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy","copyFinish":"copied","expand":"expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js"></script><script>MathJax.Hub.Config({
 menuSettings: {
   zoom: "None"
 },
 showMathMenu: false,
 jax: ["input/TeX","output/CommonHTML"],
 extensions: ["tex2jax.js"],
 TeX: {
   extensions: ["AMSmath.js","AMSsymbols.js"],
   equationNumbers: {
     autoNumber: "AMS"
   }
 },
 tex2jax: {
   inlineMath: [["\\(", "\\)"]],
   displayMath: [["\\[", "\\]"]]
 }
});</script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/brands.min.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/fontawesome.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
@font-face {
 font-family: 'Font Awesome 6 Brands';
 src: local('Font Awesome 6 Brands'), url('/lib/fontawesome/fa-brands.woff2') format('woff2');
}
@font-face {
 font-family: 'Font Awesome 6 Free';
 src: local('Font Awesome 6 Free'), url('/lib/fontawesome/fa-regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ISSAC/iss4cf0ng's blog" type="application/atom+xml">
</head><body><div class="loading" style="opacity: 0"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn hide"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/About/"><span class="navItemTitle">About</span></a></li><li class="navItem"><a class="navBlock" href="/Alien/"><span class="navItemTitle">Alien</span></a></li><li class="navItem"><a class="navBlock" href="/2026/01/28/2026-1-28-ToolsDuplexSpy-v2-0-0/"><span class="navItemTitle">DuplexSpy</span></a></li><li class="navItem"><a class="navBlock" href="/Notes/"><span class="navItemTitle">Notes</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>[Book] Reverse Engineering Core (리버스 엔지니어링 핵심 원리)</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2026-01-04T13:41:45.000Z" id="date"> 2026-01-04</time></div></span><br><span>Last Update: <div class="control"><time datetime="2026-01-21T15:42:09.459Z" id="updated"> 2026-01-21</time></div></span><br><span>Word Count: <div class="control">10.1k</div></span><br><span>Read Time: <div class="control">62 min</div></span></div></div><hr><div id="post-content"><h1 id="El-libro"><a href="#El-libro" class="headerlink" title="El libro"></a>El libro</h1><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/libro.jpg'><img src="/images/books/ReverseEngineeringCore/libro.jpg" width="500">
</p>

<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This article is used to keep notes and summaries of the book “Reverse Engineering Core”.<br>The content will be continuously updated as I read through the book.</p>
<h1 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h1><p>Finally, I have completed this book.</p>
<p align="center" class='item-img' data-src='/images/meme/terrible_cake.png'><img src="/images/meme/terrible_cake.png" width="500">
</p>

<p>I had always wanted to read this book. Unfortunately, due to personal issues, I was unable to do so for a long time. Therefore, I am glad that I finally finished it.</p>
<p>This book was originally written in Korean. It also has a Simplified Chinese translation. Unfortunately, I have not found an English version. Perhaps this is because there are already many books on reverse engineering written in English.</p>
<p>This book describes the underlying principles of reverse engineering in both theoretical and practical ways.</p>
<p>It introduces how to perform software reverse engineering on the Windows platform using tools such as OllyDbg, WinDbg, and PEView. IDA is rarely discussed. Therefore, this book is especially suitable for readers who want to master OllyDbg.</p>
<p>This book <strong>DOES NOT</strong> cover <strong>kernel debugging</strong>.</p>
<p align="center" class='item-img' data-src='/images/meme/mika_nagisa_redtea.jpg'><img src="/images/meme/mika_nagisa_redtea.jpg" width="600">
</p>

<p>The book also provides both source code and compiled PE files for all chapters. This is a significant advantage for hands-on practice, because compiling the code yourself may produce different results depending on the environment. In addition, some of the provided code examples are difficult to find on the internet.</p>
<p>This book includes:</p>
<ul>
<li>Reverse engineering on Windows</li>
<li>OllyDbg</li>
<li>WinDbg</li>
<li>PE file format</li>
<li>Windows API</li>
<li>Techniques for improving reverse engineering skills</li>
<li>The author’s experience (the author previously worked for an enterprise developing anti-virus software)</li>
<li>Advanced debugging</li>
<li>Anti-debugging</li>
<li>Advanced anti-debugging</li>
<li>Anti-anti-debugging</li>
<li>Code injection</li>
<li>DLL injection</li>
<li>Application patching</li>
<li>etc.</li>
</ul>
<p>This book does not include:</p>
<ul>
<li>Kernel debugging</li>
<li>IDA Pro</li>
<li>Ghidra</li>
<li>Reverse engineering on Linux</li>
<li>Reverse engineering of Android APKs</li>
<li>Reverse engineering of iOS applications</li>
</ul>
<p>Prerequisites (Recommended):</p>
<ul>
<li>Basic knowledge of C/C++</li>
<li>Basic knowledge of the Win32 API</li>
<li>Basic understanding of Windows</li>
<li>Passion, patience, and the ability to use Google</li>
</ul>
<p>You may feel frustrated during the process of reverse engineering. However, the author also mentioned that he experienced similar frustration.</p>
<p align="center" class='item-img' data-src='/images/meme/hakari_crying.jpeg'><img src="/images/meme/hakari_crying.jpeg" width="700">
</p>

<h1 id="Chapter-1-Reverse-Engineering"><a href="#Chapter-1-Reverse-Engineering" class="headerlink" title="Chapter 1 - Reverse Engineering"></a>Chapter 1 - Reverse Engineering</h1><p>Murmur….</p>
<p>Blahblahblah….</p>
<p>This chapter introduces the background and basic knowledge of reverse engineering.</p>
<h1 id="Chapter-2-Hello-World"><a href="#Chapter-2-Hello-World" class="headerlink" title="Chapter 2 - Hello World!"></a>Chapter 2 - Hello World!</h1><h2 id="2-2-Debugging"><a href="#2-2-Debugging" class="headerlink" title="2.2 - Debugging"></a>2.2 - Debugging</h2><p><strong>Basic commands of OllyDbg</strong>:</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Command</th>
<th>Hotkey</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Restart</td>
<td>Ctrl+F2</td>
<td>Restart debugging.</td>
</tr>
<tr>
<td>Step Into</td>
<td>F7</td>
<td>Execute an OP code. If the OP code is <code>CALL</code>, then go into the called code.</td>
</tr>
<tr>
<td>Step Over</td>
<td>F8</td>
<td>Execute an OP code. If the OP code is <code>CALL</code>, then just execute the code rather then go into the called code.</td>
</tr>
<tr>
<td>Execute till Return</td>
<td>Ctrl+F9</td>
<td>Keep executing code until it reached <code>RETN</code></td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &quot;windows.h&quot;<br>#include &quot;tchar.h&quot;<br><br>int _tmain(int argc, TCHAR *argv[])<br>&#123;<br>    MessageBox(<br>        NULL, <br>        L&quot;Hello World!&quot;, <br>        L&quot;www.reversecre.com&quot;, <br>        MB_OK<br>    );<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.1.png'><img src="/images/books/ReverseEngineeringCore/2.1.png" width="800">
</p>

<p>This is the <code>main()</code> function of <strong>HelloWorld.exe</strong></p>
<h2 id="2-3-Getting-Familar-with-Debugger"><a href="#2-3-Getting-Familar-with-Debugger" class="headerlink" title="2.3 - Getting Familar with Debugger"></a>2.3 - Getting Familar with Debugger</h2><div class="table-container">
<table>
<thead>
<tr>
<th>Command</th>
<th>Hotkey</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Go to</td>
<td>Ctrl+G</td>
</tr>
<tr>
<td>Execute till Cursor</td>
<td>F4</td>
</tr>
<tr>
<td>Comment</td>
<td>;</td>
</tr>
<tr>
<td>User-defined comment</td>
<td></td>
</tr>
<tr>
<td>Label</td>
<td>:</td>
</tr>
<tr>
<td>User-defined label</td>
<td></td>
</tr>
<tr>
<td>Set/Reset breakpoint</td>
<td>F2</td>
</tr>
<tr>
<td>Run</td>
<td>F9</td>
</tr>
<tr>
<td>Show the current EPI</td>
<td>*</td>
</tr>
<tr>
<td>Show the previous Cursor</td>
<td>-</td>
</tr>
<tr>
<td>Preview CALL/JMP address</td>
<td>Enter</td>
</tr>
</tbody>
</table>
</div>
<h2 id="2-4-Find-a-Specific-Code"><a href="#2-4-Find-a-Specific-Code" class="headerlink" title="2.4 - Find a Specific Code"></a>2.4 - Find a Specific Code</h2><ol>
<li>Executing Code</li>
<li>Searching with Text: Right click -&gt; Search for -&gt; All referenced text strings</li>
<li>Searching with used APIs: Right click -&gt; Search for -&gt; All intermodular calls</li>
</ol>
<h2 id="2-5-Patching-the-Code"><a href="#2-5-Patching-the-Code" class="headerlink" title="2.5 - Patching the Code"></a>2.5 - Patching the Code</h2><ol>
<li><p>Modifying the Buffer<br>Hexdump:</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.2.png'><img src="/images/books/ReverseEngineeringCore/2.2.png" width="800">
</p>

<p> Modifying, notice that we have to append a null char(<code>00 00</code>) at the end of a string.</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.3.png'><img src="/images/books/ReverseEngineeringCore/2.3.png" width="500">
</p>

<p> Patched code:</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.4.png'><img src="/images/books/ReverseEngineeringCore/2.4.png" width="500">
</p>

<p>Save code:</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.5.png'><img src="/images/books/ReverseEngineeringCore/2.5.png" width="400">
</p>
</li>
<li><p>Adding a new string in memory<br>Insert a string int memory</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.5.png'><img src="/images/books/ReverseEngineeringCore/2.5.png" width="400">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.7.png'><img src="/images/books/ReverseEngineeringCore/2.7.png" width="400">
</p>

<p>Modify the assembly code</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.8.png'><img src="/images/books/ReverseEngineeringCore/2.8.png" width="400">
</p>

<p>Patched code:</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.9.png'><img src="/images/books/ReverseEngineeringCore/2.9.png" width="400">
</p>

</li>
</ol>
<h1 id="Chapter-3-Little-Endian"><a href="#Chapter-3-Little-Endian" class="headerlink" title="Chapter 3 - Little Endian"></a>Chapter 3 - Little Endian</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BYTE b = 0x12;<br>WORD w = 0x1234;<br>DWORD dw = 0x12345678;<br>char str[] = &quot;abcde&quot;;<br></code></pre></td></tr></table></figure>
<div class="table-container">
<table>
<thead>
<tr>
<th>TYPE</th>
<th>Name</th>
<th>SIZE</th>
<th>Big-Endian</th>
<th>Little-Endian</th>
</tr>
</thead>
<tbody>
<tr>
<td>BYTE</td>
<td>b</td>
<td>1</td>
<td>[12]</td>
<td>[12]</td>
</tr>
<tr>
<td>WORD</td>
<td>w</td>
<td>2</td>
<td>[12][34]</td>
<td>[34][12]</td>
</tr>
<tr>
<td>DWORD</td>
<td>dw</td>
<td>3</td>
<td>[12][34][56][78]</td>
<td>[78][56][34][12]</td>
</tr>
<tr>
<td>char[]</td>
<td>str</td>
<td>4</td>
<td>[61][62][63][64][65][00]</td>
<td>[65][64][63][62][61][00]</td>
</tr>
</tbody>
</table>
</div>
<p><strong><code>main()</code> function</strong>:<br> <p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/3.1.png'><img src="/images/books/ReverseEngineeringCore/3.1.png" width="500">
</p></p>
<p><strong>Hexdump</strong>:</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/3.2.png'><img src="/images/books/ReverseEngineeringCore/3.2.png" width="500">
</p>

<h1 id="Chapter-4-IA-32-Registers"><a href="#Chapter-4-IA-32-Registers" class="headerlink" title="Chapter 4 - IA-32 Registers"></a>Chapter 4 - IA-32 Registers</h1><h2 id="4-2-IA-32-Registers"><a href="#4-2-IA-32-Registers" class="headerlink" title="4.2 - IA-32 Registers"></a>4.2 - IA-32 Registers</h2><ul>
<li>General Purpose Registers(32-bit), x8</li>
<li>Segment Registers(16-bit), x6</li>
<li>Program Status and Control Register(32-bit), x1</li>
<li>Instruction Pointer(32-bit), x1</li>
</ul>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/4.reg.1.png'><img src="/images/books/ReverseEngineeringCore/4.reg.1.png" width="400">
</p>

<ol>
<li><p>General Purpose Registers<br>These type of registers are used for temporary storage, also can be used for arthimetic calculation. Usually, they are used for storing addresses and constants.</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/4.reg.2.png'><img src="/images/books/ReverseEngineeringCore/4.reg.2.png" width="400">
</p>

<ul>
<li>EAX:</li>
<li>EBX:</li>
<li>ECX:</li>
<li>EDX:</li>
</ul>
</li>
<li><p>Segment Registers<br><strong>Segment</strong> is a protection technique in IA-32. The IA-32 architecture divides memory into multiple segments, and allocates start address, range, accessing privilege, etc to them. It also provides paging technique.</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/4.segmentation.png'><img src="/images/books/ReverseEngineeringCore/4.segmentation.png" width="400">
</p>

<ul>
<li>CS: Code Segment</li>
<li>SS: Stack Segment</li>
<li>DS: Data Segment</li>
<li>ES: Extra (Data) Segment</li>
<li>FS: Data Segment</li>
<li>GS: Data Segment</li>
</ul>
</li>
<li><p>Program Status and Control Register</p>
<ul>
<li><p>EFLAGS</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/4.4.png'><img src="/images/books/ReverseEngineeringCore/4.4.png" width="400">
</p>
</li>
</ul>
</li>
<li><p>Instruction Pointer</p>
<ul>
<li>EIP</li>
</ul>
</li>
</ol>
<h1 id="Chapter-5-Stack"><a href="#Chapter-5-Stack" class="headerlink" title="Chapter 5 - Stack"></a>Chapter 5 - Stack</h1><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/5.1.png'><img src="/images/books/ReverseEngineeringCore/5.1.png" width="400">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/5.2.png'><img src="/images/books/ReverseEngineeringCore/5.2.png" width="400">
</p>

<p>After the <code>PUSH</code> instruction is executed, <strong>ESP</strong> moves upward ,and its value decreases by 4 bytes.</p>
<p>After the <code>POP EAX</code> instruction is executed, <strong>ESP</strong> moves downward, and its value increases by 4 bytes.</p>
<p>Thus, we can conclude that:</p>
<blockquote>
<p>When data is pushed onto the stack, the value of the stack pointer decreases and it moves upward.\<br>When data is popped from the stack, the value of the stack pointer increases and it moves downward.</p>
</blockquote>
<p>Initially, the stack pointer points to the top of the stack.</p>
<h1 id="Chapter-6-Analyzing-abex’-crackme-1"><a href="#Chapter-6-Analyzing-abex’-crackme-1" class="headerlink" title="Chapter 6 - Analyzing abex’ crackme#1"></a>Chapter 6 - Analyzing abex’ crackme#1</h1><h2 id="Patching-Cracking"><a href="#Patching-Cracking" class="headerlink" title="Patching (Cracking)"></a>Patching (Cracking)</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/6.1.png'><img src="/images/books/ReverseEngineeringCore/6.1.png" width="400">
</p>

<p>Modify the assembly code:<br><strong>Original</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">JE SHORT 0040103D<br></code></pre></td></tr></table></figure><br><strong>Modified</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">JMP 0040103D<br></code></pre></td></tr></table></figure></p>
<h1 id="Chapter-7-Stack-Frame"><a href="#Chapter-7-Stack-Frame" class="headerlink" title="Chapter 7 - Stack Frame"></a>Chapter 7 - Stack Frame</h1><h2 id="7-1-Stack-Frame"><a href="#7-1-Stack-Frame" class="headerlink" title="7.1 - Stack Frame"></a>7.1 - Stack Frame</h2><p>A <strong>stack frame</strong> is a structure used to organize a function’s local variables, parameters, and return address.\<br>It is accessed using <strong>EBP</strong> as the base pointer (<strong>NOT ESP</strong>).</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/7.1.png'><img src="/images/books/ReverseEngineeringCore/7.1.png" width="400">
</p>

<div class="table-container">
<table>
<thead>
<tr>
<th>Assembly</th>
<th>C Language</th>
<th>Type conversion</th>
</tr>
</thead>
<tbody>
<tr>
<td>DWORD PTR SS:[EBP-4]</td>
<td>*(DWORD*)(EBP-4)</td>
<td>DWORD (4 bytes)</td>
</tr>
<tr>
<td>WORD PTR SS:[EBP-4]</td>
<td>*(WORD*)(EBP-4)</td>
<td>WORD (2 bytes)</td>
</tr>
<tr>
<td>BYTE PTR SS:[EBP-4]</td>
<td>*(BYTE*)(EBP-4)</td>
<td>BYTE</td>
</tr>
</tbody>
</table>
</div>
<p>The symbol <code>SS</code> in <code>DWORD PTR SS:\[EBP-4\]</code> stands for <strong>Stack Segment</strong>.<br>Although x86 architecture supports segmented memory, modern Windows uses a <strong>flat memory model</strong>. Therefore, assembly instructions still syntactically specify a segment register, such as <code>SS</code>, <code>DS</code>, or <code>ES</code>.</p>
<p>On 32-bit x86 Windows, these segment registers all refer to the same flat segment, which makes the explicit segment specification effectively meaningless in this context.</p>
<p>Since <strong>EBP</strong> and <strong>ESP</strong> are registers that reference the stack, OllyDbg automatically appends the <code>SS</code> segment prefix when displaying stack-based memory operands.</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/7.2.png'><img src="/images/books/ReverseEngineeringCore/7.2.png" width="400">
</p>

<h1 id="Chapter-8-abex’-crackme-2"><a href="#Chapter-8-abex’-crackme-2" class="headerlink" title="Chapter 8 - abex’ crackme#2"></a>Chapter 8 - abex’ crackme#2</h1><h2 id="8-2-VB-Engine"><a href="#8-2-VB-Engine" class="headerlink" title="8.2 - VB Engine"></a>8.2 - VB Engine</h2><p>abex’ crackme is written in VB (Visual Basic).</p>
<p>A VB (Visual Basic) application is executed by an engine named <strong>MSVBVM60.dll (Microsoft Visual Basic Virtual Machine 6.0)</strong>.</p>
<p>A VB application can be compiled into <strong>Native Code (N Code)</strong> or <strong>Pseudo Code (P Code, or The Thunder Runtime Engine)</strong>.</p>
<p>All components of a VB application—such as <strong>dialogs</strong>, <strong>controls</strong>, <strong>forms</strong>, <strong>modules</strong>, and <strong>functions</strong>—are stored in the form of internal data structures. However, Microsoft has never publicly documented these structures, which makes debugging VB applications more difficult.</p>
<h2 id="8-3-Debugging"><a href="#8-3-Debugging" class="headerlink" title="8.3 - Debugging"></a>8.3 - Debugging</h2><p><strong>Stub Code</strong>:</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.1.png'><img src="/images/books/ReverseEngineeringCore/8.1.png" width="400">
</p>

<h3 id="Indirect-Call"><a href="#Indirect-Call" class="headerlink" title="Indirect Call"></a>Indirect Call</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">00401232   $-FF25 A0104000  JMP DWORD PTR DS:[&lt;&amp;MSVBVM60.#100&gt;]      ;  MSVBVM60.ThunRTMain<br>00401238 &gt; $ 68 141E4000    PUSH abexcm2-.00401E14                   ;  =&gt; EP<br>0040123D   . E8 F0FFFFFF    CALL &lt;JMP.&amp;MSVBVM60.#100&gt;                ;  call ThunRTMain()<br></code></pre></td></tr></table></figure>
<p>The instruction at <code>0040123D</code> is used to call the <code>ThunRTMain()</code> function. Instead of calling the function directly, it performs an indirect call through the jump instruction at <code>00401232</code>.</p>
<p>This is a well-known <strong>indirect call</strong> technique commonly used by <strong>VC++</strong> and the <strong>VB compiler</strong>.</p>
<h3 id="RT-MainStruct"><a href="#RT-MainStruct" class="headerlink" title="RT_MainStruct"></a>RT_MainStruct</h3><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.2.png'><img src="/images/books/ReverseEngineeringCore/8.2.png" width="800">
</p>

<p>Microsoft has never publicly documented the <code>RT_MainStruct</code>. However, some experts have fully reverse-engineered it and published their findings online.</p>
<h3 id="ThunRTMain"><a href="#ThunRTMain" class="headerlink" title="ThunRTMain()"></a>ThunRTMain()</h3><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.3.png'><img src="/images/books/ReverseEngineeringCore/8.3.png" width="800">
</p>

<p>Notice that the memory addresses are completely different. This region is inside <code>MSVBVM60.dll</code></p>
<h2 id="8-4-Analyzing-crackme"><a href="#8-4-Analyzing-crackme" class="headerlink" title="8.4 - Analyzing crackme"></a>8.4 - Analyzing <strong>crackme</strong></h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.4.png'><img src="/images/books/ReverseEngineeringCore/8.4.png" width="500">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.3.png'><img src="/images/books/ReverseEngineeringCore/8.3.png" width="700">
</p>

<p><strong>Assembly code that it used:</strong></p>
<ul>
<li>TEST: Logical Compare, it is same as <code>AND</code>. However, <code>TEST</code> only changes the values in <code>EFLAGS</code> register.</li>
<li>JE: Jump if equal (ZF = 1).</li>
</ul>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.4.png'><img src="/images/books/ReverseEngineeringCore/8.4.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.5.png'><img src="/images/books/ReverseEngineeringCore/8.5.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.6.png'><img src="/images/books/ReverseEngineeringCore/8.6.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.7.png'><img src="/images/books/ReverseEngineeringCore/8.7.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.8.png'><img src="/images/books/ReverseEngineeringCore/8.8.png" width="700">
</p>

<h1 id="Chapter-9-Process-Explorer"><a href="#Chapter-9-Process-Explorer" class="headerlink" title="Chapter 9 - Process Explorer"></a>Chapter 9 - Process Explorer</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/sysinternals/downloads/process-explorer">https://learn.microsoft.com/en-us/sysinternals/downloads/process-explorer</a></p>
</blockquote>
<h1 id="Chapter-10-Calling-Convention"><a href="#Chapter-10-Calling-Convention" class="headerlink" title="Chapter 10 - Calling Convention"></a>Chapter 10 - Calling Convention</h1><ul>
<li>cdecl</li>
<li>stdcall</li>
<li>fastcall</li>
</ul>
<p><code>cdecl</code> is the default method used in C language.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &quot;stdio.h&quot;<br><br>int add(int a, int b)<br>&#123;<br>    return a + b;<br>&#125;<br><br>int main(int argc, char* argv[])<br>&#123;<br>    return add(1, 2);<br>&#125;<br></code></pre></td></tr></table></figure></p>
<h2 id="cdecl"><a href="#cdecl" class="headerlink" title="cdecl"></a>cdecl</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/10.1.png'><img src="/images/books/ReverseEngineeringCore/10.1.png" width="700">
</p>

<hr>
<p><code>stdcall</code> is commonly used in Win32 API, this is used for clearing the stack by the function <strong>caller</strong>.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &quot;stdio.h&quot;<br><br>int __stdcall add(int a, int b)<br>&#123;<br>    return a + b;<br>&#125;<br>int main(int argc, char* argv[])<br>&#123;<br>    return add(1, 2);<br>&#125;<br></code></pre></td></tr></table></figure></p>
<h2 id="stdcall"><a href="#stdcall" class="headerlink" title="stdcall"></a>stdcall</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/10.2.png'><img src="/images/books/ReverseEngineeringCore/10.2.png" width="700">
</p>

<h2 id="fastcall"><a href="#fastcall" class="headerlink" title="fastcall"></a>fastcall</h2><h1 id="Chapter-11-Lenas-Reversing-for-Newbies"><a href="#Chapter-11-Lenas-Reversing-for-Newbies" class="headerlink" title="Chapter 11 - Lenas Reversing for Newbies"></a>Chapter 11 - Lenas Reversing for Newbies</h1><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/11.1.png'><img src="/images/books/ReverseEngineeringCore/11.1.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/11.2.png'><img src="/images/books/ReverseEngineeringCore/11.2.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/11.3.png'><img src="/images/books/ReverseEngineeringCore/11.3.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/11.4.png'><img src="/images/books/ReverseEngineeringCore/11.4.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/11.5.png'><img src="/images/books/ReverseEngineeringCore/11.5.png" width="700">
</p>

<p>Modify the instruction at <code>00402FE</code></p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/11.6.png'><img src="/images/books/ReverseEngineeringCore/11.6.png" width="700">
</p>

<h1 id="Chapter-12-How-to-Learn-Reverse-Engineering"><a href="#Chapter-12-How-to-Learn-Reverse-Engineering" class="headerlink" title="Chapter 12 - How to Learn Reverse Engineering"></a>Chapter 12 - How to Learn Reverse Engineering</h1><p>Blah blah blah…</p>
<p>I will write some of the content with my personal idea in “Reflection”</p>
<h1 id="Chapter-13-PE-File-Format"><a href="#Chapter-13-PE-File-Format" class="headerlink" title="Chapter 13 - PE File Format"></a>Chapter 13 - PE File Format</h1><h2 id="13-2-PE-File-Format"><a href="#13-2-PE-File-Format" class="headerlink" title="13.2 - PE File Format"></a>13.2 - PE File Format</h2><p>PE stands for <strong>Portable Executable</strong>.</p>
<p>A PE file is an executable under x32 platform, it is also know as <strong>PE32</strong>. A PE+ (or PE32+) is an executable under x64 platform (<strong>NOT PE64</strong>).</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.1.png'><img src="/images/books/ReverseEngineeringCore/13.1.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.2.png'><img src="/images/books/ReverseEngineeringCore/13.2.png" width="300">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.3.png'><img src="/images/books/ReverseEngineeringCore/13.3.png" width="1000">
</p>


<h3 id="VA-amp-RVA"><a href="#VA-amp-RVA" class="headerlink" title="VA &amp; RVA"></a>VA &amp; RVA</h3><script type="math/tex; mode=display">
RAW + ImageBase = VA</script><h2 id="13-3-PE-Header"><a href="#13-3-PE-Header" class="headerlink" title="13.3 - PE Header"></a>13.3 - PE Header</h2><h3 id="DOS-Header"><a href="#DOS-Header" class="headerlink" title="DOS Header"></a>DOS Header</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_DOS_HEADER &#123;      // DOS .EXE header<br>    WORD   e_magic;                     // Magic number<br>    WORD   e_cblp;                      // Bytes on last page of file<br>    WORD   e_cp;                        // Pages in file<br>    WORD   e_crlc;                      // Relocations<br>    WORD   e_cparhdr;                   // Size of header in paragraphs<br>    WORD   e_minalloc;                  // Minimum extra paragraphs needed<br>    WORD   e_maxalloc;                  // Maximum extra paragraphs needed<br>    WORD   e_ss;                        // Initial (relative) SS value<br>    WORD   e_sp;                        // Initial SP value<br>    WORD   e_csum;                      // Checksum<br>    WORD   e_ip;                        // Initial IP value<br>    WORD   e_cs;                        // Initial (relative) CS value<br>    WORD   e_lfarlc;                    // File address of relocation table<br>    WORD   e_ovno;                      // Overlay number<br>    WORD   e_res[4];                    // Reserved words<br>    WORD   e_oemid;                     // OEM identifier (for e_oeminfo)<br>    WORD   e_oeminfo;                   // OEM information; e_oemid specific<br>    WORD   e_res2[10];                  // Reserved words<br>    LONG   e_lfanew;                    // File address of new exe header<br>  &#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;<br><br>//Source: Microsoft Platform SDK - winnt.h (https://github.com/wine-mirror/wine/blob/master/include/winnt.h)<br></code></pre></td></tr></table></figure>
<ul>
<li>e_magic: DOS signature, 4D5A =&gt; ASCII: MZ</li>
<li>e_lfanew: Offset of NT header.</li>
</ul>
<p>Here MZ stands for <strong>Mark Zbikowski</strong>, the engineer who designed DOS executable.</p>
<h3 id="DOS-Stub"><a href="#DOS-Stub" class="headerlink" title="DOS Stub"></a>DOS Stub</h3><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.4.png'><img src="/images/books/ReverseEngineeringCore/13.4.png" width="800">
</p>

<hr>
<p>Run the following command on Windows XP:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; debug C:\WINDOWS\NOTEPAD.exe<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.6.png'><img src="/images/books/ReverseEngineeringCore/13.6.png" width="800">
</p>

<p>Although the sentence in the DOS stub states that “This program cannot be run in DOS mode”, <code>notepad.exe</code> can still be executed in a DOS environment. In practice, the DOS loader executes the DOS stub code, which prints the message above and then exits.</p>
<p>The DOS stub is optional in a PE file, but modern development tools usually include it by default. Compilers such as VB, VC++, and Delphi all generate PE files with a DOS stub.</p>
<h3 id="NT-Header"><a href="#NT-Header" class="headerlink" title="NT Header"></a>NT Header</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_NT_HEADERS &#123;<br>    DWORD Signature;<br>    IMAGE_FILE_HEADER FileHeader;<br>    IMAGE_OPTIONAL_HEADER32 OptionalHeader;<br>&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;<br><br>//Source: Microsoft Platform SDK - winnt.h (https://github.com/wine-mirror/wine/blob/master/include/winnt.h)<br></code></pre></td></tr></table></figure>
<h3 id="NT-Header-File-Header"><a href="#NT-Header-File-Header" class="headerlink" title="NT Header: File Header"></a>NT Header: File Header</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_FILE_HEADER &#123;<br>    WORD    Machine;<br>    WORD    NumberOfSections;<br>    DWORD   TimeDateStamp;<br>    DWORD   PointerToSymbolTable;<br>    DWORD   NumberOfSymbols;<br>    WORD    SizeOfOptionalHeader;<br>    WORD    Characteristics;<br>&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;<br><br>//Source: Microsoft Platform SDK - winnt.h (https://github.com/wine-mirror/wine/blob/master/include/winnt.h)<br></code></pre></td></tr></table></figure>
<p>There are four important members; file cannot be executed if they are misconfigured.</p>
<ol>
<li>Machine:\<br>Every CPU architecture has its own machine ID.<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.5.png'><img src="/images/books/ReverseEngineeringCore/13.5.png" width="800">
</p></li>
<li>NumberOfSections:\<br>PE file stores code, data and resources in different sections, each with its own attributes. <strong>NumberOfSections</strong> indicates the total number of sections in the file. This value <strong>MUST BE GREATER THAN ZERO</strong>.\<br>In addition, an executable cannot be loaded if the number of sections does not match the actual section table.</li>
<li>SizeOfOptionalHeader:\<br>The last member of structure <strong>IMAGE_NT_HEADERS</strong> is <strong>IMAGE_OPTIONAL_HEADER32</strong>. <strong>SizeOfOptionalHeader</strong> indicates the size of the <strong>IMAGE_OPTIONAL_HEADER32</strong> structure.\<br>Although <strong>IMAGE_OPTIONAL_HEADER</strong> is defined as a C structure, the Windows PE loader must still rely on the value of <strong>SizeOfOptionalHeader</strong> to determine its actual size.\<br>In PE32+ files, <strong>IMAGE_OPTIONAL_HEADER64</strong> is used instead of <strong>IMAGE_OPTIONAL_HEADER32</strong>. Since these two structures have different sizes, <strong>SizeOfOptionalHeader</strong> must explicitly specify the correct size.</li>
<li><p>Characteristics:\<br>This field is used to describe the attributes of the file.</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.7.png'><img src="/images/books/ReverseEngineeringCore/13.7.png" width="700">
</p>

<p>This value might not contain the <code>0x0002</code> (IMAGE_FILE_EXECUTABLE_IMAGE) flags for the files such as <code>*.obj</code> and <code>*.dll</code>.</p>
</li>
</ol>
<h3 id="NT-Header-Optional-Header"><a href="#NT-Header-Optional-Header" class="headerlink" title="NT Header: Optional Header"></a>NT Header: Optional Header</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_DATA_DIRECTORY &#123;<br>    DWORD   VirtualAddress;<br>    DWORD   Size;<br>&#125; IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY;<br><br>#define IMAGE_NUMBEROF_DIRECTORY_ENTRIES    16<br><br>typedef struct _IMAGE_OPTIONAL_HEADER &#123;<br>    //<br>    // Standard fields.<br>    //<br><br>    WORD    Magic;<br>    BYTE    MajorLinkerVersion;<br>    BYTE    MinorLinkerVersion;<br>    DWORD   SizeOfCode;<br>    DWORD   SizeOfInitializedData;<br>    DWORD   SizeOfUninitializedData;<br>    DWORD   AddressOfEntryPoint;<br>    DWORD   BaseOfCode;<br>    DWORD   BaseOfData;<br><br>    //<br>    // NT additional fields.<br>    //<br><br>    DWORD   ImageBase;<br>    DWORD   SectionAlignment;<br>    DWORD   FileAlignment;<br>    WORD    MajorOperatingSystemVersion;<br>    WORD    MinorOperatingSystemVersion;<br>    WORD    MajorImageVersion;<br>    WORD    MinorImageVersion;<br>    WORD    MajorSubsystemVersion;<br>    WORD    MinorSubsystemVersion;<br>    DWORD   Win32VersionValue;<br>    DWORD   SizeOfImage;<br>    DWORD   SizeOfHeaders;<br>    DWORD   CheckSum;<br>    WORD    Subsystem;<br>    WORD    DllCharacteristics;<br>    DWORD   SizeOfStackReserve;<br>    DWORD   SizeOfStackCommit;<br>    DWORD   SizeOfHeapReserve;<br>    DWORD   SizeOfHeapCommit;<br>    DWORD   LoaderFlags;<br>    DWORD   NumberOfRvaAndSizes;<br>    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];<br>&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure>
<p>The following members are important. An executable cannot not be loaded if they are misconfigured.</p>
<ol>
<li>Magic:\<br><strong>IMAGE_OPTIONAL_HEADER32</strong> has this value by <code>10B</code>; <strong>IMAGE_OPTIONAL_HEADER64</strong> has this value by <code>20B</code>.</li>
<li>AddressOfEntry:\<br>This field has the RVA value of EP. RVA value indicates the code which is the first priority of executing.</li>
<li>ImageBase:\<br>The address range of virtual memory is 0~FFFFFFFF on x32 platform. <strong>ImageBase</strong> indicates first loaded address of the file.</li>
<li><p>SectionAlignment, FileAlignment:\</p>
</li>
<li><p>SizeOfImage</p>
</li>
<li>SizeOfHeaders</li>
<li>Subsystem</li>
<li>NumberOfRvaAndSizes</li>
<li>DataDirectory</li>
</ol>
<h3 id="Section-Header"><a href="#Section-Header" class="headerlink" title="Section Header"></a>Section Header</h3><h2 id="13-4-RVA-to-RAW"><a href="#13-4-RVA-to-RAW" class="headerlink" title="13.4 - RVA to RAW"></a>13.4 - RVA to RAW</h2><script type="math/tex; mode=display">
\begin{align*}
RAW - PointerToRawData &= RVA - VirtualAddress\\
RAW &= RVA - VirtualAddress + PointerToRawData
\end{align*}</script><h3 id="Quiz"><a href="#Quiz" class="headerlink" title="Quiz"></a>Quiz</h3><p>Given the following figure, answer the following questions:</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.8.png'><img src="/images/books/ReverseEngineeringCore/13.8.png" width="700">
</p>

<ol>
<li>RVA = 5000, File Offset = ?\<br>Here we assume the ImageBase is 01000000.<br>It is located in the first section (<code>.text</code>) since<script type="math/tex; mode=display">
 01000000 + 5000 = 01005000</script>The range of the first section (<code>.text</code>) is: 01001000 ~ 01009000.\<br>Thus,<script type="math/tex; mode=display">
 RAW = 5000(RVA) - 1000(VirtualAddress) + 400(PointerToRawData)=4400</script></li>
<li>RVA = 13314, File Offset = ?<br>RVA = 13314 is located in the third section (<code>.rsrc</code>).\<br>Thus,<script type="math/tex; mode=display">
 RAW= 13314(RVA) - B000(VA) + 8400(PointerToRawData) = 10714</script></li>
<li>RVA = ABA8, File Offset = ?<br>RVA = ABA8 is located in the second section (<code>.data</code>).\<script type="math/tex; mode=display">
 RAW = ABA8(RVA) - 9000(VA) + 7C00(PointerToRawData) = 97A8</script>However, RAW address 97A8 is located in the third section. Thus, the given value of RAW by ABA8 is invalid for defining its RAW value. When VirtualSize is larger than SizeOfRawData, the extra region is zero-initialized at load time and does not have a valid file offset.</li>
</ol>
<h2 id="13-5-IAT"><a href="#13-5-IAT" class="headerlink" title="13.5 - IAT"></a>13.5 - IAT</h2><h3 id="DLL"><a href="#DLL" class="headerlink" title="DLL"></a>DLL</h3><p>Before studying the Import Address Table (IAT), we need to understand <strong>DLLs (Dynamic Link Libraries)</strong>.</p>
<p>In the era of 16-bit DOS, the concept of DLLs did not exist. Instead, applications relied on <strong>static libraries</strong>, which were linked into the executable at compile time. This approach significantly increased both memory usage and disk space consumption, which was a serious limitation when hardware resources were expensive.</p>
<p>To solve this problem, Windows introduced the concept of DLLs:</p>
<ul>
<li>Instead of embedding library code into the executable, applications import DLLs when needed.</li>
<li>Code and resources can be shared among multiple applications through memory mapping.</li>
<li>Updating a library only requires replacing the corresponding DLL file.</li>
</ul>
<p>There are two primary ways to load DLLs:</p>
<p><strong>Explicit Linking</strong>:<br>The application loads the DLL at runtime using functions such as <code>LoadLibrary</code>, and resolves function addresses manually using <code>GetProcAddress</code>. The DLL can be unloaded explicitly when it is no longer needed.</p>
<p><strong>Implicit Linking</strong>:<br>The DLL is loaded automatically by the Windows loader when the application starts, and it remains loaded until the process terminates.</p>
<p>These mechanisms are closely related to the Import Address Table (IAT), which plays a critical role during DLL loading and function resolution.</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.9.png'><img src="/images/books/ReverseEngineeringCore/13.9.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.10.png'><img src="/images/books/ReverseEngineeringCore/13.10.png" width="700">
</p>

<p>Notice that the loader calls the API function CreateFileW() via an indirect call rather than a direct call.<br>The loader obtains the address of the API function from memory address 0x01001104.<br>The loader calls API functions using this method consistently.</p>
<p>The reason the loader does not call the API function directly (for example, using the instruction <code>CALL 765233B0</code>) is that the author of notepad.exe did not know in advance which platform the program would run on.<br>This design allows the executable to support multiple platforms and environments.</p>
<p>Another reason is DLL relocation.<br>Usually, the default ImageBase of a DLL is 0x10000000.<br>If this address is already occupied by a.dll, then b.dll cannot be loaded at the same ImageBase and must be relocated, for example, to 0x3E000000.</p>
<p>In practice, it cannot be guaranteed that a DLL can be loaded at its preferred ImageBase, because the PE header uses RVAs instead of absolute virtual addresses (VAs).<br>In contrast, an executable can usually be loaded at its specified ImageBase because it has its own virtual address space.</p>
<h3 id="IMAGE-IMPORT-DESCRIPTOR"><a href="#IMAGE-IMPORT-DESCRIPTOR" class="headerlink" title="IMAGE_IMPORT_DESCRIPTOR"></a>IMAGE_IMPORT_DESCRIPTOR</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_IMPORT_DESCRIPTOR &#123;<br>	union &#123;<br>		DWORD	Characteristics; /* 0 for terminating null import descriptor  */<br>		DWORD	OriginalFirstThunk;	/* RVA to original unbound IAT */<br>	&#125; DUMMYUNIONNAME;<br>	DWORD	TimeDateStamp;	/* 0 if not bound,<br>				 * -1 if bound, and real date\time stamp<br>				 *    in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT<br>				 * (new BIND)<br>				 * otherwise date/time stamp of DLL bound to<br>				 * (Old BIND)<br>				 */<br>	DWORD	ForwarderChain;	/* -1 if no forwarders */<br>	DWORD	Name;<br>	/* RVA to IAT (if bound this IAT has actual addresses) */<br>	DWORD	FirstThunk;<br>&#125; IMAGE_IMPORT_DESCRIPTOR,*PIMAGE_IMPORT_DESCRIPTOR;<br><br>/* Import name entry */<br>typedef struct _IMAGE_IMPORT_BY_NAME &#123;<br>	WORD	Hint;<br>	char	Name[1];<br>&#125; IMAGE_IMPORT_BY_NAME,*PIMAGE_IMPORT_BY_NAME;<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure>
<p>The number of imported libraries is equal to the number of <code>IMAGE_IMPORT_DESCRIPTOR</code></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Field</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>OriginalFirstThunk</td>
<td>Address of INT (RVA)</td>
</tr>
<tr>
<td>Name</td>
<td>Address of library string name (RVA)</td>
</tr>
<tr>
<td>FirstThunk</td>
<td>Address of IAT (RVA)</td>
</tr>
</tbody>
</table>
</div>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.11.png'><img src="/images/books/ReverseEngineeringCore/13.11.png" width="600">
</p>

<h3 id="Load-into-IAT"><a href="#Load-into-IAT" class="headerlink" title="Load into IAT"></a>Load into IAT</h3><ol>
<li>Obtain the name of the library (for example: “kernel32.dll”) from IID (“IMAGE_IMPORT_DESCRIPTOR”)</li>
<li><code>LoadLibrary(&quot;kernel32.dll)</code></li>
<li>Read <strong>OriginalFirstThunk</strong> member from IID, and then obtain the addressof INT (Import Name Table).</li>
<li>Read the values from the array in INT consecutively. Subsequently, obtain the RVA (Relative Virtual Address) of <strong>IMAGE_IMPORT_BY_NAME</strong>.</li>
</ol>
<h3 id="Practice"><a href="#Practice" class="headerlink" title="Practice"></a>Practice</h3><p>Where is <strong>IMAGE_IMPORT_DESCRIPTOR</strong>? It is not located in PE header. Instead, it locates in PE body, but its location is stored in PE header.</p>
<p>The value of <code>IMAGE_OPTIONAL_HEADER32.DataDirectory[1].VirtualAddress</code> is the <strong>AddressOfEntryPoint</strong> (RVA value). <strong>IMAGE_IMPORT_DESCRIPTOR</strong> is also know as <strong>IMAGE_DIRECTORY_TABLE</strong>.</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.12.png'><img src="/images/books/ReverseEngineeringCore/13.12.png" width="600">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.13.png'><img src="/images/books/ReverseEngineeringCore/13.13.png" width="600">
</p>

<ol>
<li>Name (Library Name) <p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.14.png'><img src="/images/books/ReverseEngineeringCore/13.14.png" width="800">
 </p></li>
<li>OriginalFirstThunk——INT</li>
<li>IMAGE_IMPORT_BY_NAME</li>
<li>FirstThunk——IAT (Import Address Table)</li>
</ol>
<h2 id="13-6-EAT"><a href="#13-6-EAT" class="headerlink" title="13.6 - EAT"></a>13.6 - EAT</h2><p>The value of <code>IMAGE_OPTIONAL_HEADER32.DataDirectory[0]</code>.VirtualAddress is the RVA value of <code>IMAGE_EXPORT_DIRECTORY</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_EXPORT_DIRECTORY &#123;<br>	DWORD	Characteristics;<br>	DWORD	TimeDateStamp;          //creation time date stamp<br>	WORD	MajorVersion;<br>	WORD	MinorVersion;<br>	DWORD	Name;                   //address of library file name<br>	DWORD	Base;                   //ordinal base<br>	DWORD	NumberOfFunctions;      //number of functions<br>	DWORD	NumberOfNames;          //number of names<br>	DWORD	AddressOfFunctions;     //address of function start address array<br>	DWORD	AddressOfNames;         //address of function name string array<br>	DWORD	AddressOfNameOrdinals;  //address of ordinal array<br>&#125; IMAGE_EXPORT_DIRECTORY,*PIMAGE_EXPORT_DIRECTORY;<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure>
<p><strong>Important fields:</strong><br>| Field | Meaning |<br>| —- | —- |<br>| NumberOfFunctions | The total number of exported functions<br>| NumberOfNames |<br>| AddressOfFunctions |<br>| AddressOfNames |<br>| AddressOfNameOrdinals |</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.15.png'><img src="/images/books/ReverseEngineeringCore/13.15.png" width="600">
    <figcaption>
    Source: https://baebenzene.tistory.com/5
    </figcaption>
</p>

<p>A PE file obtains the function address from libraries via an API——<code>GetProcAddress()</code></p>
<h1 id="Chapter-16-Base-Relocation-Table"><a href="#Chapter-16-Base-Relocation-Table" class="headerlink" title="Chapter 16 - Base Relocation Table"></a>Chapter 16 - Base Relocation Table</h1><h2 id="16-1-PE-Relocation"><a href="#16-1-PE-Relocation" class="headerlink" title="16.1 - PE Relocation"></a>16.1 - PE Relocation</h2><p>Microsoft introduced <strong>ASLR</strong> technique since Windows Vista. This technique can improve security of Windows systems.</p>
<h2 id="16-2-The-Operations-of-PE-Relocation"><a href="#16-2-The-Operations-of-PE-Relocation" class="headerlink" title="16.2 - The Operations of PE Relocation"></a>16.2 - The Operations of PE Relocation</h2><h2 id="16-3-The-Principles-of-PE-Relocation"><a href="#16-3-The-Principles-of-PE-Relocation" class="headerlink" title="16.3 - The Principles of PE Relocation"></a>16.3 - The Principles of PE Relocation</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_BASE_RELOCATION<br>&#123;<br>	DWORD	VirtualAddress;<br>	DWORD	SizeOfBlock;<br>	/* WORD	TypeOffset[1]; */<br>&#125; IMAGE_BASE_RELOCATION,*PIMAGE_BASE_RELOCATION;<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/16.1.png'><img src="/images/books/ReverseEngineeringCore/16.1.png" width="600">
</p>


<h1 id="Chapter-17-Remove-reloc-Section-from-Executable"><a href="#Chapter-17-Remove-reloc-Section-from-Executable" class="headerlink" title="Chapter 17 - Remove .reloc Section from Executable"></a>Chapter 17 - Remove <code>.reloc</code> Section from Executable</h1><h1 id="Chapter-18-Analyzing-UPackPE-Header"><a href="#Chapter-18-Analyzing-UPackPE-Header" class="headerlink" title="Chapter 18 - Analyzing UPackPE Header"></a>Chapter 18 - Analyzing UPackPE Header</h1><h1 id="Chapter-19-UPackPE-Debugging-Find-the-OEP"><a href="#Chapter-19-UPackPE-Debugging-Find-the-OEP" class="headerlink" title="Chapter 19 - UPackPE Debugging - Find the OEP"></a>Chapter 19 - UPackPE Debugging - Find the OEP</h1><h1 id="Chapter-20-Patching"><a href="#Chapter-20-Patching" class="headerlink" title="Chapter 20 - Patching"></a>Chapter 20 - Patching</h1><h1 id="Chapter-21-Windows-Message-Hooking"><a href="#Chapter-21-Windows-Message-Hooking" class="headerlink" title="Chapter 21 - Windows Message Hooking"></a>Chapter 21 - Windows Message Hooking</h1><h2 id="21-2-Message-Hooking"><a href="#21-2-Message-Hooking" class="headerlink" title="21.2 - Message Hooking"></a>21.2 - Message Hooking</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/21.1.png'><img src="/images/books/ReverseEngineeringCore/21.1.png" width="600">
</p>


<h2 id="21-3-SetWindowsHookEx"><a href="#21-3-SetWindowsHookEx" class="headerlink" title="21.3 - SetWindowsHookEx()"></a>21.3 - <code>SetWindowsHookEx()</code></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">HHOOK SetWindowsHookExW(<br>  [in] int       idHook,<br>  [in] HOOKPROC  lpfn,<br>  [in] HINSTANCE hmod,<br>  [in] DWORD     dwThreadId<br>);<br></code></pre></td></tr></table></figure>
<h2 id="21-4-Code"><a href="#21-4-Code" class="headerlink" title="21.4 - Code"></a>21.4 - Code</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//Source: https://github.com/reversecore/book<br>//HookMain.cpp<br><br>#include &quot;stdio.h&quot;<br>#include &quot;conio.h&quot;<br>#include &quot;windows.h&quot;<br><br>#define	DEF_DLL_NAME		&quot;KeyHook.dll&quot;<br>#define	DEF_HOOKSTART		&quot;HookStart&quot;<br>#define	DEF_HOOKSTOP		&quot;HookStop&quot;<br><br>typedef void (*PFN_HOOKSTART)();<br>typedef void (*PFN_HOOKSTOP)();<br><br>void main()<br>&#123;<br>	HMODULE			hDll = NULL;<br>	PFN_HOOKSTART	HookStart = NULL;<br>	PFN_HOOKSTOP	HookStop = NULL;<br>	char			ch = 0;<br><br>    //Load KeyHook.dll<br>	hDll = LoadLibraryA(DEF_DLL_NAME);<br>    if( hDll == NULL )<br>    &#123;<br>        printf(&quot;LoadLibrary(%s) failed!!! [%d]&quot;, DEF_DLL_NAME, GetLastError());<br>        return;<br>    &#125;<br><br>    //Obtain the export functions&#x27; addresses.<br>	HookStart = (PFN_HOOKSTART)GetProcAddress(hDll, DEF_HOOKSTART);<br>	HookStop = (PFN_HOOKSTOP)GetProcAddress(hDll, DEF_HOOKSTOP);<br><br>    //Start hooking.<br>	HookStart();<br><br>    //Wait until user enters &#x27;q&#x27;<br>	printf(&quot;press &#x27;q&#x27; to quit!\n&quot;);<br>	while( _getch() != &#x27;q&#x27; )	;<br><br>    //Stop hooking.<br>	HookStop();<br>	<br>    //Unload KeyHook.dll<br>	FreeLibrary(hDll);<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//KeyHook.cpp<br><br>#include &quot;stdio.h&quot;<br>#include &quot;windows.h&quot;<br><br>#define DEF_PROCESS_NAME		&quot;notepad.exe&quot;<br><br>HINSTANCE g_hInstance = NULL;<br>HHOOK g_hHook = NULL;<br>HWND g_hWnd = NULL;<br><br>BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD dwReason, LPVOID lpvReserved)<br>&#123;<br>	switch( dwReason )<br>	&#123;<br>        case DLL_PROCESS_ATTACH:<br>			g_hInstance = hinstDLL;<br>			break;<br><br>        case DLL_PROCESS_DETACH:<br>			break;	<br>	&#125;<br><br>	return TRUE;<br>&#125;<br><br>LRESULT CALLBACK KeyboardProc(int nCode, WPARAM wParam, LPARAM lParam)<br>&#123;<br>	char szPath[MAX_PATH] = &#123;0,&#125;;<br>	char *p = NULL;<br><br>	if( nCode &gt;= 0 )<br>	&#123;<br>		// bit 31 : 0 =&gt; press, 1 =&gt; release<br>		if( !(lParam &amp; 0x80000000) )<br>		&#123;<br>			GetModuleFileNameA(NULL, szPath, MAX_PATH);<br>			p = strrchr(szPath, &#x27;\\&#x27;);<br><br>            //Compare to current process. Message will not be passed to the next hook if the current process is notepad.exe.<br>            if( !_stricmp(p + 1, DEF_PROCESS_NAME) )<br>				return 1;<br>		&#125;<br>	&#125;<br><br>    //If it is not notepad.exe, then the message will be passed to the next hook via calling CallNextHookEx()<br>	return CallNextHookEx(g_hHook, nCode, wParam, lParam);<br>&#125;<br><br>//Export functions.<br>#ifdef __cplusplus<br>extern &quot;C&quot; &#123;<br>#endif<br>	__declspec(dllexport) void HookStart()<br>	&#123;<br>		g_hHook = SetWindowsHookEx(WH_KEYBOARD, KeyboardProc, g_hInstance, 0);<br>	&#125;<br><br>	__declspec(dllexport) void HookStop()<br>	&#123;<br>		if( g_hHook )<br>		&#123;<br>			UnhookWindowsHookEx(g_hHook);<br>			g_hHook = NULL;<br>		&#125;<br>	&#125;<br>#ifdef __cplusplus<br>&#125;<br>#endif<br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">LRRESULT CALLBACK KeyboardProc(<br>    int code,       //HC_ACTION(0), HC_NOREMOVE(3)<br>    WPARAM wParam,  //virtual-key code<br>    LPARAM lParam   //extra information<br>);<br></code></pre></td></tr></table></figure>
<h1 id="Chapter-23-DLL-Injection"><a href="#Chapter-23-DLL-Injection" class="headerlink" title="Chapter 23 - DLL Injection"></a>Chapter 23 - DLL Injection</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD dwReason, LPVOID lpvReserved)<br>&#123;<br>    switch(dwReason)<br>    &#123;<br>        case DLL_PROCESS_ATTACH:<br><br>        break;<br><br>        case DLL_THREAD_ATTACH:<br>        break;<br><br>        case DLL_THREAD_DETACH:<br>        break;<br><br>        case DLL_PROCESS_DETACH:<br>        break;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="23-1-Implementation-of-DLL-Injection"><a href="#23-1-Implementation-of-DLL-Injection" class="headerlink" title="23.1 - Implementation of DLL Injection"></a>23.1 - Implementation of DLL Injection</h2><p>Usually, there are three methods to implement DLL injection:</p>
<ul>
<li>Create remote thread via <code>CreateRemoteThread()</code> API</li>
<li>Using registry with modifying the value of AppInit_DLLs</li>
<li>SetWindowsHookEx() API</li>
</ul>
<h3 id="CreateRemoteThread"><a href="#CreateRemoteThread" class="headerlink" title="CreateRemoteThread()"></a>CreateRemoteThread()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//myhack.cpp<br><br>#include &quot;windows.h&quot;<br>#include &quot;tchar.h&quot;<br><br>#pragma comment(lib, &quot;urlmon.lib&quot;)<br><br>#define DEF_URL     	(L&quot;http://www.naver.com/index.html&quot;)<br>#define DEF_FILE_NAME   (L&quot;index.html&quot;)<br><br>HMODULE g_hMod = NULL;<br><br>DWORD WINAPI ThreadProc(LPVOID lParam)<br>&#123;<br>    TCHAR szPath[_MAX_PATH] = &#123;0,&#125;;<br><br>    if( !GetModuleFileName( g_hMod, szPath, MAX_PATH ) )<br>        return FALSE;<br>	<br>    TCHAR *p = _tcsrchr( szPath, &#x27;\\&#x27; );<br>    if( !p )<br>        return FALSE;<br><br>    _tcscpy_s(p+1, _MAX_PATH, DEF_FILE_NAME);<br><br>    URLDownloadToFile(NULL, DEF_URL, szPath, 0, NULL);<br><br>    return 0;<br>&#125;<br><br>BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)<br>&#123;<br>    HANDLE hThread = NULL;<br><br>    g_hMod = (HMODULE)hinstDLL;<br><br>    switch( fdwReason )<br>    &#123;<br>    case DLL_PROCESS_ATTACH : <br>        OutputDebugString(L&quot;&lt;myhack.dll&gt; Injection!!!&quot;);<br>        hThread = CreateThread(NULL, 0, ThreadProc, NULL, 0, NULL);<br>        CloseHandle(hThread);<br>        break;<br>    &#125;<br><br>    return TRUE;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>Once the DLL is loaded, it prints <code>&quot;myhack.dll Injection!!!&quot;</code>. It then calls the function by creating a thread (<code>ThreadProc</code>).</p>
<p><code>ThreadProc</code> downloads the specified HTML document with the API <code>urlmon!URLDownloadToFile()</code> and saves it as <code>index.html</code>.</p>
<p>Notice that once the DLL file is loaded, <code>DllMain</code> will be called automatically. Hence, once the DLL file above is loaded, the function <code>ThreadProc()</code> will eventually be executed.</p>
<hr>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//InjectDll.cpp<br><br>#include &quot;windows.h&quot;<br>#include &quot;tchar.h&quot;<br><br>BOOL SetPrivilege(LPCTSTR lpszPrivilege, BOOL bEnablePrivilege) <br>&#123;<br>    TOKEN_PRIVILEGES tp;<br>    HANDLE hToken;<br>    LUID luid;<br><br>    if( !OpenProcessToken(GetCurrentProcess(),<br>                          TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, <br>			              &amp;hToken) )<br>    &#123;<br>        _tprintf(L&quot;OpenProcessToken error: %u\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    if( !LookupPrivilegeValue(NULL,           // lookup privilege on local system<br>                              lpszPrivilege,  // privilege to lookup <br>                              &amp;luid) )        // receives LUID of privilege<br>    &#123;<br>        _tprintf(L&quot;LookupPrivilegeValue error: %u\n&quot;, GetLastError() ); <br>        return FALSE; <br>    &#125;<br><br>    tp.PrivilegeCount = 1;<br>    tp.Privileges[0].Luid = luid;<br>    if( bEnablePrivilege )<br>        tp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;<br>    else<br>        tp.Privileges[0].Attributes = 0;<br><br>    // Enable the privilege or disable all privileges.<br>    if( !AdjustTokenPrivileges(hToken, <br>                               FALSE, <br>                               &amp;tp, <br>                               sizeof(TOKEN_PRIVILEGES), <br>                               (PTOKEN_PRIVILEGES) NULL, <br>                               (PDWORD) NULL) )<br>    &#123; <br>        _tprintf(L&quot;AdjustTokenPrivileges error: %u\n&quot;, GetLastError() ); <br>        return FALSE; <br>    &#125; <br><br>    if( GetLastError() == ERROR_NOT_ALL_ASSIGNED )<br>    &#123;<br>        _tprintf(L&quot;The token does not have the specified privilege. \n&quot;);<br>        return FALSE;<br>    &#125; <br><br>    return TRUE;<br>&#125;<br><br>BOOL InjectDll(DWORD dwPID, LPCTSTR szDllPath)<br>&#123;<br>    HANDLE hProcess = NULL, hThread = NULL;<br>    HMODULE hMod = NULL;<br>    LPVOID pRemoteBuf = NULL;<br>    DWORD dwBufSize = (DWORD)(_tcslen(szDllPath) + 1) * sizeof(TCHAR);<br>    LPTHREAD_START_ROUTINE pThreadProc;<br><br>    // #1. Obtain the Handle of notepad.exe via dwPID.<br>    if ( !(hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPID)) )<br>    &#123;<br>        _tprintf(L&quot;OpenProcess(%d) failed!!! [%d]\n&quot;, dwPID, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    // #2. Allocate virtual memory in the address space of notepad.exe.<br>    //     The size of the allocated memory is based on szDllPath.The size virtual memory space is the size of szDllName<br>    pRemoteBuf = VirtualAllocEx(hProcess, NULL, dwBufSize, MEM_COMMIT, PAGE_READWRITE);<br><br>    // #3. Write the path of myhack.dll (szDllName) into the allocated memory space.<br>    WriteProcessMemory(hProcess, pRemoteBuf, (LPVOID)szDllPath, dwBufSize, NULL);<br><br>    // #4. Obtain the address of LoadLibraryA() API.<br>    hMod = GetModuleHandle(L&quot;kernel32.dll&quot;);<br>    pThreadProc = (LPTHREAD_START_ROUTINE)GetProcAddress(hMod, &quot;LoadLibraryW&quot;);<br>	<br>    // #5. Create a remote thread in notepad.exe.<br>    hThread = CreateRemoteThread(hProcess, NULL, 0, pThreadProc, pRemoteBuf, 0, NULL);<br>    WaitForSingleObject(hThread, INFINITE);	<br><br>    CloseHandle(hThread);<br>    CloseHandle(hProcess);<br><br>    return TRUE;<br>&#125;<br><br>int _tmain(int argc, TCHAR *argv[])<br>&#123;<br>    if( argc != 3)<br>    &#123;<br>        _tprintf(L&quot;USAGE : %s &lt;pid&gt; &lt;dll_path&gt;\n&quot;, argv[0]);<br>        return 1;<br>    &#125;<br><br>    // change privilege<br>    if( !SetPrivilege(SE_DEBUG_NAME, TRUE) )<br>        return 1;<br><br>    // inject dll<br>    if( InjectDll((DWORD)_tstol(argv[1]), argv[2]) )<br>        _tprintf(L&quot;InjectDll(\&quot;%s\&quot;) success!!!\n&quot;, argv[2]);<br>    else<br>        _tprintf(L&quot;InjectDll(\&quot;%s\&quot;) failed!!!\n&quot;, argv[2]);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>CreateRemoteThread is used to create a thread in a remote process.<br>In DLL injection, it is commonly used to make the remote process call LoadLibraryW() so that the DLL is loaded into that process.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">HANDLE CreateRemoteThread(<br>  [in]  HANDLE                 hProcess,<br>  [in]  LPSECURITY_ATTRIBUTES  lpThreadAttributes,<br>  [in]  SIZE_T                 dwStackSize,<br>  [in]  LPTHREAD_START_ROUTINE lpStartAddress,<br>  [in]  LPVOID                 lpParameter,<br>  [in]  DWORD                  dwCreationFlags,<br>  [out] LPDWORD                lpThreadId<br>);<br></code></pre></td></tr></table></figure>
<h3 id="AppInit-DLLs"><a href="#AppInit-DLLs" class="headerlink" title="AppInit_DLLs"></a>AppInit_DLLs</h3><p>The principle of this method is that <strong>user32.dll</strong> automatically loads the DLLs specified in the AppInit_DLLs registry value whenever user32.dll is loaded into a process.</p>
<p>To enable this feature, you need to set <strong>LoadAppInit_DLLs</strong> to 1 and restart the system.</p>
<blockquote>
<p>Warning: This method is powerful because it allows a DLL to be loaded into all processes that load user32.dll. You must be careful with your DLL code; otherwise, your system may become unstable.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">// myhack2.cpp<br><br>#include &quot;windows.h&quot;<br>#include &quot;tchar.h&quot;<br><br>#define DEF_CMD  L&quot;c:\\Program Files\\Internet Explorer\\iexplore.exe&quot; <br>#define DEF_ADDR L&quot;http://www.naver.com&quot;<br>#define DEF_DST_PROC L&quot;notepad.exe&quot;<br><br>BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)<br>&#123;<br>    TCHAR szCmd[MAX_PATH]  = &#123;0,&#125;;<br>    TCHAR szPath[MAX_PATH] = &#123;0,&#125;;<br>    TCHAR *p = NULL;<br>    STARTUPINFO si = &#123;0,&#125;;<br>    PROCESS_INFORMATION pi = &#123;0,&#125;;<br><br>    si.cb = sizeof(STARTUPINFO);<br>    si.dwFlags = STARTF_USESHOWWINDOW;<br>    si.wShowWindow = SW_HIDE;<br><br>    switch( fdwReason )<br>    &#123;<br>    case DLL_PROCESS_ATTACH : <br>        if( !GetModuleFileName( NULL, szPath, MAX_PATH ) )<br>            break;<br>   <br>        if( !(p = _tcsrchr(szPath, &#x27;\\&#x27;)) )<br>            break;<br><br>        if( _tcsicmp(p+1, DEF_DST_PROC) )<br>            break;<br><br>        wsprintf(szCmd, L&quot;%s %s&quot;, DEF_CMD, DEF_ADDR);<br>        if( !CreateProcess(NULL, (LPTSTR)(LPCTSTR)szCmd, <br>                            NULL, NULL, FALSE, <br>                            NORMAL_PRIORITY_CLASS, <br>                            NULL, NULL, &amp;si, &amp;pi) )<br>            break;<br><br>        if( pi.hProcess != NULL )<br>            CloseHandle(pi.hProcess);<br><br>        break;<br>    &#125;<br>   <br>    return TRUE;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows<br></code></pre></td></tr></table></figure>
<h3 id="SetWindowsHookEx"><a href="#SetWindowsHookEx" class="headerlink" title="SetWindowsHookEx()"></a>SetWindowsHookEx()</h3><h1 id="Chapter-24-DLL-Ejection"><a href="#Chapter-24-DLL-Ejection" class="headerlink" title="Chapter 24 - DLL Ejection"></a>Chapter 24 - DLL Ejection</h1><p>This technique is similar to DLL injection. Instead of using <code>LoadLibrary()</code> to load a DLL, we use <code>FreeLibrary()</code> to unload a DLL via <code>CreateRemoteThread()</code>.</p>
<p>Every Windows kernel object has a <strong>reference count</strong>, which indicates how many references to the object currently exist. For example, the reference count of <code>a.dll</code> becomes 10 if <code>LoadLibrary(&quot;a.dll&quot;)</code> is called 10 times. Accordingly, <code>FreeLibrary()</code> must be called 10 times to fully unload <code>a.dll</code>.</p>
<p>The reference count is decreased by 1 whenever <code>FreeLibrary()</code> is called. Therefore, we need to pay attention to the value of the <strong>reference count</strong>.</p>
<h1 id="Chapter-25-Load-DLL-File-by-Modifying-the-PE-File"><a href="#Chapter-25-Load-DLL-File-by-Modifying-the-PE-File" class="headerlink" title="Chapter 25 - Load DLL File by Modifying the PE File"></a>Chapter 25 - Load DLL File by Modifying the PE File</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">// EjectDll.exe<br><br>#include &quot;windows.h&quot;<br>#include &quot;tlhelp32.h&quot;<br>#include &quot;tchar.h&quot;<br><br>#define DEF_PROC_NAME	(L&quot;notepad.exe&quot;)<br>#define DEF_DLL_NAME	(L&quot;myhack.dll&quot;)<br><br>DWORD FindProcessID(LPCTSTR szProcessName)<br>&#123;<br>    DWORD dwPID = 0xFFFFFFFF;<br>    HANDLE hSnapShot = INVALID_HANDLE_VALUE;<br>    PROCESSENTRY32 pe;<br><br>    // Get the snapshot of the system<br>    pe.dwSize = sizeof( PROCESSENTRY32 );<br>    hSnapShot = CreateToolhelp32Snapshot( TH32CS_SNAPALL, NULL );<br><br>    // find process<br>    Process32First(hSnapShot, &amp;pe);<br>    do<br>    &#123;<br>        if(!_tcsicmp(szProcessName, (LPCTSTR)pe.szExeFile))<br>        &#123;<br>            dwPID = pe.th32ProcessID;<br>            break;<br>        &#125;<br>    &#125;<br>    while(Process32Next(hSnapShot, &amp;pe));<br><br>    CloseHandle(hSnapShot);<br><br>    return dwPID;<br>&#125;<br><br>BOOL SetPrivilege(LPCTSTR lpszPrivilege, BOOL bEnablePrivilege) <br>&#123;<br>    TOKEN_PRIVILEGES tp;<br>    HANDLE hToken;<br>    LUID luid;<br><br>    if( !OpenProcessToken(GetCurrentProcess(),<br>                          TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, <br>			              &amp;hToken) )<br>    &#123;<br>        _tprintf(L&quot;OpenProcessToken error: %u\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    if( !LookupPrivilegeValue(NULL,           // lookup privilege on local system<br>                              lpszPrivilege,  // privilege to lookup <br>                              &amp;luid) )        // receives LUID of privilege<br>    &#123;<br>        _tprintf(L&quot;LookupPrivilegeValue error: %u\n&quot;, GetLastError() ); <br>        return FALSE; <br>    &#125;<br><br>    tp.PrivilegeCount = 1;<br>    tp.Privileges[0].Luid = luid;<br>    if( bEnablePrivilege )<br>        tp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;<br>    else<br>        tp.Privileges[0].Attributes = 0;<br><br>    // Enable the privilege or disable all privileges.<br>    if( !AdjustTokenPrivileges(hToken, <br>                               FALSE, <br>                               &amp;tp, <br>                               sizeof(TOKEN_PRIVILEGES), <br>                               (PTOKEN_PRIVILEGES) NULL, <br>                               (PDWORD) NULL) )<br>    &#123; <br>        _tprintf(L&quot;AdjustTokenPrivileges error: %u\n&quot;, GetLastError() ); <br>        return FALSE; <br>    &#125; <br><br>    if( GetLastError() == ERROR_NOT_ALL_ASSIGNED )<br>    &#123;<br>        _tprintf(L&quot;The token does not have the specified privilege. \n&quot;);<br>        return FALSE;<br>    &#125; <br><br>    return TRUE;<br>&#125;<br><br>BOOL EjectDll(DWORD dwPID, LPCTSTR szDllName)<br>&#123;<br>    BOOL bMore = FALSE, bFound = FALSE;<br>    HANDLE hSnapshot, hProcess, hThread;<br>    HMODULE hModule = NULL;<br>    MODULEENTRY32 me = &#123; sizeof(me) &#125;;<br>    LPTHREAD_START_ROUTINE pThreadProc;<br><br>    // dwPID = notepad 프로세스 ID<br>    // TH32CS_SNAPMODULE 파라미터를 이용해서 notepad 프로세스에 로딩된 DLL 이름을 얻음<br>    hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPMODULE, dwPID);<br><br>    bMore = Module32First(hSnapshot, &amp;me);<br>    for( ; bMore ; bMore = Module32Next(hSnapshot, &amp;me) )<br>    &#123;<br>        if( !_tcsicmp((LPCTSTR)me.szModule, szDllName) || <br>            !_tcsicmp((LPCTSTR)me.szExePath, szDllName) )<br>        &#123;<br>            bFound = TRUE;<br>            break;<br>        &#125;<br>    &#125;<br><br>    if( !bFound )<br>    &#123;<br>        CloseHandle(hSnapshot);<br>        return FALSE;<br>    &#125;<br><br>    if ( !(hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPID)) )<br>    &#123;<br>        _tprintf(L&quot;OpenProcess(%d) failed!!! [%d]\n&quot;, dwPID, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    hModule = GetModuleHandle(L&quot;kernel32.dll&quot;);<br>    pThreadProc = (LPTHREAD_START_ROUTINE)GetProcAddress(hModule, &quot;FreeLibrary&quot;);<br>    hThread = CreateRemoteThread(hProcess, NULL, 0, <br>                                 pThreadProc, me.modBaseAddr, <br>                                 0, NULL);<br>    WaitForSingleObject(hThread, INFINITE);	<br><br>    CloseHandle(hThread);<br>    CloseHandle(hProcess);<br>    CloseHandle(hSnapshot);<br><br>    return TRUE;<br>&#125;<br><br>int _tmain(int argc, TCHAR* argv[])<br>&#123;<br>    DWORD dwPID = 0xFFFFFFFF;<br> <br>    // find process<br>    dwPID = FindProcessID(DEF_PROC_NAME);<br>    if( dwPID == 0xFFFFFFFF )<br>    &#123;<br>        _tprintf(L&quot;There is no &lt;%s&gt; process!\n&quot;, DEF_PROC_NAME);<br>        return 1;<br>    &#125;<br><br>    _tprintf(L&quot;PID of \&quot;%s\&quot; is %d\n&quot;, DEF_PROC_NAME, dwPID);<br><br>    // change privilege<br>    if( !SetPrivilege(SE_DEBUG_NAME, TRUE) )<br>        return 1;<br><br>    // eject dll<br>    if( EjectDll(dwPID, DEF_DLL_NAME) )<br>        _tprintf(L&quot;EjectDll(%d, \&quot;%s\&quot;) success!!!\n&quot;, dwPID, DEF_DLL_NAME);<br>    else<br>        _tprintf(L&quot;EjectDll(%d, \&quot;%s\&quot;) failed!!!\n&quot;, dwPID, DEF_DLL_NAME);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct tagMODULEENTRY32 &#123;<br>    DWORD   dwSize;<br>    DWORD   th32ModuleID;<br>    DWORD   th32ProcessID;<br>    DWORD   GlblcntUsage;<br>    DWORD   ProccntUsage;<br>    BYTE    *modBaseAddr;<br>    DWORD   modBaseSize;<br>    HMODULE hModule;<br>    char    szModule[MAX_MODULE_NAME32 + 1];<br>    char    szExePath[MAX_PATH];<br>&#125; MODULEENTRY32;<br></code></pre></td></tr></table></figure>
<h1 id="Chapter-26-PE-Tools"><a href="#Chapter-26-PE-Tools" class="headerlink" title="Chapter 26 - PE Tools"></a>Chapter 26 - PE Tools</h1><h1 id="Chapter-27-Code-Injection"><a href="#Chapter-27-Code-Injection" class="headerlink" title="Chapter 27 - Code Injection"></a>Chapter 27 - Code Injection</h1><h2 id="27-4-CodeInjection-cpp"><a href="#27-4-CodeInjection-cpp" class="headerlink" title="27.4 - CodeInjection.cpp"></a>27.4 - CodeInjection.cpp</h2><p><strong>MsgBox()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//MsgBox.cpp<br><br>#include &quot;windows.h&quot;<br><br>DWORD WINAPI ThreadProc(LPVOID lParam)<br>&#123;<br>    MessageBoxA(NULL, &quot;www.reversecore.com&quot;, &quot;ReverseCore&quot;, MB_OK);<br><br>    return 0;<br>&#125;<br><br>BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)<br>&#123;<br>    switch( fdwReason )<br>    &#123;<br>        case DLL_PROCESS_ATTACH : <br>            CreateThread(NULL, 0, ThreadProc, NULL, 0, NULL);<br>            break;<br>    &#125;<br><br>    return TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><br><strong>main()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">int main(int argc, char *argv[])<br>&#123;<br>    DWORD dwPID     = 0;<br><br>	if( argc != 2 )<br>	&#123;<br>	    printf(&quot;\n USAGE  : %s &lt;pid&gt;\n&quot;, argv[0]);<br>		return 1;<br>	&#125;<br><br>	// change privilege<br>	if( !SetPrivilege(SE_DEBUG_NAME, TRUE) )<br>        return 1;<br><br>    // code injection<br>    dwPID = (DWORD)atol(argv[1]);<br>    InjectCode(dwPID);<br><br>	return 0;<br>&#125;<br></code></pre></td></tr></table></figure><br><strong>ThreadProc()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _THREAD_PARAM <br>&#123;<br>    FARPROC pFunc[2];               // LoadLibraryA(), GetProcAddress()<br>    char    szBuf[4][128];          // &quot;user32.dll&quot;, &quot;MessageBoxA&quot;, &quot;www.reversecore.com&quot;, &quot;ReverseCore&quot;<br>&#125; THREAD_PARAM, *PTHREAD_PARAM;<br><br>typedef HMODULE (WINAPI *PFLOADLIBRARYA)<br>(<br>    LPCSTR lpLibFileName<br>);<br><br>typedef FARPROC (WINAPI *PFGETPROCADDRESS)<br>(<br>    HMODULE hModule,<br>    LPCSTR lpProcName<br>);<br><br>typedef int (WINAPI *PFMESSAGEBOXA)<br>(<br>    HWND hWnd,<br>    LPCSTR lpText,<br>    LPCSTR lpCaption,<br>    UINT uType<br>);<br><br>DWORD WINAPI ThreadProc(LPVOID lParam)<br>&#123;<br>    PTHREAD_PARAM   pParam      = (PTHREAD_PARAM)lParam;<br>    HMODULE         hMod        = NULL;<br>    FARPROC         pFunc       = NULL;<br><br>    // LoadLibrary()<br>    hMod = ((PFLOADLIBRARYA)pParam-&gt;pFunc[0])(pParam-&gt;szBuf[0]);    // &quot;user32.dll&quot;<br>    if( !hMod )<br>        return 1;<br><br>    // GetProcAddress()<br>    pFunc = (FARPROC)((PFGETPROCADDRESS)pParam-&gt;pFunc[1])(hMod, pParam-&gt;szBuf[1]);  // &quot;MessageBoxA&quot;<br>    if( !pFunc )<br>        return 1;<br><br>    // MessageBoxA()<br>    ((PFMESSAGEBOXA)pFunc)(NULL, pParam-&gt;szBuf[2], pParam-&gt;szBuf[3], MB_OK);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure><br><strong>InjectCode()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL InjectCode(DWORD dwPID)<br>&#123;<br>    HMODULE         hMod            = NULL;<br>    THREAD_PARAM    param           = &#123;0,&#125;;<br>    HANDLE          hProcess        = NULL;<br>    HANDLE          hThread         = NULL;<br>    LPVOID          pRemoteBuf[2]   = &#123;0,&#125;;<br>    DWORD           dwSize          = 0;<br><br>    hMod = GetModuleHandleA(&quot;kernel32.dll&quot;);<br><br>    // set THREAD_PARAM<br>    param.pFunc[0] = GetProcAddress(hMod, &quot;LoadLibraryA&quot;);<br>    param.pFunc[1] = GetProcAddress(hMod, &quot;GetProcAddress&quot;);<br>    strcpy_s(param.szBuf[0], &quot;user32.dll&quot;);<br>    strcpy_s(param.szBuf[1], &quot;MessageBoxA&quot;);<br>    strcpy_s(param.szBuf[2], &quot;www.reversecore.com&quot;);<br>    strcpy_s(param.szBuf[3], &quot;ReverseCore&quot;);<br><br>    // Open Process<br>    if ( !(hProcess = OpenProcess(PROCESS_ALL_ACCESS,   // dwDesiredAccess<br>                                  FALSE,                // bInheritHandle<br>                                  dwPID)) )             // dwProcessId<br>    &#123;<br>        printf(&quot;OpenProcess() fail : err_code = %d\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    // Allocation for THREAD_PARAM<br>    dwSize = sizeof(THREAD_PARAM);<br>    if( !(pRemoteBuf[0] = VirtualAllocEx(hProcess,          // hProcess<br>                                      NULL,                 // lpAddress<br>                                      dwSize,               // dwSize<br>                                      MEM_COMMIT,           // flAllocationType<br>                                      PAGE_READWRITE)) )    // flProtect<br>    &#123;<br>        printf(&quot;VirtualAllocEx() fail : err_code = %d\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    if( !WriteProcessMemory(hProcess,                       // hProcess<br>                            pRemoteBuf[0],                  // lpBaseAddress<br>                            (LPVOID)&amp;param,                 // lpBuffer<br>                            dwSize,                         // nSize<br>                            NULL) )                         // [out] lpNumberOfBytesWritten<br>    &#123;<br>        printf(&quot;WriteProcessMemory() fail : err_code = %d\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    // Allocation for ThreadProc()<br>    dwSize = (DWORD)InjectCode - (DWORD)ThreadProc;<br>    if( !(pRemoteBuf[1] = VirtualAllocEx(hProcess,          // hProcess<br>                                      NULL,                 // lpAddress<br>                                      dwSize,               // dwSize<br>                                      MEM_COMMIT,           // flAllocationType<br>                                      PAGE_EXECUTE_READWRITE)) )    // flProtect<br>    &#123;<br>        printf(&quot;VirtualAllocEx() fail : err_code = %d\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    if( !WriteProcessMemory(hProcess,                       // hProcess<br>                            pRemoteBuf[1],                  // lpBaseAddress<br>                            (LPVOID)ThreadProc,             // lpBuffer<br>                            dwSize,                         // nSize<br>                            NULL) )                         // [out] lpNumberOfBytesWritten<br>    &#123;<br>        printf(&quot;WriteProcessMemory() fail : err_code = %d\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    if( !(hThread = CreateRemoteThread(hProcess,            // hProcess<br>                                       NULL,                // lpThreadAttributes<br>                                       0,                   // dwStackSize<br>                                       (LPTHREAD_START_ROUTINE)pRemoteBuf[1],     // dwStackSize<br>                                       pRemoteBuf[0],       // lpParameter<br>                                       0,                   // dwCreationFlags<br>                                       NULL)) )             // lpThreadId<br>    &#123;<br>        printf(&quot;CreateRemoteThread() fail : err_code = %d\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    WaitForSingleObject(hThread, INFINITE);	<br><br>    CloseHandle(hThread);<br>    CloseHandle(hProcess);<br><br>    return TRUE;<br>&#125;<br><br>BOOL SetPrivilege(LPCTSTR lpszPrivilege, BOOL bEnablePrivilege) <br>&#123;<br>    TOKEN_PRIVILEGES tp;<br>    HANDLE hToken;<br>    LUID luid;<br><br>    if( !OpenProcessToken(GetCurrentProcess(),<br>                          TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, <br>			              &amp;hToken) )<br>    &#123;<br>        printf(&quot;OpenProcessToken error: %u\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    if( !LookupPrivilegeValue(NULL,           // lookup privilege on local system<br>                              lpszPrivilege,  // privilege to lookup <br>                              &amp;luid) )        // receives LUID of privilege<br>    &#123;<br>        printf(&quot;LookupPrivilegeValue error: %u\n&quot;, GetLastError() ); <br>        return FALSE; <br>    &#125;<br><br>    tp.PrivilegeCount = 1;<br>    tp.Privileges[0].Luid = luid;<br>    if( bEnablePrivilege )<br>        tp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;<br>    else<br>        tp.Privileges[0].Attributes = 0;<br><br>    // Enable the privilege or disable all privileges.<br>    if( !AdjustTokenPrivileges(hToken, <br>                               FALSE, <br>                               &amp;tp, <br>                               sizeof(TOKEN_PRIVILEGES), <br>                               (PTOKEN_PRIVILEGES) NULL, <br>                               (PDWORD) NULL) )<br>    &#123; <br>        printf(&quot;AdjustTokenPrivileges error: %u\n&quot;, GetLastError() ); <br>        return FALSE; <br>    &#125; <br><br>    if( GetLastError() == ERROR_NOT_ALL_ASSIGNED )<br>    &#123;<br>        printf(&quot;The token does not have the specified privilege. \n&quot;);<br>        return FALSE;<br>    &#125; <br><br>    return TRUE;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<h1 id="Chapter-28-Code-Injection-via-Assembly-Code"><a href="#Chapter-28-Code-Injection-via-Assembly-Code" class="headerlink" title="Chapter 28 - Code Injection via Assembly Code"></a>Chapter 28 - Code Injection via Assembly Code</h1><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/28.1.png'><img src="/images/books/ReverseEngineeringCore/28.1.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/28.2.png'><img src="/images/books/ReverseEngineeringCore/28.2.png" width="700">
</p>

<h1 id="Chapter-29-API-Hooking"><a href="#Chapter-29-API-Hooking" class="headerlink" title="Chapter 29 - API Hooking"></a>Chapter 29 - API Hooking</h1><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/29.1.png'><img src="/images/books/ReverseEngineeringCore/29.1.png" width="700">
    <figcaption>
    Source: https://maple19out.tistory.com/45
    </figcaption>
</p>

<h1 id="Chapter-30-API-Hooking-of-Notepad-exe-WriteFile"><a href="#Chapter-30-API-Hooking-of-Notepad-exe-WriteFile" class="headerlink" title="Chapter 30 - API Hooking of Notepad.exe WriteFile()"></a>Chapter 30 - API Hooking of <code>Notepad.exe</code> WriteFile()</h1><h2 id="Debug-Events"><a href="#Debug-Events" class="headerlink" title="Debug Events"></a>Debug Events</h2><ul>
<li>EXCEPTION_DEBUG_EVENT</li>
<li>CREATE_THREAD_DEBUG_EVENT</li>
<li>CREATE_PROCESS_DEBUG_EVENT</li>
<li>EXIT_THREAD_DEBUG_EVENT</li>
<li>EXIT_PROCESS_DEBUG_EVENT</li>
<li>LOAD_DLL_DEBUG_EVENT</li>
<li>UNLOAD_DLL_DEBUG_EVENT</li>
<li>OUTPUT_DEBUT_STRING_EVENT</li>
<li>RIP_EVENT</li>
</ul>
<h2 id="EXCEPTION-DEBUG-EVENT"><a href="#EXCEPTION-DEBUG-EVENT" class="headerlink" title="EXCEPTION_DEBUG_EVENT"></a>EXCEPTION_DEBUG_EVENT</h2><ul>
<li>EXCEPTION_ACCESS_VIOLATION</li>
<li>EXCEPTION_ARRAY_BOUNDS_EXCEEDED</li>
<li>EXCEPTION_BREAKPOINT</li>
<li>EXCEPTION_DATATYPE_MISALIGNMENT</li>
<li>EXCEPTION_FLT_DENORMAL_OPERAND</li>
<li>EXCEPTION_FLT_DIVIDE_BY_ZERO</li>
<li>EXCEPTION_FLT_INEXACT_RESULT</li>
<li>EXCEPTION_FLT_INVALID_OPERATION</li>
<li>EXCEPTION_FLT_OVERFLOW</li>
<li>EXCEPTION_FLT_STACK_CHECK</li>
<li>EXCEPTION_FLT_UNDERFLOW</li>
<li>EXCEPTION_FLT_ILLEGAL_INSTRUCTIOIN</li>
<li>EXCEPTION_IN_PAGE_ERROR</li>
<li>EXCEPTION_INT_DIVIDE_BY_ZERO</li>
<li>EXCEPTION_INT_OVERFLOW</li>
<li>EXCEPTION_INVALID_DISPOSITION</li>
<li>EXCEPTION_NONCONTINUABLE_EXCEPTION</li>
<li>EXCEPTION_PRIV_INSTRUCTION</li>
<li>EXCEPTION_SINGLE_STEP</li>
<li>EXCEPTION_STACK_OVERFLOW</li>
</ul>
<h2 id="30-4-Practice"><a href="#30-4-Practice" class="headerlink" title="30.4 - Practice"></a>30.4 - Practice</h2><h2 id="30-5-Principle"><a href="#30-5-Principle" class="headerlink" title="30.5 - Principle"></a>30.5 - Principle</h2><p><strong>WriteFile()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL WriteFile(<br>  [in]                HANDLE       hFile,<br>  [in]                LPCVOID      lpBuffer,<br>  [in]                DWORD        nNumberOfBytesToWrite,<br>  [out, optional]     LPDWORD      lpNumberOfBytesWritten,<br>  [in, out, optional] LPOVERLAPPED lpOverlapped<br>);<br></code></pre></td></tr></table></figure></p>
<hr>
<p><strong>main()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">int main(int argc, char* argv[])<br>&#123;<br>    DWORD dwPID;<br><br>    if( argc != 2 )<br>    &#123;<br>        printf(&quot;\nUSAGE : hookdbg.exe &lt;pid&gt;\n&quot;);<br>        return 1;<br>    &#125;<br><br>    //Attach Process<br>    dwPID = atoi(argv[1]);<br>    if( !DebugActiveProcess(dwPID) )<br>    &#123;<br>        printf(&quot;DebugActiveProcess(%d) failed!!!\n&quot;<br>               &quot;Error Code = %d\n&quot;, dwPID, GetLastError());<br>        return 1;<br>    &#125;<br><br>    //Debugger loop<br>    DebugLoop();<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p><strong>DebugLoop()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">void DebugLoop()<br>&#123;<br>    DEBUG_EVENT de;<br>    DWORD dwContinueStatus;<br><br>    //Waiting for debuggee event.<br>    while( WaitForDebugEvent(&amp;de, INFINITE) )<br>    &#123;<br>        dwContinueStatus = DBG_CONTINUE;<br><br>        //Debuggee process is created or attached.<br>        if( CREATE_PROCESS_DEBUG_EVENT == de.dwDebugEventCode )<br>        &#123;<br>            OnCreateProcessDebugEvent(&amp;de);<br>        &#125;<br>        //Exception<br>        else if( EXCEPTION_DEBUG_EVENT == de.dwDebugEventCode )<br>        &#123;<br>            if( OnExceptionDebugEvent(&amp;de) )<br>                continue;<br>        &#125;<br>        //Event of debuggee is terminated.<br>        else if( EXIT_PROCESS_DEBUG_EVENT == de.dwDebugEventCode )<br>        &#123;<br>            // debuggee 종료 -&gt; debugger 종료<br>            break;<br>        &#125;<br><br>        //Continue debuggee.<br>        ContinueDebugEvent(de.dwProcessId, de.dwThreadId, dwContinueStatus);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p><strong>DEBUG_EVENT structure</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _DEBUG_EVENT &#123;<br>  DWORD dwDebugEventCode;<br>  DWORD dwProcessId;<br>  DWORD dwThreadId;<br>  union &#123;<br>    EXCEPTION_DEBUG_INFO      Exception;<br>    CREATE_THREAD_DEBUG_INFO  CreateThread;<br>    CREATE_PROCESS_DEBUG_INFO CreateProcessInfo;<br>    EXIT_THREAD_DEBUG_INFO    ExitThread;<br>    EXIT_PROCESS_DEBUG_INFO   ExitProcess;<br>    LOAD_DLL_DEBUG_INFO       LoadDll;<br>    UNLOAD_DLL_DEBUG_INFO     UnloadDll;<br>    OUTPUT_DEBUG_STRING_INFO  DebugString;<br>    RIP_INFO                  RipInfo;<br>  &#125; u;<br>&#125; DEBUG_EVENT, *LPDEBUG_EVENT;<br><br>//Source: https://learn.microsoft.com/en-us/windows/win32/api/minwinbase/ns-minwinbase-debug_event<br></code></pre></td></tr></table></figure></p>
<p><strong>OnCreateProcessDebugEvent()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL OnCreateProcessDebugEvent(LPDEBUG_EVENT pde)<br>&#123;<br>    // WriteFile() API 주소 구하기<br>    g_pfWriteFile = GetProcAddress(GetModuleHandleA(&quot;kernel32.dll&quot;), &quot;WriteFile&quot;);<br><br>    // API Hook - WriteFile()<br>    //   첫 번째 byte 를 0xCC (INT 3) 으로 변경 <br>    //   (orginal byte 는 백업)<br>    memcpy(&amp;g_cpdi, &amp;pde-&gt;u.CreateProcessInfo, sizeof(CREATE_PROCESS_DEBUG_INFO));<br>    ReadProcessMemory(g_cpdi.hProcess, g_pfWriteFile, <br>                      &amp;g_chOrgByte, sizeof(BYTE), NULL);<br>    WriteProcessMemory(g_cpdi.hProcess, g_pfWriteFile, <br>                       &amp;g_chINT3, sizeof(BYTE), NULL);<br><br>    return TRUE;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p><strong>OnExceptionDebugEvent()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL OnExceptionDebugEvent(LPDEBUG_EVENT pde)<br>&#123;<br>    CONTEXT ctx;<br>    PBYTE lpBuffer = NULL;<br>    DWORD dwNumOfBytesToWrite, dwAddrOfBuffer, i;<br>    PEXCEPTION_RECORD per = &amp;pde-&gt;u.Exception.ExceptionRecord;<br><br>    //BreakPoint exception (INT 3)<br>    if( EXCEPTION_BREAKPOINT == per-&gt;ExceptionCode )<br>    &#123;<br>        //if BP address is the address of WriteFile()<br>        if( g_pfWriteFile == per-&gt;ExceptionAddress )<br>        &#123;<br>            // #1. Unhook<br>            //0xCC -&gt; original byte<br>            WriteProcessMemory(g_cpdi.hProcess, g_pfWriteFile, <br>                               &amp;g_chOrgByte, sizeof(BYTE), NULL);<br><br>            // #2. Thread Context<br>            ctx.ContextFlags = CONTEXT_CONTROL;<br>            GetThreadContext(g_cpdi.hThread, &amp;ctx);<br><br>            // #3. WriteFile(), param 2, 3<br>            //   함수의 파라미터는 해당 프로세스의 스택에 존재함<br>            //   param 2 : ESP + 0x8<br>            //   param 3 : ESP + 0xC<br>            ReadProcessMemory(g_cpdi.hProcess, (LPVOID)(ctx.Esp + 0x8), <br>                              &amp;dwAddrOfBuffer, sizeof(DWORD), NULL);<br>            ReadProcessMemory(g_cpdi.hProcess, (LPVOID)(ctx.Esp + 0xC), <br>                              &amp;dwNumOfBytesToWrite, sizeof(DWORD), NULL);<br><br>            // #4. 임시 버퍼 할당<br>            lpBuffer = (PBYTE)malloc(dwNumOfBytesToWrite+1);<br>            memset(lpBuffer, 0, dwNumOfBytesToWrite+1);<br><br>            // #5. WriteFile() 의 버퍼를 임시 버퍼에 복사<br>            ReadProcessMemory(g_cpdi.hProcess, (LPVOID)dwAddrOfBuffer, <br>                              lpBuffer, dwNumOfBytesToWrite, NULL);<br>            printf(&quot;\n### original string ###\n%s\n&quot;, lpBuffer);<br><br>            // #6. 소문자 -&gt; 대문자 변환<br>            for( i = 0; i &lt; dwNumOfBytesToWrite; i++ )<br>            &#123;<br>                if( 0x61 &lt;= lpBuffer[i] &amp;&amp; lpBuffer[i] &lt;= 0x7A )<br>                    lpBuffer[i] -= 0x20;<br>            &#125;<br><br>            printf(&quot;\n### converted string ###\n%s\n&quot;, lpBuffer);<br><br>            // #7. 변환된 버퍼를 WriteFile() 버퍼로 복사<br>            WriteProcessMemory(g_cpdi.hProcess, (LPVOID)dwAddrOfBuffer, <br>                               lpBuffer, dwNumOfBytesToWrite, NULL);<br>            <br>            // #8. 임시 버퍼 해제<br>            free(lpBuffer);<br><br>            // #9. Thread Context 의 EIP 를 WriteFile() 시작으로 변경<br>            //   (현재는 WriteFile() + 1 만큼 지나왔음)<br>            ctx.Eip = (DWORD)g_pfWriteFile;<br>            SetThreadContext(g_cpdi.hThread, &amp;ctx);<br><br>            // #10. Debuggee 프로세스를 진행시킴<br>            ContinueDebugEvent(pde-&gt;dwProcessId, pde-&gt;dwThreadId, DBG_CONTINUE);<br>            Sleep(0);<br><br>            // #11. API Hook<br>            WriteProcessMemory(g_cpdi.hProcess, g_pfWriteFile, <br>                               &amp;g_chINT3, sizeof(BYTE), NULL);<br><br>            return TRUE;<br>        &#125;<br>    &#125;<br><br>    return FALSE;<br>&#125;<br></code></pre></td></tr></table></figure><br><strong>CONTEXT (x86 32-bit)</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _CONTEXT &#123;<br>  DWORD              ContextFlags;<br>  DWORD              Dr0;<br>  DWORD              Dr1;<br>  DWORD              Dr2;<br>  DWORD              Dr3;<br>  DWORD              Dr6;<br>  DWORD              Dr7;<br>  FLOATING_SAVE_AREA FloatSave;<br>  DWORD              SegGs;<br>  DWORD              SegFs;<br>  DWORD              SegEs;<br>  DWORD              SegDs;<br>  DWORD              Edi;<br>  DWORD              Esi;<br>  DWORD              Ebx;<br>  DWORD              Edx;<br>  DWORD              Ecx;<br>  DWORD              Eax;<br>  DWORD              Ebp;<br>  DWORD              Eip;<br>  DWORD              SegCs;<br>  DWORD              EFlags;<br>  DWORD              Esp;<br>  DWORD              SegSs;<br>  BYTE               ExtendedRegisters[MAXIMUM_SUPPORTED_EXTENSION];<br>&#125; CONTEXT;<br></code></pre></td></tr></table></figure></p>
<h1 id="Chapter-31-Debugger"><a href="#Chapter-31-Debugger" class="headerlink" title="Chapter 31 - Debugger"></a>Chapter 31 - Debugger</h1><h2 id="OllyDbg"><a href="#OllyDbg" class="headerlink" title="OllyDbg"></a>OllyDbg</h2><h2 id="IDA-Pro"><a href="#IDA-Pro" class="headerlink" title="IDA Pro"></a>IDA Pro</h2><h2 id="WinDbg"><a href="#WinDbg" class="headerlink" title="WinDbg"></a>WinDbg</h2><h1 id="Chapter-32-Displaying-Korean-in-calc-exe"><a href="#Chapter-32-Displaying-Korean-in-calc-exe" class="headerlink" title="Chapter 32 - Displaying Korean in calc.exe"></a>Chapter 32 - Displaying Korean in <code>calc.exe</code></h1><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/32.1.png'><img src="/images/books/ReverseEngineeringCore/32.1.png" width="800">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL SetWindowTextA(<br>  [in]           HWND   hWnd,<br>  [in, optional] LPCSTR lpString<br>);<br><br>//Source: https://learn.microsoft.com/zh-tw/windows/win32/api/winuser/nf-winuser-setwindowtexta<br></code></pre></td></tr></table></figure>
<p>Here <strong>W</strong> stands for <strong>Wide Character</strong> version. <strong>A</strong> stands for <strong>ASCII</strong> version.</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/32.2.png'><img src="/images/books/ReverseEngineeringCore/32.2.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/32.4.png'><img src="/images/books/ReverseEngineeringCore/32.4.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/32.5.png'><img src="/images/books/ReverseEngineeringCore/32.5.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/32.2.png'><img src="/images/books/ReverseEngineeringCore/32.2.png" width="700">
</p>

<blockquote>
<p>Important: Notice that <strong>Little-endian</strong> is used on x32 platform. Thus, you must enter the hexadecimal unicode in reversed. In addition, Unicode is constituted by 2 bytes (16 bits).</p>
</blockquote>
<h2 id="32-4-Practice"><a href="#32-4-Practice" class="headerlink" title="32.4 - Practice"></a>32.4 - Practice</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; InjectDll.exe -e 3192 C:\work\hookiat.dll<br></code></pre></td></tr></table></figure>
<h2 id="32-5-Code"><a href="#32-5-Code" class="headerlink" title="32.5 - Code"></a>32.5 - Code</h2><p><strong>DllMain()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)<br>&#123;<br>	switch( fdwReason )<br>	&#123;<br>		case DLL_PROCESS_ATTACH : <br>            // original API 주소 저장<br>           	g_pOrgFunc = GetProcAddress(GetModuleHandle(L&quot;user32.dll&quot;), <br>                                        &quot;SetWindowTextW&quot;);<br><br>            // # hook<br>            //   user32!SetWindowTextW() 를 hookiat!MySetWindowText() 로 후킹<br>			hook_iat(&quot;user32.dll&quot;, g_pOrgFunc, (PROC)MySetWindowTextW);<br>			break;<br><br>		case DLL_PROCESS_DETACH :<br>            // # unhook<br>            //   calc.exe 의 IAT 를 원래대로 복원<br>            hook_iat(&quot;user32.dll&quot;, (PROC)MySetWindowTextW, g_pOrgFunc);<br>			break;<br>	&#125;<br><br>	return TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><br><strong>MySetWindowTextW()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL WINAPI MySetWindowTextW(HWND hWnd, LPWSTR lpString)<br>&#123;<br>    wchar_t* pNum = L&quot;영일이삼사오육칠팔구&quot;; //0123456789 or 零一二三四五六七八九<br>    wchar_t temp[2] = &#123;0,&#125;;<br>    int i = 0, nLen = 0, nIndex = 0;<br><br>    nLen = wcslen(lpString);<br>    for(i = 0; i &lt; nLen; i++)<br>    &#123;<br>        // &#x27;수&#x27;문자를 &#x27;한글&#x27;문자로 변환<br>        //   lpString 은 wide-character (2 byte) 문자열<br>        if( L&#x27;0&#x27; &lt;= lpString[i] &amp;&amp; lpString[i] &lt;= L&#x27;9&#x27; )<br>        &#123;<br>            temp[0] = lpString[i];<br>            nIndex = _wtoi(temp);<br>            lpString[i] = pNum[nIndex];<br>        &#125;<br>    &#125;<br><br>    // user32!SetWindowTextW() API 호출<br>    //   (위에서 lpString 버퍼 내용을 변경하였음)<br>    return ((PFSETWINDOWTEXTW)g_pOrgFunc)(hWnd, lpString);<br>&#125;<br></code></pre></td></tr></table></figure></p>
<hr>
<p><strong>hook_iat()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL hook_iat(LPCSTR szDllName, PROC pfnOrg, PROC pfnNew)<br>&#123;<br>	HMODULE hMod;<br>	LPCSTR szLibName;<br>	PIMAGE_IMPORT_DESCRIPTOR pImportDesc; <br>	PIMAGE_THUNK_DATA pThunk;<br>	DWORD dwOldProtect, dwRVA;<br>	PBYTE pAddr;<br><br>    // hMod, pAddr = ImageBase of calc.exe<br>    //             = VA to MZ signature (IMAGE_DOS_HEADER)<br>	hMod = GetModuleHandle(NULL);<br>	pAddr = (PBYTE)hMod;<br><br>    // pAddr = VA to PE signature (IMAGE_NT_HEADERS)<br>	pAddr += *((DWORD*)&amp;pAddr[0x3C]);<br><br>    // dwRVA = RVA to IMAGE_IMPORT_DESCRIPTOR Table<br>	dwRVA = *((DWORD*)&amp;pAddr[0x80]);<br><br>    // pImportDesc = VA to IMAGE_IMPORT_DESCRIPTOR Table<br>	pImportDesc = (PIMAGE_IMPORT_DESCRIPTOR)((DWORD)hMod+dwRVA);<br><br>	for( ; pImportDesc-&gt;Name; pImportDesc++ )<br>	&#123;<br>        // szLibName = VA to IMAGE_IMPORT_DESCRIPTOR.Name<br>		szLibName = (LPCSTR)((DWORD)hMod + pImportDesc-&gt;Name);<br>		if( !_stricmp(szLibName, szDllName) )<br>		&#123;<br>            // pThunk = IMAGE_IMPORT_DESCRIPTOR.FirstThunk<br>            //        = VA to IAT(Import Address Table)<br>			pThunk = (PIMAGE_THUNK_DATA)((DWORD)hMod + <br>                                         pImportDesc-&gt;FirstThunk);<br><br>            // pThunk-&gt;u1.Function = VA to API<br>			for( ; pThunk-&gt;u1.Function; pThunk++ )<br>			&#123;<br>				if( pThunk-&gt;u1.Function == (DWORD)pfnOrg )<br>				&#123;<br>                    //Modify the attribute of memory to E/R/W<br>					VirtualProtect((LPVOID)&amp;pThunk-&gt;u1.Function, <br>                                   4, <br>                                   PAGE_EXECUTE_READWRITE, <br>                                   &amp;dwOldProtect);<br><br>                    //Modify IAT value (Hooking).<br>                    pThunk-&gt;u1.Function = (DWORD)pfnNew;<br>					<br>                    //Redo modification.<br>                    VirtualProtect((LPVOID)&amp;pThunk-&gt;u1.Function, <br>                                   4, <br>                                   dwOldProtect, <br>                                   &amp;dwOldProtect);						<br><br>					return TRUE;<br>				&#125;<br>			&#125;<br>		&#125;<br>	&#125;<br><br>	return FALSE;<br>&#125;<br><br></code></pre></td></tr></table></figure></p>
<hr>
<p><strong>IAT structure</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">hMod = GetModuleHandle(NULL);       // hMod = ImageBase<br>pAddr = (PBYTE)hMod;                // pAddr = ImageBase<br>pAddr += *((DWORD*)&amp;pAddr[0x3C]);   // pAddr = &quot;PE&quot; signature<br>dwRVA = *((DWORD*)&amp;pAddr[0x80]);    // dwRVA = RVA of IMAGE_IMPORT_DESCRIPTOR<br><br>pImportDesc = (PIMAGE_IMPORT_DESCRIPTOR)((DWORD)hMod+dwRVA);<br></code></pre></td></tr></table></figure></p>
<h1 id="Chapter-33-Hidden-Process"><a href="#Chapter-33-Hidden-Process" class="headerlink" title="Chapter 33 - Hidden Process"></a>Chapter 33 - Hidden Process</h1><h2 id="33-3-Hidden-Process"><a href="#33-3-Hidden-Process" class="headerlink" title="33.3 - Hidden Process"></a>33.3 - Hidden Process</h2><p><strong>CreateToolhelp32Snapshot()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">HANDLE CreateToolhelp32Snapshot(<br>  [in] DWORD dwFlags,<br>  [in] DWORD th32ProcessID<br>);<br><br>//Source: https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot<br></code></pre></td></tr></table></figure></p>
<p><strong>EnumProcess()</strong></p>
<h2 id=""><a href="#" class="headerlink" title=""></a><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL EnumProcesses(<br>  [out] DWORD   *lpidProcess,<br>  [in]  DWORD   cb,<br>  [out] LPDWORD lpcbNeeded<br>);<br><br>//Source: https://learn.microsoft.com/en-us/windows/win32/api/psapi/nf-psapi-enumprocesses<br></code></pre></td></tr></table></figure></h2><p><strong>ZwQuerySystemInformation()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">NTSTATUS WINAPI ZwQuerySystemInformation(<br>  _In_      SYSTEM_INFORMATION_CLASS SystemInformationClass,<br>  _Inout_   PVOID                    SystemInformation,<br>  _In_      ULONG                    SystemInformationLength,<br>  _Out_opt_ PULONG                   ReturnLength<br>);<br><br>//Source: https://learn.microsoft.com/en-us/windows/win32/sysinfo/zwquerysysteminformation<br></code></pre></td></tr></table></figure></p>
<h2 id="33-4-Practice"><a href="#33-4-Practice" class="headerlink" title="33.4 - Practice"></a>33.4 - Practice</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL InjectAllProcess(int nMode, LPCTSTR szDllPath)<br>&#123;<br>	DWORD                   dwPID = 0;<br>	HANDLE                  hSnapShot = INVALID_HANDLE_VALUE;<br>	PROCESSENTRY32          pe;<br><br>	// Get the snapshot of the system<br>	pe.dwSize = sizeof( PROCESSENTRY32 );<br>	hSnapShot = CreateToolhelp32Snapshot( TH32CS_SNAPALL, NULL );<br><br>	// find process<br>	Process32First(hSnapShot, &amp;pe);<br>	do<br>	&#123;<br>		dwPID = pe.th32ProcessID;<br><br>        // 시스템의 안정성을 위해서<br>        // PID 가 100 보다 작은 시스템 프로세스에 대해서는<br>        // DLL Injection 을 수행하지 않는다.<br>		if( dwPID &lt; 100 )<br>			continue;<br><br>        if( nMode == INJECTION_MODE )<br>		    InjectDll(dwPID, szDllPath);<br>        else<br>            EjectDll(dwPID, szDllPath);<br>	&#125;<br>	while( Process32Next(hSnapShot, &amp;pe) );<br><br>	CloseHandle(hSnapShot);<br><br>	return TRUE;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="33-5-HideProc"><a href="#33-5-HideProc" class="headerlink" title="33.5 - HideProc"></a>33.5 - HideProc</h2><h1 id="Chapter-34-Global-API-Hooking"><a href="#Chapter-34-Global-API-Hooking" class="headerlink" title="Chapter 34 - Global API Hooking"></a>Chapter 34 - Global API Hooking</h1><h1 id="Chapter-35-How-to-Choose-Your-Tools"><a href="#Chapter-35-How-to-Choose-Your-Tools" class="headerlink" title="Chapter 35 - How to Choose Your Tools"></a>Chapter 35 - How to Choose Your Tools</h1><h1 id="Chapter-36-64-bit"><a href="#Chapter-36-64-bit" class="headerlink" title="Chapter 36 - 64-bit"></a>Chapter 36 - 64-bit</h1><h2 id="36-1-64-bit-Processing"><a href="#36-1-64-bit-Processing" class="headerlink" title="36.1 - 64-bit Processing"></a>36.1 - 64-bit Processing</h2><div class="table-container">
<table>
<thead>
<tr>
<th>Terminology</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>AMB64</td>
<td>64-bit processors developed by AMD.</td>
</tr>
<tr>
<td>EM64T</td>
<td>64-bit processors developed by Intel. They support AMD64.</td>
</tr>
<tr>
<td>Intel64</td>
<td>New name of EM64T.</td>
</tr>
<tr>
<td>IA-64</td>
<td>64-bit CPUs developed by Intel and HP.</td>
</tr>
<tr>
<td>x86</td>
<td>CPUs of Intel IA-32, IA-16 and IA-8.</td>
</tr>
<tr>
<td>x64</td>
<td>AMD64 &amp; Intel64</td>
</tr>
</tbody>
</table>
</div>
<h1 id="Chapter-37-x64-Processor"><a href="#Chapter-37-x64-Processor" class="headerlink" title="Chapter 37 - x64 Processor"></a>Chapter 37 - x64 Processor</h1><h1 id="Chapter-38-PE32"><a href="#Chapter-38-PE32" class="headerlink" title="Chapter 38 - PE32+"></a>Chapter 38 - PE32+</h1><p><strong>IMAGE_NT_HEADERS</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_NT_HEADERS64 &#123;<br>  DWORD Signature;<br>  IMAGE_FILE_HEADER FileHeader;<br>  IMAGE_OPTIONAL_HEADER64 OptionalHeader;<br>&#125; IMAGE_NT_HEADERS64, *PIMAGE_NT_HEADERS64;<br><br>typedef struct _IMAGE_NT_HEADERS &#123;<br>  DWORD Signature; /* &quot;PE&quot;\0\0 */	/* 0x00 */<br>  IMAGE_FILE_HEADER FileHeader;		/* 0x04 */<br>  IMAGE_OPTIONAL_HEADER32 OptionalHeader;	/* 0x18 */<br>&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;<br><br>#ifdef _WIN64<br>typedef IMAGE_NT_HEADERS64  IMAGE_NT_HEADERS;<br>typedef PIMAGE_NT_HEADERS64 PIMAGE_NT_HEADERS;<br>#else<br>typedef IMAGE_NT_HEADERS32  IMAGE_NT_HEADERS;<br>typedef PIMAGE_NT_HEADERS32 PIMAGE_NT_HEADERS;<br>#endif<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure></p>
<hr>
<p><strong>IMAGE_FILE_HEADER</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#define IMAGE_FILE_MACHINE_UNKNOWN      0<br>#define IMAGE_FILE_MACHINE_TARGET_HOST  0x0001<br>#define IMAGE_FILE_MACHINE_I386         0x014c<br>#define IMAGE_FILE_MACHINE_R3000        0x0162<br><br>#define IMAGE_FILE_MACHINE_R4000        0x0166<br>#define IMAGE_FILE_MACHINE_R10000       0x0168<br>#define IMAGE_FILE_MACHINE_WCEMIPSV2    0x0169<br><br>#define IMAGE_FILE_MACHINE_ALPHA        0x0184<br>#define IMAGE_FILE_MACHINE_SH3          0x01a2<br>#define IMAGE_FILE_MACHINE_SH3DSP       0x01a3<br>#define IMAGE_FILE_MACHINE_SH3E         0x01a4<br>#define IMAGE_FILE_MACHINE_SH4          0x01a6<br>#define IMAGE_FILE_MACHINE_SH5          0x01a8<br>#define IMAGE_FILE_MACHINE_ARM          0x01c0<br>#define IMAGE_FILE_MACHINE_THUMB        0x01c2<br>#define IMAGE_FILE_MACHINE_ARMNT        0x01c4<br>#define IMAGE_FILE_MACHINE_AM33         0x01d3<br>#define IMAGE_FILE_MACHINE_POWERPC      0x01f0<br><br>#define IMAGE_FILE_MACHINE_POWERPCFP    0x01f1<br>#define IMAGE_FILE_MACHINE_IA64         0x0200<br>#define IMAGE_FILE_MACHINE_MIPS16       0x0266<br>#define IMAGE_FILE_MACHINE_ALPHA64      0x0284<br>#define IMAGE_FILE_MACHINE_AXP64 IMAGE_FILE_MACHINE_ALPHA64<br>#define IMAGE_FILE_MACHINE_MIPSFPU      0x0366<br>#define IMAGE_FILE_MACHINE_MIPSFPU16    0x0466<br>#define IMAGE_FILE_MACHINE_TRICORE      0x0520<br>#define IMAGE_FILE_MACHINE_CEF          0x0cef<br>#define IMAGE_FILE_MACHINE_EBC          0x0ebc<br>#define IMAGE_FILE_MACHINE_CHPE_X86     0x3a64<br>#define IMAGE_FILE_MACHINE_AMD64        0x8664<br>#define IMAGE_FILE_MACHINE_M32R         0x9041<br>#define IMAGE_FILE_MACHINE_ARM64EC      0xa641<br>#define IMAGE_FILE_MACHINE_ARM64X       0xa64e<br>#define IMAGE_FILE_MACHINE_ARM64        0xaa64<br>#define IMAGE_FILE_MACHINE_RISCV32      0x5032<br>#define IMAGE_FILE_MACHINE_RISCV64      0x5064<br>#define IMAGE_FILE_MACHINE_RISCV128     0x5128<br>#define IMAGE_FILE_MACHINE_CEE          0xc0ee<br><br>//Source: //Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure></p>
<hr>
<p><strong>IMAGE_OPTIONAL_HEADER</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_OPTIONAL_HEADER &#123;<br><br>  /* Standard fields */<br><br>  WORD  Magic; /* 0x10b or 0x107 */	/* 0x00 */<br>  BYTE  MajorLinkerVersion;<br>  BYTE  MinorLinkerVersion;<br>  DWORD SizeOfCode;<br>  DWORD SizeOfInitializedData;<br>  DWORD SizeOfUninitializedData;<br>  DWORD AddressOfEntryPoint;		/* 0x10 */<br>  DWORD BaseOfCode;<br>  DWORD BaseOfData;<br><br>  /* NT additional fields */<br><br>  DWORD ImageBase;<br>  DWORD SectionAlignment;		/* 0x20 */<br>  DWORD FileAlignment;<br>  WORD  MajorOperatingSystemVersion;<br>  WORD  MinorOperatingSystemVersion;<br>  WORD  MajorImageVersion;<br>  WORD  MinorImageVersion;<br>  WORD  MajorSubsystemVersion;		/* 0x30 */<br>  WORD  MinorSubsystemVersion;<br>  DWORD Win32VersionValue;<br>  DWORD SizeOfImage;<br>  DWORD SizeOfHeaders;<br>  DWORD CheckSum;			/* 0x40 */<br>  WORD  Subsystem;<br>  WORD  DllCharacteristics;<br>  DWORD SizeOfStackReserve;<br>  DWORD SizeOfStackCommit;<br>  DWORD SizeOfHeapReserve;		/* 0x50 */<br>  DWORD SizeOfHeapCommit;<br>  DWORD LoaderFlags;<br>  DWORD NumberOfRvaAndSizes;<br>  IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES]; /* 0x60 */<br>  /* 0xE0 */<br>&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;<br><br>typedef struct _IMAGE_OPTIONAL_HEADER64 &#123;<br>  WORD  Magic; /* 0x20b */<br>  BYTE MajorLinkerVersion;<br>  BYTE MinorLinkerVersion;<br>  DWORD SizeOfCode;<br>  DWORD SizeOfInitializedData;<br>  DWORD SizeOfUninitializedData;<br>  DWORD AddressOfEntryPoint;<br>  DWORD BaseOfCode;<br>  ULONGLONG ImageBase;<br>  DWORD SectionAlignment;<br>  DWORD FileAlignment;<br>  WORD MajorOperatingSystemVersion;<br>  WORD MinorOperatingSystemVersion;<br>  WORD MajorImageVersion;<br>  WORD MinorImageVersion;<br>  WORD MajorSubsystemVersion;<br>  WORD MinorSubsystemVersion;<br>  DWORD Win32VersionValue;<br>  DWORD SizeOfImage;<br>  DWORD SizeOfHeaders;<br>  DWORD CheckSum;<br>  WORD Subsystem;<br>  WORD DllCharacteristics;<br>  ULONGLONG SizeOfStackReserve;<br>  ULONGLONG SizeOfStackCommit;<br>  ULONGLONG SizeOfHeapReserve;<br>  ULONGLONG SizeOfHeapCommit;<br>  DWORD LoaderFlags;<br>  DWORD NumberOfRvaAndSizes;<br>  IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];<br>&#125; IMAGE_OPTIONAL_HEADER64, *PIMAGE_OPTIONAL_HEADER64;<br><br>/* Possible Magic values */<br>#define IMAGE_NT_OPTIONAL_HDR32_MAGIC      0x10b<br>#define IMAGE_NT_OPTIONAL_HDR64_MAGIC      0x20b<br>#define IMAGE_ROM_OPTIONAL_HDR_MAGIC       0x107<br><br>#ifdef _WIN64<br>#define IMAGE_SIZEOF_NT_OPTIONAL_HEADER IMAGE_SIZEOF_NT_OPTIONAL64_HEADER<br>#define IMAGE_NT_OPTIONAL_HDR_MAGIC     IMAGE_NT_OPTIONAL_HDR64_MAGIC<br>#else<br>#define IMAGE_SIZEOF_NT_OPTIONAL_HEADER IMAGE_SIZEOF_NT_OPTIONAL32_HEADER<br>#define IMAGE_NT_OPTIONAL_HDR_MAGIC     IMAGE_NT_OPTIONAL_HDR32_MAGIC<br>#endif<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure></p>
<hr>
<p><strong>Stack &amp; Heap</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_THUNK_DATA64 &#123;<br>	union &#123;<br>		ULONGLONG ForwarderString;<br>		ULONGLONG Function;<br>		ULONGLONG Ordinal;<br>		ULONGLONG AddressOfData;<br>	&#125; u1;<br>&#125; IMAGE_THUNK_DATA64,*PIMAGE_THUNK_DATA64;<br>#pragma pack(pop)<br><br>typedef struct _IMAGE_THUNK_DATA32 &#123;<br>	union &#123;<br>		DWORD ForwarderString;<br>		DWORD Function;<br>		DWORD Ordinal;<br>		DWORD AddressOfData;<br>	&#125; u1;<br>&#125; IMAGE_THUNK_DATA32,*PIMAGE_THUNK_DATA32;<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure></p>
<hr>
<p><strong>IMAGE_IMPORT_DESCRIPTOR</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_IMPORT_DESCRIPTOR &#123;<br>	union &#123;<br>		DWORD	Characteristics; /* 0 for terminating null import descriptor  */<br>		DWORD	OriginalFirstThunk;	/* RVA to original unbound IAT */<br>	&#125; DUMMYUNIONNAME;<br>	DWORD	TimeDateStamp;	/* 0 if not bound,<br>				 * -1 if bound, and real date\time stamp<br>				 *    in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT<br>				 * (new BIND)<br>				 * otherwise date/time stamp of DLL bound to<br>				 * (Old BIND)<br>				 */<br>	DWORD	ForwarderChain;	/* -1 if no forwarders */<br>	DWORD	Name;<br>	/* RVA to IAT (if bound this IAT has actual addresses) */<br>	DWORD	FirstThunk;<br>&#125; IMAGE_IMPORT_DESCRIPTOR,*PIMAGE_IMPORT_DESCRIPTOR;<br></code></pre></td></tr></table></figure></p>
<h1 id="Chapter-39-WinDbg"><a href="#Chapter-39-WinDbg" class="headerlink" title="Chapter 39 - WinDbg"></a>Chapter 39 - WinDbg</h1><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/39.1.png'><img src="/images/books/ReverseEngineeringCore/39.1.png" width="800">
</p>

<h1 id="Chapter-40-64-bit-Debugging"><a href="#Chapter-40-64-bit-Debugging" class="headerlink" title="Chapter 40 - 64-bit Debugging"></a>Chapter 40 - 64-bit Debugging</h1><h2 id="40-1-Debugger-on-x64-Platform"><a href="#40-1-Debugger-on-x64-Platform" class="headerlink" title="40.1 - Debugger on x64 Platform"></a>40.1 - Debugger on x64 Platform</h2><div class="table-container">
<table>
<thead>
<tr>
<th>OS</th>
<th>PE32</th>
<th>PE32+</th>
</tr>
</thead>
<tbody>
<tr>
<td>32-bit</td>
<td>OllyDbg, IDA Pro, WinDbg</td>
<td>IDA Pro (Disassemble only)</td>
</tr>
<tr>
<td>64-bit</td>
<td>OllyDbg, IDA Pro, WinDbg</td>
<td>IDA Pro, WinDbg</td>
</tr>
</tbody>
</table>
</div>
<h2 id="40-2-x64-Debugging"><a href="#40-2-x64-Debugging" class="headerlink" title="40.2 - x64 Debugging"></a>40.2 - x64 Debugging</h2><p><strong>WOW64Test</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &quot;stdio.h&quot;<br>#include &quot;windows.h&quot;<br>#include &quot;Shlobj.h&quot;<br>#include &quot;tchar.h&quot;<br>#pragma comment(lib, &quot;Shell32.lib&quot;)<br><br>int _tmain(int argc, TCHAR* argv[])<br>&#123;<br>    HKEY    hKey                = NULL;<br>    HANDLE  hFile               = INVALID_HANDLE_VALUE;<br>    TCHAR   szPath[MAX_PATH]    = &#123;0,&#125;;<br><br>    ////////////////<br>    // system32 folder<br>    if( GetSystemDirectory(szPath, MAX_PATH) )<br>    &#123;<br>        _tprintf(L&quot;1) system32 path = %s\n&quot;, szPath);<br>    &#125;<br><br>    ////////////////<br>    // File size<br>    _tcscat_s(szPath, L&quot;\\kernel32.dll&quot;);<br>    hFile = CreateFile(szPath, GENERIC_READ, FILE_SHARE_READ, NULL, <br>                       OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);<br>    if( hFile != INVALID_HANDLE_VALUE )<br>    &#123;<br>        _tprintf(L&quot;2) File size of \&quot;%s\&quot; = %d\n&quot;, <br>        szPath, GetFileSize(hFile, NULL));<br>        CloseHandle(hFile);<br>    &#125;<br><br>    ////////////////<br>    // Program Files<br>    if( SHGetSpecialFolderPath(NULL, szPath, <br>                               CSIDL_PROGRAM_FILES, FALSE) )<br>    &#123;<br>        _tprintf(L&quot;3) Program Files path = %s\n&quot;, szPath);<br>    &#125;<br><br>    ////////////////<br>    // Registry<br>    if( ERROR_SUCCESS == RegCreateKey(HKEY_LOCAL_MACHINE, <br>                                      L&quot;SOFTWARE\\ReverseCore&quot;, &amp;hKey) )<br>    &#123;<br>        RegCloseKey(hKey);<br>        _tprintf(L&quot;4) Create Registry Key : HKLM\\SOFTWARE\\ReverseCore\n&quot;);<br>    &#125;<br><br>    return 0;<br>&#125;<br><br></code></pre></td></tr></table></figure></p>
<h2 id="40-3-WOW64Test-x86-exe"><a href="#40-3-WOW64Test-x86-exe" class="headerlink" title="40.3 - WOW64Test_x86.exe"></a>40.3 - WOW64Test_x86.exe</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.1.png'><img src="/images/books/ReverseEngineeringCore/40.1.png" width="1000">
    <figcaption>
    Run code.
    </figcaption>
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.2.png'><img src="/images/books/ReverseEngineeringCore/40.2.png" width="700">
    <figcaption>
    Enable "x64 Compatibility-mode [single-step]
    </figcaption>
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.3.png'><img src="/images/books/ReverseEngineeringCore/40.3.png" width="600">
    <figcaption>
    Startup
    </figcaption>
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.4.png'><img src="/images/books/ReverseEngineeringCore/40.4.png" width="600">
    <figcaption>
    main() function.
    </figcaption>
</p>

<h2 id="40-4-WOW64Test-x64-exe"><a href="#40-4-WOW64Test-x64-exe" class="headerlink" title="40.4 - WOW64Test_x64.exe"></a>40.4 - WOW64Test_x64.exe</h2><p>We use <strong>WinDbg</strong> to debug this executable<br>File -&gt; Launch Executable</p>
<p>Firstly, we need to obtain the EP address.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; !dh WOW64Test_x64<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.5.png'><img src="/images/books/ReverseEngineeringCore/40.5.png" width="700">
    <figcaption>
    Display PE header.
    </figcaption>
</p>

<p>Go into EP:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; g WOW64Test_x64 + 142C<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.6.png'><img src="/images/books/ReverseEngineeringCore/40.6.png" width="800">
    <figcaption>
    Go into EP.
    </figcaption>
</p>

<p>Show more instructions:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; u eip L10<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.7.png'><img src="/images/books/ReverseEngineeringCore/40.7.png" width="700">
    <figcaption>
    Display more instructions.
    </figcaption>
</p>

<p>Trace the <code>jmp</code> instruction at <code>00000001 40001439</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; g WOW64Test_x64 + 12b4<br>&gt; u eip L60<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.8.png'><img src="/images/books/ReverseEngineeringCore/40.8.png" width="700">
    <figcaption>
    Trace function
    </figcaption>
</p>

<hr>
<p>main() function<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; bp KERNEL32!GetCommandLineW<br>&gt; g<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.9.png'><img src="/images/books/ReverseEngineeringCore/40.9.png" width="1200">
    <figcaption>
    Set breakpoint.
    </figcaption>
</p>

<p>Obtain the return address from stack<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; r rsp<br>&gt; dq rsp<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.10.png'><img src="/images/books/ReverseEngineeringCore/40.10.png" width="1200">
    <figcaption>
    View register, and then dump the register.
    </figcaption>
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; g 00000001`40001381<br>&gt; u eip L20<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.11.png'><img src="/images/books/ReverseEngineeringCore/40.11.png" width="1200">
    <figcaption>
    Go to the address that we obtained, this is the main() function that we want since the return address is the address of main function. The assembly code above is the assembly code of main().
    </figcaption>
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; g 00000001`400013ea<br>&gt; r<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.12.png'><img src="/images/books/ReverseEngineeringCore/40.12.png" width="800">
    <figcaption>
    Arguments.
    </figcaption>
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; db rdx<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.13.png'><img src="/images/books/ReverseEngineeringCore/40.13.png" width="800">
    <figcaption>
    Dump rdx to show argument.
    </figcaption>
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; db rdx<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.14.png'><img src="/images/books/ReverseEngineeringCore/40.14.png" width="800">
    <figcaption>
    Dump r8 to show stack pointers.
    </figcaption>
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; db 023b3ac0 l200<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.15.png'><img src="/images/books/ReverseEngineeringCore/40.15.png" width="800">
    <figcaption>
    Dump the stack. The address 023b3ac0 is the address of the first element of the array of last result (`db rdx`). Always remember little-endian is used.
    </figcaption>
</p>

<h1 id="Chapter-41-ASLR"><a href="#Chapter-41-ASLR" class="headerlink" title="Chapter 41 - ASLR"></a>Chapter 41 - ASLR</h1><p>ASLR stands for <strong>Address Space Layout Randomization</strong>.</p>
<p>Windows OS that apply ASLR:</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>OS</th>
<th>Kernal Version</th>
</tr>
</thead>
<tbody>
<tr>
<td>Windows 2000</td>
<td>5.0</td>
</tr>
<tr>
<td>Windows XP</td>
<td>5.1</td>
</tr>
<tr>
<td>Windows Server 2003</td>
<td>5.2</td>
</tr>
<tr>
<td>Windows Vista</td>
<td>6.0</td>
</tr>
<tr>
<td>Windows Server 2008</td>
<td>6.0</td>
</tr>
<tr>
<td>Windows Server 2008 R2</td>
<td>6.1</td>
</tr>
<tr>
<td>Windows 7</td>
<td>6.1</td>
</tr>
</tbody>
</table>
</div>
<p>IMAGE_FILE_HEADER\Characteristics</p>
<p>IMAGE_FILE_RELOCS_STRIPPED</p>
<h1 id="Chapter-42-Session-of-Kernel-6"><a href="#Chapter-42-Session-of-Kernel-6" class="headerlink" title="Chapter 42 - Session of Kernel 6"></a>Chapter 42 - Session of Kernel 6</h1><p>Session 0 Isolation</p>
<h1 id="Chapter-43-DLL-Injection-in-Kernel-6"><a href="#Chapter-43-DLL-Injection-in-Kernel-6" class="headerlink" title="Chapter 43 - DLL Injection in Kernel 6"></a>Chapter 43 - DLL Injection in Kernel 6</h1><h1 id="Chapter-44-InjDll-exe——A-Tool-for-DLL-Injection"><a href="#Chapter-44-InjDll-exe——A-Tool-for-DLL-Injection" class="headerlink" title="Chapter 44 - InjDll.exe——A Tool for DLL Injection"></a>Chapter 44 - InjDll.exe——A Tool for DLL Injection</h1><h1 id="Chapter-45-TLS-Callback-Function"><a href="#Chapter-45-TLS-Callback-Function" class="headerlink" title="Chapter 45 - TLS Callback Function"></a>Chapter 45 - TLS Callback Function</h1><p>From this point on, this book will introduce more advanced topics in reverse engineering.</p>
<p>Here, TLS stands for <strong>Thread Local Storage</strong>, instead of <strong>Transport Layer Security</strong> used in networking.</p>
<p>TLS Callback Function is commonly used in anti-debugging.</p>
<h2 id="45-1-Practice-1-HelloTls-exe"><a href="#45-1-Practice-1-HelloTls-exe" class="headerlink" title="45.1 - Practice#1 HelloTls.exe"></a>45.1 - Practice#1 HelloTls.exe</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.1.png'><img src="/images/books/ReverseEngineeringCore/45.1.png" width="500">
    <figcaption>
    Running HelloTls.exe
    </figcaption>
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.2.png'><img src="/images/books/ReverseEngineeringCore/45.2.png" width="500">
    <figcaption>
    Debugging HelloTls.exe
    </figcaption>
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.3.png'><img src="/images/books/ReverseEngineeringCore/45.3.png" width="700">
    <figcaption>
    OllyDbg: HelloTls.exe is terminated.
    </figcaption>
</p>

<h2 id="45-2-TLS"><a href="#45-2-TLS" class="headerlink" title="45.2 - TLS"></a>45.2 - TLS</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.4.png'><img src="/images/books/ReverseEngineeringCore/45.4.png" width="700">
    <figcaption>
    IMAGE_NT_HEADERS\IMAGE-OPTIOAL_HEADER\IMAGE_DATA_DIRECTORY[9] -> TLS Table
    </figcaption>
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_TLS_DIRECTORY64 &#123;<br>    ULONGLONG   StartAddressOfRawData;<br>    ULONGLONG   EndAddressOfRawData;<br>    ULONGLONG   AddressOfIndex;<br>    ULONGLONG   AddressOfCallBacks;<br>    DWORD       SizeOfZeroFill;<br>    DWORD       Characteristics;<br>&#125; IMAGE_TLS_DIRECTORY64, *PIMAGE_TLS_DIRECTORY64;<br><br>typedef struct _IMAGE_TLS_DIRECTORY32 &#123;<br>    DWORD   StartAddressOfRawData;<br>    DWORD   EndAddressOfRawData;<br>    DWORD   AddressOfIndex;<br>    DWORD   AddressOfCallBacks;<br>    DWORD   SizeOfZeroFill;<br>    DWORD   Characteristics;<br>&#125; IMAGE_TLS_DIRECTORY32, *PIMAGE_TLS_DIRECTORY32;<br><br>#ifdef _WIN64<br>typedef IMAGE_TLS_DIRECTORY64           IMAGE_TLS_DIRECTORY;<br>typedef PIMAGE_TLS_DIRECTORY64          PIMAGE_TLS_DIRECTORY;<br>#else<br>typedef IMAGE_TLS_DIRECTORY32           IMAGE_TLS_DIRECTORY;<br>typedef PIMAGE_TLS_DIRECTORY32          PIMAGE_TLS_DIRECTORY;<br>#endif<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.5.png'><img src="/images/books/ReverseEngineeringCore/45.5.png" width="700">
    <figcaption>
    IMAGE_TLS_DIRECTORY
    </figcaption>
</p>

<p><strong>AddressOfCallbacks</strong> stores an array of pointers which point to callback functions. It is a significant member in structure <strong>IMAGE_TLS_DIRECTORY</strong>. The array is ended with NULL value.</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.6.png'><img src="/images/books/ReverseEngineeringCore/45.6.png" width="700">
    <figcaption>
    PEView.exe: AddressOfCallbacks
    </figcaption>
</p>

<p>Notice that we can register multiple TLS callback functions by modifying the program, even though the original program contains only one TLS callback.</p>
<h2 id="45-3-TLS-Callback-Function"><a href="#45-3-TLS-Callback-Function" class="headerlink" title="45.3 - TLS Callback Function"></a>45.3 - TLS Callback Function</h2><p>A TLS callback function is invoked whenever a process thread is created or terminated.<br>When the main thread is created, the TLS callback is executed before the program’s entry point (EP).<br>This behavior can be leveraged for anti-debugging purposes.</p>
<p>Notice that the TLS callback function is invoked when the program is terminated.</p>
<h3 id="IMAGE-TLS-CALLBACK"><a href="#IMAGE-TLS-CALLBACK" class="headerlink" title="IMAGE_TLS_CALLBACK"></a>IMAGE_TLS_CALLBACK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef VOID (CALLBACK *PIMAGE_TLS_CALLBACK)(<br>	LPVOID DllHandle,<br>    DWORD Reason,<br>    LPVOID Reserved<br>);<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure>
<p>Notice that the definition of TLS callback function is similar to <strong>DllMain()</strong>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL WINAPI DllMain(<br>  _In_ HINSTANCE hinstDLL,<br>  _In_ DWORD     fdwReason,<br>  _In_ LPVOID    lpvReserved<br>);<br><br>//Source: https://learn.microsoft.com/en-us/windows/win32/dlls/dllmain<br></code></pre></td></tr></table></figure><br>The TLS callback function and DllMain() have the same parameter order.<br>For a callback function, DllHandle is the address of the module (its load address), and Reason indicates why the callback function is being invoked.</p>
<p>There are four possible values for Reason:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">/* Argument 1 passed to the DllEntryProc. */<br>#define	DLL_PROCESS_DETACH	0	/* detach process (unload library) */<br>#define	DLL_PROCESS_ATTACH	1	/* attach process (load library) */<br>#define	DLL_THREAD_ATTACH	2	/* attach new thread */<br>#define	DLL_THREAD_DETACH	3	/* detach thread */<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure></p>
<h2 id="45-4-Practice-2-TlsTest-exe"><a href="#45-4-Practice-2-TlsTest-exe" class="headerlink" title="45.4 - Practice#2 TlsTest.exe"></a>45.4 - Practice#2 TlsTest.exe</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &lt;windows.h&gt;<br><br>#pragma comment(linker, &quot;/INCLUDE:__tls_used&quot;)<br><br>void print_console(char* szMsg)<br>&#123;<br>    HANDLE hStdout = GetStdHandle(STD_OUTPUT_HANDLE);<br><br>    WriteConsoleA(hStdout, szMsg, strlen(szMsg), NULL, NULL);<br>&#125;<br><br>void NTAPI TLS_CALLBACK1(PVOID DllHandle, DWORD Reason, PVOID Reserved)<br>&#123;<br>    char szMsg[80] = &#123;0,&#125;;<br>    wsprintfA(szMsg, &quot;TLS_CALLBACK1() : DllHandle = %X, Reason = %d\n&quot;, DllHandle, Reason);<br>    print_console(szMsg);<br>&#125;<br><br>void NTAPI TLS_CALLBACK2(PVOID DllHandle, DWORD Reason, PVOID Reserved)<br>&#123;<br>    char szMsg[80] = &#123;0,&#125;;<br>    wsprintfA(szMsg, &quot;TLS_CALLBACK2() : DllHandle = %X, Reason = %d\n&quot;, DllHandle, Reason);<br>    print_console(szMsg);<br>&#125;<br><br>#pragma data_seg(&quot;.CRT$XLX&quot;)<br>    PIMAGE_TLS_CALLBACK pTLS_CALLBACKs[] = &#123; TLS_CALLBACK1, TLS_CALLBACK2, 0 &#125;;<br>#pragma data_seg()<br><br>DWORD WINAPI ThreadProc(LPVOID lParam)<br>&#123;<br>    print_console(&quot;ThreadProc() start\n&quot;);<br><br>    print_console(&quot;ThreadProc() end\n&quot;);<br><br>    return 0;<br>&#125;<br><br>int main(void)<br>&#123;<br>    HANDLE hThread = NULL;<br><br>    print_console(&quot;main() start\n&quot;);<br><br>    hThread = CreateThread(NULL, 0, ThreadProc, NULL, 0, NULL);<br>    WaitForSingleObject(hThread, 60*1000);<br>    CloseHandle(hThread);<br><br>    print_console(&quot;main() end\n&quot;);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>The calling order of TLS function:</p>
<ol>
<li>DLL_PROCESS_ATTACH</li>
<li>DLL_THREAD_ATTACH</li>
<li>DLL_THREAD_DETACH</li>
<li>DLL_PROCESS_DETACH</li>
</ol>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.7.png'><img src="/images/books/ReverseEngineeringCore/45.7.png" width="700">
    <figcaption>
    TlsTest.exe
    </figcaption>
</p>

<h2 id="45-5-Debugging-TLS-Callback-Function"><a href="#45-5-Debugging-TLS-Callback-Function" class="headerlink" title="45.5 - Debugging TLS Callback Function"></a>45.5 - Debugging TLS Callback Function</h2><p>Enable “System breakpoint”:</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.8.png'><img src="/images/books/ReverseEngineeringCore/45.8.png" width="700">
    <figcaption>
    Debugging options -> Events -> System breakpoint
    </figcaption>
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.9.png'><img src="/images/books/ReverseEngineeringCore/45.9.png" width="700">
</p>

<p>Or using <strong>Olly Advanced</strong>:</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.10.png'><img src="/images/books/ReverseEngineeringCore/45.10.png" width="500">
    <figcaption>
    Plugin -> Plly Advanced -> Anti-Debug 2 -> Break on TLS Callback
    </figcaption>
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.11.png'><img src="/images/books/ReverseEngineeringCore/45.11.png" width="700">
</p>

<h2 id="45-6-Manually-Add-TLS-Callback-Function"><a href="#45-6-Manually-Add-TLS-Callback-Function" class="headerlink" title="45.6 - Manually Add TLS Callback Function."></a>45.6 - Manually Add TLS Callback Function.</h2><p>Before modification:</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.12.png'><img src="/images/books/ReverseEngineeringCore/45.12.png" width="700">
</p>

<p>Modification:</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.12.png'><img src="/images/books/ReverseEngineeringCore/45.12.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.13.png'><img src="/images/books/ReverseEngineeringCore/45.13.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.14.png'><img src="/images/books/ReverseEngineeringCore/45.14.png" width="700">
    <figcaption>
    Modifying .rsrc section header.
    </figcaption>
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.15.png'><img src="/images/books/ReverseEngineeringCore/45.15.png" width="700">
    <figcaption>
    HxD: IMAGE_DATA_DIRECTORY
    </figcaption>
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.16.png'><img src="/images/books/ReverseEngineeringCore/45.16.png" width="700">
    <figcaption>
    PEView: IMAGE_DATA_DIRECTORY
    </figcaption>
</p>

<p>Write the assembly code:</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.17.png'><img src="/images/books/ReverseEngineeringCore/45.17.png" width="700">
    <figcaption>
    OllyDbg: Copy to executable -> Selection -> Save file.
    </figcaption>
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.18.png'><img src="/images/books/ReverseEngineeringCore/45.18.png" width="700">
    <figcaption>
    OllyDbg: Save file.
    </figcaption>
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.19.png'><img src="/images/books/ReverseEngineeringCore/45.19.png" width="500">
    <figcaption>
    Testing
    </figcaption>
</p>

<h1 id="Chapter-46-TEB"><a href="#Chapter-46-TEB" class="headerlink" title="Chapter 46 - TEB"></a>Chapter 46 - TEB</h1><p>TEB stands for <strong>Thread Environment Block</strong>.</p>
<p>We can view TEB structure using the following command in <strong>WinDbg</strong>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; dt _TEB<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/46.1.png'><img src="/images/books/ReverseEngineeringCore/46.1.png" width="700">
    <figcaption>
    Members of TEB
    </figcaption>
</p>

<p>There are two important members:</p>
<ol>
<li><strong>+0x030 ProcessEnvironmentBlock: Ptr32 _PEB</strong>\<br>This pointer points to PEB (Introduces in next chapter) .</li>
<li><strong>NtTib</strong>\<br>TIB stands for <strong>Thread Information Block</strong>, this is the definition of TIB:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _NT_TIB<br>&#123;<br>     struct _EXCEPTION_REGISTRATION_RECORD *ExceptionList;<br>     PVOID StackBase;<br>     PVOID StackLimit;<br>     PVOID SubSystemTib;<br>     union &#123;<br>         PVOID FiberData;<br>         DWORD Version;<br>     &#125; DUMMYUNIONNAME;<br>     PVOID ArbitraryUserPointer;<br>     struct _NT_TIB *Self;<br>&#125; NT_TIB, *PNT_TIB;<br></code></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="46-2-Accessing-TEB"><a href="#46-2-Accessing-TEB" class="headerlink" title="46.2 - Accessing TEB"></a>46.2 - Accessing TEB</h2><h3 id="Ntdll-NtCurrentTeb"><a href="#Ntdll-NtCurrentTeb" class="headerlink" title="Ntdll.NtCurrentTeb()"></a>Ntdll.NtCurrentTeb()</h3><h3 id="FS-Segment-Register"><a href="#FS-Segment-Register" class="headerlink" title="FS Segment Register"></a>FS Segment Register</h3><p>FS segment register indicates the TEB structure of the current thread.</p>
<ul>
<li>FS:[0x18] = start address of TEB<script type="math/tex; mode=display">
  \begin{align*}
  FS:[0x18] &= TEB.NtTib.Self\\
  &= Address of TIB\\
  &= Address of TEB FS:0 \\
  &= 7FFDF000
  \end{align*}</script></li>
<li>FS:[0X30] = start address of PEB<script type="math/tex; mode=display">
  \begin{align*}
  FS:[0x30] &= TEB.ProcessEnvironmentBlock\\
  &= Address of PEB
  \end{align*}</script></li>
<li>FS:[0] = start address of SEH<script type="math/tex; mode=display">
  \begin{align*}
  FS:[0] &= TEB.NtTib.ExceptionList\\
  &= Address of SEH
  \end{align*}</script></li>
</ul>
<h1 id="Chapter-47-PEB"><a href="#Chapter-47-PEB" class="headerlink" title="Chapter 47 - PEB"></a>Chapter 47 - PEB</h1><h2 id="47-1-PEB"><a href="#47-1-PEB" class="headerlink" title="47.1 - PEB"></a>47.1 - PEB</h2><h3 id="Accessing-PEB"><a href="#Accessing-PEB" class="headerlink" title="Accessing PEB"></a>Accessing PEB</h3><p>PEB stands for <strong>Process Environment Block</strong>.<br>PEB structure stores information of process.</p>
<p>We execute the following instruction in OllyDby (F7 or F8) at EP:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">MOV EAX,DWORD PTR FS:[0x30]<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/47.1.png'><img src="/images/books/ReverseEngineeringCore/47.1.png" width="700">
    <figcaption>
    EAX
    </figcaption>
</p>

<h3 id="Definition-of-PEB"><a href="#Definition-of-PEB" class="headerlink" title="Definition of PEB"></a>Definition of PEB</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _PEB &#123;<br>  BYTE                          Reserved1[2];<br>  BYTE                          BeingDebugged;<br>  BYTE                          Reserved2[1];<br>  PVOID                         Reserved3[2];<br>  PPEB_LDR_DATA                 Ldr;<br>  PRTL_USER_PROCESS_PARAMETERS  ProcessParameters;<br>  PVOID                         Reserved4[3];<br>  PVOID                         AtlThunkSListPtr;<br>  PVOID                         Reserved5;<br>  ULONG                         Reserved6;<br>  PVOID                         Reserved7;<br>  ULONG                         Reserved8;<br>  ULONG                         AtlThunkSListPtr32;<br>  PVOID                         Reserved9[45];<br>  BYTE                          Reserved10[96];<br>  PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine;<br>  BYTE                          Reserved11[128];<br>  PVOID                         Reserved12[1];<br>  ULONG                         SessionId;<br>&#125; PEB, *PPEB;<br></code></pre></td></tr></table></figure>
<h3 id="Members-of-PEB"><a href="#Members-of-PEB" class="headerlink" title="Members of PEB"></a>Members of PEB</h3><p><strong>Windows 10</strong></p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/47.2.png'><img src="/images/books/ReverseEngineeringCore/47.2.png" width="700">
    <figcaption>
    EAX
    </figcaption>
</p>

<h2 id="47-2-Important-Members"><a href="#47-2-Important-Members" class="headerlink" title="47.2 - Important Members"></a>47.2 - Important Members</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">+002 BeginDebugged : UChar<br>+008 ImageBaseAddress : Ptr32 Void<br>+00c Ldr : Ptr32 _PEB_LDR_DATA<br>+018 ProcessHeap : Ptr32 Void<br>+068 NtGlobalFlag : Uint4B<br></code></pre></td></tr></table></figure>
<ol>
<li>PEB.BeginDebugged:\<br>This value is commonly used in anti-debugging.</li>
<li>PEB.ImageBaseAddress:\<br>This value indicates the <strong>ImageBase</strong> of the process. We use <strong>GetModuleHandle()</strong> to obtain ImageBase.</li>
<li>PEB.Ldr:\<br>This member is a pointer that points to <strong>_PEB_LDR_DATA</strong> structure. After a DLL has been loaded into a process, we can obtain the ImageBase of the module through <code>PEB.Ldr</code>.</li>
<li>PEB.ProcessHeap &amp; PEB.NtGlobalFlag:\<br>These two values are commonly used in anti-debugging.</li>
</ol>
<h1 id="Chapter-48-SEH"><a href="#Chapter-48-SEH" class="headerlink" title="Chapter 48 - SEH"></a>Chapter 48 - SEH</h1><h2 id="48-1-SEH"><a href="#48-1-SEH" class="headerlink" title="48.1 - SEH"></a>48.1 - SEH</h2><p>SEH stands for <strong>Structured Exception Handling</strong>.</p>
<p>SEH is the exception handling mechanism used in Windows. In practice, we use keywords such as <code>__try</code>, <code>__except</code>, <code>__finally</code> to implement exception handling. Additionally, this mechanism is widely used in anti-debugging techniques.</p>
<p>Notice that the structure of SEH is different from the <code>try</code> / <code>catch</code> mechanism in C++. Windows introduced the SEH mechanism first, and it was later integrated into Visual C++. In other words, SEH is a low-level exception handling mechanism supported by the Windows operating system and the Visual C++ compiler.</p>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/48.1.png'><img src="/images/books/ReverseEngineeringCore/48.1.png" width="700">
    <figcaption>
    Exception.
    </figcaption>
</p>

<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/48.2.png'><img src="/images/books/ReverseEngineeringCore/48.2.png" width="700">
    <figcaption>
    Memory: Address 0 is undefined.
    </figcaption>
</p>

<h2 id="48-4-Exception"><a href="#48-4-Exception" class="headerlink" title="48.4 - Exception"></a>48.4 - Exception</h2><p>There are 5 types of common exceptions:</p>
<ol>
<li><strong>EXCEPTION_ACCESS_VIOLATION(C0000005)</strong></li>
<li><strong>EXCEPTION_BREAKPOINT(80000003)</strong></li>
<li><strong>EXCEPTION_ILLEGAL_INSTRUCTION(C000001D)</strong></li>
<li><strong>EXCEPTION_INT_DIVIDE_BY_ZERO(C0000094)</strong></li>
<li><strong>EXCEPTION_SINGLE_STEP(80000004)</strong></li>
</ol>
<h2 id="48-5-Details-of-SEH"><a href="#48-5-Details-of-SEH" class="headerlink" title="48.5 - Details of SEH"></a>48.5 - Details of SEH</h2><h3 id="SEH-Chain"><a href="#SEH-Chain" class="headerlink" title="SEH Chain"></a>SEH Chain</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _EXCEPTION_REGISTRATION_RECORD<br>&#123;<br>     PEXCEPTION_REGISTRATION_RECORD Next;<br>     PEXCEPTION_DISPOSITION Handler;<br>&#125; EXCEPTION_REGISTRATION_RECORD, *PEXCEPTION_REGISTRATION_RECORD;<br><br>//Source: https://maple19out.tistory.com/72<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/48.3.png'><img src="/images/books/ReverseEngineeringCore/48.3.png" width="700" alt="SEH Chain">
    <figcaption>
    Source: https://maple19out.tistory.com/72
    </figcaption>
</p>

<h3 id="Definition-of-Exception-Handler"><a href="#Definition-of-Exception-Handler" class="headerlink" title="Definition of Exception Handler"></a>Definition of Exception Handler</h3><h3 id="TEB-NtTib-ExceptionList"><a href="#TEB-NtTib-ExceptionList" class="headerlink" title="TEB.NtTib.ExceptionList"></a>TEB.NtTib.ExceptionList</h3><h3 id="Using-SEH"><a href="#Using-SEH" class="headerlink" title="Using SEH"></a>Using SEH</h3><h2 id="48-6-Practice-2-seh-exe"><a href="#48-6-Practice-2-seh-exe" class="headerlink" title="48.6 - Practice#2 - seh.exe"></a>48.6 - Practice#2 - seh.exe</h2><h1 id="Chapter-49-IA-32-Instruction"><a href="#Chapter-49-IA-32-Instruction" class="headerlink" title="Chapter 49 - IA-32 Instruction"></a>Chapter 49 - IA-32 Instruction</h1><h2 id="49-2-Terminology"><a href="#49-2-Terminology" class="headerlink" title="49.2 - Terminology"></a>49.2 - Terminology</h2><div class="table-container">
<table>
<thead>
<tr>
<th>Terminology</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Machine Language</td>
</tr>
<tr>
<td>Instruction</td>
</tr>
<tr>
<td>OpCode</td>
</tr>
<tr>
<td>Assembly</td>
</tr>
<tr>
<td>Assemble</td>
</tr>
<tr>
<td>Assembler</td>
</tr>
<tr>
<td>Disassemble</td>
</tr>
<tr>
<td>Disassembler</td>
</tr>
<tr>
<td>Disassembly</td>
</tr>
<tr>
<td>*Compile</td>
</tr>
<tr>
<td>*Link</td>
</tr>
</tbody>
</table>
</div>
<h2 id="49-3-IA-32-Instruction-Format"><a href="#49-3-IA-32-Instruction-Format" class="headerlink" title="49.3 - IA-32 Instruction Format"></a>49.3 - IA-32 Instruction Format</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/49.1.png'><img src="/images/books/ReverseEngineeringCore/49.1.png" width="700" alt="IA-32 Format">
    <figcaption>
    Source: https://www.researchgate.net/figure/A-32-general-instruction-format_fig1_265265229
    </figcaption>
</p>

<h3 id="Instruction-Prefix"><a href="#Instruction-Prefix" class="headerlink" title="Instruction Prefix"></a>Instruction Prefix</h3><h3 id="Opcode"><a href="#Opcode" class="headerlink" title="Opcode"></a>Opcode</h3><h3 id="ModR-M"><a href="#ModR-M" class="headerlink" title="ModR/M"></a>ModR/M</h3><h3 id="SIB"><a href="#SIB" class="headerlink" title="SIB"></a>SIB</h3><p>SIB (Scale-Index-Base) is also an optional field.</p>
<h3 id="Deplacement"><a href="#Deplacement" class="headerlink" title="Deplacement"></a>Deplacement</h3><h3 id="Immediate"><a href="#Immediate" class="headerlink" title="Immediate"></a>Immediate</h3><h2 id="49-4-Instruction-Analyzing"><a href="#49-4-Instruction-Analyzing" class="headerlink" title="49.4 - Instruction Analyzing"></a>49.4 - Instruction Analyzing</h2><h2 id="49-5-Practice"><a href="#49-5-Practice" class="headerlink" title="49.5 - Practice"></a>49.5 - Practice</h2><h1 id="Chapter-50-Anti-Debugging"><a href="#Chapter-50-Anti-Debugging" class="headerlink" title="Chapter 50 - Anti-Debugging"></a>Chapter 50 - Anti-Debugging</h1><h2 id="50-1-Anti-Debugging"><a href="#50-1-Anti-Debugging" class="headerlink" title="50.1 Anti-Debugging"></a>50.1 Anti-Debugging</h2><p>Anti-Debugging techniques are strongly dependent to OS and debugger.</p>
<h2 id="50-2-Anti-Anti-Debugging"><a href="#50-2-Anti-Anti-Debugging" class="headerlink" title="50.2 - Anti-Anti-Debugging"></a>50.2 - Anti-Anti-Debugging</h2><h2 id="50-3-Types-of-Anti-Debugging"><a href="#50-3-Types-of-Anti-Debugging" class="headerlink" title="50.3 - Types of Anti-Debugging"></a>50.3 - Types of Anti-Debugging</h2><h3 id="Static-Anti-Debugging"><a href="#Static-Anti-Debugging" class="headerlink" title="Static Anti-Debugging"></a>Static Anti-Debugging</h3><p><strong>Static anti-debugging</strong> is used to detect a debugger. If a debugger is detected, the process cannot execute normally. Once the static anti-debugging technique is cracked, the program can execute normally.</p>
<h3 id="Dynamic-Anti-Debugging"><a href="#Dynamic-Anti-Debugging" class="headerlink" title="Dynamic Anti-Debugging"></a>Dynamic Anti-Debugging</h3><p>Even though we have cracked the static anti-debugging technique, we may still encounter difficulties. If a dynamic anti-debugging technique is applied, it becomes difficult to trace instructions because this technique interferes with the debugger.</p>
<h1 id="Chapter-51-Static-Anti-Debugging-Techniques"><a href="#Chapter-51-Static-Anti-Debugging-Techniques" class="headerlink" title="Chapter 51 - Static Anti-Debugging Techniques"></a>Chapter 51 - Static Anti-Debugging Techniques</h1><h2 id="51-2-PEB"><a href="#51-2-PEB" class="headerlink" title="51.2 - PEB"></a>51.2 - PEB</h2><p>PEB is used for detecting a debugger. It provides reliable and convenient information. This technique is commonly used in anti-debugging.</p>
<h3 id="BeingDebugged-0x2"><a href="#BeingDebugged-0x2" class="headerlink" title="BeingDebugged (+0x2)"></a>BeingDebugged (+0x2)</h3><h3 id="Ldr-0xC"><a href="#Ldr-0xC" class="headerlink" title="Ldr (+0xC)"></a>Ldr (+0xC)</h3><h3 id="Process-Heap-0x18"><a href="#Process-Heap-0x18" class="headerlink" title="Process Heap (+0x18)"></a>Process Heap (+0x18)</h3><ul>
<li>GetPocessHeap()</li>
<li>Flags (+0xC) &amp; Force Flags (+0x10)</li>
</ul>
<h3 id="NtGlobalFlag-0x68"><a href="#NtGlobalFlag-0x68" class="headerlink" title="NtGlobalFlag (+0x68)"></a>NtGlobalFlag (+0x68)</h3><h2 id="51-3-NtQueryInformationProcess"><a href="#51-3-NtQueryInformationProcess" class="headerlink" title="51.3 - NtQueryInformationProcess()"></a>51.3 - NtQueryInformationProcess()</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">__kernel_entry NTSTATUS NtQueryInformationProcess(<br>  [in]            HANDLE           ProcessHandle,<br>  [in]            PROCESSINFOCLASS ProcessInformationClass,<br>  [out]           PVOID            ProcessInformation,<br>  [in]            ULONG            ProcessInformationLength,<br>  [out, optional] PULONG           ReturnLength<br>);<br><br>//Source: https://learn.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntqueryinformationprocess<br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef enum _PROCESSINFOCLASS<br>&#123;<br>    ProcessBasicInformation,                        // q: PROCESS_BASIC_INFORMATION, PROCESS_EXTENDED_BASIC_INFORMATION<br>    ProcessQuotaLimits,                             // qs: QUOTA_LIMITS, QUOTA_LIMITS_EX<br>    ProcessIoCounters,                              // q: IO_COUNTERS<br>    ProcessVmCounters,                              // q: VM_COUNTERS, VM_COUNTERS_EX, VM_COUNTERS_EX2<br>    ProcessTimes,                                   // q: KERNEL_USER_TIMES<br>    ProcessBasePriority,                            // s: KPRIORITY<br>    ProcessRaisePriority,                           // s: ULONG<br>    ProcessDebugPort,                               // q: HANDLE<br>    ProcessExceptionPort,                           // s: PROCESS_EXCEPTION_PORT (requires SeTcbPrivilege)<br>    ProcessAccessToken,                             // s: PROCESS_ACCESS_TOKEN<br>    ProcessLdtInformation,                          // qs: PROCESS_LDT_INFORMATION // 10<br>    ProcessLdtSize,                                 // s: PROCESS_LDT_SIZE<br>    ProcessDefaultHardErrorMode,                    // qs: ULONG<br>    ProcessIoPortHandlers,                          // s: PROCESS_IO_PORT_HANDLER_INFORMATION // (kernel-mode only)<br>    ProcessPooledUsageAndLimits,                    // q: POOLED_USAGE_AND_LIMITS<br>    ProcessWorkingSetWatch,                         // q: PROCESS_WS_WATCH_INFORMATION[]; s: void<br>    ProcessUserModeIOPL,                            // qs: ULONG (requires SeTcbPrivilege)<br>    ProcessEnableAlignmentFaultFixup,               // s: BOOLEAN<br>    ProcessPriorityClass,                           // qs: PROCESS_PRIORITY_CLASS<br>    ProcessWx86Information,                         // qs: ULONG (requires SeTcbPrivilege) (VdmAllowed)<br>    ProcessHandleCount,                             // q: ULONG, PROCESS_HANDLE_INFORMATION // 20<br>    ProcessAffinityMask,                            // qs: KAFFINITY, qs: GROUP_AFFINITY<br>    ProcessPriorityBoost,                           // qs: ULONG<br>    ProcessDeviceMap,                               // qs: PROCESS_DEVICEMAP_INFORMATION, PROCESS_DEVICEMAP_INFORMATION_EX<br>    ProcessSessionInformation,                      // q: PROCESS_SESSION_INFORMATION<br>    ProcessForegroundInformation,                   // s: PROCESS_FOREGROUND_BACKGROUND<br>    ProcessWow64Information,                        // q: ULONG_PTR<br>    ProcessImageFileName,                           // q: UNICODE_STRING<br>    ProcessLUIDDeviceMapsEnabled,                   // q: ULONG<br>    ProcessBreakOnTermination,                      // qs: ULONG<br>    ProcessDebugObjectHandle,                       // q: HANDLE // 30<br>    ProcessDebugFlags,                              // qs: ULONG<br>    ProcessHandleTracing,                           // q: PROCESS_HANDLE_TRACING_QUERY; s: PROCESS_HANDLE_TRACING_ENABLE[_EX] or void to disable<br>    ProcessIoPriority,                              // qs: IO_PRIORITY_HINT<br>    ProcessExecuteFlags,                            // qs: ULONG (MEM_EXECUTE_OPTION_*)<br>    ProcessTlsInformation,                          // qs: PROCESS_TLS_INFORMATION // ProcessResourceManagement<br>    ProcessCookie,                                  // q: ULONG<br>    ProcessImageInformation,                        // q: SECTION_IMAGE_INFORMATION<br>    ProcessCycleTime,                               // q: PROCESS_CYCLE_TIME_INFORMATION // since VISTA<br>    ProcessPagePriority,                            // qs: PAGE_PRIORITY_INFORMATION<br>    ProcessInstrumentationCallback,                 // s: PVOID or PROCESS_INSTRUMENTATION_CALLBACK_INFORMATION // 40<br>    ProcessThreadStackAllocation,                   // s: PROCESS_STACK_ALLOCATION_INFORMATION, PROCESS_STACK_ALLOCATION_INFORMATION_EX<br>    ProcessWorkingSetWatchEx,                       // q: PROCESS_WS_WATCH_INFORMATION_EX[]; s: void<br>    ProcessImageFileNameWin32,                      // q: UNICODE_STRING<br>    ProcessImageFileMapping,                        // q: HANDLE (input)<br>    ProcessAffinityUpdateMode,                      // qs: PROCESS_AFFINITY_UPDATE_MODE<br>    ProcessMemoryAllocationMode,                    // qs: PROCESS_MEMORY_ALLOCATION_MODE<br>    ProcessGroupInformation,                        // q: USHORT[]<br>    ProcessTokenVirtualizationEnabled,              // s: ULONG<br>    ProcessConsoleHostProcess,                      // qs: ULONG_PTR // ProcessOwnerInformation<br>    ProcessWindowInformation,                       // q: PROCESS_WINDOW_INFORMATION // 50<br>    ProcessHandleInformation,                       // q: PROCESS_HANDLE_SNAPSHOT_INFORMATION // since WIN8<br>    ProcessMitigationPolicy,                        // s: PROCESS_MITIGATION_POLICY_INFORMATION<br>    ProcessDynamicFunctionTableInformation,         // s: PROCESS_DYNAMIC_FUNCTION_TABLE_INFORMATION<br>    ProcessHandleCheckingMode,                      // qs: ULONG; s: 0 disables, otherwise enables<br>    ProcessKeepAliveCount,                          // q: PROCESS_KEEPALIVE_COUNT_INFORMATION<br>    ProcessRevokeFileHandles,                       // s: PROCESS_REVOKE_FILE_HANDLES_INFORMATION<br>    ProcessWorkingSetControl,                       // s: PROCESS_WORKING_SET_CONTROL<br>    ProcessHandleTable,                             // q: ULONG[] // since WINBLUE<br>    ProcessCheckStackExtentsMode,                   // qs: ULONG // KPROCESS-&gt;CheckStackExtents (CFG)<br>    ProcessCommandLineInformation,                  // q: UNICODE_STRING // 60<br>    ProcessProtectionInformation,                   // q: PS_PROTECTION<br>    ProcessMemoryExhaustion,                        // s: PROCESS_MEMORY_EXHAUSTION_INFO // since THRESHOLD<br>    ProcessFaultInformation,                        // s: PROCESS_FAULT_INFORMATION<br>    ProcessTelemetryIdInformation,                  // q: PROCESS_TELEMETRY_ID_INFORMATION<br>    ProcessCommitReleaseInformation,                // qs: PROCESS_COMMIT_RELEASE_INFORMATION<br>    ProcessDefaultCpuSetsInformation,               // qs: SYSTEM_CPU_SET_INFORMATION[5] // ProcessReserved1Information<br>    ProcessAllowedCpuSetsInformation,               // qs: SYSTEM_CPU_SET_INFORMATION[5] // ProcessReserved2Information<br>    ProcessSubsystemProcess,                        // s: void // EPROCESS-&gt;SubsystemProcess<br>    ProcessJobMemoryInformation,                    // q: PROCESS_JOB_MEMORY_INFO<br>    ProcessInPrivate,                               // q: BOOLEAN; s: void // ETW // since THRESHOLD2 // 70<br>    ProcessRaiseUMExceptionOnInvalidHandleClose,    // qs: ULONG; s: 0 disables, otherwise enables<br>    ProcessIumChallengeResponse,                    // q: PROCESS_IUM_CHALLENGE_RESPONSE<br>    ProcessChildProcessInformation,                 // q: PROCESS_CHILD_PROCESS_INFORMATION<br>    ProcessHighGraphicsPriorityInformation,         // q: BOOLEAN; s: BOOLEAN (requires SeTcbPrivilege)<br>    ProcessSubsystemInformation,                    // q: SUBSYSTEM_INFORMATION_TYPE // since REDSTONE2<br>    ProcessEnergyValues,                            // q: PROCESS_ENERGY_VALUES, PROCESS_EXTENDED_ENERGY_VALUES, PROCESS_EXTENDED_ENERGY_VALUES_V1<br>    ProcessPowerThrottlingState,                    // qs: POWER_THROTTLING_PROCESS_STATE<br>    ProcessActivityThrottlePolicy,                  // qs: PROCESS_ACTIVITY_THROTTLE_POLICY // ProcessReserved3Information<br>    ProcessWin32kSyscallFilterInformation,          // q: WIN32K_SYSCALL_FILTER<br>    ProcessDisableSystemAllowedCpuSets,             // s: BOOLEAN // 80<br>    ProcessWakeInformation,                         // q: PROCESS_WAKE_INFORMATION // (kernel-mode only)<br>    ProcessEnergyTrackingState,                     // qs: PROCESS_ENERGY_TRACKING_STATE<br>    ProcessManageWritesToExecutableMemory,          // s: MANAGE_WRITES_TO_EXECUTABLE_MEMORY // since REDSTONE3<br>    ProcessCaptureTrustletLiveDump,                 // q: ULONG<br>    ProcessTelemetryCoverage,                       // q: TELEMETRY_COVERAGE_HEADER; s: TELEMETRY_COVERAGE_POINT<br>    ProcessEnclaveInformation,<br>    ProcessEnableReadWriteVmLogging,                // qs: PROCESS_READWRITEVM_LOGGING_INFORMATION<br>    ProcessUptimeInformation,                       // q: PROCESS_UPTIME_INFORMATION<br>    ProcessImageSection,                            // q: HANDLE<br>    ProcessDebugAuthInformation,                    // s: CiTool.exe --device-id // PplDebugAuthorization // since RS4 // 90<br>    ProcessSystemResourceManagement,                // s: PROCESS_SYSTEM_RESOURCE_MANAGEMENT<br>    ProcessSequenceNumber,                          // q: ULONGLONG<br>    ProcessLoaderDetour,                            // qs: Obsolete // since RS5<br>    ProcessSecurityDomainInformation,               // q: PROCESS_SECURITY_DOMAIN_INFORMATION<br>    ProcessCombineSecurityDomainsInformation,       // s: PROCESS_COMBINE_SECURITY_DOMAINS_INFORMATION<br>    ProcessEnableLogging,                           // qs: PROCESS_LOGGING_INFORMATION<br>    ProcessLeapSecondInformation,                   // qs: PROCESS_LEAP_SECOND_INFORMATION<br>    ProcessFiberShadowStackAllocation,              // s: PROCESS_FIBER_SHADOW_STACK_ALLOCATION_INFORMATION // since 19H1<br>    ProcessFreeFiberShadowStackAllocation,          // s: PROCESS_FREE_FIBER_SHADOW_STACK_ALLOCATION_INFORMATION<br>    ProcessAltSystemCallInformation,                // s: PROCESS_SYSCALL_PROVIDER_INFORMATION // since 20H1 // 100<br>    ProcessDynamicEHContinuationTargets,            // s: PROCESS_DYNAMIC_EH_CONTINUATION_TARGETS_INFORMATION<br>    ProcessDynamicEnforcedCetCompatibleRanges,      // s: PROCESS_DYNAMIC_ENFORCED_ADDRESS_RANGE_INFORMATION // since 20H2<br>    ProcessCreateStateChange,                       // s: Obsolete // since WIN11<br>    ProcessApplyStateChange,                        // s: Obsolete<br>    ProcessEnableOptionalXStateFeatures,            // s: ULONG64 // EnableProcessOptionalXStateFeatures<br>    ProcessAltPrefetchParam,                        // qs: OVERRIDE_PREFETCH_PARAMETER // App Launch Prefetch (ALPF) // since 22H1<br>    ProcessAssignCpuPartitions,                     // s: HANDLE<br>    ProcessPriorityClassEx,                         // s: PROCESS_PRIORITY_CLASS_EX<br>    ProcessMembershipInformation,                   // q: PROCESS_MEMBERSHIP_INFORMATION<br>    ProcessEffectiveIoPriority,                     // q: IO_PRIORITY_HINT // 110<br>    ProcessEffectivePagePriority,                   // q: ULONG<br>    ProcessSchedulerSharedData,                     // q: SCHEDULER_SHARED_DATA_SLOT_INFORMATION // since 24H2<br>    ProcessSlistRollbackInformation,<br>    ProcessNetworkIoCounters,                       // q: PROCESS_NETWORK_COUNTERS<br>    ProcessFindFirstThreadByTebValue,               // q: PROCESS_TEB_VALUE_INFORMATION // NtCurrentProcess<br>    ProcessEnclaveAddressSpaceRestriction,          // qs: // since 25H2<br>    ProcessAvailableCpus,                           // q: PROCESS_AVAILABLE_CPUS_INFORMATION<br>    MaxProcessInfoClass<br>&#125; PROCESSINFOCLASS;<br><br>//Source: https://ntdoc.m417z.com/processinfoclass<br></code></pre></td></tr></table></figure>
<h3 id="ProcessDebugPort-0x7"><a href="#ProcessDebugPort-0x7" class="headerlink" title="ProcessDebugPort(0x7)"></a>ProcessDebugPort(0x7)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">DWORD dwDebugPort = 0;<br>pNtQueryInformationProcess(GetCurrentProcess(), ProcessDebugPort, &amp;dwDebugPort, sizeof(dwDebugPort), NULL);<br>printf(&quot;NtQueryInformationProcess(PorcessDebugPort) = 0x%X\n&quot;, dwDebugPort);<br>if (dwDebugPort != 0x0)<br>    printf(&quot;\t=&gt; Debugging.\n&quot;);<br>else<br>    printf(&quot;\t=&gt; Not debugging.\n&quot;);<br></code></pre></td></tr></table></figure>
<p><strong>CheckRemoteDebuggerPresent()</strong></p>
<h3 id="ProcessDebugObjectHandle-0x1E"><a href="#ProcessDebugObjectHandle-0x1E" class="headerlink" title="ProcessDebugObjectHandle(0x1E)"></a>ProcessDebugObjectHandle(0x1E)</h3><h3 id="ProcessDebugFlags-0x1F"><a href="#ProcessDebugFlags-0x1F" class="headerlink" title="ProcessDebugFlags(0x1F)"></a>ProcessDebugFlags(0x1F)</h3><h2 id="51-4-NtQuerySystemInformation"><a href="#51-4-NtQuerySystemInformation" class="headerlink" title="51.4 - NtQuerySystemInformation()"></a>51.4 - NtQuerySystemInformation()</h2><h2 id="51-5-NtQueryObject"><a href="#51-5-NtQueryObject" class="headerlink" title="51.5 - NtQueryObject()"></a>51.5 - NtQueryObject()</h2><h2 id="51-6-ZwSetInformationThread"><a href="#51-6-ZwSetInformationThread" class="headerlink" title="51.6 - ZwSetInformationThread()"></a>51.6 - ZwSetInformationThread()</h2><h2 id="51-7-TLS-Callback-Function"><a href="#51-7-TLS-Callback-Function" class="headerlink" title="51.7 - TLS Callback Function"></a>51.7 - TLS Callback Function</h2><h2 id="51-8-ETC"><a href="#51-8-ETC" class="headerlink" title="51.8 - ETC"></a>51.8 - ETC</h2><h1 id="Chapter-52-Dynamic-Anti-Debugging-Techniques"><a href="#Chapter-52-Dynamic-Anti-Debugging-Techniques" class="headerlink" title="Chapter 52 - Dynamic Anti-Debugging Techniques"></a>Chapter 52 - Dynamic Anti-Debugging Techniques</h1><h2 id="52-2-Exception"><a href="#52-2-Exception" class="headerlink" title="52.2 - Exception"></a>52.2 - Exception</h2><h3 id="SEH"><a href="#SEH" class="headerlink" title="SEH"></a>SEH</h3><h3 id="SetUnhandledExceptionFilter"><a href="#SetUnhandledExceptionFilter" class="headerlink" title="SetUnhandledExceptionFilter()"></a>SetUnhandledExceptionFilter()</h3><h2 id="52-3-Time-Checking"><a href="#52-3-Time-Checking" class="headerlink" title="52.3 - Time Checking"></a>52.3 - Time Checking</h2><h3 id="Interval"><a href="#Interval" class="headerlink" title="Interval"></a>Interval</h3><ol>
<li>COunter based method</li>
<li>Time based method</li>
</ol>
<h3 id="RDTSC"><a href="#RDTSC" class="headerlink" title="RDTSC"></a>RDTSC</h3><h2 id="52-4-Trap-Flag"><a href="#52-4-Trap-Flag" class="headerlink" title="52.4 - Trap Flag"></a>52.4 - Trap Flag</h2><h2 id="52-5-0xCC"><a href="#52-5-0xCC" class="headerlink" title="52.5 - 0xCC"></a>52.5 - 0xCC</h2><h1 id="Chapter-53-Advanced-Anti-Debugging"><a href="#Chapter-53-Advanced-Anti-Debugging" class="headerlink" title="Chapter 53 - Advanced Anti-Debugging"></a>Chapter 53 - Advanced Anti-Debugging</h1><h2 id="53-1-Advanced-Anti-Debugging"><a href="#53-1-Advanced-Anti-Debugging" class="headerlink" title="53.1 - Advanced Anti-Debugging"></a>53.1 - Advanced Anti-Debugging</h2><h2 id="53-2-Garbage-Code"><a href="#53-2-Garbage-Code" class="headerlink" title="53.2 - Garbage Code"></a>53.2 - Garbage Code</h2><h2 id="53-3-Breaking-Code-Alignment"><a href="#53-3-Breaking-Code-Alignment" class="headerlink" title="53.3 - Breaking Code Alignment"></a>53.3 - Breaking Code Alignment</h2><h2 id="53-4-Encryption-Decription"><a href="#53-4-Encryption-Decription" class="headerlink" title="53.4 - Encryption/Decription"></a>53.4 - Encryption/Decription</h2><h2 id="53-5-Stolen-Bytes-Remove-OEP"><a href="#53-5-Stolen-Bytes-Remove-OEP" class="headerlink" title="53.5 - Stolen Bytes (Remove OEP)"></a>53.5 - Stolen Bytes (Remove OEP)</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/53.5.png'><img src="/images/books/ReverseEngineeringCore/53.5.png" width="700" alt="Stolen Bytes">
</p>

<h2 id="53-6-API-Relocation"><a href="#53-6-API-Relocation" class="headerlink" title="53.6 - API Relocation"></a>53.6 - API Relocation</h2><h2 id="53-7-Debug-Blocker-Self-Debugging"><a href="#53-7-Debug-Blocker-Self-Debugging" class="headerlink" title="53.7 - Debug Blocker (Self Debugging)"></a>53.7 - Debug Blocker (Self Debugging)</h2><h1 id="Chapter-54-Practice-1-Service"><a href="#Chapter-54-Practice-1-Service" class="headerlink" title="Chapter 54 - Practice#1: Service"></a>Chapter 54 - Practice#1: Service</h1><h1 id="Chapter-55-Practice-2-Self-Creation"><a href="#Chapter-55-Practice-2-Self-Creation" class="headerlink" title="Chapter 55 - Practice#2: Self Creation"></a>Chapter 55 - Practice#2: Self Creation</h1><h1 id="Chapter-56-Practice-3-PE-Image-Switching"><a href="#Chapter-56-Practice-3-PE-Image-Switching" class="headerlink" title="Chapter 56 - Practice#3: PE Image Switching"></a>Chapter 56 - Practice#3: PE Image Switching</h1><h1 id="Chapter-57-Practice-4-Debug-Blocker"><a href="#Chapter-57-Practice-4-Debug-Blocker" class="headerlink" title="Chapter 57 - Practice#4: Debug Blocker"></a>Chapter 57 - Practice#4: Debug Blocker</h1><h1 id="THANKS-FOR-READING"><a href="#THANKS-FOR-READING" class="headerlink" title="THANKS FOR READING"></a>THANKS FOR READING</h1><p align="center" class='item-img' data-src='/images/meme/mika_nagisa_rollcake.gif'><img src="/images/meme/mika_nagisa_rollcake.gif" width="500">
</p><div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2026/01/05/2026-1-5-ProgrammingRust/">← Next [Book] Programming Rust</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2026/01/02/2026-1-2-NotePrivilegeEscalationTechnique/">[Book] Privilege Escalation - Offensive and Defensive Tactics and Techniques Prev →</a></div></div></div></div><div class="bottom-btn"><div><a id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a id="to-index" href="#toc-div" title="To Catalog">≡</a><a id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://avatars.githubusercontent.com/u/110074064?v=4" alt="Logo"></a><h1 id="Dr"><a href="/">ISSAC</a></h1><div id="description"><p>Everything is failing...</p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/iss4cf0ng/"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" target="_blank" rel="noopener" href="https://gist.github.com/iss4cf0ng/"><i class="fab fa-code-branch" alt="Gist"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#El-libro"><span class="toc-number">1.</span> <span class="toc-text">El libro</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">2.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reflection"><span class="toc-number">3.</span> <span class="toc-text">Reflection</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-1-Reverse-Engineering"><span class="toc-number">4.</span> <span class="toc-text">Chapter 1 - Reverse Engineering</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-2-Hello-World"><span class="toc-number">5.</span> <span class="toc-text">Chapter 2 - Hello World!</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-Debugging"><span class="toc-number">5.1.</span> <span class="toc-text">2.2 - Debugging</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-Getting-Familar-with-Debugger"><span class="toc-number">5.2.</span> <span class="toc-text">2.3 - Getting Familar with Debugger</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-Find-a-Specific-Code"><span class="toc-number">5.3.</span> <span class="toc-text">2.4 - Find a Specific Code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-Patching-the-Code"><span class="toc-number">5.4.</span> <span class="toc-text">2.5 - Patching the Code</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-3-Little-Endian"><span class="toc-number">6.</span> <span class="toc-text">Chapter 3 - Little Endian</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-4-IA-32-Registers"><span class="toc-number">7.</span> <span class="toc-text">Chapter 4 - IA-32 Registers</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-IA-32-Registers"><span class="toc-number">7.1.</span> <span class="toc-text">4.2 - IA-32 Registers</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-5-Stack"><span class="toc-number">8.</span> <span class="toc-text">Chapter 5 - Stack</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-6-Analyzing-abex%E2%80%99-crackme-1"><span class="toc-number">9.</span> <span class="toc-text">Chapter 6 - Analyzing abex’ crackme#1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Patching-Cracking"><span class="toc-number">9.1.</span> <span class="toc-text">Patching (Cracking)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-7-Stack-Frame"><span class="toc-number">10.</span> <span class="toc-text">Chapter 7 - Stack Frame</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-Stack-Frame"><span class="toc-number">10.1.</span> <span class="toc-text">7.1 - Stack Frame</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-8-abex%E2%80%99-crackme-2"><span class="toc-number">11.</span> <span class="toc-text">Chapter 8 - abex’ crackme#2</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-VB-Engine"><span class="toc-number">11.1.</span> <span class="toc-text">8.2 - VB Engine</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-Debugging"><span class="toc-number">11.2.</span> <span class="toc-text">8.3 - Debugging</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Indirect-Call"><span class="toc-number">11.2.1.</span> <span class="toc-text">Indirect Call</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RT-MainStruct"><span class="toc-number">11.2.2.</span> <span class="toc-text">RT_MainStruct</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ThunRTMain"><span class="toc-number">11.2.3.</span> <span class="toc-text">ThunRTMain()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-4-Analyzing-crackme"><span class="toc-number">11.3.</span> <span class="toc-text">8.4 - Analyzing crackme</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-9-Process-Explorer"><span class="toc-number">12.</span> <span class="toc-text">Chapter 9 - Process Explorer</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-10-Calling-Convention"><span class="toc-number">13.</span> <span class="toc-text">Chapter 10 - Calling Convention</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#cdecl"><span class="toc-number">13.1.</span> <span class="toc-text">cdecl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stdcall"><span class="toc-number">13.2.</span> <span class="toc-text">stdcall</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fastcall"><span class="toc-number">13.3.</span> <span class="toc-text">fastcall</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-11-Lenas-Reversing-for-Newbies"><span class="toc-number">14.</span> <span class="toc-text">Chapter 11 - Lenas Reversing for Newbies</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-12-How-to-Learn-Reverse-Engineering"><span class="toc-number">15.</span> <span class="toc-text">Chapter 12 - How to Learn Reverse Engineering</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-13-PE-File-Format"><span class="toc-number">16.</span> <span class="toc-text">Chapter 13 - PE File Format</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#13-2-PE-File-Format"><span class="toc-number">16.1.</span> <span class="toc-text">13.2 - PE File Format</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#VA-amp-RVA"><span class="toc-number">16.1.1.</span> <span class="toc-text">VA &amp; RVA</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-3-PE-Header"><span class="toc-number">16.2.</span> <span class="toc-text">13.3 - PE Header</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DOS-Header"><span class="toc-number">16.2.1.</span> <span class="toc-text">DOS Header</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DOS-Stub"><span class="toc-number">16.2.2.</span> <span class="toc-text">DOS Stub</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NT-Header"><span class="toc-number">16.2.3.</span> <span class="toc-text">NT Header</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NT-Header-File-Header"><span class="toc-number">16.2.4.</span> <span class="toc-text">NT Header: File Header</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NT-Header-Optional-Header"><span class="toc-number">16.2.5.</span> <span class="toc-text">NT Header: Optional Header</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Section-Header"><span class="toc-number">16.2.6.</span> <span class="toc-text">Section Header</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-4-RVA-to-RAW"><span class="toc-number">16.3.</span> <span class="toc-text">13.4 - RVA to RAW</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Quiz"><span class="toc-number">16.3.1.</span> <span class="toc-text">Quiz</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-5-IAT"><span class="toc-number">16.4.</span> <span class="toc-text">13.5 - IAT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DLL"><span class="toc-number">16.4.1.</span> <span class="toc-text">DLL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IMAGE-IMPORT-DESCRIPTOR"><span class="toc-number">16.4.2.</span> <span class="toc-text">IMAGE_IMPORT_DESCRIPTOR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Load-into-IAT"><span class="toc-number">16.4.3.</span> <span class="toc-text">Load into IAT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Practice"><span class="toc-number">16.4.4.</span> <span class="toc-text">Practice</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-6-EAT"><span class="toc-number">16.5.</span> <span class="toc-text">13.6 - EAT</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-16-Base-Relocation-Table"><span class="toc-number">17.</span> <span class="toc-text">Chapter 16 - Base Relocation Table</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#16-1-PE-Relocation"><span class="toc-number">17.1.</span> <span class="toc-text">16.1 - PE Relocation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16-2-The-Operations-of-PE-Relocation"><span class="toc-number">17.2.</span> <span class="toc-text">16.2 - The Operations of PE Relocation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16-3-The-Principles-of-PE-Relocation"><span class="toc-number">17.3.</span> <span class="toc-text">16.3 - The Principles of PE Relocation</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-17-Remove-reloc-Section-from-Executable"><span class="toc-number">18.</span> <span class="toc-text">Chapter 17 - Remove .reloc Section from Executable</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-18-Analyzing-UPackPE-Header"><span class="toc-number">19.</span> <span class="toc-text">Chapter 18 - Analyzing UPackPE Header</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-19-UPackPE-Debugging-Find-the-OEP"><span class="toc-number">20.</span> <span class="toc-text">Chapter 19 - UPackPE Debugging - Find the OEP</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-20-Patching"><span class="toc-number">21.</span> <span class="toc-text">Chapter 20 - Patching</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-21-Windows-Message-Hooking"><span class="toc-number">22.</span> <span class="toc-text">Chapter 21 - Windows Message Hooking</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#21-2-Message-Hooking"><span class="toc-number">22.1.</span> <span class="toc-text">21.2 - Message Hooking</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21-3-SetWindowsHookEx"><span class="toc-number">22.2.</span> <span class="toc-text">21.3 - SetWindowsHookEx()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21-4-Code"><span class="toc-number">22.3.</span> <span class="toc-text">21.4 - Code</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-23-DLL-Injection"><span class="toc-number">23.</span> <span class="toc-text">Chapter 23 - DLL Injection</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#23-1-Implementation-of-DLL-Injection"><span class="toc-number">23.1.</span> <span class="toc-text">23.1 - Implementation of DLL Injection</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CreateRemoteThread"><span class="toc-number">23.1.1.</span> <span class="toc-text">CreateRemoteThread()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AppInit-DLLs"><span class="toc-number">23.1.2.</span> <span class="toc-text">AppInit_DLLs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SetWindowsHookEx"><span class="toc-number">23.1.3.</span> <span class="toc-text">SetWindowsHookEx()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-24-DLL-Ejection"><span class="toc-number">24.</span> <span class="toc-text">Chapter 24 - DLL Ejection</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-25-Load-DLL-File-by-Modifying-the-PE-File"><span class="toc-number">25.</span> <span class="toc-text">Chapter 25 - Load DLL File by Modifying the PE File</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-26-PE-Tools"><span class="toc-number">26.</span> <span class="toc-text">Chapter 26 - PE Tools</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-27-Code-Injection"><span class="toc-number">27.</span> <span class="toc-text">Chapter 27 - Code Injection</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#27-4-CodeInjection-cpp"><span class="toc-number">27.1.</span> <span class="toc-text">27.4 - CodeInjection.cpp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-28-Code-Injection-via-Assembly-Code"><span class="toc-number">28.</span> <span class="toc-text">Chapter 28 - Code Injection via Assembly Code</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-29-API-Hooking"><span class="toc-number">29.</span> <span class="toc-text">Chapter 29 - API Hooking</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-30-API-Hooking-of-Notepad-exe-WriteFile"><span class="toc-number">30.</span> <span class="toc-text">Chapter 30 - API Hooking of Notepad.exe WriteFile()</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Debug-Events"><span class="toc-number">30.1.</span> <span class="toc-text">Debug Events</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EXCEPTION-DEBUG-EVENT"><span class="toc-number">30.2.</span> <span class="toc-text">EXCEPTION_DEBUG_EVENT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#30-4-Practice"><span class="toc-number">30.3.</span> <span class="toc-text">30.4 - Practice</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#30-5-Principle"><span class="toc-number">30.4.</span> <span class="toc-text">30.5 - Principle</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-31-Debugger"><span class="toc-number">31.</span> <span class="toc-text">Chapter 31 - Debugger</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#OllyDbg"><span class="toc-number">31.1.</span> <span class="toc-text">OllyDbg</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IDA-Pro"><span class="toc-number">31.2.</span> <span class="toc-text">IDA Pro</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WinDbg"><span class="toc-number">31.3.</span> <span class="toc-text">WinDbg</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-32-Displaying-Korean-in-calc-exe"><span class="toc-number">32.</span> <span class="toc-text">Chapter 32 - Displaying Korean in calc.exe</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#32-4-Practice"><span class="toc-number">32.1.</span> <span class="toc-text">32.4 - Practice</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#32-5-Code"><span class="toc-number">32.2.</span> <span class="toc-text">32.5 - Code</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-33-Hidden-Process"><span class="toc-number">33.</span> <span class="toc-text">Chapter 33 - Hidden Process</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#33-3-Hidden-Process"><span class="toc-number">33.1.</span> <span class="toc-text">33.3 - Hidden Process</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">33.2.</span> <span class="toc-text">1234567BOOL EnumProcesses(  [out] DWORD   *lpidProcess,  [in]  DWORD   cb,  [out] LPDWORD lpcbNeeded);&#x2F;&#x2F;Source: https:&#x2F;&#x2F;learn.microsoft.com&#x2F;en-us&#x2F;windows&#x2F;win32&#x2F;api&#x2F;psapi&#x2F;nf-psapi-enumprocesses</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#33-4-Practice"><span class="toc-number">33.3.</span> <span class="toc-text">33.4 - Practice</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#33-5-HideProc"><span class="toc-number">33.4.</span> <span class="toc-text">33.5 - HideProc</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-34-Global-API-Hooking"><span class="toc-number">34.</span> <span class="toc-text">Chapter 34 - Global API Hooking</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-35-How-to-Choose-Your-Tools"><span class="toc-number">35.</span> <span class="toc-text">Chapter 35 - How to Choose Your Tools</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-36-64-bit"><span class="toc-number">36.</span> <span class="toc-text">Chapter 36 - 64-bit</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#36-1-64-bit-Processing"><span class="toc-number">36.1.</span> <span class="toc-text">36.1 - 64-bit Processing</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-37-x64-Processor"><span class="toc-number">37.</span> <span class="toc-text">Chapter 37 - x64 Processor</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-38-PE32"><span class="toc-number">38.</span> <span class="toc-text">Chapter 38 - PE32+</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-39-WinDbg"><span class="toc-number">39.</span> <span class="toc-text">Chapter 39 - WinDbg</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-40-64-bit-Debugging"><span class="toc-number">40.</span> <span class="toc-text">Chapter 40 - 64-bit Debugging</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#40-1-Debugger-on-x64-Platform"><span class="toc-number">40.1.</span> <span class="toc-text">40.1 - Debugger on x64 Platform</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#40-2-x64-Debugging"><span class="toc-number">40.2.</span> <span class="toc-text">40.2 - x64 Debugging</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#40-3-WOW64Test-x86-exe"><span class="toc-number">40.3.</span> <span class="toc-text">40.3 - WOW64Test_x86.exe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#40-4-WOW64Test-x64-exe"><span class="toc-number">40.4.</span> <span class="toc-text">40.4 - WOW64Test_x64.exe</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-41-ASLR"><span class="toc-number">41.</span> <span class="toc-text">Chapter 41 - ASLR</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-42-Session-of-Kernel-6"><span class="toc-number">42.</span> <span class="toc-text">Chapter 42 - Session of Kernel 6</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-43-DLL-Injection-in-Kernel-6"><span class="toc-number">43.</span> <span class="toc-text">Chapter 43 - DLL Injection in Kernel 6</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-44-InjDll-exe%E2%80%94%E2%80%94A-Tool-for-DLL-Injection"><span class="toc-number">44.</span> <span class="toc-text">Chapter 44 - InjDll.exe——A Tool for DLL Injection</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-45-TLS-Callback-Function"><span class="toc-number">45.</span> <span class="toc-text">Chapter 45 - TLS Callback Function</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#45-1-Practice-1-HelloTls-exe"><span class="toc-number">45.1.</span> <span class="toc-text">45.1 - Practice#1 HelloTls.exe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#45-2-TLS"><span class="toc-number">45.2.</span> <span class="toc-text">45.2 - TLS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#45-3-TLS-Callback-Function"><span class="toc-number">45.3.</span> <span class="toc-text">45.3 - TLS Callback Function</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IMAGE-TLS-CALLBACK"><span class="toc-number">45.3.1.</span> <span class="toc-text">IMAGE_TLS_CALLBACK</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#45-4-Practice-2-TlsTest-exe"><span class="toc-number">45.4.</span> <span class="toc-text">45.4 - Practice#2 TlsTest.exe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#45-5-Debugging-TLS-Callback-Function"><span class="toc-number">45.5.</span> <span class="toc-text">45.5 - Debugging TLS Callback Function</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#45-6-Manually-Add-TLS-Callback-Function"><span class="toc-number">45.6.</span> <span class="toc-text">45.6 - Manually Add TLS Callback Function.</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-46-TEB"><span class="toc-number">46.</span> <span class="toc-text">Chapter 46 - TEB</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#46-2-Accessing-TEB"><span class="toc-number">46.1.</span> <span class="toc-text">46.2 - Accessing TEB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ntdll-NtCurrentTeb"><span class="toc-number">46.1.1.</span> <span class="toc-text">Ntdll.NtCurrentTeb()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FS-Segment-Register"><span class="toc-number">46.1.2.</span> <span class="toc-text">FS Segment Register</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-47-PEB"><span class="toc-number">47.</span> <span class="toc-text">Chapter 47 - PEB</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#47-1-PEB"><span class="toc-number">47.1.</span> <span class="toc-text">47.1 - PEB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Accessing-PEB"><span class="toc-number">47.1.1.</span> <span class="toc-text">Accessing PEB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Definition-of-PEB"><span class="toc-number">47.1.2.</span> <span class="toc-text">Definition of PEB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Members-of-PEB"><span class="toc-number">47.1.3.</span> <span class="toc-text">Members of PEB</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#47-2-Important-Members"><span class="toc-number">47.2.</span> <span class="toc-text">47.2 - Important Members</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-48-SEH"><span class="toc-number">48.</span> <span class="toc-text">Chapter 48 - SEH</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#48-1-SEH"><span class="toc-number">48.1.</span> <span class="toc-text">48.1 - SEH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#48-4-Exception"><span class="toc-number">48.2.</span> <span class="toc-text">48.4 - Exception</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#48-5-Details-of-SEH"><span class="toc-number">48.3.</span> <span class="toc-text">48.5 - Details of SEH</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SEH-Chain"><span class="toc-number">48.3.1.</span> <span class="toc-text">SEH Chain</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Definition-of-Exception-Handler"><span class="toc-number">48.3.2.</span> <span class="toc-text">Definition of Exception Handler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TEB-NtTib-ExceptionList"><span class="toc-number">48.3.3.</span> <span class="toc-text">TEB.NtTib.ExceptionList</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-SEH"><span class="toc-number">48.3.4.</span> <span class="toc-text">Using SEH</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#48-6-Practice-2-seh-exe"><span class="toc-number">48.4.</span> <span class="toc-text">48.6 - Practice#2 - seh.exe</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-49-IA-32-Instruction"><span class="toc-number">49.</span> <span class="toc-text">Chapter 49 - IA-32 Instruction</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#49-2-Terminology"><span class="toc-number">49.1.</span> <span class="toc-text">49.2 - Terminology</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#49-3-IA-32-Instruction-Format"><span class="toc-number">49.2.</span> <span class="toc-text">49.3 - IA-32 Instruction Format</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Instruction-Prefix"><span class="toc-number">49.2.1.</span> <span class="toc-text">Instruction Prefix</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Opcode"><span class="toc-number">49.2.2.</span> <span class="toc-text">Opcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ModR-M"><span class="toc-number">49.2.3.</span> <span class="toc-text">ModR&#x2F;M</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SIB"><span class="toc-number">49.2.4.</span> <span class="toc-text">SIB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deplacement"><span class="toc-number">49.2.5.</span> <span class="toc-text">Deplacement</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Immediate"><span class="toc-number">49.2.6.</span> <span class="toc-text">Immediate</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#49-4-Instruction-Analyzing"><span class="toc-number">49.3.</span> <span class="toc-text">49.4 - Instruction Analyzing</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#49-5-Practice"><span class="toc-number">49.4.</span> <span class="toc-text">49.5 - Practice</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-50-Anti-Debugging"><span class="toc-number">50.</span> <span class="toc-text">Chapter 50 - Anti-Debugging</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#50-1-Anti-Debugging"><span class="toc-number">50.1.</span> <span class="toc-text">50.1 Anti-Debugging</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#50-2-Anti-Anti-Debugging"><span class="toc-number">50.2.</span> <span class="toc-text">50.2 - Anti-Anti-Debugging</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#50-3-Types-of-Anti-Debugging"><span class="toc-number">50.3.</span> <span class="toc-text">50.3 - Types of Anti-Debugging</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Static-Anti-Debugging"><span class="toc-number">50.3.1.</span> <span class="toc-text">Static Anti-Debugging</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dynamic-Anti-Debugging"><span class="toc-number">50.3.2.</span> <span class="toc-text">Dynamic Anti-Debugging</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-51-Static-Anti-Debugging-Techniques"><span class="toc-number">51.</span> <span class="toc-text">Chapter 51 - Static Anti-Debugging Techniques</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#51-2-PEB"><span class="toc-number">51.1.</span> <span class="toc-text">51.2 - PEB</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BeingDebugged-0x2"><span class="toc-number">51.1.1.</span> <span class="toc-text">BeingDebugged (+0x2)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ldr-0xC"><span class="toc-number">51.1.2.</span> <span class="toc-text">Ldr (+0xC)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Process-Heap-0x18"><span class="toc-number">51.1.3.</span> <span class="toc-text">Process Heap (+0x18)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NtGlobalFlag-0x68"><span class="toc-number">51.1.4.</span> <span class="toc-text">NtGlobalFlag (+0x68)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#51-3-NtQueryInformationProcess"><span class="toc-number">51.2.</span> <span class="toc-text">51.3 - NtQueryInformationProcess()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ProcessDebugPort-0x7"><span class="toc-number">51.2.1.</span> <span class="toc-text">ProcessDebugPort(0x7)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProcessDebugObjectHandle-0x1E"><span class="toc-number">51.2.2.</span> <span class="toc-text">ProcessDebugObjectHandle(0x1E)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProcessDebugFlags-0x1F"><span class="toc-number">51.2.3.</span> <span class="toc-text">ProcessDebugFlags(0x1F)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#51-4-NtQuerySystemInformation"><span class="toc-number">51.3.</span> <span class="toc-text">51.4 - NtQuerySystemInformation()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#51-5-NtQueryObject"><span class="toc-number">51.4.</span> <span class="toc-text">51.5 - NtQueryObject()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#51-6-ZwSetInformationThread"><span class="toc-number">51.5.</span> <span class="toc-text">51.6 - ZwSetInformationThread()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#51-7-TLS-Callback-Function"><span class="toc-number">51.6.</span> <span class="toc-text">51.7 - TLS Callback Function</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#51-8-ETC"><span class="toc-number">51.7.</span> <span class="toc-text">51.8 - ETC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-52-Dynamic-Anti-Debugging-Techniques"><span class="toc-number">52.</span> <span class="toc-text">Chapter 52 - Dynamic Anti-Debugging Techniques</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#52-2-Exception"><span class="toc-number">52.1.</span> <span class="toc-text">52.2 - Exception</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SEH"><span class="toc-number">52.1.1.</span> <span class="toc-text">SEH</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SetUnhandledExceptionFilter"><span class="toc-number">52.1.2.</span> <span class="toc-text">SetUnhandledExceptionFilter()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#52-3-Time-Checking"><span class="toc-number">52.2.</span> <span class="toc-text">52.3 - Time Checking</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Interval"><span class="toc-number">52.2.1.</span> <span class="toc-text">Interval</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RDTSC"><span class="toc-number">52.2.2.</span> <span class="toc-text">RDTSC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#52-4-Trap-Flag"><span class="toc-number">52.3.</span> <span class="toc-text">52.4 - Trap Flag</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#52-5-0xCC"><span class="toc-number">52.4.</span> <span class="toc-text">52.5 - 0xCC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-53-Advanced-Anti-Debugging"><span class="toc-number">53.</span> <span class="toc-text">Chapter 53 - Advanced Anti-Debugging</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#53-1-Advanced-Anti-Debugging"><span class="toc-number">53.1.</span> <span class="toc-text">53.1 - Advanced Anti-Debugging</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#53-2-Garbage-Code"><span class="toc-number">53.2.</span> <span class="toc-text">53.2 - Garbage Code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#53-3-Breaking-Code-Alignment"><span class="toc-number">53.3.</span> <span class="toc-text">53.3 - Breaking Code Alignment</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#53-4-Encryption-Decription"><span class="toc-number">53.4.</span> <span class="toc-text">53.4 - Encryption&#x2F;Decription</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#53-5-Stolen-Bytes-Remove-OEP"><span class="toc-number">53.5.</span> <span class="toc-text">53.5 - Stolen Bytes (Remove OEP)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#53-6-API-Relocation"><span class="toc-number">53.6.</span> <span class="toc-text">53.6 - API Relocation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#53-7-Debug-Blocker-Self-Debugging"><span class="toc-number">53.7.</span> <span class="toc-text">53.7 - Debug Blocker (Self Debugging)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-54-Practice-1-Service"><span class="toc-number">54.</span> <span class="toc-text">Chapter 54 - Practice#1: Service</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-55-Practice-2-Self-Creation"><span class="toc-number">55.</span> <span class="toc-text">Chapter 55 - Practice#2: Self Creation</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-56-Practice-3-PE-Image-Switching"><span class="toc-number">56.</span> <span class="toc-text">Chapter 56 - Practice#3: PE Image Switching</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-57-Practice-4-Debug-Blocker"><span class="toc-number">57.</span> <span class="toc-text">Chapter 57 - Practice#4: Debug Blocker</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#THANKS-FOR-READING"><span class="toc-number">58.</span> <span class="toc-text">THANKS FOR READING</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {code.findCode();
document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><script src="/js/slide.js"></script></body></html>